<!--本地路径-->
<link rel="stylesheet" type="text/css" href="/css/PM/PMContent.css">

<!-- CSS -->
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/Bootstrap-3.3.7/css/bootstrap.min.css">

<!--<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/DataTables-1.10.18/css/jquery.dataTables.css">-->
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/DataTables-1.10.18/css/dataTables.bootstrap.css">

<!-- JS  -->
<script type="text/javascript" src="/css/PM/DataTables/DataTables-1.10.18/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="/css/PM/DataTables/DataTables-1.10.18/js/dataTables.bootstrap.min.js"></script>
<!-- date picker -->
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.min.js" charset="UTF-8"></script>
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>
<link rel="stylesheet" type="text/css" href="/css/MSTools/layui/css/layui.css">
<script src="/js/PM/FileSaver.min.js"></script>
<script src="/js/PM/tableExport.js"></script>
<script src="/js/PM/PMfuns.js"></script>
<!-- JS 这3个管分析视窗 -->
<script src="/js/bootstrap.min.js"></script>
<script src="/js/PM/FileSaver.min.js"></script>
<script src="/js/PM/tableExport.js"></script>
<!-- 打印 -->
<script src="/public/print/print.js"></script>
<!-- 预览 -->
<script src="/arch/FnSubA.js"></script>
<script src="/arch/FnSubB.js"></script>
<script src="/js/HMIPrint/jquery.easyui.min.js"></script>
<script type="text/javascript" src="/css/MSTools/layui/layui.js"></script>
<link rel="stylesheet" type="text/css" href="/css/TM/tmcode-font.css">
<script src="/bomq/supplyFn.js"></script>
<script src="/bomq/utilFn.js"></script>
<script src="/good/jquery.watermark.js"></script>
<% layout(locals.global.theme_layout_dir+'/master.ejs') -%>
</br>
<div class="layui-form-item">
	  <a class="layui-btn layui-btn-info" id="btn_apply_A"
		    style="margin-left:30px">采&nbsp;&nbsp;&nbsp;&nbsp;购</a>
	  <a class="layui-btn layui-btn-info" id="btn_apply_B"
		    style="margin-left:30px">差&nbsp;&nbsp;&nbsp;&nbsp;旅</a>
</div>
	<div id="noprint" class="noprint">
		<div class="divcontent">
			<div id="handout_wrap_inner"></div>
			<!-- <h1>费用单据查找</h1> -->
			<label>模式:</label>
			<select id="Pattern" name="Pattern" class="can-find-M140"></select>
			<!-- <label>种类:</label>
			<select id="CapMode" name="CapMode" class="can-find-M140"></select> -->
			<button id="SeaBtn" class="btn btn-default">与我相关</button>
			<button id="SeaAllBtn" class="btn btn-default">全部单据</button>
			<!-- <input type="button" id="DisplayBtn" class="btn btn-info" value="栏位" /> -->
			<button id="BTNFitler" type="button" class="btn btn-default">过滤查找</button>
			<input type="button" id="DetailBtn" class="btn btn-info" value="预览" />
			<input type="button" id="btn_apply" class="btn btn-info" onclick="apply_hmi();" value="送审" />
			<input type="button" id="MdfyBtn" class="btn btn-primary" value="编辑" />
			<input type="button" id="VoidBtn" class="btn btn-primary" value="作废" />
			<input type="button" id="PurFixBtn" class="btn btn-danger" value="采购" />
			<input type="button" id="ExpFillBtn" class="btn btn-warning" value="报销" />
			<input type="hidden" id="hideDeptName" value="" />
			<input type="hidden" id="hideFlowRole" value="" />
			<input type="hidden" id="hidePhone" value="" />
			<input type="hidden" id="MicroOrig" value="" />
			<input type="hidden" id="MicroGroup" value="" />
			<hr>
			<br />
			<div id="DivFilter" class="easyui-window" title="自定义过滤器" closed="true"
				style="width:900px;height:400px;">
				<form style="padding:10px 50px;">
					<div class="form-horizontal">
						<div class="form-group">
							<label for="taskMakeDate" class="col-sm-2 control-label">上周日期范围:</label>
							<div class="col-sm-3">
								<div class="input-group date form_date " data-date=""
									data-date-format="yyyy-mm-dd" data-link-field="taskMakeDateB"
									data-link-format="yyyy-mm-dd">
									<input id="taskMakeDateB" class="form-control " size="16"
										type="text" value="" readonly>
									<span class="input-group-addon"><span
											class="glyphicon glyphicon-calendar"></span></span>
								</div>
								<input type="hidden" id="taskMakeDateB" value="" />
							</div>
							<div class="col-sm-3">
								<div class="input-group date form_date " data-date=""
									data-date-format="yyyy-mm-dd" data-link-field="taskMakeDateE"
									data-link-format="yyyy-mm-dd">
									<input id="taskMakeDateE" class="form-control " size="16"
										type="text" value="" readonly>
									<span class="input-group-addon"><span
											class="glyphicon glyphicon-calendar"></span></span>
								</div>
								<input type="hidden" id="taskMakeDateE" value="" />
							</div>
						</div>
					</div>
				</form>
				<br></br>
				<form style="padding:10px 50px;">
					<div class="form-horizontal">
						<div class="form-group">
							<div class="col-sm-3">
								<label>姓名:</label>
								<input id="MicroName" class="form-control " size="16" type="text"
									value="">
							</div>
							<div class="col-sm-3">
								<label>部門:</label>
								<input id="MicroDept" class="form-control " size="16" type="text"
									value="">
								<br></br>
							</div>
							<div class="col-sm-3">
								<label>关键字:</label>
								<input id="MicroWord" class="form-control " size="16" type="text"
									value="">
								<br></br>
							</div>
						</div>
					</div>
				</form>
				<form style="padding:10px 50px;">
					<div class="form-horizontal">
						<div class="col-sm-3">
							<label class="form-horizontal"></label>
							<div class="form-horizontal">
								<button id="FilterComfirmBtnN" type="button"
									class="btn btn-primary">确认</button>
								<button id="FilterCancelBtnN" type="button"
									class="btn btn-warning">清空</button>
							</div>
						</div>
					</div>
				</form>
			</div>

		</div>
	</div><!-- modal fade -->
	<div class="modal fade" id="kisswindow" tabindex="-1" role="dialog" aria-labelledby="kisswindowLabel"
		aria-hidden="true" data-backdrop="static">
		<div class="modal-dialog" style="width:70%">
			<div class="modal-content">
				<div class="modal-body">
					<div class="panel panel-info">
						<div class="panel-heading">
							<h3 class="panel-title">费用明细</h3>
						</div>
						<div id="listPrintViewDiv">
						</div>
						<div style="margin-left:400px;margin-top:5px;">
							<br />
							<br />
							<!-- <button id="PrintConfirm" style="margin-left:60px" type="button"
								class="btn btn-info">打印</button>
							<button id="PrintClose" type="button" class="btn btn-primary"
								data-dismiss="modal">关闭</button> -->
						</div>
					</div><!-- /.modal-content -->
				</div><!-- /.modal -->
			</div><!-- 总结 -->
		</div><!-- /.modal -->
	</div>
	<div class="modal fade" id="momowindow" style="top:200px;" tabindex="-1" role="dialog"
		aria-labelledby="momowindowLabel" aria-hidden="true" data-backdrop="static">
		<div class="modal-dialog" style="width:65%">
			<div class="modal-content">
				<div class="modal-header">
					<h3 class="panel-title">建立核销金额</h3>
				</div>
				<div class="modal-body">
					<div class="panel panel-info">
						<div class="panel-heading">
							<h3 class="panel-title"></h3>
						</div>
						<div class="panel-body">
							<br />
							<div class="form-group">
								<label class="col-sm-1 control-label">文号</label>
								<div class="col-sm-3">
									<input id="BillNo" class="form-control" type="text" value=""
										readonly>
								</div>
								<label class="col-sm-1 control-label">申请</label>
								<div class="col-sm-3">
									<input id="TotalValue" class="form-control" type="text" value=""
										readonly>
								</div>
								<label class="col-sm-1 control-label">调整额</label>
								<div class="col-sm-3">
									<input id="ExceedValue" class="form-control" type="text" value=""
									readonly >
								</div>
								<input type="hidden" id="hideCurJob" value="" />
							</div>
							<br />
							<br />
							<div class="form-group">
								<label class="col-sm-1 control-label">上限</label>
								<div class="col-sm-3">
									<input id="UpperLimit" class="form-control" type="text" value="">
								</div>	
							</div>
							<br> </br>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button id="FormBYES" type="button" class="btn btn-primary"
						data-dismiss="modal">确认</button>
					<button id="FormBClose" type="button" class="btn btn-primary"
						data-dismiss="modal">关闭</button>
				</div>
			</div><!-- /.modal-content -->
		</div><!-- /.modal -->
	</div><!-- finmomo -->
	<div class="modal fade" id="sweetModal" tabindex="2">
		<!-- begconfirm -->
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"><span
							aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
					<h4 class="modal-title"></h4>
				</div>
				<div class="modal-body">
					<p></p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default cancelBtn" data-dismiss="modal">取消</button>
					<button type="button" class="btn btn-danger sureBtn" data-dismiss="modal">确定</button>
				</div>
			</div>
		</div>
	</div><!-- finconfirm -->
	<div class="pdf-wrapper" id="pdf-wrapper" style="background-color: aliceblue;">
		<!--数据呈现区-->
		<table id="center_TB" class="table table-striped table-bordered">
			<thead id="content">

			</thead>
		</table>
	</div>
	</div>
	<div id="root" style="height: 100%"></div>
	<script>
		var href = "/app/TMFinc/tripHistory";
		var CapMode = 'B';
		var pick = 'B';
		var missType = '';
		var missAcute = '';
		var missBcute = '';
		var missScute = '';
		var missCcute = '';
		var missDcute = '';
		var glbA = '';
		var glbB = '';
		var glbC = '';
		var glbD = '';
		var glbE = '';
		var glbF = '';
		var glbG = '';
		var glbH = '';
		var glbS = '';
		var Pattern = '';
		var CapMode = 'B';  //出差单是 B
		var SeaMode = '';  //0 is SeaBtn , 1 is SeaAllBtn
		var CurName = '';
		var selClass = '';
		var FieldA = true;
		var FieldB = true;
		var FieldC = true;
		var FieldD = true;
		var FieldE = false;
		var FieldF = false;
		var FieldG = false;
		var FieldH = true;
		var FieldI = false;
		var FieldJ = false;
		var FieldK = false;
		var storage = window.localStorage;
		var hidata = localStorage.getItem("findXXX");
		hidata = JSON.parse(hidata);
		var sessionName = '';
		var sessionOID = '';
		let sData = [];
		if (hidata != undefined && hidata != null) {
			FieldA = ((hidata.A == null || hidata.A == undefined) ? (FieldA) : hidata.A);
			FieldB = ((hidata.B == null || hidata.B == undefined) ? (FieldB) : hidata.B);
			FieldC = ((hidata.C == null || hidata.C == undefined) ? (FieldC) : hidata.C);
			FieldD = ((hidata.D == null || hidata.D == undefined) ? (FieldD) : hidata.D);
			FieldE = ((hidata.E == null || hidata.E == undefined) ? (FieldE) : hidata.E);
			FieldF = ((hidata.F == null || hidata.F == undefined) ? (FieldF) : hidata.F);
			FieldG = ((hidata.G == null || hidata.G == undefined) ? (FieldG) : hidata.G);
			FieldH = ((hidata.H == null || hidata.H == undefined) ? (FieldH) : hidata.H);
			FieldI = ((hidata.I == null || hidata.I == undefined) ? (FieldI) : hidata.I);
			FieldJ = ((hidata.J == null || hidata.J == undefined) ? (FieldJ) : hidata.J);
			FieldK = ((hidata.K == null || hidata.K == undefined) ? (FieldK) : hidata.K);
			console.log("敏A希", FieldA, "敏B希", FieldB);
		}
		var columnsData = [];
		//页面加载函数---------------
		$(document).ready(function () {
			sessionName = "<%-locals.session.yjUser.Name%>";
			sessionOID = "<%-locals.session.yjUser.OID%>";
			layui.use(['form', 'layedit', 'laydate'], function () {
				var form = layui.form
					, layer = layui.layer
					, layedit = layui.layedit
					, laydate = layui.laydate;
				form.render();
				var DataPara = {
					"tableID": "#center_TB",
					"DBTable": "auto_parts"
				}
				missType = getQueryString("missT");
				missAcute = getQueryString("missA");
				missBcute = getQueryString("missB");
				missScute = getQueryString("missS");
				var missAencode = decodeURI(missAcute);

				glbA = missAencode;
				columnsData = [

				];
				var contentSum = "";
				var content = '<tr>'
					+ '<th></th>'
					+ '</tr>';
				contentSum += content;
				$('#content').html(contentSum);
				var youoption = document.createElement("option");
				youoption.id = "SIGN";
				youoption.name = "SIGN";
				youoption.text = "AND";
				youoption.value = "1";
				$("#SIGN").append(youoption);
				youoption = document.createElement("option");
				youoption.text = "OR";
				youoption.value = "2";
				$("#SIGN").append(youoption);
			});
			getpull(); getDrop();
			obtHisGroup(sessionName);
			function timer(time) {
				setTimeout(function () {
					if (missScute == '0') {
						$("#SeaBtn").addClass("active");
						$('#SeaBtn').click();
					} else if (missScute == '1') {
						$("#SeaAllBtn").addClass("active");
						$('#SeaAllBtn').click();
					} else {
						$("#SeaAllBtn").addClass("active");
						$('#SeaAllBtn').click();
					}
				}, time);
			}
			timer(500);
			$("#pdf-wrapper").css('visibility', 'hidden');
		});

		var DataPara = {
			"tableID": "#center_TB",
			"DBTable": "auto_parts"
		}
		columnsData = [

		];
		$('#btn_apply_A').click(function () {
                        window.location.href = '/app/TMFinc/feeHistory';
                });
		$('#btn_apply_B').click(function () {
			     window.location.href = href;
		});
		function showDBDataByBill(DataPara, columnsData, Pattern, CapMode, SeaMode, StaffName) {
			$("#pdf-wrapper").css('visibility', 'visible');
			var limit = '5000';
			var filter = ' 1=1 ';
			var orderBy = '';
			$("#center_TB").dataTable().fnDestroy();
			var signoption = $("#SIGN option:selected");
			var signTxt = signoption.text();
			var Advstr = { "SIGN": signTxt, "Pattern": Pattern, "StaffName": StaffName, "limit": limit };
			var MicroName = $("#MicroName").val();
			var MicroOrig = $("#MicroOrig").val();
			var MicroGroup = $("#MicroGroup").val();
			var MicroDept = $("#MicroDept").val();
			var MicroWord = $("#MicroWord").val();
			var MicroRole = $("#hideFlowRole").val();
			var Micstr = {
				"MicroName": MicroName, "MicroOrig": MicroOrig, "MicroRole": MicroRole , "MicroGroup": MicroGroup , "MicroDept": MicroDept, "MicroWord": MicroWord
			};
			console.log("一曲长歌 ", Micstr);
			$("#matchRec").html("查找条件:" + signTxt);
			var reportChannel = 'FeeHead';
			var arrange = 'Fee';
			var taskData = { "reportType": reportChannel, "arrange": arrange, "pick": CapMode };
			console.log("一曲长歌一曲长歌", CapMode);
			$('#content').val();
			$('#content').html();
			let newColumns = [];
			$.ajax({
				method: 'post',
				data: taskData,
				url: "/app/TMFinc/getRoute",
				success: function (data) {
					$('#content').val();
					$('#content').html();
					$('#content').html(data[1]);
					newColumns = [];
					newColumns = data[0];
					var reportType = 'FeeHisVisit';
					var taskData = { "reportType": reportType, "arrange": arrange, "pick": CapMode, 
					"filter": filter, "Advstr": Advstr, "Micstr": Micstr,"limit": limit, "orderBy": orderBy };
					bornTable(taskData, newColumns);
				},
				error: function () {
				}
			})
		}

		function bornTable(taskData, columnsData) {
			console.log("倾覆了故国", columnsData);
			$(DataPara.tableID).DataTable({
				ajax: {
					method: 'post',
					data: taskData,
					url: "/app/TMFinc/getRoute",
					dataSrc: ''
				},
				columns: columnsData,
				aaSorting: [0, 'desc'],
				language: languageCN
			});
			var table = $('#center_TB').DataTable();
			$('#center_TB tbody').on('click', 'tr', function () {
				$(this).removeClass('selected');
				if ($(this).hasClass('selected')) {
					$(this).removeClass('selected');
				} else {
					table.$('tr.selected').removeClass('selected');
					$(this).addClass('selected');
				}
			});

			$('#center_TB tbody').on('dblclick', 'tr', function () {
				var table = $('#center_TB').DataTable();
				var dataSelect = table.row('.selected').data();
				var data = table.row(this).data();
				var billNo = dataSelect.BillNo; billNo = myTrim(billNo);
				if (CapMode == 'A') {
					shuffleA(billNo);
				}
				if (CapMode == 'B') {
					shuffleB(billNo);
				}
				$('#kisswindow').modal('show');
			});
		}
		function showDBDataSelf(DataPara, columnsData, MakeDateB, MakeDateE, Pattern, CapMode, Micstr) {
			$("#pdf-wrapper").css('visibility', 'visible');
			var limit = '5000';
			var filter = ' 1=1 ';
			var orderBy = '';
			$("#center_TB").dataTable().fnDestroy();
			var signoption = $("#SIGN option:selected");
			var signTxt = signoption.text();
			var Advstr = { "SIGN": signTxt, "weekbeg": MakeDateB, "weekend": MakeDateE, "Pattern": Pattern, "CapMode": CapMode, "limit": limit };
			var reportChannel = 'FeeHead';
			var arrange = 'Fee';
			var taskData = { "reportType": reportChannel, "arrange": arrange, "pick": CapMode };
			$.ajax({
				method: 'post',
				data: taskData,
				url: "/app/TMFinc/getRoute",
				success: function (data) {
					$('#content').html(data[1]);
					let newColumns = [];
					newColumns = data[0];
					var reportType = 'FeeHisVisit';
					var taskType = { "reportType": reportType, "arrange": arrange, "pick": CapMode, "filter": filter, "Advstr": Advstr, "Micstr": Micstr, "limit": limit, "orderBy": orderBy };
					//   console.log("倾覆了故国",taskType);
					bornTable(taskType, newColumns);
				},
				error: function () {
				}
			})
		}
		function reloadCol() {
			columnsData = [

			];
		}
		$('#BTNFitler').click(function () {
			$('#DivFilter').window('open');
			$('.form_date').datetimepicker({
				language: 'zh-CN',
				weekStart: 1,
				todayBtn: 1,
				autoclose: 1,
				todayHighlight: 1,
				startView: 2,
				minView: 2,
				forceParse: 0
			});
			$("#BTNGroupFilter").children().removeClass("active");
			$("#BTNFitler").addClass("active")
		});
		//过滤功能组 自定义过滤确认按钮-----NNN
		$('#FilterComfirmBtnN').click(function () {
			$('#DivFilter').window('close');
			filter_look();
		});
		//过滤功能组 自定义过滤确认按钮-----
		$('#FilterCancelBtnN').click(function () {
			$("#taskMakeDateB").val("")
			$("#taskMakeDateE").val("")
			$("#MicroName").val("")
			$("#MicroOrig").val("")
			$("#MicroGroup").val("")
			$("#MicroDept").val("")
			$("#MicroRole").val("")
			$("#MicroWord").val("")
		});
		function filter_look() {
			$("#center_TB").dataTable().fnDestroy();
			var MakeDateB = $("#taskMakeDateB").val();
			var MakeDateE = $("#taskMakeDateE").val();
			var MicroName = $("#MicroName").val();
			var MicroOrig = $("#MicroOrig").val();
			var MicroGroup = $("#MicroGroup").val();
			var MicroDept = $("#MicroDept").val();
			var MicroRole = $("#MicroRole").val();
			var MicroWord = $("#MicroWord").val();
			var Micstr = {
				"MicroName": MicroName, "MicroOrig": MicroOrig , "MicroRole": MicroRole ,"MicroGroup": MicroGroup , "MicroDept": MicroDept, "MicroWord": MicroWord
			};
			console.log("杨过", MicroName, "龙女", MicroDept, "陈研", MicroWord);
			Pattern = $('#Pattern').val();
			// CapMode = $('#CapMode').val();
			reloadCol();
			showDBDataSelf(DataPara, columnsData, MakeDateB, MakeDateE, Pattern, CapMode, Micstr);
		}
		$('#DetailBtn').click(function () {
			var table = $('#center_TB').DataTable();
			var dataSelect = table.row('.selected').data();
			if (dataSelect == undefined) {
				alert("当前未选择任何数据,请先点击需要的数据行!");
			} else {
				var billNo = dataSelect.BillNo; billNo = myTrim(billNo);
				console.log("西阭", (billNo));
				if (CapMode == 'A') {
					shuffleA(billNo);
				}
				if (CapMode == 'B') {
					shuffleB(billNo);
				}
				$('#kisswindow').modal('show');
			}
		});
		$('#SeaBtn').click(function () {
			SeaMode = '0';
			$("#center_TB").dataTable().fnDestroy();
			Pattern = $('#Pattern').val();
			// CapMode = $('#CapMode').val();
			if (missAcute != undefined && missAcute != null) {
				Pattern = missAcute;
			}
			if (missBcute != undefined && missBcute != null) {
				CapMode = missBcute;
			}
			if (missScute != undefined && missScute != null) {
				SeaMode = missScute;
			}
			console.log("希望", missAcute, "是存在的", missBcute, "和奇迹", missScute);
			var msource = '';
			var morder = "";
			reloadCol();
			showDBDataByBill(DataPara, columnsData, Pattern, CapMode, SeaMode, sessionName);
			$("#SeaBtn").addClass("active");
			$("#SeaAllBtn").removeClass("active");
		});
		$('#SeaAllBtn').click(function () {
			var DateB = $("#taskMakeDateB").val();
			var DateE = $("#taskMakeDateE").val();
			missAcute = $('#Pattern').val();
			missBcute = $('#CapMode').val();
			missScute = '1';
			SeaMode = '1';
			$("#center_TB").dataTable().fnDestroy();
			Pattern = $('#Pattern').val();
			// CapMode = $('#CapMode').val();
			if (missAcute != undefined && missAcute != null) {
				Pattern = missAcute;
			}
			if (missBcute != undefined && missBcute != null) {
				CapMode = missBcute;
			}
			if (missScute != undefined && missScute != null) {
				SeaMode = missScute;
			}
			console.log("希望", missAcute, "是存在的", missBcute, "和奇迹", missScute);
			var msource = '';
			var morder = "";
			reloadCol();
			showDBDataByBill(DataPara, columnsData, Pattern, CapMode, SeaMode, '');
			$("#SeaAllBtn").addClass("active");
			$("#SeaBtn").removeClass("active");
		});
		$('#MdfyBtn').click(function () {
			var table = $('#center_TB').DataTable();
			var dataSelect = table.row('.selected').data();
			if (dataSelect == undefined) {
				alert("当前未选择任何数据,请先点击需要的数据行!");
			} else {
				var billNo = dataSelect.BillNo; billNo = myTrim(billNo);
				var CurText = dataSelect.CurText;
				var SendText = dataSelect.SendText;
				var StaffName = dataSelect.StaffName;
				if (CurText == '作废') {

				} else {
					if (SendText != '保存') {
						layer.msg('非保存状态 ， 此单不能修改', { icon: 1 });
						return;
					}
				}

				if (CurText == '核准') {
					layer.msg('已核准状态 ， 此单不能修改', { icon: 1 });
					return;
				}
				if (CurText == '报销') {
					layer.msg('已报销状态 ， 此单不能修改', { icon: 1 });
					return;
				}
				if (sessionName != StaffName) {
					layer.msg('非本人操作 ， 此单不能修改', { icon: 1 });
					return;
				}
				layer.confirm(billNo + '进入编辑作业，请确认操作是否无误？', {
					btn: ['是', '否']
				}, function () {
					var paramClearA = encodeURI(encodeURI(billNo));
					var paramType = 'Mdy';

					if (CapMode == 'A') {
						window.location.href = "/app/TMFinc/feeApplyForm?missT=" + paramType + "&missA=" + paramClearA + " ";
					}
					if (CapMode == 'B') {
						window.location.href = "/app/TMFinc/feeTravel?missT=" + paramType + "&missA=" + paramClearA + " ";
					}
				}, function () {
					layer.msg('无操作', { icon: 1 });
				});
			}
		});
		$('#VoidBtn').click(function () {
			var table = $('#center_TB').DataTable();
			var dataSelect = table.row('.selected').data();
			if (dataSelect == undefined) {
				alert("当前未选择任何数据,请先点击需要的数据行!");
			} else {
				var billNo = dataSelect.BillNo; billNo = myTrim(billNo);
				var CurText = dataSelect.CurText;
				var StaffName = dataSelect.StaffName;
				var MagName = dataSelect.MagName;
				var VipName = dataSelect.VipName;
				var DeptName = dataSelect.DeptName;
				if (CurText == '核准') {
					layer.msg('已核准状态 ， 此单不能作废', { icon: 1 });
					return;
				}
				if (CurText == '作废') {
					layer.msg('已作废状态 ， 此单不能作废', { icon: 1 });
					return;
				}
				// console.log("鲨炮",MagName,"流尾",VipName,"喷",sessionName,"中",StaffName);
				if (sessionName == MagName || sessionName == VipName || sessionName == StaffName) {
					// console.log("虽",VipName,"自性",MagName,"清净",sessionName,"客尘",DeptName);
				} else {
					layer.msg('非相关人士 ， 此单不能修改', { icon: 1 });
					return;
				}
				layer.confirm(billNo + '此单作废不可回复，请确认操作是否无误？', {
					btn: ['是', '否']
				}, function () {
					layer.msg('操作成功', { icon: 1 });
					var arrange = 'VoidBill';
					var reportType = 'rejectFee';
					var ReasonPest = '';
					var taskData = {
						"reportType": reportType, "arrange": arrange, "BillNo": billNo, "CurName": sessionName,
						"Reason": ReasonPest,
					}
					$.ajax({
						method: 'post',
						data: taskData,
						url: "/app/TMFinc/getRoute",
						success: function (data) {
							if (data.status == 'Fail') {
								layer.msg("讯息" + data.message);
							} else if (data.status == 'OK') {
								layer.confirm("作废文号" + data.BillNo + "" + (data.status), {
									btn: ['知道了']
								}, function () {
									layer.msg('操作成功', { icon: 1 });
									var DateB = $("#taskMakeDateB").val();
									var DateE = $("#taskMakeDateE").val();
									missAcute = $('#Pattern').val();
									missBcute = $('#CapMode').val();
									window.location.href = "/app/TMFinc/feeHistory?missT=" + missType + "&missA=" + missAcute + "&missB=" + missBcute + "&missC=" + DateB + "&missD=" + DateE + " ";
								});
							}
						},
						error: function () {
						}
					})
				}, function () {
					layer.msg('无操作', { icon: 1 });
				});
			}
		});
		$('#PurFixBtn').click(function () {
			var table = $('#center_TB').DataTable();
			var dataSelect = table.row('.selected').data();
			if (dataSelect == undefined) {
				alert("当前未选择任何数据,请先点击需要的数据行!");
			} else {
				var billNo = dataSelect.BillNo; billNo = myTrim(billNo);
				var CurText = dataSelect.CurText;
				var StaffName = dataSelect.StaffName;
				var PurName = dataSelect.PurName;
				var PexName = dataSelect.PexName;
				var CfoName = dataSelect.CfoName;
				var DeptName = dataSelect.DeptName;
				if (CurText != '审批') {
					layer.msg('非审批状态 ， 此单不能修改', { icon: 1 });
					return;
				}
				if (sessionName == PurName || sessionName == PexName || sessionName == CfoName) {
					// console.log("鲨嘴炮",PurName,"流星尾",PurName,"轰",sessionName,"空中",DeptName);
				} else {
					layer.msg('非采购承办人或采购主管或财务人员 ， 此单不能修改', { icon: 1 });
					return;
				}
				layer.confirm(billNo + '进入编辑作业，请确认操作是否无误？', {
					btn: ['是', '否']
				}, function () {
					var paramClearA = encodeURI(encodeURI(billNo));
					var paramType = '';
					var paramPur = 'Pur';
					var paramDept = encodeURI(encodeURI(DeptName));
					var paramJump = encodeURI(encodeURI(sessionName));
					if (CapMode == 'A') {
						window.location.href = "/app/TMFinc/feeApplyForm?missT=" + paramType + "&missJ=" + paramJump + "&missG=" + paramDept + "&missP=" + paramPur + "&missA=" + paramClearA + " ";
					}
					if (CapMode == 'B') {
						window.location.href = "/app/TMFinc/feeTravel?missT=" + paramType + "&missJ=" + paramJump + "&missG=" + paramDept + "&missP=" + paramPur + "&missA=" + paramClearA + " ";
					}
				}, function () {
					layer.msg('无操作', { icon: 1 });
				});
			}
		});
		$('#ExpFillBtn').click(function () {
			var table = $('#center_TB').DataTable();
			var dataSelect = table.row('.selected').data();
			if (dataSelect == undefined) {
				alert("当前未选择任何数据,请先点击需要的数据行!");
			} else {

				var BillNo = dataSelect.BillNo; BillNo = myTrim(BillNo);
				var CurText = dataSelect.CurText;
				var ClaimText = dataSelect.ClaimText;
				var StaffName = dataSelect.StaffName;
				var MagName = dataSelect.MagName;
				var VipName = dataSelect.VipName;
				var CurJob = dataSelect.CurJob;
				var message = '开始报销输入发票实际额，请确认操作是否无误？';
				var TotalValue = dataSelect.TotalValue;
				var ExceedValue = dataSelect.ExceedValue;
				if (CurText != '核准') {
					layer.msg('非核准状态 ， 此单不能报销', { icon: 1 });
					return;
				}
				if (ClaimText == '报销') {
					 message = '此单已进行报销中，是否追加预算？'
				}
				var sessionDept = $("#hideDeptName").val();
				if (sessionDept == '财务部' || sessionName == MagName || sessionName == VipName || sessionName == StaffName) {
				} else {
					layer.msg('非相关人士 ， 此单不能报销作业', { icon: 1 });
					return;
				}
				layer.confirm(BillNo + message, {
					btn: ['是', '否']
				}, function () {
					layer.msg('操作成功', { icon: 1 });
					$('#BillNo').val(BillNo);
					$('#TotalValue').val(TotalValue);
					$('#ExceedValue').val(ExceedValue);
					$("#hideCurJob").val(CurJob);
					$('#momowindow').modal('show');
				}, function () {
					layer.msg('无操作', { icon: 1 });
				});

			}
		});
		function apply_hmi() {
			var table = $('#center_TB').DataTable();
			var dataSelect = table.row('.selected').data();
			if (dataSelect == undefined) {
				alert("当前未选择任何数据,请先点击需要的数据行!");
			} else {
				var billNo = dataSelect.BillNo; billNo = myTrim(billNo);
				var SendText = dataSelect.SendText;
				var CurText = dataSelect.CurText;
				var StaffName = dataSelect.StaffName;
				if (SendText != '保存') {
					layer.msg('非保存状态 ， 此单不能送审', { icon: 1 });
					return;
				}
				if (CurText == '核准') {
					layer.msg('已核准状态 ， 此单不能送审', { icon: 1 });
					return;
				}
				if (CurText == '作废') {
					layer.msg('已作废状态 ， 此单不能送审', { icon: 1 });
					return;
				}
				if (CurText == '退回') {
					layer.msg('已退回状态 ， 此单不能送审', { icon: 1 });
					return;
				}
				if (sessionName != StaffName) {
					layer.msg('非本人提交 ， 此单不能送审', { icon: 1 });
					return;
				}
				console.log("西阭", (billNo));
				var SendStatus = '1';
				layer.confirm('此单送出审批吗，请确认操作是否无误？', {
					btn: ['是', '否']
				}, function () {
					layer.msg('操作成功', { icon: 1 });
					var Basstr = {
						"SendStatus": SendStatus, "hideBillNo": billNo
					};
					var reportType = 'applyBudget';
					var arrange = 'confirm';
					var taskData = {
						"reportType": reportType, "arrange": arrange, "Basstr": Basstr
					}
					$.ajax({
						method: 'post',
						data: taskData,
						url: "/app/TMFinc/getRoute",
						success: function (data) {
							console.log("会好", JSON.stringify(data));
							if (data.status == 'Fail') {
								layer.msg("讯息" + data.message);
							} else if (data.status == 'OK') {
								layer.confirm("申请文号" + data.BillNo + "已送出" + (data.status), {
									btn: ['知道了']
								}, function () {
									layer.msg('操作成功', { icon: 1 });
									var DateB = $("#taskMakeDateB").val();
									var DateE = $("#taskMakeDateE").val();
									missAcute = $('#Pattern').val();
									missBcute = $('#CapMode').val();
									window.location.href = "/app/TMFinc/tripHistory?missT=" + missType + "&missA=" + missAcute + "&missB=" + missBcute + "&missC=" + DateB + "&missD=" + DateE + " ";
								});
							}
						},
						error: function () {
						}
					})
				}, function () {
					layer.msg('无操作', { icon: 1 });
				});
			}
		}
		function ReConfirm(title, content) {
			var confirmPromise = new Promise(function (resolve, reject) {
				$('#sweetModal .modal-title').text(title);
				$('#sweetModal .modal-body p').text(content);
				$('#sweetModal').modal('show');
				$('#sweetModal .sureBtn').off('click').click(resolve);
				$('#sweetModal .cancelBtn').off('click').click(reject);
			})
			return confirmPromise;
		};
		$('#FormBClose').click(function () {
			$('#momowindow').modal('close');
		});
		$('#FormBYES').click(function () {
			var Flag = 'N';
			var UpperLimit = $('#UpperLimit').val();
			var TotalValue = $('#TotalValue').val();
			var ExceedValue = $('#ExceedValue').val();
			var hideCurJob = $('#hideCurJob').val();
			UpperLimit = nulReplace0(UpperLimit); UpperLimit = parseInt(UpperLimit, 10);
			TotalValue = nulReplace0(TotalValue); TotalValue = parseInt(TotalValue, 10);
			ExceedValue = nulReplace0(ExceedValue); ExceedValue = parseInt(ExceedValue, 10);

			var BillNo = $('#BillNo').val();
			var StaffName = sessionName;
			var StaffID = sessionOID;
			var Advstr = {
				"BillNo": BillNo, "UpperLimit": UpperLimit, "TotalValue": TotalValue, "ExceedValue": ExceedValue,
				"StaffName": StaffName, "StaffID": StaffID , "CurJob": hideCurJob
			};
			console.log("刀的B意义",Advstr);
			var message = '建立报销可使用金额，请确认操作是否无误？';
			if (ExceedValue !=undefined && ExceedValue !=null && ExceedValue !='') {
				if ( UpperLimit > ExceedValue ) {
				    Flag = 'Y';
			      }
			}else{
				if (TotalValue !=undefined && TotalValue !=null && TotalValue !='') {
					if ( UpperLimit > TotalValue ) {
					  Flag = 'Y';
					}else{
					  Flag = 'N';	
					}
			      }else{
					layer.msg('操作不成功', { icon: 1 });
					return ;
				}
			}
			if (Flag == 'Y') {
				var messYes = ' 金额不可超过！！请重新修改金额或再次进入追加预算审批程序';
				// layer.msg(messYes, { icon: 1 });
				ReConfirm("资讯", messYes).then(function () {
					console.log('再次进入费用审批');
					$('.console-show').text('Promise_resolve_confirm页面点击"确定"');
					var reportType = 'ClaimCreate';
					var arrange = 'exceedBud';
					var taskData = { "reportType": reportType, "arrange": arrange,  "pick": pick, "Advstr": Advstr };
					$.ajax({
						method: 'post',
						data: taskData,
						url: "/app/TMFinc/getRoute",
						success: function (data) {
							console.log("会好", JSON.stringify(data));
							if (data.status == 'Fail') {
								layer.msg("讯息" + data.message);
							} else if (data.status == 'OK') {
								layer.confirm("文号" + data.BillNo + "已重新审批" + (data.status), {
									btn: ['知道了']
								}, function () {
									layer.msg('操作成功', { icon: 1 });
									var DateB = $("#taskMakeDateB").val();
									var DateE = $("#taskMakeDateE").val();
									missAcute = $('#Pattern').val();
									missBcute = $('#CapMode').val();
									window.location.href = href+"?missT=" + missType + "&missA=" + missAcute + "&missB=" + missBcute + "&missS=" + SeaMode + "&missC=" + DateB + "&missD=" + DateE + " ";
								});
							}
						},
						error: function () {
						}
					})
				}, function () {
					console.log("取消被点击，返回之前的操作");
					$('.console-show').text('Promise_reject_confirm页面点击"取消"');
				})
			}
			if (Flag == 'N') {
				ReConfirm("警告", message).then(function () {
					console.log('确定被点击，执行后续操作');
					$('.console-show').text('Promise_resolve_confirm页面点击"确定"');
					var reportType = 'ClaimCreate';
					var arrange = 'beginInvoice';
					var taskData = { "reportType": reportType, "arrange": arrange,  "pick": pick, "Advstr": Advstr };
					$.ajax({
						method: 'post',
						data: taskData,
						url: "/app/TMFinc/getRoute",
						success: function (data) {
							console.log("会好", JSON.stringify(data));
							if (data.status == 'Fail') {
								layer.msg("讯息" + data.message);
							} else if (data.status == 'OK') {
								layer.confirm("文号" + data.BillNo + "已开始报销" + (data.status), {
									btn: ['知道了']
								}, function () {
									layer.msg('操作成功', { icon: 1 });
									var DateB = $("#taskMakeDateB").val();
									var DateE = $("#taskMakeDateE").val();
									missAcute = $('#Pattern').val();
									missBcute = $('#CapMode').val();
									window.location.href = href+"?missT=" + missType + "&missA=" + missAcute + "&missB=" + missBcute + "&missS=" + SeaMode + "&missC=" + DateB + "&missD=" + DateE + " ";
								});
							}
						},
						error: function () {
						}
					})
				}, function () {
					console.log("取消被点击，返回之前的操作");
					$('.console-show').text('Promise_reject_confirm页面点击"取消"');
				})
			}


		});
		$('#PrintConfirm').click(function () {
			Print('#listPrintViewDiv', {
				onStart: function () {
					console.log('onStart', new Date())
				},
				onEnd: function () {
					console.log('onEnd', new Date())
				}
			})
		});
		function nulReplace0(passTxt) {
			var ret = '';
			ret = (passTxt == null || passTxt == undefined || passTxt == '') ? ('0') : passTxt;
			return ret;
		}
	</script>