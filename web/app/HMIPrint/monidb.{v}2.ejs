<link rel="stylesheet" type="text/css" href="/css/HMI/HMIContent.css">
<script src="/js/HMIPrint/FileSaver.min.js"></script>
<script src="/js/HMIPrint/tableExport.js"></script>

<!-- 新 Bootstrap 核心 CSS 文件 -->
<link href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
 
<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>

<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="/DataTables/media/css/jquery.dataTables.css">
<!-- DataTables -->
<script type="text/javascript" charset="utf8" src="/DataTables/media/js/jquery.dataTables.js"></script>

<% layout(locals.global.theme_layout_dir+'/master.ejs') -%>

<div class="content">
    <h1>Moni 数据库维护</h1>
    <hr>
    <!--<button id="Add"  onclick="javascript:$('#win').window('open')">添加</button>-->
    <div class="lineitem">
        <button id="Add" class="easyui-linkbutton">添加</button>
        <button id="Upd" class="easyui-linkbutton">更新</button>
        <button id="Del" class="easyui-linkbutton">删除</button>
    </div>
    <table id="moniDBTable" class="moniDBTableStyle">
        <thead>
            <tr>
                <th>厂家</th>
                <th>控制</th>
                <th>机型</th>
                <th>保留0</th>
                <th>保留1</th>
                <th>保留2</th>
                <th>保留3</th>
                <th>保留4</th>
                <th>内容</th>
                <th>中文</th>
                <th>繁体</th>
                <th>英文</th>
                <th>精度</th>
                <th>可见</th>
            </tr>
        </thead>
    </table>
    <!-- 点击更新、添加按钮后弹出的窗口 -->
    <div id="win" class="easyui-window" title="DBinfo" closed="true" style="width:400px;height:450px;">
        <form style="padding:10px 20px 10px 40px;">
            <p>厂家: <input id="ManufacturerInput" size="30" type="text"></p>
            <p>控制: <input id="CtrlTypeInput" size="30" type="text"></p>
            <p>机型: <input id="MachTypeInput" size="30" type="text"></p>
            <p>保留0: <input id="Reserved0Input" size="30" type="text"></p>
            <p>保留1: <input id="Reserved1Input" size="30" type="text"></p>
            <p>保留2: <input id="Reserved2Input" size="30" type="text"></p>
            <p>保留3: <input id="Reserved3Input" size="30" type="text"></p>
            <p>保留4: <input id="Reserved4Input" size="30" type="text"></p>
            <p>内容: <input id="DDKeyInput" size="30" type="text"></p>
            <p>中文: <input id="CNInput" size="30" type="text"></p>
            <p>繁体: <input id="TWInput" size="30" type="text"></p>
            <p>英文: <input id="ENInput" size="30" type="text"></p>
            <p>精度: <input id="PrecInput" size="30" type="text"></p>
            <p>可见: <input id="VisbInput" size="30" type="text"></p>
            <div style="padding:5px;text-align:center;">
                <a id="AddDoButton"　href="#" class="easyui-linkbutton" icon="icon-ok">添加</a>
                <a id="UpdDoButton"　href="#" class="easyui-linkbutton" icon="icon-ok">更新</a>
                <a id="CancelButton" href="#" class="easyui-linkbutton" icon="icon-cancel">取消</a>
            </div>
        </form>
    </div>
</div>
<script>
// 构建moni数据结构
function moniData(UID, Manufacturer, Prec, CtrlType, MachType, DDKey, CN, TW, EN, Visb, Reserved0, Reserved1, Reserved2, Reserved3, Reserved4) {
    this.UID = UID;
    this.Manufacturer = Manufacturer;
    this.Prec = Prec;
    this.CtrlType = CtrlType;
    this.MachType = MachType;
    this.DDKey = DDKey;
    this.CN = CN;
    this.TW = TW;
    this.EN = EN;
    this.Visb = Visb;
    this.Reserved0 = Reserved0;
    this.Reserved1 = Reserved1;
    this.Reserved2 = Reserved2;
    this.Reserved3 = Reserved3;
    this.Reserved4 = Reserved4;

}

// 检查Form输入数据是否符号规范
function checkinput(Data) {

    if (Data.Prec == "") {
        alert("精度不能为空,请检查!");
        return false;
    }
    if (Data.Prec > 10) {
        alert("精度必须为小于10的整数,请检查!");
        return false;
    }

    if (Data.DDKey == "") {
        alert("内容不能为空,请检查!");
        return false;
    }
    if (Data.CN == "") {
        alert("中文不能为空,请检查!");
        return false;
    }

    if (Data.Visb == "") {
        alert("可见性不能为空,请检查!");
        return false;
    }
    if (Data.Visb != "0" && Data.Visb != "1") {
        alert("可见性只能输入0或1,0代表不可见,1代表可见!");
        return false;
    }

    return true;

}

//AJAX新增函数
function ajaxAdd(moniData) {
    $.ajax({
        method: 'post',
        url: '/app/HMIPrint/moniAdd',
        data: moniData,
        success: function(data, textStatus) {

            // alert("成功数据:" + JSON.stringify(data));

            if (data.affectedRows != 0) {
                alert("新增数据成功!");
                window.location.reload();
            }
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {
            alert('新增失败！失败原因：相同内容的数据已存在，请以更新的方式更新此数据！');
        }
    });
}
//ajax更新函数

function ajaxUpd(moniData) {

    $.ajax({
        method: 'post',
        url: '/app/HMIPrint/moniUpd',
        data: moniData,
        success: function(data, textStatus) {
            //      alert("成功数据:"+JSON.stringify(data));

            if (data.changedRows != 0) {
                alert("更新数据成功!");
                window.location.reload();
            } else {
                alert("未有数据更新!");
            }
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {

        }
    });
}

//ajax删除函数
function ajaxDel(UID) {
    $.ajax({
        method: 'post',
        url: '/app/HMIPrint/moniDel',
        data: UID,
        success: function(data, textStatus) {

            //  alert("成功数据:"+JSON.stringify(data));

            if (data.affectedRows != 0) {
                alert("删除数据成功!");
                window.location.reload();
            } else {
                alert("删除数据失败!");
            }
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {

        }
    });
}

//加载完成后执行程序
$(document).ready(function() {
    var oParsed = JSON.parse(sessionStorage.getItem("lastFormData")); // 当前页面缓存的Obj数据
    var oInput;
    // obj内无需缓存但仍需在第一次初始化的key
    var aIgnKey = [
        "PrecInput",
        "DDKeyInput",
        "CNInput",
        "TWInput",
        "ENInput",
        "VisbInput"
    ];
    if (oParsed) {
        oInput = oParsed;
    } else {
        oInput = {
            "ManufacturerInput": "STD",
            "PrecInput": 0,
            "CtrlTypeInput": "0000",
            "MachTypeInput": "00000000",
            "DDKeyInput": "",
            "CNInput": "",
            "TWInput": "",
            "ENInput": "",
            "VisbInput": 1,
            "Reserved0Input": "0",
            "Reserved1Input": "0",
            "Reserved2Input": "0",
            "Reserved3Input": "0",
            "Reserved4Input": "0"
        };
    }

    //加载数据表及数据----------
    $('#moniDBTable').DataTable({
        ajax: {
            url: '/app/HMIPrint/getMoniInfo',
            dataSrc: ''
        },
        columns: [
            { data: 'Manufacturer' },
            { data: 'CtrlType' },
            { data: 'MachType' },
            { data: 'Reserved0' },
            { data: 'Reserved1' },
            { data: 'Reserved2' },
            { data: 'Reserved3' },
            { data: 'Reserved4' },
            { data: 'DDKey' },
            { data: 'CN' },
            { data: 'TW' },
            { data: 'EN' },
            { data: 'Prec' },
            { data: 'Visb' }
        ]
    });


    //判断是否选中数据-------
    var table = $('#moniDBTable').DataTable();

    $('#moniDBTable tbody').on('click', 'tr', function() {
        if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
        } else {
            table.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
        }
    });


    // 添加按钮-----
    // Chenly 2018-10-31 加上默认值
    $('#Add').click(function() {
        $('#win').window('open');
        $('#AddDoButton').show();
        $('#UpdDoButton').hide();

        // $('#ManufacturerInput').val("STD");
        // $('#PrecInput').val("0");
        // $('#CtrlTypeInput').val("0000");
        // $('#MachTypeInput').val("00000000");
        // $('#DDKeyInput').val("");
        // $('#CNInput').val("");
        // $('#TWInput').val("");
        // $('#ENInput').val("");
        // $('#VisbInput').val("1");
        // $('#Reserved0Input').val("0");
        // $('#Reserved1Input').val("0");
        // $('#Reserved2Input').val("0");
        // $('#Reserved3Input').val("0");
        // $('#Reserved4Input').val("0");

        // 读取上一次提交表格内数据的值
        var inputNum = $("#win").find("input").length;
        for (var i = 0; i < inputNum; ++i) {
            var inputElem = $("#win").find("input").eq(i);
            var inputID = inputElem.attr("id");
            // console.log("#2", inputID);
            // mark，初始化的内容直接按照构造的数据来就行了
            if (oInput.hasOwnProperty(inputID) /*&& (aIgnKey.indexOf(inputID) === -1)*/ ) {
                var IDTmp = "#" + inputID; // id选择器要加个#
                $(IDTmp).val(oInput[inputID]); // inputElem.attr("value", oInput[objID]);
            }

        }
    });

    //更新按钮---------
    $('#Upd').click(function() {

        //alert("seclet: "+JSON.stringify(table.row('.selected').data()));
        // table.row('.selected').remove().draw( false );
        var dataSelect = table.row('.selected').data();

        if (dataSelect == undefined) {
            alert("当前未选择任何数据,请先点击需要更新的数据行!");
        } else {
            $('#win').window('open');
            $('#AddDoButton').hide();
            $('#UpdDoButton').show();
            $('#ManufacturerInput').val(dataSelect.Manufacturer);
            $('#PrecInput').val(dataSelect.Prec);
            $('#CtrlTypeInput').val(dataSelect.CtrlType);
            $('#MachTypeInput').val(dataSelect.MachType);
            $('#DDKeyInput').val(dataSelect.DDKey);
            $('#CNInput').val(dataSelect.CN);
            $('#TWInput').val(dataSelect.TW);
            $('#ENInput').val(dataSelect.EN);
            $('#VisbInput').val(dataSelect.Visb);
            $('#Reserved0Input').val(dataSelect.Reserved0);
            $('#Reserved1Input').val(dataSelect.Reserved1);
            $('#Reserved2Input').val(dataSelect.Reserved2);
            $('#Reserved3Input').val(dataSelect.Reserved3);
            $('#Reserved4Input').val(dataSelect.Reserved4);
        }


    });

    //删除按钮----------
    $('#Del').click(function() {
        var dataSelect = table.row('.selected').data();

        if (dataSelect == undefined) {
            alert("当前未选择任何数据,请先点击需要删除的数据行!");
        } else {
            var delDataMsg = confirm("风险操作！此行数据内容移除后无法还原，请确认操作是否无误！");
            if (delDataMsg === true) {
                var UID = { "UID": dataSelect.UID };
                // alert("UID:"+UID);
                ajaxDel(UID);
            }
        }


        //          table.row('.selected').remove().draw( false );//前端删除显示数据 ,数据库不删除
    });



    //form框添加按钮----------
    $('#AddDoButton').click(function() {
        var UID = "";
        // Chenly 2018-11-01 mark，将数组作为形参构造obj
        // var ManufacturerInput = $('#ManufacturerInput').val();
        // var PrecInput = $('#PrecInput').val();
        // var CtrlTypeInput = $('#CtrlTypeInput').val();
        // var MachTypeInput = $('#MachTypeInput').val();
        // var DDKeyInput = $('#DDKeyInput').val();
        // var CNInput = $('#CNInput').val();
        // var TWInput = $('#TWInput').val();
        // var ENInput = $('#ENInput').val();
        // var VisbInput = $('#VisbInput').val();
        // var Reserved0Input = $('#Reserved0Input').val();
        // var Reserved1Input = $('#Reserved1Input').val();
        // var Reserved2Input = $('#Reserved2Input').val();
        // var Reserved3Input = $('#Reserved3Input').val();
        // var Reserved4Input = $('#Reserved4Input').val();

        // var formData = new moniData(UID, ManufacturerInput, PrecInput, CtrlTypeInput, MachTypeInput, DDKeyInput, CNInput, TWInput, ENInput, VisbInput, Reserved0Input, Reserved1Input, Reserved2Input, Reserved3Input, Reserved4Input);

        // UID + form的数据 ==> 构造obj
        var aRemainVal = [];
        for (var key in oInput) {
            key = "#" + key;
            var nVal = $(key).val();
            aRemainVal.push(nVal);
        }
        var formData = new moniData(UID, ...aRemainVal);
        // alert("formData:" + JSON.stringify(formData));

        if (checkinput(formData)) {
            // 保存本次提交表格内数据的值至obj内，便于连续操作
            var inputNum = $("#win").find("input").length;
            for (var i = 0; i < inputNum; ++i) {
                var inputElem = $("#win").find("input").eq(i);
                var inputID = inputElem.attr("id");
                // console.log("#1", inputID);
                if (oInput.hasOwnProperty(inputID) && (aIgnKey.indexOf(inputID) === -1)) {
                    var IDTmp = "#" + inputID; // id选择器要加个#
                    oInput[inputID] = $(IDTmp).val();
                }
            }
            sessionStorage.setItem("lastFormData", JSON.stringify(oInput));

            ajaxAdd(formData);

        } else {
            //  alert("输入错误");

        }


    });
    //form 更新按钮

    $('#UpdDoButton').click(function() {

        var UID = table.row('.selected').data().UID;
        // Chenly 2018-11-01 mark，将数组作为形参构造obj
        // var ManufacturerInput = $('#ManufacturerInput').val();
        // var PrecInput = $('#PrecInput').val();
        // var CtrlTypeInput = $('#CtrlTypeInput').val();
        // var MachTypeInput = $('#MachTypeInput').val();
        // var DDKeyInput = $('#DDKeyInput').val();
        // var CNInput = $('#CNInput').val();
        // var TWInput = $('#TWInput').val();
        // var ENInput = $('#ENInput').val();
        // var VisbInput = $('#VisbInput').val();
        // var Reserved0Input = $('#Reserved0Input').val();
        // var Reserved1Input = $('#Reserved1Input').val();
        // var Reserved2Input = $('#Reserved2Input').val();
        // var Reserved3Input = $('#Reserved3Input').val();
        // var Reserved4Input = $('#Reserved4Input').val();

        // var formData = new moniData(UID, ManufacturerInput, PrecInput, CtrlTypeInput, MachTypeInput, DDKeyInput, CNInput, TWInput, ENInput, VisbInput, Reserved0Input, Reserved1Input, Reserved2Input, Reserved3Input, Reserved4Input);

        // UID + form的数据 ==> 构造obj
        var aRemainVal = [];
        for (var key in oInput) {
            key = "#" + key;
            var nVal = $(key).val();
            aRemainVal.push(nVal);
        }
        var formData = new moniData(UID, ...aRemainVal);

        //      alert("formData:"+JSON.stringify(formData));

        if (checkinput(formData)) {
            //  alert("输入正确");
            ajaxUpd(formData);

        } else {
            //  alert("输入错误");
        }

    });

    //form框 取消按钮

    $('#CancelButton').click(function() {
        $('#win').window('close');
    });


});


//function getdata(DDKey) {
//    $.ajax({
//        method: 'get',
//        data: { DDKey: DDKey },
//        url: "/app/HMIPrint/getMoniInfo", // Chenly 2018-10-15 加载此路径的文件，注：此文件类型为.{m}.js
//        success: function(data) {
//           alert(JSON.stringify(data));
//
//        },
//        error: function() {}
//    });
//
//}
//
//
//getdata();
</script>