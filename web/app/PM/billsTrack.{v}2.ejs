<!-- CSS -->
<link rel="stylesheet" type="text/css" href="/css/PM/PMContent.css">
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/Bootstrap-3.3.7/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/DataTables-1.10.18/css/dataTables.bootstrap.css">
<link href="/css/PM/datetimepicker/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
<link rel="stylesheet" href="/css/PM/bootstrap-select.min.css" />


<!-- JS  -->

<script src="/css/PM/DataTables/Bootstrap-3.3.7/js/bootstrap.min.js"></script>
<script src="/css/PM/bootstrap-select.min.js"></script>
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.min.js" charset="UTF-8"></script>
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>

<script type="text/javascript"  src="/css/PM/DataTables/DataTables-1.10.18/js/jquery.dataTables.min.js"></script>
<script type="text/javascript"  src="/css/PM/DataTables/DataTables-1.10.18/js/dataTables.bootstrap.min.js"></script>
<script src="/js/PM/FileSaver.min.js"></script>
<script src="/js/PM/tableExport.js"></script>
<script src="/js/PM/PMfuns.js"></script>




<% layout(locals.global.theme_layout_dir+'/master.ejs') -%>



<div class="divcontent">
    <h1>工作流程-进度跟踪</h1>
    <hr>

    <!-- 操作区（按钮等） -->
    <div class="lineitem">
        
     <!--   <button id="BTNInfo" class="btn btn-warning">详情</button> -->
        
        <!-- 按钮触发模态框 -->

        <button id="BTNInfo" class="btn btn-info" data-toggle="modal" >查看详情</button>
        <button id="BTNDelete" class="btn btn-danger" data-toggle="modal" >完结归档</button>
        <!-- 模态框（Modal） -->
        <div class="modal fade" id="BillPLD" tabindex="-1" role="dialog" aria-labelledby="BillPLDLabel" aria-hidden="true">
            <div class="modal-dialog" style="width:90%">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="BillPLDLabel">进度信息汇总</h4>
                    </div>
                    <div class="modal-body">

                    
                    
                    <div class="panel panel-info" style="width:60%;float:left">
                    
                    <!--------------panel--------------------->
                    <div class="panel-heading">
                        <h3 class="panel-title">计划单信息</h3>
                    </div>
                    <div class="panel-body">
                    <table class="table table-bordered">
                    <tr>
                      <td>&nbsp;</td>
                      <td colspan="3">&nbsp;</td>
                      <td>&nbsp;</td>
                      <td colspan="3">&nbsp;</td>
                    </tr>
                    <tr>
                      <td>&nbsp;</td>
                      <td colspan="7">&nbsp;</td>
                    </tr>
                   </table>
                    </div>
                    <!--------------panel--------------------->
                    <!--------------panel--------------------->
                    <div class="panel-heading">
                        <h3 class="panel-title">方案单信息</h3>
                    </div>
                    
                    <div class="panel-body">
                    
                    <table class="table table-bordered">
                    
                    <tr>
                      <td>&nbsp;</td>
                      <td colspan="3">&nbsp;</td>
                      <td>&nbsp;</td>
                      <td colspan="3">&nbsp;</td>
                    </tr>
                    <tr>
                      <td>&nbsp;</td>
                      <td colspan="7">&nbsp;</td>
                    </tr>
                    </table>
                    </div>
                    <!--------------panel--------------------->
                    </div>
                    
                    <div class="panel panel-info" style="width:39%;float:right">
                    
                    <!--------------panel--------------------->
                    <div class="panel-heading">
                        <h3 class="panel-title">计划单信息</h3>
                    </div>
                    <div class="panel-body">
                    <table class="table table-bordered">
                    <tr>
                      <td>&nbsp;</td>
                      <td colspan="3">&nbsp;</td>
                      <td>&nbsp;</td>
                      <td colspan="3">&nbsp;</td>
                    </tr>
                    <tr>
                      <td>&nbsp;</td>
                      <td colspan="7">&nbsp;</td>
                    </tr>
                   </table>
                    </div>
                    <!--------------panel--------------------->
                    <!--------------panel--------------------->
                    <div class="panel-heading">
                        <h3 class="panel-title">方案单信息</h3>
                    </div>
                    
                    <div class="panel-body">
                    
                    <table class="table table-bordered">
                    
                    <tr>
                      <td>&nbsp;</td>
                      <td colspan="3">&nbsp;</td>
                      <td>&nbsp;</td>
                      <td colspan="3">&nbsp;</td>
                    </tr>
                    <tr>
                      <td>&nbsp;</td>
                      <td colspan="7">&nbsp;</td>
                    </tr>
                    </table>
                    </div>
                    <!--------------panel--------------------->
                    </div>
                    
                    
                    
                    <!--------------清除float浮动 外部div自动展开--------------------->
                    <div style='clear:both'></div>

                    
                    
                    </div>
                    <div class="modal-footer">
                        <button id="BTNFormClose" type="button" class="btn btn-default" data-dismiss="modal">关闭</button>

                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>
        
        

    </div>
    
    
    
    
    <br/>

    <!--数据呈现区-->
    <table id="billsTrackTable" class="table table-striped table-bordered"  >
        <thead>
            <tr>
                <th>数据库ID</th>
                <th>计划单号</th>
                <th>版本号</th>
                <th>客户简称</th>
                <th>主题</th>
                <th>方案负责人</th>
                <th>进度状态</th>


            </tr>
        </thead>
    </table>
    


    
    
</div>


<script>



//函数:详情按钮详情页自动填写内容------------------------
function Fun_winDetailInit(dataSelect){
	
	$('#DBID').val(dataSelect.DBID); 
	$('#fileDBID').val(dataSelect.fileDBID); 
	
	console.log("fileDBID:"+dataSelect.fileDBID);
	
	$('#BPID').val(dataSelect.BPID); 
	$('#version').text(dataSelect.version); 
	
	var SQLCTRName={SQL:"SQLSRCustomers"};
	var CTRName="#CTRName";
	Fun_getSQLSelectDBData(SQLCTRName,CTRName,dataSelect.CTRName);
	
	var SQLMHEName={SQL:"SQLSRMachines"};
	var MHEName="#MHEName";
	Fun_getSQLSelectDBData(SQLMHEName,MHEName,dataSelect.MHEName);
	
	var SQLModel={SQL:"SQLSRSystems"};
	var model="#model";
	Fun_getSQLSelectDBData(SQLModel,model,dataSelect.model);
	
	var SQLPGEMaker={SQL:"SQLSRStaffs"};
	var PGEMaker="#PGEMaker";
	Fun_getSQLSelectDBData(SQLPGEMaker,PGEMaker,dataSelect.PGEMaker);

    
    $('#topic').val(dataSelect.topic); 
    $('#detail').val(dataSelect.detail); 
    
  
  $('.form_date').datetimepicker({
      language:  'zh-CN',
      weekStart: 1,
      todayBtn:  1,
		autoclose: 1,
		todayHighlight: 1,
		startView: 2,
		minView: 2,
		forceParse: 0
  });

  $('#divFilesUploaded').html("");
  
  if(dataSelect.fileKey!=null){
	  
	  console.log("不为空"+dataSelect.fileKey);
	  var downloadurl="<a id='filePath' href="+'/system.files.download/upload_'+dataSelect.fileKey+" download="+dataSelect.fileName+">"+"<span id='fileName'>"+dataSelect.fileName+"</span></a>";
	  $('#divFilesUploaded').html(downloadurl);
  }
  
  
  $('#applyDate').val(dataSelect.applyDate); 
  $('#limitDate').val(dataSelect.limitDate);
  $('#maker').val(dataSelect.maker);
  $('#makeDate').val(dataSelect.makeDate);
//  $('#auditor').val("<%-locals.session.yjUser.Name%>");
//  $('#auditDate').val(Ndate);
  
  
  $("#BTNFormAdd").hide();
  
  switch(dataSelect.urgency){
  case 1:
	  $("#urgencyOption1").attr("checked",true);
	  break;
  case 2:
	  $("#urgencyOption2").attr("checked",true);
	  break;
  case 3:
	  $("#urgencyOption3").attr("checked",true);
	  break;  
  }
  
  $('#auditResult').val(dataSelect.auditResult);

  //如果是已审核单据 则不显示更新和审核按钮
  if(dataSelect.auditDate==null){
	  

	  $("#BTNFormModify").show();
	  $("#BTNFormUpdate").hide();
	  $("#BTNFormAuditYes").show();
	  $("#BTNFormAuditNo").show();
	  
	  var SQLAuditor={SQL:"SQLSRStaffs"};
	  var auditor="#auditor";
	  
	  if(dataSelect.auditor==null){
		  
		  console.log("审核日期空,审核人空");
		  
		    $("#auditTypeOption2").attr("checked",true);	 
			Fun_getSQLSelectDBData(SQLAuditor,auditor);	   
		    $("#auditor").attr("disabled",true);
		    $('#auditDate').val("");

	  }else{
		  
		  console.log("审核日期空,审核人有");
		  
		    $("#auditTypeOption3").attr("checked",true);
		    Fun_getSQLSelectDBData(SQLAuditor,auditor,dataSelect.auditor);	   
		    $("#auditor").attr("disabled",true);
		    $('#auditDate').val("");
	  }
	  
	  
	
	  
  }else{ 
	  
	    
	    
	    var SQLAuditor={SQL:"SQLSRStaffs"};
	    var auditor="#auditor";
	    
	    $("#BPID").attr("disabled",true);
	  
	    $("#auditTypeOption1").attr("checked",true);
	    Fun_getSQLSelectDBData(SQLAuditor,auditor,dataSelect.auditor);	 
	    
	    $("#auditor").attr("disabled",true);
	    
	    $('#auditDate').val(dataSelect.auditDate);
	    
	    $("#BTNFormModify").hide();
	    $("#BTNFormUpdate").show();
	    $("#BTNFormAuditYes").hide();
	    $("#BTNFormAuditNo").hide();
	
	  
  }
  

 

}

//页面加载函数---------------
$(document).ready( function () {
	
	
	const tableSQL={"SQL":"SQLTableBillsTrack"};
	
	var sessionName="<%-locals.session.yjUser.Name%>";
	
	console.log("sessionName:"+sessionName);
	
	
	const tableInfo={
			"tableID":"#billsTrackTable",
			"columnsData":[
				{ data: 'DBID' ,"visible": false},
		        { data: 'BPID' },
		        { data: 'version'},
		        { data: 'CTRName'},
		        { data: 'topic'},
		        { data: 'PGEMaker'},
		        { data: 'WFStatusText'}
			]
	}
	
	
	Fun_showSQLTable(tableSQL,tableInfo)

	
//判断是否选中数据-------
var table = $('#billsTrackTable').DataTable();
$('#billsTrackTable tbody').on('click', 'tr', function() {
    if ($(this).hasClass('selected')) {
        $(this).removeClass('selected');
    } else {
        table.$('tr.selected').removeClass('selected');
        $(this).addClass('selected');
    }
 
    var dataSelect = table.row('.selected').data();
    
    

});
	







//详情按钮---------
$('#BTNInfo').click(function() {
    alert("seclet: "+JSON.stringify(table.row('.selected').data()));
    // table.row('.selected').remove().draw( false );
    var dataSelect = table.row('.selected').data();
    if (dataSelect == undefined) {
        alert("请先点击表格中的表单!");
    } else {
    	
    	
    	$('#BillPLD').modal('show')
    	Fun_winDetailInit(dataSelect);
    	

    }
});




//删除按钮----------
$('#BTNDelete').click(function() {
    var dataSelect = table.row('.selected').data();
    
 //   alert(JSON.stringify(dataSelect));
    
    if (dataSelect == undefined) {
        alert("当前未选择任何数据,请先点击需要删除的数据行!");
    } else {
    	
    	
    	if(dataSelect.auditDate!=null){
    		alert("已审核单据禁止删除!");
    	}else{
    		
    		
    		var msg1 = confirm("风险操作！此行数据内容移除后无法还原，请确认操作是否无误！");
            if (msg1 === true) {
                var msg2 = confirm("确认删除此行数据？");
                if (msg2 === true) {
                	
                //	alert(dataSelect.DBID);
                    var IDData = {"DBTable":"ppm_bills_plan","DBID":dataSelect.DBID};
 //                   alert("IDData:"+JSON.stringify(IDData));
                    delDBData(IDData);
                }
            }
    		
    		
    	}

    }
    //          table.row('.selected').remove().draw( false );//前端删除显示数据 ,数据库不删除
});



	
}); 

</script>
