<!-- CSS -->
<link rel="stylesheet" type="text/css" href="/css/PM/PMContent.css">
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/Bootstrap-3.3.7/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/DataTables-1.10.18/css/dataTables.bootstrap.css">
<link href="/css/PM/datetimepicker/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
<link rel="stylesheet" href="/css/PM/bootstrap-select.min.css" />


<!-- JS  -->

<script src="/css/PM/DataTables/Bootstrap-3.3.7/js/bootstrap.min.js"></script>
<script src="/css/PM/bootstrap-select.min.js"></script>
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.min.js" charset="UTF-8"></script>
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>

<script type="text/javascript"  src="/css/PM/DataTables/DataTables-1.10.18/js/jquery.dataTables.min.js"></script>
<script type="text/javascript"  src="/css/PM/DataTables/DataTables-1.10.18/js/dataTables.bootstrap.min.js"></script>
<script src="/js/PM/FileSaver.min.js"></script>
<script src="/js/PM/tableExport.js"></script>
<script src="/js/PM/PMfuns.js"></script>




<% layout(locals.global.theme_layout_dir+'/master.ejs') -%>



<div class="divcontent">
    <h1>内核工作流程-T发布单</h1>
    <hr>

    <!-- 操作区（按钮等） -->
    <div class="lineitem">


        <!-- 按钮触发模态框 -->
        <button id="BTNPBHDetail" class="btn btn-primary" data-toggle="modal" >发布维护</button>

        <!-- 模态框（Modal） -->
        <div class="modal fade" id="BillPLD" tabindex="-1" role="dialog" aria-labelledby="BillPLDLabel" aria-hidden="true">
            <div class="modal-dialog" style="width:75%">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="BillPLDLabel">发布面板</h4>
                    </div>
                    <div class="modal-body">

                    <div class="panel panel-info">

                    <div class="panel-heading">
                        <h3 class="panel-title">计划单信息</h3>
                    </div>

                    <div class="panel-body">




                    <div class="form-horizontal" >

                    <input id="DBID" type="text" value="" style="display:none;">
                    <input id="auditResult" type="text" value="" style="display:none;">
                    
                    <!-------------------------------------------------------------------------->
                    <div class="form-group">
                      <label class="col-sm-1 control-label">来源任务单号:</label>
                      <div class="col-sm-2">
                        <span id="BTIDfrom" class="help-block"></span>
                      </div>
                      
                      <label class="col-sm-1 control-label">来源计划单号:</label>
                      <div class="col-sm-2">
                        <span id="BPIDfrom" class="help-block"></span>
                      </div>
                      
                    </div>


                    <!-------------------------------------------------------------------------->
                     <div class="form-group">
                       <label class="col-sm-1 control-label">计划单号:</label>
                       <div class="col-sm-2">
                         <span id="BPID" class="help-block"></span>
                       </div>

                       <label class="col-sm-1 control-label">计划版本号:</label>
                       <div class="col-sm-1">
                       <span id="version" class="help-block"></span>
                       </div>

                       <label  class="col-sm-1 control-label" for="name">客户:</label>
                       <div class="col-sm-1 ">
                       <span id="PBHCTRName" class="help-block"></span>
                       </div>


                       <label  class="col-sm-1 control-label" for="name">机型:</label>
                       <div class="col-sm-1 ">
                       <span id="MHEName" class="help-block"></span>
                       </div>


                       <label  class="col-sm-1 control-label" for="name">系统:</label>
                       <div class="col-sm-1 ">
                       <span id="model" class="help-block"></span>
                       </div>





                     </div>




                     <!-------------------------------------------------------------------------->
                     <div class="form-group">

                     <label for="applyDate" class="col-sm-1 control-label">申请日期:</label>
                     <div class="col-sm-1 ">
                     <span id="applyDate" class="help-block"></span>
                 	 </div>


                     <label for="limitDate" class="col-sm-1 control-label">完成期限:</label>
                     <div class="col-sm-2 ">
                     <span id="limitDate" class="help-block"></span>
                 	 </div>


                 	<label  class="col-sm-1 control-label" for="name">方案负责人:</label>
                    <div class="col-sm-1 ">
                    <span id="PGEMaker" class="help-block"></span>
                    </div>
                    
                    <label  class="col-sm-1 control-label" for="name">FQC需求:</label>
                    <div class="col-sm-1 ">
                    <span id="FQCRequestText" class="help-block"></span>
                    </div>
                    
                    <label  class="col-sm-1 control-label" for="name">FQC结果:</label>
                    <div class="col-sm-1 ">
                    <span id="FQCPassText" class="help-block"></span>
                    </div>


                 	 </div>




                     <!-------------------------------------------------------------------------->

                     <div class="form-group">
                     <label class="col-sm-1 control-label">修改主题:</label>
                     <div class="col-sm-8">
                     <span id="topic" class="help-block"></span>
                     </div>
                     </div>

                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     <label  class="col-sm-1 control-label" for="name">修改要求:</label>
                     <div class="col-sm-8">
                     <span id="detail" class="help-block"></span>
                     </div>
                     </div>





                     <!-------------------------------------------------------------------------->

                     </div>
                    </div>
                   </div>
                   <!--panel------------------------------------------------------------------------>

                   <div class="panel panel-default">
                   <div class="panel-heading">任务清单</div>

                   <div style="margin:10px;">
                	 <table id="billsTaskTable" class="table table-bordered" style="width:100%;" >
                   <thead>
                   </thead>
                   <tbody>
                   </tbody>
                   </table>
                   </div>

                   </div>

                   <!--panel------------------------------------------------------------------------>
                   <div class="panel panel-success">
                   <div class="panel-heading">
                       <h3 class="panel-title">发布记录</h3>
                   </div>
                   <div class="panel-body">


                   <div class="form-horizontal" >
                   
                   <!-------------------------------------------------------------------------->
                   <div class="form-group">
                   <label class="col-sm-1 control-label">收件人:</label>
                   <div class="col-sm-10">
                     <input id="emailADRS" class="form-control"  type="text" value="">
                   </div>
                   </div>
                   <!-------------------------------------------------------------------------->
                   <div class="form-group">
                   <label class="col-sm-1 control-label">抄送:</label>
                   <div class="col-sm-10">
                     <input id="emailCopyADRS" class="form-control"  type="text" value="">
                   </div>
                   </div>
                   <!-------------------------------------------------------------------------->
                   <div class="form-group">
                   <label class="col-sm-1 control-label">主题:</label>
                   <div class="col-sm-10">
                     <input id="emailTitle" class="form-control"  type="text" value="">
                   </div>
                   </div>
                 
               	
               	<!-------------------------------------------------------------------------->
               	 <div class="form-group">
               	<label  class="col-sm-1 control-label" for="name">附件:</label>
               	
               	<div class="col-sm-8">

               	
               	<div id="div_previewImages"></div>
                  <div id="progressNumber"></div> 
                
                  <div id="divFilesUploaded"></div>
                  
               	</div>
               	
               	
               	</div>
               	
               	<!-------------------------------------------------------------------------->
                   <!-------------------------------------------------------------------------->
                   <div class="form-group">
                   <label class="col-sm-1 control-label">邮件内容:</label>
                   <div class="col-sm-10">
                   <textarea id="emailContent" class="form-control" rows="6"></textarea>

                   </div>
                   </div>
                   <!-------------------------------------------------------------------------->

                   <div class="form-group">
                   <label class="col-sm-1 control-label">备注:</label>
                   <div class="col-sm-10">

                   <input id="PBHRemark" class="form-control"  type="text" value="">
                   </div>
                   </div>

                  


               	<!-------------------------------------------------------------------------->
                <div class="form-group" >

                <label  class="col-sm-1 control-label" for="name">发布制单人:</label>
                <div class="col-sm-2">
                <span id="PBHMaker" class="help-block"></span>
                </div>

                <label class="col-sm-1 control-label"></label>
                <label for="PBHMakeDate" class="col-sm-2 control-label">发布制单日期:</label>
                <div class="col-sm-2">
                <span id="PBHMakeDate" class="help-block"></span>
            	 </div>
            	 
            	 <label class="col-sm-1 control-label">发布版本号:</label>
                 <div class="col-sm-1">
                 <span id="PBHVersion" class="help-block"></span>
                 </div>


                </div>

                <!-------------------------------------------------------------------------->
                    <div class="form-group" id="DivPBHAuditInfo">

                    <label  class="col-sm-1 control-label" for="name">发布审核人:</label>
                    <div class="col-sm-2">
                    <select  id="PBHAuditor" class="selectpicker" data-live-search="true">
                    </select>
                    </div>

                    <label class="col-sm-1 control-label"></label>
                    <label for="recordAuditDate" class="col-sm-2 control-label">发布审核日期:</label>
                    <div class="col-sm-2">
                    <span id="PBHAuditDate" class="help-block"></span>
                	 </div>

                	<label class="col-sm-1 control-label">发布结果:</label>
                    <div class="col-sm-1">
                    <span id="PBHResultText" class="help-block"></span>
                    </div>

                    </div>
                    <!-------------------------------------------------------------------------->



               	    <div class="form-group" id="DivToolBTNS">
                    <label class="col-sm-1 control-label">工具:</label>
                    <div class="col-sm-10">
                    <button id="BTNGetInfo" class="btn btn-success" data-toggle="modal" >填入系统信息</button>
                    <button id="BTNResetInfo" class="btn btn-warning" data-toggle="modal" >清空信息</button>
                   
                    </div>
                    </div>

                    <!-------------------------------------------------------------------------->



               	    <div class="form-group" id="DivPBHBTNS">
                    <label class="col-sm-1 control-label">登记:</label>
                    <div class="col-sm-10">
                    <button id="BTNPBHSave" class="btn btn-success" data-toggle="modal" >保存发布信息</button>
                    <button id="BTNPBHAudit" class="btn btn-warning" data-toggle="modal" >审核发布信息</button>
                   
                    </div>
                    </div>
                    
                    <!-------------------------------------------------------------------------->
                    


                    <!----T发布单 邮件模块注释
               	    <div class="form-group" id="DivPBHBTNS" >
                    <label class="col-sm-1 control-label">邮件:</label>
                    <div class="col-sm-10">
                    <button id="BTNModelEmail" class="btn btn-default" data-toggle="modal" >系统邮件</button>
                    <a id="mailhref"><button id="BTNSendEmailDiv" class="btn btn-default" data-toggle="modal" >自定义邮件</button></a>
                    </div>
                    </div>
                    
                    -->
                    <!-------------------------------------------------------------------------->



                   </div>



                   </div>
                   </div>
                   <!--panel------------------------------------------------------------------------>
                   
                   <button id="BTNUpdVer" class="btn btn-danger" data-toggle="modal" >更新版本</button>




                    </div>
                    <div class="modal-footer">
                        <button id="BTNFormClose" type="button" class="btn btn-default" data-dismiss="modal">关闭</button>

                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>



    </div>




    <br/>

    <!--数据呈现区-->
    <table id="billsPLDTable" class="table table-striped table-bordered"  >
        <thead>
            <tr>
                <th>数据库ID</th>
                <th>计划单号</th>
                <th>计划版本号</th>
                <th>客户简称</th>
                <th>完成期限</th>
                <th>任务数量</th>
                <th>任务完结数量</th>
                <th>流程状态</th>
                <th>发布结果</th>
            </tr>
        </thead>
    </table>



    <!-- 点击更新、添加按钮后弹出的窗口 -->
    <div id="winEmail" class="easyui-window" title="表单详情" closed="true" style="width:80%;height:800px;">

    <div class="divcontent">

	<h3>邮件预览</h3>
	<hr>
	
	<div class="form-horizontal" id="DivEmailModel">
	 <!-------------------------------------------------------------------------->
     <div class="form-group">
     <label class="col-sm-1 control-label">收件人:</label>
     <div class="col-sm-10">
     <span id="emailADRSModel" class="help-block"></span>

     </div>
     </div>
     <!-------------------------------------------------------------------------->
     <div class="form-group">
     <label class="col-sm-1 control-label">抄送:</label>
     <div class="col-sm-10">
     <span id="emailCopyADRSModel" class="help-block"></span>

     </div>
     </div>
     <!-------------------------------------------------------------------------->
     <div class="form-group">
     <label class="col-sm-1 control-label">主题:</label>
     <div class="col-sm-10">
     <span id="emailTitleModel" class="help-block"></span>

     </div>
     </div>
     <!-------------------------------------------------------------------------->
     <div class="form-group">
     <label class="col-sm-1 control-label">附件:</label>
     <div class="col-sm-10">
     <span id="emailFilesModel" class="help-block"></span>
     
     </div>
     </div>

     <!-------------------------------------------------------------------------->
     <div class="form-group">
     <label class="col-sm-1 control-label">邮件内容:</label>
     <div class="col-sm-10">
     <div id="emailContentModel" class="help-block" style="white-space:pre;"></div>


     </div>
     </div>
     <!-------------------------------------------------------------------------->
     
     <div class="form-group" >
     <label class="col-sm-1 control-label"></label>
     <div class="col-sm-10">
     <button id="BTNModelEmailSend" class="btn btn-default" data-toggle="modal" >发送邮件</button>

     </div>
     </div>
     <!-------------------------------------------------------------------------->
     
     <div >
	
     </div>




    </div>
    <!-- 点击更新、添加按钮后弹出的窗口 -->


</div>


<script>
//函数-根据自定义SQL获取数据加载Task表格,不显示搜索分页,简易模式

//
//function Fun_showSQLFileTable(SQL,tableID){
//
//	//alert(JSON.stringify(DataPara));
//
//	 $.ajax({
//         method:'get',
//         data:SQL,
//         url:"/app/PM/getSQLDBData",
//         success:function(data){
//        	// console.log("back Task data:"+JSON.stringify(data));
//
//        	 for(var i=0;i<data.length;i++){
//
//        		 var tr="<tr>" +
//        		 		"<td>"+data[i].BTID+"</td><td>"+data[i].BTVersion+"</td><td>"+data[i].taskTypeText+"</td>" +
//        		 		"<td>"+data[i].taskStaff+"</td><td>"+data[i].taskDBE+"</td><td id='modifyContent"+i+"'>"+data[i].modifyContent+"</td>" +
//        		 		"<td id='TDfile"+i+"'><a id='hrefA"+i+"'  href='/system.files.download/upload_"+data[i].taskFileKey+"' download="+data[i].taskFileName+"><span id='fileName"+i+"'>"+data[i].taskFileName+"</span></a></td>"
//        		 		"</tr>";
//
//        		 $(tableID+" tbody").append(tr);
//
//        	 }
//
//         },
//         error:function(){}
//     })
//
//}


//检查输入项
function checkPBHInput(){
	
	if($("#emailADRS").val()==""){
		alert("收件人邮箱未填写,请检查!");
		return false;
	}else if($("#emailContent").val()==null){
		alert("邮件内容未填写,请检查!");
		return false;
	}
	

	return true;
	
}




//函数:详情按钮详情页自动填写内容------------------------
function Fun_winDetailInit(dataSelect){
	
	console.log("dataSelect1111:"+JSON.stringify(dataSelect));

	$('#DBID').val(dataSelect.DBID);
	

	$('#BTIDfrom').text(dataSelect.BTIDfrom);
	$('#BPIDfrom').text(dataSelect.BPIDfrom);
	$('#BPID').text(dataSelect.BPID);
	$('#version').text(dataSelect.version);
	$('#PBHCTRName').text(dataSelect.PLDCTRName);
	$('#MHEName').text(dataSelect.MHEName);
	$('#model').text(dataSelect.model);
	$('#PGEMaker').text(dataSelect.PGEMaker);
	$('#FQCRequestText').text(dataSelect.FQCRequestText);
	$('#FQCPassText').text(dataSelect.FQCPassText);
	$('#applyDate').text(dataSelect.applyDate);
	$('#limitDate').text(dataSelect.limitDate);
	$('#topic').text(dataSelect.topic);
	$('#detail').text(dataSelect.detail);
	
//	tasksTableSQL={"SQL":"SQLTableBillsTask","filter":"taskBPID = '"+dataSelect.BPID+"'"};
//	var tableID="#billsTaskTable";
//	Fun_showSQLFileTable(tasksTableSQL,tableID);
	
	//加载任务表内容, 
	var SQLParamTask={
			"tableName":"ppm_bills_task_t",
			"titles":[
				"BTID",
				"BTVersion",
				"taskStaff",
				"taskTypeText",
				"taskLimitDate",
				"modifyContent",
				"functionsDBE",
				"taskFiles"
				],
			"filter":"taskBPID='"+dataSelect.BPID+"'",
			"BID":"BTID",
			"VER":"BTVersion"
			};
	
	
	
	Fun_fillTrackTable("#billsTaskTable",SQLParamTask);
	
	
	$('#emailADRS').val(dataSelect.emailADRS);
	$('#emailCopyADRS').val(dataSelect.emailCopyADRS);

	$('#emailTitle').val(dataSelect.emailTitle);
	
//    var emailFiles=JSON.parse(dataSelect.emailFiles);
//    
//    var emailFilesHtml=$('#emailFiles').html();
//    
//   console.log("emailFiles:"+emailFiles);
   
//   if(emailFiles!=null){
//	   for(var i=0;i<emailFiles.length;i++){
//	    	 $("#emailFiles").html(emailFilesHtml+"<a href='/system.files.download/upload_"+emailFiles[i].fileKey+"' download='"+emailFiles[i].fileName+"'>"+emailFiles[i].fileName+"</a>");
//	    	 
//	    	 emailFilesHtml=$("#emailFiles").html()+" ; ";
//
//	    }
//   }
//    
//   emailFilesValue=emailFiles;
   
   if(dataSelect.files!=null){
		  
		  var files=JSON.parse(dataSelect.files);
		  if(files!=null){
			  
			  var fileLink="";
				 if(files.length>0){
					 for(var i=0;i<files.length;i++){
						 console.log("files[i].fileName:"+files[i].fileName);
						 
						fileLink=fileLink+"<a  href="+'/system.files.download/upload_'+files[i].fileKey+" download="+files[i].fileName+">"+"<span>"+files[i].fileName+"</span></a>"+" ; ";
					 } 
					 
					 fileLink=fileLink.substr(0, fileLink.length-3); 
				 }
		  var downloadurl=fileLink;
		  }else{
			  downloadurl="";
		  }
		  $('#divFilesUploaded').html(downloadurl);
	  }

	
	$('#emailContent').val(dataSelect.emailContent);
	$('#PBHRemark').val(dataSelect.PBHRemark);
	
	$('#PBHMaker').text(dataSelect.PBHMaker);
	$('#PBHMakeDate').text(dataSelect.PBHMakeDate);	
	$('#PBHVersion').text(dataSelect.PBHVersion);	
	$('#PBHAuditor').text(dataSelect.PBHAuditor);
	$('#PBHAuditDate').text(dataSelect.PBHAuditDate);
	$('#PBHResultText').text(dataSelect.PBHResultText);
	
	
	var SQLAuditor={SQL:"SQLSRStaffs"};
	var PBHAuditor="#PBHAuditor";
	Fun_getSQLSelectDBData(SQLAuditor,PBHAuditor,sessionName);


	

	if(dataSelect.PBHAuditResult==0||dataSelect.PBHAuditResult==null){
		$("#DivFileBTNS").show();
		$('#DivToolBTNS').show();
		$('#DivPBHBTNS').show();
		$("#PBHAuditor").attr("disabled",false);
		$('#BTNUpdVer').hide();
		
	}else{
		
		$('input').attr("disabled",true);
		$('select').attr("disabled",true);
		$('textarea').attr("disabled",true);
		
		$("#DivFileBTNS").hide();
		$('#DivToolBTNS').hide();
		$('#DivPBHBTNS').hide();
		$("#PBHAuditor").attr("disabled",true);
		$('#BTNUpdVer').show();
		
	}

}

//页面加载函数---------------
$(document).ready( function () {




	 sessionName="<%-locals.session.yjUser.Name%>";

	 var undone=getQueryString("undone");
		
		if(undone=="true"){
			var tableSQL={"SQL":"SQLTableBillsPBH_T","filter":" (PGEMaker = '"+sessionName+"' OR PBHMaker = '"+sessionName+"'  OR PBHAuditor = '"+sessionName+"') AND ( PBHStatus IS NULL OR PBHStatus =0)"};
		}else{
			var tableSQL={"SQL":"SQLTableBillsPBH_T"};
		}


	 tableInfo={
			"tableID":"#billsPLDTable",
			"columnsData":[
				{ data: 'DBID' ,"visible": false},
		        { data: 'BPID' },
		        { data: 'version'},
		        { data: 'PLDCTRName'},
		        { data: 'limitDate'},
		        { data: 'taskNum'},
		        { data: 'taskNumDone'},
		        { data: 'WFStatusText'},
		        { data: 'PBHStatusText'}
			]
	}


	Fun_showSQLTable(tableSQL,tableInfo);



//判断是否选中数据-------
var table = $('#billsPLDTable').DataTable();
$('#billsPLDTable tbody').on('click', 'tr', function() {
    if ($(this).hasClass('selected')) {
        $(this).removeClass('selected');
    } else {
        table.$('tr.selected').removeClass('selected');
        $(this).addClass('selected');
    }

    var dataSelect = table.row('.selected').data();


});


//按钮-发布维护---------
$('#BTNPBHDetail').click(function() {

	console.log("seclet: "+JSON.stringify(table.row('.selected').data()));
    // table.row('.selected').remove().draw( false );
    var dataSelect = table.row('.selected').data();
    if (dataSelect == undefined) {
        alert("请先点击表格中的表单!");
    } else {

    	$('#BillPLD').modal('show')
    	Fun_winDetailInit(dataSelect);

    }


});

//按钮-填入系统信息

$('#BTNGetInfo').click(function() {
	
	$('#BTNResetInfo').click();
var PBHCTRName= $("#PBHCTRName").text();
$("#emailTitle").val("【弘讯PPM处理结果】"+ $("#topic").text());

var fileNum=$("#billsTaskTable tbody").find("tr").length;
console.log("fileNum:"+fileNum);

var filesHtml=$("#divFilesUploaded").html();
//emailFilesValue=[];
//console.log("emailFiles:"+emailFiles);
	
	SQLEMails={"SQL":"SQLGetEMails","filter":"FTYName = '"+PBHCTRName+"'"};
	 $.ajax({
         method:'get',
         data:SQLEMails,
         url:"/app/PM/getSQLDBData",
         success:function(data){
        	 console.log("back email data:"+JSON.stringify(data));
        	 
        	 
        	 $("#emailADRS").val(data[0].email);
        	 
        	// alert(JSON.stringify(getEmails(data[0].contacts)));
        	 
        	 $("#emailCopyADRS").val(getEmails(data[0].contacts));
        	 
             emailContentFormat="Dear "+data[0].contact+":\n        您的需求已处理完成,需求单编号:"+$("#BPID").text()+";\n";
             
             var filesHtml="";
             
             var emailModifyContent="";
             
             var emailFunctionsDBE="";
             
             for(var i=0;i<fileNum;i++){
            	 
            	 var tdFiles=$("#billsTaskTable tbody tr:eq("+i+") td:last").html();

            	 if(tdFiles!=""){
            		 
            		 filesHtml=filesHtml+tdFiles+" ; ";
            		 
            		 emailModifyContent=emailModifyContent+$("#billsTaskTable tbody tr:eq("+i+") td:eq(5)").html()+"\n";
            		 
            		 emailFunctionsDBE=emailFunctionsDBE+$("#billsTaskTable tbody tr:eq("+i+") td:eq(6)").html()+"\n";
            		 
            	 }
        	 }
             
             console.log("filesHtml:"+JSON.stringify(filesHtml));

             if(filesHtml!=""){
            	 filesHtml=filesHtml.substr(0, filesHtml.length-3);
            	 $("#divFilesUploaded").html(filesHtml);
             }
             
             
             
             
             var ibtn="<button  class='btn btn-default btn-xs'>×</button>";
             $("#divFilesUploaded").find("a").after(ibtn);

             $("#divFilesUploaded :button").on('click',function() {
            	 
            	 $(this).prev("a").remove();
            	 $(this).prev("span").remove();

            	 $(this).remove();

             })

             $("#emailContent").val(emailContentFormat+"修改内容:\n"+emailModifyContent+"功能说明:\n"+emailFunctionsDBE);

         },
         error:function(){}
     })

});


//按钮-清空信息
$('#BTNResetInfo').click(function() {
	$("#emailADRS").val("");
	$("#emailCopyADRS").val("");
	$("#emailTitle").val("");
	$("#divFilesUploaded").text("");
	$("#emailContent").val("");
	$("#PBHRemark").val("");

});



//按钮-PBH保存---------
$('#BTNPBHSave').click(function() {
	
	
	
	
   var files=[];
	
	$('#divFilesUploaded a').each(function(){
		var fileKey=$(this).attr('href').substring(30);
		var fileName=$(this).attr('download');
		
		var fileInfo={
				"fileName":fileName,
				"fileKey":fileKey
		}
		
		files.push(fileInfo);
	});

		 var PBHData={
					"DBTable":"ppm_bills_PBH_t",
					"DBID":$('#DBID').val(),
					"PBHBPID":$('#BPID').text(),
					"PBHCTRName":$('#PBHCTRName').text(),
					"emailADRS":$('#emailADRS').val(),
					"emailCopyADRS":$('#emailCopyADRS').val(),
					"emailTitle":$('#emailTitle').val(),
//					"files":JSON.stringify(filesValue),
					"files":JSON.stringify(files),
					"emailContent":$('#emailContent').val(),
					"PBHRemark":$('#PBHRemark').val(),
					"PBHMaker":sessionName,
					"PBHMakeDate":Ndate,
					"PBHAuditor":$('#PBHAuditor option:selected').text()
			}

	saveDBData(PBHData,"PBH单");

});



//按钮-PBH审核---------
$('#BTNPBHAudit').click(function() {
	
    var files=[];
	
	$('#divFilesUploaded a').each(function(){
		var fileKey=$(this).attr('href').substring(30);
		var fileName=$(this).attr('download');
		
		var fileInfo={
				"fileName":fileName,
				"fileKey":fileKey
		}
		files.push(fileInfo);
	});

	var fileNum=$("#billsTaskTable tbody").find("tr").length;
	
	var modifyContent="";
    
    var functionsDBE="";
    
    for(var i=0;i<fileNum;i++){
   	 
   	var tdFiles=$("#billsTaskTable tbody tr:eq("+i+") td:last").html();

   	 if(tdFiles!=""){
   		 
   		modifyContent=modifyContent+$("#billsTaskTable tbody tr:eq("+i+") td:eq(5)").html()+"\n";
   		 
   		functionsDBE=functionsDBE+$("#billsTaskTable tbody tr:eq("+i+") td:eq(6)").html()+"\n";
   		 
   	     }
	 }
	

		 var PBHData={
					"DBTable":"ppm_bills_PBH_t",
					"DBID":$('#DBID').val(),
					"PBHAuditor":sessionName,
					"PBHAuditDate":Ndate,
					"PBHAuditResult":1,
					"PBHStatus":1,
					"PBHStatusText":"已发布"
			}
		 
		 
		 var ajax1=$.ajax({
		        method: 'post',
		        url: '/app/PM/updDBData',
		        data: PBHData,
		        success: function(data, textStatus) {
		        },
		        error: function(XMLHttpRequest, textStatus, errorThrown) {}
		        });
		 

		 var taskFromData={
				 "DBTable":"ppm_bills_task",
				 "BillIDName":"BTID",
				 "BillID":$("#BTIDfrom").text(),
				 "BTStatus":3,
				 "BTStatusText":"任务完成",
				 "modifyContent":modifyContent,
				 "functionsDBE":functionsDBE,
				 "taskFiles":JSON.stringify(files)
		 }
		 
		 var ajax2=$.ajax({
		        method: 'post',
		        url: '/app/PM/updBillStatus',
		        data: taskFromData,
		        success: function(data, textStatus) {
		        },
		        error: function(XMLHttpRequest, textStatus, errorThrown) {}
		        });
		 
		 
		 var PLDFromData={
				 "DBTable":"ppm_bills_plan",
				 "BillIDName":"BPID",
				 "BillID":$("#BPIDfrom").text(),
				 "TaskNumDone":1,
				 "WFStatus":30
		 }
		 
		 var ajax3=$.ajax({
		        method: 'post',
		        url: '/app/PM/updBillStatus',
		        data: PLDFromData,
		        success: function(data, textStatus) {
		        },
		        error: function(XMLHttpRequest, textStatus, errorThrown) {}
		        });

		$.when(ajax1,ajax2).done(function(){
				alert("发布单已审核,来源任务单已回填,该内核任务完结!");
			window.location.reload();
			
		});
		 

});


//radio 定义更换按键触发事件-----------
$('input:radio[name="auditType"]').click(function(){

	  var PGEMaker=$('#PGEMaker').children('option:selected').text();
	  console.log("PGEMaker:"+PGEMaker);
	  var radioValue = $('input:radio[name="auditType"]:checked').val();
	     switch(radioValue){
	 	case "1":
	 		var SQLAuditor={SQL:"SQLSRStaffs"};
	 		var auditor="#auditor";
	 		Fun_getSQLSelectDBData(SQLAuditor,auditor,PGEMaker);
	 	    $("#auditor").attr("disabled",true);
	 	    $('#auditDate').val("");
     	    $('#auditResult').val("");
	 	    break;
	 	case "2":

	 	    var SQLAuditor={SQL:"SQLSRStaffs"};
	 		var auditor="#auditor";
	 		Fun_getSQLSelectDBData(SQLAuditor,auditor);
	 	    $("#auditor").attr("disabled",false);
	 	    $('#auditDate').val("");
	 	    $('#auditResult').val("");
	 	    break;
	 	}

});

//按钮-邮件预览
$('#BTNModelEmail').click(function() {
	
	$('#winEmail').window('open');
	
	$('#emailADRSModel').text($('#emailADRS').val());
	$('#emailCopyADRSModel').text($('#emailCopyADRS').val());
	$('#emailTitleModel').text($('#emailTitle').val());
	$('#emailFilesModel').text($('#divFilesUploaded').text());
	
	
	
	$('#emailContentModel').html($('#emailContent').val());
	

	

	     


   
});

//按钮-发送邮件

$('#BTNModelEmailSend').click(function() {
	
	
    var files=[];
	
	$('#divFilesUploaded a').each(function(){
		var fileKey=$(this).attr('href').substring(30);
		var fileName=$(this).attr('download');
		
		var fileInfo={
				"fileName":fileName,
				"fileKey":fileKey
		}
		
		files.push(fileInfo);
	});
	
	 var emailData={
			    "pbhBPID":$('#BPID').text(),
			    "emailResult":1,
				"emailADRS":$('#emailADRS').val(),
				"emailCopyADRS":$('#emailCopyADRS').val(),
				"emailTitle":$('#emailTitle').val(),
				"emailFiles":JSON.stringify(files),
				"emailContent":$('#emailContent').val(),
				"PBHStatus":1

		}

	$.ajax({
        method: 'post',
        url: '/app/PM/sendSYSMail',
        data: emailData,
        success: function(data, textStatus) {
              alert("发送成功:"+JSON.stringify(textStatus));

        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {
        	
        	 alert("发送失败:"+JSON.stringify(textStatus));
        }
    });
   
});


//按钮-邮件自定义
$('#BTNSendEmailDiv').click(function() {
	
	var msg = confirm("点击自定义邮件后,讲跳转至邮件客户端,发布单默认邮件已发送,是否继续?");
	if(msg==true){	
	
	
	var emailData={
		    "pbhBPID":$('#BPID').text(),
		    "emailResult":2,
		    "PBHStatus":2
			
	}

   $.ajax({
    method: 'post',
    url: '/app/PM/sendSYSMail',
    data: emailData,
    success: function(data, textStatus) {

    },
    error: function(XMLHttpRequest, textStatus, errorThrown) {

    }
    });
	
	
	$('#mailhref').attr("href","mailto:"+$('#emailADRS').val()+"?subject="+$('#emailTitle').val()+"&cc="+$('#emailCopyADRS').val()+"&body="+$('#emailContent').val());
	$('#mailhref').click();
	
	}
   
});

//按钮-更新版本

$('#BTNUpdVer').click(function() {
	
	var msg = confirm("风险操作,更新版本后原发布单将失效,是否继续?");
	if(msg==true){	
		
		var newVersion=parseInt($('#PBHVersion').text())+1;
	
	
	 var PBHData={
			  
				"DBTable":"ppm_bills_PBH_t",
				"PBHVersion":newVersion,
				"PBHBPID":$('#BPID').text(),
				"PBHCTRName":$('#PBHCTRName').text(),
				"emailADRS":$('#emailADRS').val(),
				"emailCopyADRS":$('#emailCopyADRS').val(),
				"emailTitle":$('#emailTitle').val(),
				"emailContent":$('#emailContent').val(),
				"PBHRemark":$('#PBHRemark').val(),
				"PBHMaker":sessionName,
				"PBHMakeDate":Ndate,
				"PBHAuditor":$('#PBHAuditor option:selected').text()
		}
	
	 addDBData(PBHData);
	 
	}
	
});





//按钮-表单关闭按钮,添加刷新数据功能
$('#BTNFormClose').click(function() {
	 window.location.reload();
});



});

</script>
