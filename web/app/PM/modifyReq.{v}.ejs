<!-- CSS -->
<link rel="stylesheet" type="text/css" href="/css/PM/PMContent.css">
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/Bootstrap-3.3.7/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/DataTables-1.10.18/css/dataTables.bootstrap.css">
<link href="/css/PM/datetimepicker/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
<link rel="stylesheet" href="/css/PM/bootstrap-select.min.css" />


<!-- JS  -->

<script src="/css/PM/DataTables/Bootstrap-3.3.7/js/bootstrap.min.js"></script>
<script src="/css/PM/bootstrap-select.min.js"></script>
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.min.js" charset="UTF-8"></script>
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>

<script type="text/javascript"  src="/css/PM/DataTables/DataTables-1.10.18/js/jquery.dataTables.min.js"></script>
<script type="text/javascript"  src="/css/PM/DataTables/DataTables-1.10.18/js/dataTables.bootstrap.min.js"></script>
<script src="/js/PM/FileSaver.min.js"></script>
<script src="/js/PM/tableExport.js"></script>
<script src="/js/PM/PMfuns.js"></script>


<% layout(locals.global.theme_layout_dir+'/master.ejs') -%>



<div class="divcontent">
    <h1>核心修改申请</h1>
    <hr>

    <!-- 操作区（按钮等） -->
    <div class="lineitem">
        
     <!--   <button id="DetailBtn" class="btn btn-warning">详情</button> -->
        
        <!-- 按钮触发模态框 -->
        <button id="DetailBtn" class="btn btn-primary" data-toggle="modal" >详情</button>
        </div>
        
        <!-- 模态框（Modal） -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog" style="width:90%">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel">需求单信息</h4>
                    </div>
                    <div class="modal-body">

                    <div class="panel panel-info">
                	
                    <div class="panel-heading">
                        <h3 class="panel-title">基本信息</h3>
                    </div>
                    
                    <div class="panel-body">

                    <div>
                    <span id="SPAN_Bill_ID"></span></br>
                    <span id="SPAN_Customer_ID"></span>
                    <span id="SPAN_Customer_Name"></span>    
                    <span id="SPAN_Bill_From"></span></br>
                    <span id="SPAN_Bill_Apply_Date_Char"></span>
                    <span id="SPAN_Bill_Limit_Date_Char"></span></br>
                    <span id="SPAN_Bill_Topic"></span></br>
                    <span id="SPAN_Bill_Describe"></span></br>
                    <span id="SPAN_State_Flag"></span>
                    
                    </div>
                 
                    
                   </div>
                   
                   <div class="panel-heading">
                   <h3 class="panel-title">处理记录</h3>
                   </div>
               
                    <div class="panel-body">

                   <span id="SPAN_Bill_ID"></span></br>
                   <span id="SPAN_Customer_ID"></span>
                   <span id="SPAN_Customer_Name"></span>

                    </div>
                    

                    <div class="panel-heading">
                    <h3 class="panel-title">核心修改申请</h3>
                    </div>

                     <div class="panel-body">

                     <form class="form-horizontal" > 
                     
                     
                     <!-------------------------------------------------------------------------->
                      <div class="form-group">
                        <label class="col-sm-1 control-label">申请单号:</label>
                        <div class="col-sm-5">
                          <input class="form-control" id="focusedInput" type="text" value="">
                        </div>
                      </div>
                     
                      <!-------------------------------------------------------------------------->
                      
                      <div class="form-group">
                    	<label class="col-sm-1 control-label">修改原因:</label>   
                    	<div class="col-sm-6">
                    	    <label class="checkbox-inline">
                    	        <input type="checkbox" id="inlineCheckbox1" value="option1"> 功能修改
                    	    </label>
                    	    <label class="checkbox-inline">
                    	        <input type="checkbox" id="inlineCheckbox2" value="option2"> 功能新增
                    	    </label>
                    	    <label class="checkbox-inline">
                    	        <input type="checkbox" id="inlineCheckbox3" value="option3"> 优化
                    	    </label>    
                    	        <label class="checkbox-inline">
                    	        <input type="checkbox" id="inlineCheckbox3" value="option3"> BUG修正
                    	    </label>  
                    	        <label class="checkbox-inline">
                    	        <input type="checkbox" id="inlineCheckbox3" value="option3"> 测试程式
                    	    </label>  
                    	        
                    	</div>
                      </div>
                      
 <!-------------------------------------------------------------------------->
                      
                      <div class="form-group">
                    	<label class="col-sm-1 control-label">修改属性:</label>   
                    	<div class="col-sm-6">
                    	    <label class="checkbox-inline">
                    	        <input type="checkbox" id="inlineCheckbox1" value="option1"> 画面
                    	    </label>
                    	    <label class="checkbox-inline">
                    	        <input type="checkbox" id="inlineCheckbox2" value="option2"> 结果
                    	    </label>
                    	    <label class="checkbox-inline">
                    	        <input type="checkbox" id="inlineCheckbox3" value="option3"> 参数
                    	    </label> 
                    	        <label class="checkbox-inline">
                    	        <input type="checkbox" id="inlineCheckbox3" value="option3"> 通信
                    	    </label>     
                    	        
                    	        
                    	</div>
                      </div>
                      
                      
                      <!-------------------------------------------------------------------------->
                      
                      
                      <div class="form-group"> 
                      
                      <label  class="col-sm-1 control-label" for="name">机型:</label>    
                      <div class="col-sm-2">
                      <select  id="mach_Type_Selector" class="selectpicker" data-live-search="true"> 
                      </select>
                      </div>  
                      
                      <label  class="col-sm-1 control-label" for="name">新版本号:</label>    
                      <div class="col-sm-2">
                      <input class="form-control" id="focusedInput" type="text" value="">
                      </div>
                      
                      
                      </div>
                     
                      
                    
                  	
     
                  
                      
                      <!-------------------------------------------------------------------------->
                      <div class="form-group">
                      <label  class="col-sm-1 control-label" for="name">描述</label>    
                      <div class="col-sm-6">
                      <textarea class="form-control" rows="6"></textarea>
                      </div>
                      </div>
                      
                      <!-------------------------------------------------------------------------->
                      
                      <div class="form-group">
                      <label  class="col-sm-1 control-label" for="name">上传</label>  
                      
                      <div class="col-sm-6">
                      <div id="div_previewImages"></div>
                      <div id="progressNumber"></div>
                      
                      
                      <input type="file" name="myHead" multiple="multiple" id="fileToUpload" style="display:none;" onchange="fileSelected()" >
                      <a class="btn btn-info" onclick="$('#fileToUpload').click();">选择文件</a>
                      
                      
                  	<input type="button" class="btn " onclick="uploadFile()" value="确认上传" >
                  	<input type="button" class="btn " onclick="deleteFile()" value="delete" >
                      
                      
                      </div>

                      
                     

                  	
                  	</div>
                  	
                  	<!-------------------------------------------------------------------------->
                  	 <div class="form-group">
                  	<label  class="col-sm-1 control-label" for="name">附件:</label>
                  	
                  	<div class="col-sm-6">

                  	<div id="div_images"></div>
                  	</div>
                  	
                  	
                  	</div>
                  	
                    <!-------------------------------------------------------------------------->
                    <div class="form-group">
                    
                    
                    <label  class="col-sm-1 control-label" for="name">记录人:</label>    
                    <div class="col-sm-2">
                    <input class="form-control" id="focusedInput" type="text" disabled="disabled" value="<%-(locals.session==null)?"":locals.session.yjUser.Name%>">
                    </div>
                    
                    
                    
                    <label for="dtp_input2" class="col-sm-1 control-label">记录日期:</label>
                    <div class="col-sm-2">
                    <input id="ReqDate" class="form-control" disabled="disabled" id="focusedInput" type="text" value="">
                    </div>
                	  
                    </div>
                      
                      <!-------------------------------------------------------------------------->
                      <div class="form-group">    
                      <label  class="col-sm-1 control-label" for="name"></label>  
                      <div class="col-sm-6">
                      <button id="Add" class="btn btn-info">添加</button>
                      </div>    
                      </div>
                      <!-------------------------------------------------------------------------->
                      
                      </form>

                     </div>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    </div>
                    
                    
                    <div class="modal-footer">
                    
                    </div>
                    
                    
                    
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>
        
        

    </div>
    
    
    
    
    <br/>

    <!--数据呈现区-->
    <table id="orders_DB" class="table table-striped table-bordered"  >
        <thead>
            <tr>
                <th>数据库ID</th>
                <th>订单号</th>
                <th>客户ID</th>
                <th>客户简称</th>
                <th>主题</th>
                <th>申请日期</th>
                <th>完成期限</th>
                <th>当前状态</th>

            </tr>
        </thead>
    </table>
    
    
   
    
    
    <!-- 点击更新、添加按钮后弹出的窗口 -->
    <div id="win" class="easyui-window" title="表单详情" closed="true" style="width:90%;height:800px;">
    
    <div class="divcontent">

	<h1>新单录入</h1>
	<hr>

	
	

</div>
        
        
        
        
    </div>
    <!-- 点击更新、添加按钮后弹出的窗口 -->
    
    
</div>


<script>

////定义显示客户信息数据参数结构-------------
//function factDataPara(tableID,DBTable,Bill_Topic) {
//    this.tableID = tableID;
//    this.DBTable = DBTable;
//    this.Bill_Topic = Bill_Topic;
//}
//检查输入信息-------------------
function checkinput(Data) {
    if (Data.Bill_ID=="") {
        alert('厂商码不能为空，请检查!');
        return false;
    } else if (Data.Customer_ID=="") {
        alert('厂商名称不能为空，请检查!');
        return false;
    }
    return true;
}

//定义添加发送数据结构---------------------

function addDataInfo(DBTable,Bill_ID,Customer_ID,Bill_Topic){
	this.DBTable=DBTable;
	this.Bill_ID=Bill_ID;
	this.Customer_ID=Customer_ID;
	this.Bill_Topic=Bill_Topic;
}




//函数详情页加载内容------------------------
function Fun_winInit(){
	
	var cust_Select_Para={DBTable:"pm_customers",selectTitle:"cust_Name"};
	var cust_selectorID="#cust_Selector";
    getSelectDBData(cust_Select_Para,cust_selectorID);
	
    
	var staff_Select_Para={DBTable:"pm_staffs",selectTitle:"staff_Name"};
	var staff_selectorID="#staff_Selector";
    getSelectDBData(staff_Select_Para,staff_selectorID);
    
    
    var mach_Type_Select_Para={DBTable:"pm_machinetypes",selectTitle:"mach_Type_Name"};
	var mach_Type_selectorID="#mach_Type_Selector";
    getSelectDBData(mach_Type_Select_Para,mach_Type_selectorID);
    
    
    $('.form_date').datetimepicker({
        language:  'zh-CN',
        weekStart: 1,
        todayBtn:  1,
		autoclose: 1,
		todayHighlight: 1,
		startView: 2,
		minView: 2,
		forceParse: 0
    });
    
    $('#ReqDate').val(Ndate);
    $('#order_EndDate').val(Fun_getEndDate(Ndate,3));
	
	
	
}



//页面加载函数---------------
$(document).ready( function () {
		
	var DataPara={
			"tableID":"#orders_DB",
			"Filter":[{"State_Flag":"4","CType":"<>"}]
	}
		
	
	var columnsData=[
		{ data: 'DBID' ,"visible": false},
        { data: 'Bill_ID' },
        { data: 'Customer_ID'},
        { data: 'cust_Name'},
        { data: 'Bill_Topic'},
        { data: 'Bill_Apply_Date_Char'},
        { data: 'Bill_Limit_Date_Char'},
        { data: 'State_Flag'},
    ];

//	alert(JSON.stringify(DataPara));
	showOrdersDBData(DataPara,columnsData);
	
//判断是否选中数据-------
var table = $('#orders_DB').DataTable();
$('#orders_DB tbody').on('click', 'tr', function() {
    if ($(this).hasClass('selected')) {
        $(this).removeClass('selected');
    } else {
        table.$('tr.selected').removeClass('selected');
        $(this).addClass('selected');
    }
 
    var dataSelect = table.row('.selected').data();
    
    

});
	






//详情按钮---------
$('#DetailBtn').click(function() {
 //   alert("seclet: "+JSON.stringify(table.row('.selected').data()));
    // table.row('.selected').remove().draw( false );
    var dataSelect = table.row('.selected').data();
    if (dataSelect == undefined) {
        alert("请先点击表格中的表单!");
    } else {
    	
    	
    	$('#myModal').modal('show');
    	Fun_winInit();
    	
    //	alert("dataSelect:"+JSON.stringify(dataSelect));
    	
        
    	  $('#SPAN_Bill_ID').html("单号:"+dataSelect.Bill_ID);
          $('#SPAN_Customer_ID').html("客户ID:"+dataSelect.Customer_ID);
          $('#SPAN_Customer_Name').html("客户名称:"+dataSelect.cust_Name);
          $('#SPAN_Bill_From').html("来源:"+dataSelect.Bill_From);
          $('#SPAN_Bill_Apply_Date_Char').html("申请日期:"+dataSelect.Bill_Apply_Date_Char);
          $('#SPAN_Bill_Limit_Date_Char').html("完成日期:"+dataSelect.Bill_Limit_Date_Char);
          $('#SPAN_Bill_Topic').html("主题:"+dataSelect.Bill_Topic);
          $('#SPAN_Bill_Describe').html("描述:"+dataSelect.Bill_Describe);
          $('#SPAN_State_Flag').html("状态:"+dataSelect.State_Flag);
        
        
      
        
        
        
        $('#Customer_ID').val(dataSelect.Customer_ID);
        $('#Bill_Topic').val(dataSelect.Bill_Topic);
        
    }
});


//删除按钮----------
$('#Del').click(function() {
    var dataSelect = table.row('.selected').data();
    
//    alert(JSON.stringify(dataSelect));
    
    if (dataSelect == undefined) {
        alert("当前未选择任何数据,请先点击需要删除的数据行!");
    } else {
        var msg1 = confirm("风险操作！此行数据内容移除后无法还原，请确认操作是否无误！");
        if (msg1 === true) {
            var msg2 = confirm("确认删除此行数据？");
            if (msg2 === true) {
            	
            //	alert(dataSelect.DBID);
                var IDData = {"DBTable":"PM_orders","DBID":dataSelect.DBID};
             //   alert("IDData:"+JSON.stringify(IDData));
                delDBData(IDData);
            }
        }
    }
    //          table.row('.selected').remove().draw( false );//前端删除显示数据 ,数据库不删除
});


//form框添加按钮----------
$('#AddDoButton').click(function() {
	var DBTable="PM_orders";
	var Bill_ID=$("#Bill_ID").val();
	var Customer_ID=$("#Customer_ID").val();
	var Bill_Topic=$("#Bill_Topic").val();
	
	var DBData=new addDataInfo(DBTable,Bill_ID,Customer_ID,Bill_Topic);
	
	
	addDBData(DBData);
	


});




//form 更新按钮------------
$('#UpdDoButton').click(function() {
	
 //   var UID = table.row('.selected').data().UID;
	
//	var Bill_ID=$('#Bill_ID').val();
//    var Customer_ID=$('#Customer_ID').val();
//    var Bill_Topic=$('#Bill_Topic').val();
	
	var updInput={
			Bill_ID:$('#Bill_ID').val(),
			Customer_ID:$('#Customer_ID').val(),
			Bill_Topic:$('#Bill_Topic').val()			
	}

   
    var updJSON={
			'DBTable':"PM_orders",
			'DBID':table.row('.selected').data().DBID
    	};
	var changed=0;

    for (var key in updInput) {   	
//   	alert(key);
    	if(updInput[key]!=table.row('.selected').data()[key]){    		
//    		alert("updInput:"+updInput[key]);
//    		alert("selected:"+table.row('.selected').data()[key]);    		
    		updJSON[key]=updInput[key];//不可用updJSON.key 会以"key"属性直接加入
    		changed=changed+1;
    	}
    }

//   alert("updJSON:"+JSON.stringify(updJSON));
    
    if(changed!=0){
    	if (checkinput(updJSON)) {
    		 var msg = confirm("共调整"+changed+"处信息,请确认！");
    		 if(msg==true){
    			 updDBData(updJSON);
    		 }
    		 
    	}
    }else{
    	alert("未有任何信息修改!");
    }
    
});


//form框 取消按钮----------------
$('#CancelButton').click(function() {
    $('#win').window('close');
});

	
	
}); 

</script>
