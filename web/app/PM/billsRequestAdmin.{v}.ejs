<!-- 导入css库 -->
<link rel="stylesheet" type="text/css" href="/ppmLib/css/divCss.css">

<!-- 导入js库 -->
<script type="text/javascript" src="/ppmLib/publicFuns.js"></script>

<!-- 导入datatables -->
<link rel="stylesheet" type="text/css" href="/ppmLib/DataTables/datatables.min.css" />
<script type="text/javascript" src="/ppmLib/DataTables/datatables.min.js"></script>

<!-- 导入bootstrapSelect -->
<link rel="stylesheet" href="/ppmLib/bootstrapSelect/css/bootstrap-select.min.css" />
<script type="text/javascript" src="/ppmLib/bootstrapSelect/js/bootstrap-select.min.js"></script>


<!-- 导入bootstrapSwitch -->
<link rel="stylesheet" href="/ppmLib/bootstrapSwitch/css/bootstrap3/bootstrap-switch.min.css" />
<script type="text/javascript" src="/ppmLib/bootstrapSwitch/js/bootstrap-switch.min.js"></script>

<!-- 导入datatimepicker -->
<link href="/ppmLib/datetimepicker/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
<script type="text/javascript" src="/ppmLib/datetimepicker/bootstrap-datetimepicker.min.js" charset="UTF-8"></script>
<script type="text/javascript" src="/ppmLib/datetimepicker/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>


<!-- 导入qrcode 二维码库 -->
<script type="text/javascript" src="/ppmLib/qrcode/qrcode.min.js"></script>

<!-- 导入instascan 二维码扫描库 -->
<script type="text/javascript" src="/ppmLib/instascan/instascan.min.js"></script>

<!-- 导入print 打印库 -->
<script type="text/javascript" src="/ppmLib/print/print.js"></script>

<!-- 加载foil外框架 -->
<% layout(locals.global.theme_layout_dir+'/master.ejs') -%>

<!-- 定义html元素 -->
<div class="rpContent">

    <!-- 按钮：用于打开模态框 -->

    <div class="row clearfix">
        <div class="col-md-12 column">
            <div class="page-header">
                <h1>工作流程-需求单管理</h1>
            </div>
        </div>
    </div>


    <div class="row clearfix">
        <div class="col-md-12 column">


            <!-- 定义基础模块数据表 -->

            <div class="panel panel-default" id='mainTablePanel'>
                <div class="panel-heading">
                    <div style="float: left;">
                        <div class="btn-group">
                            <button type="button" class="btn btn-primary">过滤</button>
                            <button type="button" id="btnFilterToday" class="btn btn-default">当天</button>
                            <button type="button" id="btnFilterDiy" class="btn btn-default">自定义</button>
                        </div>
                    </div>
                    <div style="clear:both"></div>
                </div>
                <div class="panel-body">
                    <table id="ppm_requestbills" class=" table table-striped table-bordered" style="width:100%">
                        <thead>
                            <tr>
                                <th>申请单号</th>
                                <th>送修时间</th>
                                <th>客户简称</th>
                                <th>联系人</th>
                                <th>电话</th>
                                <th width='300'>地址</th>
                                <th>客户归属</th>
                                <th>送修方式</th>
                                <th>送修人</th>
                                <th>备注</th>
                                <th>搜索值</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>




    <!-- 过滤器模态框（Modal） -->
    <div class="modal fade" id="filterModal" tabindex="-1" role="dialog" aria-hidden="true">

        <div class="modal-dialog" style="width: 800px;">

            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    <h4 class="modal-title">
                        过滤器
                    </h4>
                </div>
                <div class="modal-body">

                    <div class="panel panel-info">
                        <div class="panel-body" style="height:500px">
                            <form class="form-horizontal" role="form" id='filterForm'>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">客户简称</label>
                                    <div class="col-sm-5">
                                        <select class="selectpicker" id="filterForm-customerShortName" multiple
                                            data-live-search="true" data-size="10"
                                            data-selected-text-format="count > 3">
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-2 control-label">送修人</label>
                                    <div class="col-sm-5">
                                        <select class="selectpicker" id="filterForm-requestStaff" multiple
                                            data-live-search="true" data-size="10"
                                            data-selected-text-format="count > 3">
                                        </select>
                                    </div>
                                </div>


                                <div class="form-group">
                                    <label class="col-sm-2 control-label">送修日期</label>
                                    <div class="col-sm-5">
                                        <div class="input-group date form_date ">
                                            <input id="filterForm-requestDateB" class="form-control " size="16"
                                                type="text" value="" placeholder="起始日期" readonly>
                                            <span class="input-group-addon"><span
                                                    class="glyphicon glyphicon-calendar"></span></span>
                                        </div>
                                    </div>

                                    <div class="col-sm-5">
                                        <div class="input-group date form_date ">
                                            <input id="filterForm-requestDateE" class="form-control " size="16"
                                                type="text" value="" placeholder="结束日期" readonly>
                                            <span class="input-group-addon"><span
                                                    class="glyphicon glyphicon-calendar"></span></span>
                                        </div>
                                    </div>

                                </div>

                                <div class="form-group">
                                    <label class="col-sm-2 control-label">制单日期</label>
                                    <div class="col-sm-5">
                                        <div class="input-group date form_date ">
                                            <input id="filterForm-makeDateB" class="form-control " size="16" type="text"
                                                value="" placeholder="起始日期" readonly>
                                            <span class="input-group-addon"><span
                                                    class="glyphicon glyphicon-calendar"></span></span>
                                        </div>
                                    </div>

                                    <div class="col-sm-5">
                                        <div class="input-group date form_date ">
                                            <input id="filterForm-makeDateE" class="form-control " size="16" type="text"
                                                value="" placeholder="结束日期" readonly>
                                            <span class="input-group-addon"><span
                                                    class="glyphicon glyphicon-calendar"></span></span>
                                        </div>
                                    </div>

                                </div>



                                <div class="form-group">
                                    <label class="col-sm-2 control-label"></label>

                                    <div class="col-sm-10">
                                        <button type="button" class="btn btn-default" data-dismiss="modal"
                                            id="closeFilter">关闭
                                        </button>
                                        <button type="button" class="btn btn-primary" id="confirmFilter">
                                            确定
                                        </button>

                                    </div>


                                </div>
                            </form>

                        </div>
                    </div>


                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>
    </div>






    <!-- 模态框（Modal） -->
    <div class="modal fade" id="ppm_requestbillsModal" tabindex="-1" role="dialog" aria-hidden="true"
        data-backdrop="static">

        <div class="modal-dialog" style="width: 75%;">

            <!-- 按钮触发模态框 -->
            <button class="btn btn-primary" data-toggle="modal" data-target="#ppm_requestbillsModal"
                id="ppm_requestbillsModalOpen" style="display: none;">
                开始演示模态框
            </button>
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    <h4 class="modal-title">
                        表单详情
                    </h4>
                </div>
                <div class="modal-body">

                    <!-- 表单面板 -->
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <form class="form-horizontal" role="form" id='ppm_requestbillsForm'>

                                <!-- <input id="ppm_requestbillsForm-DBID" type="hidden" value=""> -->

                                <div class="form-group">
                                    <label class="col-sm-1 control-label"
                                        for="ppm_requestbillsForm-requestBillId">申请单号</label>
                                    <div class="col-sm-5">
                                        <p class="form-control-static" id="ppm_requestbillsForm-requestBillId"></p>
                                    </div>


                                    <label class="col-sm-1 control-label"
                                        for="ppm_requestbillsForm-requestDate">送修时间:</label>
                                    <div class="col-sm-5 ">
                                        <div class="input-group date form_date ">
                                            <input id="ppm_requestbillsForm-requestDate" class="form-control " size="16"
                                                type="text" value="" readonly>
                                            <span class="input-group-addon"><span
                                                    class="glyphicon glyphicon-calendar"></span></span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-1 control-label"
                                        for="ppm_requestbillsForm-fromBillId">来源单类型</label>
                                    <div class="col-sm-5">
                                        <p class="form-control-static" id="ppm_requestbillsForm-fromBillType"></p>
                                    </div>

                                    <label class="col-sm-1 control-label"
                                        for="ppm_requestbillsForm-fromBillId">来源单号</label>
                                    <div class="col-sm-5">
                                        <p class="form-control-static" id="ppm_requestbillsForm-fromBillId"></p>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-1 control-label "
                                        for="ppm_requestbillsForm-customerId">客户编号</label>
                                    <div class="col-sm-5">
                                        <p class="form-control-static" id="ppm_requestbillsForm-customerId"></p>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-1 control-label text-warning"
                                        for="ppm_requestbillsForm-customerShortName">客户简称</label>
                                    <div class="col-sm-5">
                                        <select id="ppm_requestbillsForm-customerShortName"
                                            class="selectpicker form-control" data-live-search="true" data-size="10">
                                        </select>
                                    </div>





                                    <label class="col-sm-1 control-label"
                                        for="ppm_requestbillsForm-customerName">客户名称</label>
                                    <div class="col-sm-5">
                                        <input class="form-control" id="ppm_requestbillsForm-customerName" type="text">
                                    </div>


                                </div>

                                <div class="form-group">
                                    <label class="col-sm-1 control-label"
                                        for="ppm_requestbillsForm-isInland">国内外</label>
                                    <div class="col-sm-5">
                                        <select id="ppm_requestbillsForm-isInland" class="selectpicker">

                                        </select>
                                    </div>

                                    <label class="col-sm-1 control-label"
                                        for="ppm_requestbillsForm-customerArea">客户区域</label>
                                    <div class="col-sm-5">
                                        <select id="ppm_requestbillsForm-customerArea" class="selectpicker form-control"
                                            data-live-search="true" data-size="10">
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-1 control-label text-warning"
                                        for="customerContacts">可选联系人</label>
                                    <div class="col-sm-5">
                                        <!-- <input class="form-control" id="ppm_requestbillsForm-contact" type="text"> -->
                                        <select id="customerContacts" class="selectpicker">
                                        </select>
                                    </div>

                                    <label class="col-sm-1 control-label"
                                        for="ppm_requestbillsForm-customerId">保固期</label>
                                    <div class="col-sm-5">
                                        <p class="form-control-static" id="ppm_requestbillsForm-warrantyPeriod"></p>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-1 control-label text-warning"
                                        for="ppm_requestbillsForm-contact">联系人</label>
                                    <div class="col-sm-5">
                                        <input class="form-control" id="ppm_requestbillsForm-contact" type="text">
                                    </div>

                                    <label class="col-sm-1 control-label text-warning"
                                        for="ppm_requestbillsForm-mobilePhone">移动电话</label>
                                    <div class="col-sm-5">
                                        <input class="form-control" id="ppm_requestbillsForm-mobilePhone" type="text">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-1 control-label text-warning"></label>
                                    <div class="col-sm-5">
                                        <button type="button" class="btn btn-warning" id="addContactsBtn">添加到可选联系人
                                        </button>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-1 control-label text-warning"
                                        for="ppm_requestbillsForm-customerBelongShort">归属公司简称</label>
                                    <div class="col-sm-5">
                                        <!-- <input class="form-control" id="ppm_requestbillsForm-customerBelongShort"
                                            type="text"> -->
                                        <select id="ppm_requestbillsForm-customerBelongShort"
                                            class="selectpicker form-control" data-live-search="true" data-size="10">
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-1 control-label text-warning"
                                        for="ppm_requestbillsForm-requestWay">送修方式</label>
                                    <div class="col-sm-5">
                                        <select id="ppm_requestbillsForm-requestWay" class="selectpicker">

                                        </select>
                                    </div>

                                    <label class="col-sm-1 control-label text-warning"
                                        for="ppm_requestbillsForm-requestStaff">送修人</label>
                                    <div class="col-sm-5">
                                        <!-- <input class="form-control" id="ppm_requestbillsForm-requestStaff" type="text"> -->
                                        <select id="ppm_requestbillsForm-requestStaff" class="selectpicker"
                                            data-live-search="true" data-size="5">
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-1 control-label text-warning"
                                        for="ppm_requestbillsForm-address">地址</label>
                                    <div class="col-sm-11">
                                        <input class="form-control" id="ppm_requestbillsForm-address" type="text">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-1 control-label">单据备注</label>
                                    <div class="col-sm-11">
                                        <input class="form-control" id="ppm_requestbillsForm-remark" type="text">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-sm-1 control-label" for="msgSwitch">短信提醒</label>
                                    <div class="col-sm-11">
                                        <input id="msgSwitch" type="checkbox">
                                    </div>
                                </div>


                                <div class="form-group">
                                    <label class="col-sm-1 control-label" for="ppm_requestbillsForm-maker">制单人</label>
                                    <div class="col-sm-5">
                                        <p class="form-control-static" id="ppm_requestbillsForm-maker"></p>
                                    </div>

                                    <label class="col-sm-1 control-label"
                                        for="ppm_requestbillsForm-makeDate">制单时间</label>
                                    <div class="col-sm-5">
                                        <p class="form-control-static" id="ppm_requestbillsForm-makeDate"></p>
                                    </div>
                                </div>

                            </form>



                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal"
                        id="ppm_requestbillsModalClose">关闭
                    </button>

                    <button type="button" class="btn btn-primary" id="ppm_requestbillsSave">
                        保存单据
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>



</div>



<script type="text/javascript">
    //申请表主表dataTable column 数组

    const mainColumnsArray = [{
        data: 'CTRName',
        // visible: 'false'
    }, {
        data: 'orderFrom'
    }, {
        data: 'billClass'
    }, {
        data: 'functionClass',
    }, {
        data: 'orderFromDep',
    }, {
        data: 'topic',
    }, {
        data: 'detail',
    }, {
        data: 'OGNSystemVersion',
    }, {
        data: 'MHEName',
    }, {
        data: 'applyDate',
    }];




    //创建申请单新单号
    const createRequestBillId = async () => {
        let r1 = await getDataBySql({
            sql: "getReqeustBillsNum",
            params: {
                filter: 'makeDate="' + currentDate() + '"'
            }
        })
        // console.log('r1:' + r1);
        let r2 = r1[0].billsNum
        let r3 = parseInt(r2) + 1;

        let r4 = PrefixInteger(r3, 3);
        // console.log('r4:' + r4);
        let r5 = dateFormat(currentDate(), 'yyyyMMdd');

        let billId = 'AA-' + r5 + r4;
        $("#ppm_requestbillsForm-requestBillId").text(billId);
    }



    //添加主表监听器,定义双击打开事件

    const addMainTableListener = () => {

        //解绑原事件
        $('#ppm_requestbills tbody').unbind();

        //定义主表单击击事件
        $('#ppm_requestbills tbody').on('click', 'tr', async function () {
            //设定选中
            let table = $('#ppm_requestbills').DataTable();

            if ($(this).hasClass('selected')) {
                $(this).removeClass('selected');
                //清空选中单据数据
                mainTableData = {}
                // await loadMainBillSubTable()
                $('#subTablePanel').hide();
            } else {
                table.$('tr.selected').removeClass('selected');
                $(this).addClass('selected');

                let rowSelect = table.row('.selected').data();
                // console.log("rowSelect:" + JSON.stringify(rowSelect));

                mainTableData = rowSelect; //刷新全局主表对象数据

                await loadMainBillSubTable(rowSelect.requestBillId)

                //打开面板
                $('#subTablePanel').show();

            }

        });


        //定义主表双击事件
        $('#ppm_requestbills tbody').on('dblclick', 'tr', async function () {



            //打开关联信息,打印功能
            $("#accordion").show();

            // $("#listPrintBtn").show();
            // $("#ppm_requestbillsPrint").show();

            //设定选中
            let table = $('#ppm_requestbills').DataTable();
            table.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
            let dataSelect = table.row('.selected').data();

            mainTableData = dataSelect; //刷新全局主表对象数据

            // console.log('mainTableData', mainTableData);

            //解除客户监听事件
            $('#ppm_requestbillsForm-customerShortName').unbind();

            //初始化并填写form内inputs
            initAndFillFormInputs({
                formId: 'ppm_requestbillsForm',
                params: dataSelect
            })

            let r1 = await getDataBySql({
                sql: 'getCustomers',
                params: {
                    filter: 'customerShortName="' + dataSelect.customerShortName + '"'
                }
            })

            // console.log('r1:' + JSON.stringify(r1));
            //重置客户信息改变状态
            customerDataChanged = false
            customerData = r1[0]; //将查询结果赋给全局变量


            //加载备选联系人
            loadContactOptions(customerData);

            //关闭子表panel
            $('#ppm_recordbillsPanel').hide();

            //加载子表记录表数据

            loadBillSubTable(dataSelect.requestBillId);

            //客户选定监听事件
            addCustomerListener();

            //控制产品工具栏显示
            if (mainTableData.fromBillType) {
                $('#productToolBar').hide()
            } else {
                $('#productToolBar').show()
            }

            //打开面板
            $('#ppm_requestbillsModal').modal('show');

        });

    }




    //主表加载数据函数;

    const loadBillMainTable = async () => {

        //显示过滤模式
        if (mainTableFilter === 'to_days(makeDate) = to_days(now())') {
            $('#btnFilterToday').addClass('active');
            $('#btnFilterDiy').removeClass('active');
        } else {
            $('#btnFilterDiy').addClass('active');
            $('#btnFilterToday').removeClass('active');
        }

        //初始化主表
        loadBillDataTable({
            elementId: 'ppm_requestbills',
            sqlParams: {
                sqlId: 'sqlRequestBills',
                params: {
                    filter: mainTableFilter,
                    orderBy: 'billSaveTimeStamp desc'
                }
            },
            dtParams: {
                // bAutoWidth: false,//取消自动宽度
                columns: mainColumnsArray,
                // scrollX: true,
                // autoWidth: true
            }
        })
        //清空选项值
        $('.dataTables_filter input').val('')

        //自定义样式调整
        $('.dataTables_filter input').attr({
            'name': 'search',
            'size': 45
        });
        $('.dataTables_filter input').attr({
            'name': 'search',
            'placeholder': '可用表属性过滤'
        });




        //隐藏搜索值数据列,bStateSave 会导致列中visible 属性失效,采用指定隐藏方案
        let table = $('#ppm_requestbills').DataTable();
        table.column('last').visible(false)

        addMainTableListener();

        //关闭面板
        $('#subTablePanel').hide();
    }






    //保存维修申请单函数
    const saveRequestbill = async () => {

        let mainFormData = getPostFormData({
            formId: 'ppm_requestbillsForm'
        })

        //给主表数据添加,maker 和makeDate时间;新增状态等待单号检测完成,制单人为空则为新增状态

        if (!mainFormData.data[0].maker) {
            await autoUpdateRequestBillId();
            //刷新申请单号
            mainFormData.data[0].requestBillId = $("#ppm_requestbillsForm-requestBillId").text();
            mainFormData.data[0].maker = sessionName;
            mainFormData.data[0].makeDate = currentDate();
        }

        // console.log("subTableData:" + JSON.stringify(subTableData))

        //添加申请单号到子表数据

        //给主表数据中添加产品清单
        let factoryNos = '';
        for (let n of subTableData) {
            n.requestBillId = $("#ppm_requestbillsForm-requestBillId").text();
            n.fromBillId = $("#ppm_requestbillsForm-fromBillId").text();
            if (n.status === '新增') {
                n.status = '待维修'
            }
            factoryNos = factoryNos + n.factoryNo + ' ';
        }

        mainFormData.data[0].factoryNos = factoryNos;

        let r1 = await postDBData({
            sql: 'replace',
            params: mainFormData
        })

        let r2 = await postDBData({
            sql: 'replace',
            params: {
                tableId: 'ppm_recordbills',
                data: subTableData
            }
        })

        // console.log('saveRequestbill r1:' + JSON.stringify(r1));
        // console.log('saveRequestbill r2:' + JSON.stringify(r2));

        if (r1.affectedRows > 0 && r2.affectedRows > 0) {
            alert('保存成功!')
        } else {
            alert('出现错误!')
        }

        //do-更新还货单状态
        if (mainFormData.data[0].fromBillType === '还货单') {

            let returnBillsIdArr = $("#ppm_requestbillsForm-fromBillId").text().split(',');
            let returnBillsArr = []
            for (const n of returnBillsIdArr) {
                returnBillsArr.push({
                    returnBillId: n,
                    status: '已返修'
                })
            }

            let r1 = await postDBData({
                sql: 'update',
                params: {
                    tableId: 'ppm_returnbills',
                    data: returnBillsArr,
                    key: 'returnBillId'
                }
            })

            let r2 = await postDBData({
                sql: 'update',
                params: {
                    tableId: 'ppm_returnsubbills',
                    data: returnBillsArr,
                    key: 'returnBillId'
                }
            })


            if (r1.affectedRows > 0 && r2.affectedRows > 0) {
                alert('更新还货单状态成功!')
            }

            loadUnReturnRequestTable()

        }

        //do-更新还货单状态
        if (mainFormData.data[0].fromBillType === '维修单') {
            //check-检查选中
            let table = $('#ppm_partsbills').DataTable();
            let rowsSelect = table.rows('.selected').data();
            let partBillsArr = []

            for (let i = 0; i < rowsSelect.length; i++) {
                partBillsArr.push({
                    DBID: rowsSelect[i].DBID,
                    repairPartStatus: '已返修'
                })

            }

            let rUpdatePartBill = await postDBData({
                sql: 'update',
                params: {
                    tableId: 'ppm_partsbills',
                    data: partBillsArr,
                    key: 'DBID'
                }
            })
            if (rUpdatePartBill.affectedRows > 0) {
                alert('更新配件返修状态成功!')
            }

            loadUnPartRequestTable()

        }

        //更新客户信息功能

        // console.log('customerData:' + JSON.stringify(customerData));
        // console.log('mainFormData:' + JSON.stringify(mainFormData));

        //定义当前表内实际填写客户数据
        let billCustomerData = {
            customerId: mainFormData.data[0].customerId,
            customerArea: mainFormData.data[0].customerArea,
            customerName: mainFormData.data[0].customerName,
            contact: mainFormData.data[0].contact,
            mobilePhone: mainFormData.data[0].mobilePhone,
            customerBelongShort: mainFormData.data[0].customerBelongShort,
            isInland: mainFormData.data[0].isInland
        }

        //判断当前表内客户数据是否存在更新;

        for (const p in billCustomerData) {
            if (billCustomerData[p] !== customerData[p]) {

                // console.log(p + ':' + 'billCustomerData[p]' + billCustomerData[p] + ',customerData[p]:' +
                //     customerData[p] + '不同');

                customerData[p] = billCustomerData[p];
                customerDataChanged = true;
                // break;
            }
        }

        //存在不同则更新客户信息
        if (customerDataChanged) {

            if (confirm('是否更新该客户基础信息?')) {
                let rc = await postDBData({
                    sql: 'update',
                    params: {
                        tableId: 'ppm_customers',
                        data: [customerData],
                        key: 'customerId'
                    }
                })
                if (rc.affectedRows > 0) {
                    alert('更新客户信息成功!')
                }

            }
        }

        // $('#ppm_requestbillsModal').modal('hide');多层modal存在失效问题,改用click关闭
        $('#ppm_requestbillsModalClose').click()

        loadBillMainTable();

    }




    //检查需求单Id函数,防止多人同时填单时出现的覆盖问题

    const checkRequestBillId = async () => {
        let billId = $("#ppm_requestbillsForm-requestBillId").text();

        let r1 = await getDataBySql({
            sql: 'getReqeustBillsNum',
            params: {
                filter: 'requestBillId="' + billId + '"'
            }
        })

        let r2 = r1[0].billsNum;
        // console.log("checkRequestBillId:" + r2);

        let o = r2 > 0 ? false : true;
        return o;

    }

    //更新需求单号加1
    const updateRequestBillId = () => {
        let billId = $("#ppm_requestbillsForm-requestBillId").text();
        if (billId) {
            billIdArr = billId.split('-');
            let newBillId = billIdArr[0] + '-' + (parseInt(billIdArr[1]) + 1);
            $("#ppm_requestbillsForm-requestBillId").text(newBillId);
        }
    }

    //递归更新单号直到不存在冲突单号;

    const autoUpdateRequestBillId = async () => {
        let r = await checkRequestBillId();
        if (r) {
            return true
        } else {
            // console.log('fail:' + $("#ppm_requestbillsForm-requestBillId").text());
            updateRequestBillId()
            // console.log('fail11:' + $("#ppm_requestbillsForm-requestBillId").text());
            return await autoUpdateRequestBillId();
        }
    }


    //检查删除单据数据
    const checkDeleteBills = async () => {

        let resultData = {
            result: null,
            data: {}
        }

        let table = $('#ppm_requestbills').DataTable();
        let dataSelect = table.rows('.selected').data();
        let mainDBIDArr = [];
        let subDBIDArr = [];
        let billsIdArr = [];

        for (let n = 0; n < dataSelect.length; n++) {
            mainDBIDArr.push(dataSelect[n].DBID);
            billsIdArr.push(dataSelect[n].requestBillId);
        }

        switch (true) {
            case billsIdArr.length === 0:
                alert('请先选中需要删除的申请单!')

                resultData.result = false;
                return resultData
                break;
            case billsIdArr.length > 0:
                let billIdRange = getRangeString(billsIdArr);

                // console.log("billsIdArr:" + JSON.stringify(billsIdArr));

                let statusArr = await getDataBySql({
                    sql: 'getRecordBillStatus',
                    params: {
                        filter: 'requestBillId in ' + billIdRange
                    }
                })

                // console.log("statusArr:" + JSON.stringify(statusArr));
                for (const n of statusArr) {
                    if (n.status !== '待维修') {
                        alert('选中单据存在关联的维修单,不符合删除条件!')
                        resultData.result = false;
                        return resultData
                    }
                    subDBIDArr.push(n.DBID)
                }

                break;
        }

        resultData = {
            result: true,
            data: {
                mainDBIDArr: mainDBIDArr,
                subDBIDArr: subDBIDArr
            }
        }

        return resultData;
    }





    $(document).ready(function () {

        // alert(parseInt(''))
        //定义全局变量,当前用户名
        sessionName = "<%-locals.session.yjUser.Name%>";
        //定义主表全局变量临时数据对象
        mainTableData = {};


        //存储当前客户信息
        customerData = {}
        //记录客户基本信息是否被改变
        customerDataChanged = false
        //主表过滤器
        mainTableFilter = '';


        //过滤器当天按钮
        $('#btnFilterToday').click(function () {
            mainTableFilter = 'to_days(makeDate) = to_days(now())';
            //初始化主表
            loadBillMainTable();

        })

        $('#btnFilterToday').click(); //默认开启当天过滤

        //过滤器自定义按钮
        $('#btnFilterDiy').click(function () {
            //打开面板
            $('#filterModal').modal('show');
            clearFormInputs({
                formId: 'filterForm'
            })
        })

        //过滤器确认按钮

        $('#confirmFilter').click(function () {
            //获取filterform内数据
            let filter = '';

            //客户简称过滤
            let customerSelectedValues = [];
            $("#filterForm-customerShortName option:selected ").each(function () {
                customerSelectedValues.push($(this).val());
            });

            if (customerSelectedValues.length > 0) {
                let customerRange = getRangeString(customerSelectedValues);
                filter = ' and customerShortName in ' + customerRange;
            }

            //送修人过滤
            let requestStaffSelectedValues = [];
            $("#filterForm-requestStaff option:selected ").each(function () {
                requestStaffSelectedValues.push($(this).val());
            });

            if (requestStaffSelectedValues.length > 0) {
                let requestStaffRange = getRangeString(requestStaffSelectedValues);
                filter = ' and requestStaff in ' + requestStaffRange;
            }


            //申请日期过滤
            let requestDateB = $('#filterForm-requestDateB').val();
            let requestDateE = $('#filterForm-requestDateE').val();

            if (requestDateB) {
                filter = filter + ' and requestDate>="' + requestDateB + '"'
            }

            if (requestDateE) {
                filter = filter + ' and requestDate<="' + requestDateE + '"'
            }

            //制单日期过滤
            let makeDateB = $('#filterForm-makeDateB').val();
            let makeDateE = $('#filterForm-makeDateE').val();

            if (makeDateB) {
                filter = filter + ' and makeDate>="' + makeDateB + '"'
            }

            if (makeDateE) {
                filter = filter + ' and makeDate<="' + makeDateE + '"'
            }



            //去除filter中开始的and关键字避免sql错误;

            if (filter) {
                filter = filter.substring(4, filter.length);
            }

            mainTableFilter = filter

            $('#closeFilter').click();
            loadBillMainTable()

        })


        //新增需求单按钮
        $('#btnRequestBillNew').click(function () {

            //清空form数据
            clearFormInputs({
                formId: 'ppm_requestbillsForm'
            })

            //清空原有选项
            $('#customerContacts').empty();
            $('#customerContacts').selectpicker('destroy');


            //清空子表及全局变量
            subTableData = [];
            $('#ppm_recordbills tbody').html("");


            //打开面板
            $('#ppm_recordbillsPanel').hide();


            //清空modal数据
            clearFormInputs({
                formId: 'ppm_requestbillsForm'
            })


            createRequestBillId();
            $("#ppm_requestbillsForm-requestDate").val(currentDate());
            $("#ppm_requestbillsForm-isInland").selectpicker('val', '国内')
            $("#ppm_requestbillsForm-requestWay").selectpicker('val', '邮寄过来')

            //在保存时赋值
            // $("#ppm_requestbillsForm-maker").text(sessionName);
            // $("#ppm_requestbillsForm-makeDate").text(currentDate());

            // //客户选定监听事件
            // addCustomerListener();


            //显示/隐藏
            //隐藏产品增减按钮
            $('#productToolBar').show()
            $("#accordion").hide();

            //重置客户信息改变状态
            customerDataChanged = false
            customerData = {}

            //打开面板
            $('#ppm_requestbillsModal').modal('show');

        })


        //删除需求单
        $('#btnRequestBillDelete').click(async function () {
            //check-检查是否为系统单据
            if (mainTableData.fromBillType) {
                alert('该单为系统生成单据不可删除,可以调整内容!')
                return
            }

            //检查条件
            let resultData = await checkDeleteBills();
            if (!resultData.result) {
                return;
            }

            //提醒删除风险
            if (!confirm('删除后无法恢复,确认删除?')) {
                return;
            }

            //删除单据

            // let table = $('#ppm_requestbills').DataTable();
            // let dataSelect = table.rows('.selected').data();
            // let DBIDArr = [];
            // for (let n = 0; n < dataSelect.length; n++) {
            //     DBIDArr.push(dataSelect[n].DBID);
            // }

            let r1 = await postDBData({
                sql: 'delete',
                params: {
                    tableId: 'ppm_requestbills',
                    data: resultData.data.mainDBIDArr
                }
            })

            let r2 = await postDBData({
                sql: 'delete',
                params: {
                    tableId: 'ppm_recordbills',
                    data: resultData.data.subDBIDArr
                }
            })

            if (r1.affectedRows && r2.affectedRows) {
                alert('删除成功!')

            }

            //重新加载表单
            loadBillMainTable();


        })





        // //初始化过滤器日期组
        // loadDatePickers({
        //     elementIds: [
        //         'filterForm-requestDateB',
        //         'filterForm-requestDateE',
        //         'filterForm-makeDateB',
        //         'filterForm-makeDateE'
        //     ]
        // })


        // //初始化组件
        // loadDatePicker({
        //     elementId: "ppm_requestbillsForm-requestDate",
        // })

        // $("#msgSwitch").bootstrapSwitch({
        //     onText: "是",
        //     offText: "否"
        // });


        // //初始化selector



        // loadBootStrapSelector({
        //     elementId: 'ppm_recordbillsForm-productBelong',
        //     sqlParams: {
        //         sql: 'getOptionSelector',
        //         params: {
        //             filter: 'optionClass="产品归属"',
        //             orderBy: 'orderId'
        //         }
        //     },
        // })

        // loadBootStrapSelectors({
        //     elementIds: [
        //         'ppm_recordbillsForm-isRework',
        //         'ppm_recordbillsForm-urgent',
        //         'ppm_recordbillsForm-inWarranty'
        //     ],
        //     sqlParams: {
        //         sql: 'getOptionSelector',
        //         params: {
        //             filter: 'optionClass="是或否"'
        //         }
        //     },

        // })


        // 关闭事件重置选中datatable选中,避免显示错误
        $('#ppm_requestbillsModal').on('hidden.bs.modal', function () {
            let table = $('#ppm_requestbills').DataTable();
            table.$('tr.selected').removeClass('selected');
            mainTableData = {}

            // //添加监听出来扫描modal关闭 表单modal失效问题
            $(this).removeData('bs.modal');
            $(document.body).addClass("modal-open");
        })

        //自动调整modal显示位置
        $('#scanModal').on('show.bs.modal', function (
            e) {
            // 关键代码，如没将modal设置为 block，则$modala_dialog.height() 为零 
            $(this).css('display', 'block');
            // var modalHeight = $(window).height() / 2;
            let modalHeight = $(window).height() / 3;
            $(this).find('.modal-dialog').css({
                'margin-top': modalHeight
            });
        });

        // //enter键监听
        // $(window).keyup(function (event) {
        //     // var event = ev || event
        //     if (event.keyCode == 13) {
        //         // alert("按了enter键")
        //     }
        // });






    });
</script>