<!-- CSS -->
<link rel="stylesheet" type="text/css" href="/css/PM/PMContent.css">
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/Bootstrap-3.3.7/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/DataTables-1.10.18/css/dataTables.bootstrap.css">
<link href="/css/PM/datetimepicker/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
<link rel="stylesheet" href="/css/PM/bootstrap-select.min.css" />


<!-- JS  -->

<script src="/css/PM/DataTables/Bootstrap-3.3.7/js/bootstrap.min.js"></script>
<script src="/css/PM/bootstrap-select.min.js"></script>
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.min.js" charset="UTF-8"></script>
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>

<script type="text/javascript"  src="/css/PM/DataTables/DataTables-1.10.18/js/jquery.dataTables.min.js"></script>
<script type="text/javascript"  src="/css/PM/DataTables/DataTables-1.10.18/js/dataTables.bootstrap.min.js"></script>
<script src="/js/PM/FileSaver.min.js"></script>
<script src="/js/PM/tableExport.js"></script>
<script src="/js/PM/PMfuns.js"></script>




<% layout(locals.global.theme_layout_dir+'/master.ejs') -%>



<div class="divcontent">
    <h1>工作流程-方案单</h1>
    <hr>

    <!-- 操作区（按钮等） -->
    <div class="lineitem">
        
        
        <!-- 按钮触发模态框 -->

        <button id="BTNBPTInfo" class="btn btn-info" data-toggle="modal" >方案维护</button>
        <button id="BTNBPTAudit" class="btn btn-warning" data-toggle="modal" >方案审核</button>
        <!-- 模态框（Modal） -->
        <div class="modal fade" id="BillBPT" tabindex="-1" role="dialog" aria-labelledby="BillBPTLabel" aria-hidden="true">
            <div class="modal-dialog" style="width:98%">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="BillPLDLabel">方案单面板</h4>
                    </div>
                    <div class="modal-body">
                    
                    <!--------------跟踪面板----------------->
                    
                    <div class="panel panel-info" style="width:20%;float:left;">
                    
                    <!--------------panel--------------------->
                    <div class="panel-heading">
                        <h3 class="panel-title">计划单信息</h3>
                    </div>
                    <div class="panel-body" >
                    
                    <table class="table table-bordered">
                    <tr>
                      <td>计划单号:</td>
                      <td id="Left-billPLD-BPID"></td>
                    </tr>
                    <tr>
                      <td>版本号:</td>
                      <td id="Left-billPLD-version"></td>
                    </tr>
                    <tr>
                       <td>客户名称:</td>
                       <td id="Left-billPLD-CTRName"></td>
                    </tr>
                    
                    <tr>
                    <td>单据状态:</td>
                    <td id="Left-billPLD-auditText"></td>
                    </tr>
                    
                    <tr>
                    <td colspan="2"> 
                    
                    <button type="button" class="btn btn-warning" title="计划单详情"  
            			data-container="body" data-toggle="popover" data-placement="right" 
            			data-content="<div id='billPLDDetailDIV'>ddd</div>">
            		计划单详情
            	    </button>
                    
                    </td> 
                    </tr>
                    
                    
                    </table>
                    
                    
                    
                   
                    
                    </div>
                    <!--------------panel--------------------->
                    <!--------------panel--------------------->
                    <div class="panel-heading">
                        <h3 class="panel-title">方案单信息</h3>
                    </div>
                    
                    <div class="panel-body">
                    
                   
                    </div>
                    <!--------------panel--------------------->
                    </div>
                    
                    
                    
                    
                    <!--------------跟踪面板----------------->
                    
                    <!--------------方案单面板----------------->

                    <div class="panel panel-info" style="width:75%;float:right;">
                	
                    <div class="panel-heading">
                        <h3 class="panel-title">方案单</h3>
                    </div>
                    
                    <div class="panel-body">
                    

                    

                    <form class="form-horizontal" >  
                    
                    <input id="PLDDBID" type="text" value="" style="display:none;">
                    
                    <input id="DBID" type="text" value="" style="display:none;">

                    
                    <input id="auditResult" type="text" value="" style="display:none;">
                    
                    
                   
                     <!-------------------------------------------------------------------------->

                     <div class="form-group">
                       <label class="col-sm-1 control-label">计划单号:</label>
                       <div class="col-sm-3">
                         <input id="BPID" class="form-control"  type="text" value="">
                       </div>
                       
                       <label class="col-sm-1 control-label">客户名称:</label>
                       <div class="col-sm-3">
                         <input id="CTRName" class="form-control"  type="text" value="">
                       </div>

                     </div>
                     
                    
                     
                     <!-------------------------------------------------------------------------->
                     
                     <div class="form-group">
                     <label class="col-sm-1 control-label">方案人:</label>
                     <div class="col-sm-3">
                       <input id="PGEMaker" class="form-control"  type="text" value="">
                     </div>
                     
                     <label for="limitDate" class="col-sm-1 control-label">完成期限:</label>                     
                     <div class="col-sm-3">
                     <input id="limitDate" class="form-control"  type="text" value="">
                     </div>
                     
                     </div>
                     
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     
                     <label class="col-sm-1 control-label">方案单号:</label>
                     <div class="col-sm-3">
                       <input id="BPTID" class="form-control"  type="text" value="">
                     </div>
                     
                     <label class="col-sm-2 control-label">方案单版本号: <span id="version"></span></label>
                     
                     <label class="col-sm-2 control-label">方案单状态: <span id="BPTAuditResultText"></span></label>
                     
                     </div>
                    
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">   
                     
                     <label  class="col-sm-1 control-label" for="name">机型:</label>    
                     <div class="col-sm-3">
                     <select  id="MHEName" class="selectpicker" data-live-search="true"> 
                     </select>
                     </div>  
                     
                     
                     <label  class="col-sm-1 control-label" for="name">系统:</label>    
                     <div class="col-sm-3">
                     <select  id="model" class="selectpicker" data-live-search="true"> 
                     </select>
                     </div>  
                     
                     <label class="col-sm-1 control-label">系统版本:</label>
                     <div class="col-sm-2">
                       <input id="OGNSystemVersion" class="form-control"  type="text" value="">
                     </div>
                    
                     </div>
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">

                    

                 	 </div>

                     <!-------------------------------------------------------------------------->

                     <div class="form-group">
                     
                     <label class="col-sm-1 control-label"> 是否修改:</label>   
                  	 <div class="col-sm-6">
                        
                  	    <label class="radio-inline">
                  	        <input type="radio" name="modifyType" id="modifyTypeOption1" value="1"> 修改
                  	    </label>
                  	    <label class="radio-inline">
                  	        <input type="radio" name="modifyType" id="modifyTypeOption2"  value="2"> 程序已有不处理
                  	    </label>
                  	    <label class="radio-inline">
                 	        <input type="radio" name="modifyType" id="modifyTypeOption3"  value="3"> 要求不合理
                 	    </label> 
                 	        
                 	    <label class="radio-inline">
                	        <input type="radio" name="modifyType" id="modifyTypeOption4"  value="4"> 非常规维护产品
                	    </label>     
                 	    
                  	</div>
                  	
                     </div>
                     
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     
                     <label class="col-sm-1 control-label">修改原因:</label>   
                 	 <div class="col-sm-8">
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" name="modifyReason" id="modifyReasonCheckbox1" value="R1"> 功能修改
                 	    </label>
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" name="modifyReason" id="modifyReasonCheckbox2" value="R2"> 功能新增
                 	    </label>
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" name="modifyReason" id="modifyReasonCheckbox3" value="R3"> 优化
                 	    </label>
                 	    <label class="checkbox-inline">
                	        <input type="checkbox" name="modifyReason" id="modifyReasonCheckbox3" value="R4">测试程序
                	    </label>
                 	 </div>
                 	 
                 	 
                     </div>
                     

                    
                     
                     
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     <label  class="col-sm-1 control-label" for="name">修改方案说明:</label>    
                     <div class="col-sm-8">
                     <textarea id="BPTDescribe" class="form-control" rows="3"></textarea>
                     </div>
                     </div>
                     
                     
 <!-------------------------------------------------------------------------->
                     
                     <div class="form-group">
                     <label  class="col-sm-1 control-label" for="name">上传</label>  
                     
                     <div class="col-sm-8">
                     <input type="file" name="myHead" multiple="multiple" id="fileToUpload" style="display:none;" onchange="fileSelected()" >
                     <a class="btn btn-info" onclick="$('#fileToUpload').click()">选择文件</a>
                     
                     
                 	<input  type="button" class="btn btn-success" onclick="uploadFile()" value="确认上传" >
                 	<input type="button" class="btn btn-warning" onclick="deleteFile()" value="清空附件" >

                     </div>

                 	</div>
                 	
                 	<!-------------------------------------------------------------------------->
                 	 <div class="form-group">
                 	<label  class="col-sm-1 control-label" for="name">附件:</label>
                 	
                 	<div class="col-sm-8">

                 	
                 	<div id="div_previewImages"></div>
                    <div id="progressNumber"></div> 
                    <span id="fileDBID" style="display:none"></span>
                    <div id="divFilesUploaded"></div>
                    
                 	</div>
                 	
                 	
                 	</div>
                     
                     
                    
                     
                 	
                     
                     
                 	
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     <label  class="col-sm-1 control-label" for="name">任务清单:</label>    
                     <div class="col-sm-11">
                     
                     <div class="panel panel-default">
                     <div class="panel-heading">任务清单</div>
                     
                     <div style="margin:10px;">
                  	 <table id="billsTaskTable" class="table table-bordered" style="width:100%;" >
                     <thead>
                         <tr>
                             <th>数据库ID</th>
                             <th>任务单号</th>
                             <th>任务单版本号</th>
                             <th>任务类型</th>
                             <th>任务负责人</th>
                             <th>任务完成期限</th>
                             <th>任务单审核状态</th>
                         </tr>
                     </thead>
                     </table>
                     </div>

                     </div>
                     </div>
                     </div>
                     
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     <label  class="col-sm-1 control-label" for="name">任务管理:</label> 
                     
                     <div class="col-sm-11">
                     
                     <button id="BTNTaskAdd" type="button" class="btn btn-primary">新增任务</button>

                 	 <button id="BTNTaskDel" type="button" class="btn btn-danger">删除任务</button>
                 	 </div>
                 	 </div>
                    
                 	 <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     <label  class="col-sm-1 control-label" for="name"></label> 
                 	 
                     <div class="col-sm-11">

                     
                     <div class="panel panel-default" id="billTaskPanel" >
                     <div class="panel-heading">任务单填写</div>
                     
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     
                     <label class="col-sm-2 control-label">类型:</label>   
                 	 <div class="col-sm-10">
                 	    <label class="radio-inline">
                 	        <input type="radio" name="taskType" id="radio1" value="T1"> DSP任务单
                 	    </label>
                 	    <label class="radio-inline">
                 	        <input type="radio" name="taskType" id="radio2" value="T2"> HMI任务单
                 	    </label>
                 	    <label class="radio-inline">
                 	        <input type="radio" name="taskType" id="radio3" value="T3"> 内核任务单
                 	    </label>
                 	   
                 	        
                 	      
                 	 </div>
                 	 
                 	
                 	
                 	
                     </div>
                     
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     
                     <label class="col-sm-2 control-label">修改属性:</label>   
                 	 <div class="col-sm-8">
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" name="modfiyABE"  value="ABE1"> 画面
                 	    </label>
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" name="modfiyABE"  value="ABE2"> 结构
                 	    </label>
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" name="modfiyABE"  value="ABE3"> 参数
                 	    </label>
                 	        
                 	    <label class="checkbox-inline">
                	        <input type="checkbox" name="modfiyABE"  value="ABE4">通信
                	    </label>   
                	        <label class="checkbox-inline">
                	        <input type="checkbox" name="modfiyABE"  value="ABE5">逻辑
                	    </label>
                	        <label class="checkbox-inline">
                 	        <input type="checkbox" name="modfiyABE"  value="ABE6"> kernel
                 	    </label>
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" name="modfiyABE"  value="ABE7"> LIB
                 	    </label>
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" name="modfiyABE"  value="ABE8"> OS
                 	    </label>
                 	 </div>
                 	 
                 	 
                     </div>
                     <!-------------------------------------------------------------------------->
                     
                     <div class="form-group">
                     
                     <label class="col-sm-2 control-label">任务单号:</label>
                     <div class="col-sm-3">
                       <input id="taskBPID" class="form-control"  type="hidden" value="">

                       <input id="BTID" class="form-control"  type="text" value="">
                     </div>
                     
                     <label class="col-sm-2 control-label">任务单版本号: <span id="BTVersion"></span></label>
                     
                     <label class="col-sm-2 control-label">任务单审核状态: <span id="BTAuditResultText"></span></label>
                    
                     
                     </div>
                     
                     
                     <div class="form-group">  
                     
                     <label  class="col-sm-2 control-label" for="name">负责人:</label>    
                     <div class="col-sm-2">
                     <select  id="taskStaff" class="selectpicker" data-live-search="true"> 
                     </select>
                     </div>
                     
                     <label for="limitDate" class="col-sm-2 control-label">任务完成期限:</label>                     
                     <div class="col-sm-3">
                     <div class="input-group date form_date " data-date="" data-date-format="yyyy-mm-dd" data-link-field="limitDate" data-link-format="yyyy-mm-dd" >
                         <input id="taskLimitDate" class="form-control " size="16" type="text" value="" readonly>
                 		<span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                     </div>
                     <input type="hidden" id="taskLimitDate" value="" />                 	
                 	 </div>

                     </div>
                     <!-------------------------------------------------------------------------->
                     
                     <div class="form-group"> 
                     <label class="col-sm-2 control-label">任务要求:</label>
                     <div class="col-sm-8">
                     <textarea id="taskDBE" class="form-control" rows="2"></textarea>
                     </div>
                     
                     </div>
                     
                    
                    
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     <label class="col-sm-2 control-label"></label>   
                  	 <div class="col-sm-6">
                  	<button id="BTNTaskSave" type="button" class="btn btn-success">保存</button>
                  	
                  	
                  	 </div>
                  	 </div>
                  	
                  	 <!-------------------------------------------------------------------------->


                     </div>
                     
                     
                     
                 	 
                     </div>
                     </div>
                     
                 	 
                 	 
                   
                     
                    
                     <!-------------------------------------------------------------------------->

                     <div class="form-group">  
                     
                     <label  class="col-sm-1 control-label" for="name">制单人:</label>    
                     <div class="col-sm-3">
                     <input id="maker" class="form-control"  type="text" disabled="true" >
                     </div>
                     
                     <label  class="col-sm-1 control-label" for="name">制单日期:</label>    
                     <div class="col-sm-3">
                     <input id="makeDate" class="form-control"  type="text" disabled="true" >
                     </div>
                     
                     
                     </div>
                     
                     <!-------------------------------------------------------------------------->

                     

                  	<div id="auditTypeDiv" class="form-group">
                  	
                  	<label class="col-sm-1 control-label">审核方式:</label>   
                  	<div class="col-sm-6">
                  	    
                  	    <label class="radio-inline">
          	            <input type="radio" name="auditType" id="auditTypeOption1"  value="1"> 暂不审核
          	            </label>
                        
                  	    <label class="radio-inline">
                  	        <input type="radio" name="auditType" id="auditTypeOption2" value="2"> 自我审核
                  	    </label>
                  	    
                  	    <label class="radio-inline">
                 	        <input type="radio" name="auditType" id="auditTypeOption3"  value="3"> 指定审核人
                 	    </label>
                  	        
                  	        
                  	</div>
                      
                     </div>
                     
                     <!-------------------------------------------------------------------------->

                     <div class="form-group">  
                     
                     <label  class="col-sm-1 control-label" for="name">审核人:</label>    
                     <div class="col-sm-3">
                     <select  id="auditor" class="selectpicker" data-live-search="true"> 
                     </select>
                     </div>
                     
                     <label  class="col-sm-1 control-label" for="name">审核日期:</label>    
                     <div class="col-sm-3">
                     <input id="auditDate" class="form-control"  type="text" disabled="true" >
                     </div>
                     
                     
                     </div>
                     
                     <!-------------------------------------------------------------------------->
                     <div class="form-group"> 
                     <label class="col-sm-1 control-label">审核意见:</label>
                     <div class="col-sm-8">
                     <textarea id="BPTAuditOpinion" class="form-control" rows="2"></textarea>
                     </div>
                     
                     </div>

                     </form>
                     
                     
                    

                    </div>
                    
                    <div class="panel-footer">
                    
                    <label class="col-sm-1 control-label"></label>
                    <button id="BTNBPTSave" type="button" class="btn btn-primary">保存方案</button>
                    <button id="BTNBPTUpdate" type="button" class="btn btn-warning">更新版本</button>
                    <button id="BTNBPTAuditYes" type="button" class="btn btn-success">审核通过</button>
                    <button id="BTNBPTAuditNo" type="button" class="btn btn-danger">审核驳回</button>

                    
                    </div>
                   
                    
                   </div>
                   
                  
                   
                   
                   
                   <!--------------方案单面板----------------->

                   
                   
                   <!---------清除浮动---------------------------------->
                   <div style='clear:both'></div>

                    
                    
                    </div>
                    <div class="modal-footer">
                      
                        
                       
                     
                        <button id="BTNBPTClose" type="button" class="btn btn-default" data-dismiss="modal">关闭</button>

                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>
        
        

    </div>
    
    
    
    
    <br/>

    <!--数据呈现区-->
    <table id="billsBPTTable" class="table table-striped table-bordered"  >
        <thead>
            <tr>
                <th>数据库ID</th>
                <th>计划单号</th>
                <th>计划单版本号</th>
                <th>客户简称</th>
                <th>计划单完成期限</th>
                <th>方案人</th>
                <th>方案单号</th>
                <th>方案单版本号</th>
                <th>方案单状态</th>

            </tr>
        </thead>
    </table>

    
</div>


<script>


//函数:计划单号生成规则

function Fun_billIDCreate(para){
	var BillID=new Date(Ndate).Format("yyyyMMdd")+para+Math.floor(Math.random()*1000);
	return BillID;
}

//函数 获取checkbox值
function getCheckBoxValue(CBName){
	var test = $("input[name='"+CBName+"']:checked");
	var checkBoxValue = ""; 
	test.each(function(){
		checkBoxValue += $(this).val()+",";
	})
	checkBoxValue = checkBoxValue.substring(0,checkBoxValue.length-1);
	console.log("checkBoxValue:"+checkBoxValue);
	return checkBoxValue;
}
//函数 设定根据值设定checkbox选中状态
function setCheckBoxValue(CBName,CBVals){

	var checkBox = CBVals;
	
	if(CBVals!=null){
		var checkBoxArray = checkBox.split(",");
		for(var i=0;i<checkBoxArray.length;i++){
			$("input[name='"+CBName+"']").each(function(){
				if($(this).val()==checkBoxArray[i]){
					
					console.log("thisval:"+$(this).val());
					console.log("checkBoxArray:"+checkBoxArray[i]);
					console.log("this:"+JSON.stringify(this));
					
					$(this).prop('checked', true);
				}
			})
		}
		
	}

}

//函数:详情按钮详情页自动填写内容1:所有情况必定加载------------------------

function Fun_BPTDetailInitPart1(dataSelect){
	
	
	$('#PLDDBID').val(dataSelect.PLDDBID); 	
	
    $('#DBID').val(dataSelect.DBID); 	
	
	$('#BPID').val(dataSelect.BPID); 
	$("#BPID").attr("disabled",true);
	
	$('#CTRName').val(dataSelect.CTRName); 
	$("#CTRName").attr("disabled",true);
	
	$('#BPTID').val(dataSelect.BPID); 
	$("#BPTID").attr("disabled",true);
	
//	var BPTID=Fun_billIDCreate('FA');
//	$('#BPTID').val(BPTID); 
	
	$('#PGEMaker').val(dataSelect.PGEMaker); 
	$("#PGEMaker").attr("disabled",true);
	
	$('#limitDate').val(dataSelect.limitDate); 
	$("#limitDate").attr("disabled",true);
	
	$('#taskLimitDate').val(dataSelect.limitDate); 

	if(dataSelect.version==null){
		$('#version').text(0); 
	}else{
		$('#version').text(dataSelect.version); 
	}
	
	
	$('#BPTAuditResultText').text(dataSelect.BPTAuditResultText);
//	//设定初始化的select值,如果方案单有数据加载方案单数据,如没有加载计划单数据
//	if(dataSelect.MHEName==""){
//		var showMHEName=dataSelect.PLDMHEName;
//	}else{
//		var showMHEName=dataSelect.MHEName;
//	}
//	
//	if(dataSelect.model==""){
//		var showModel=dataSelect.PLDModel;
//	}else{
//		var showModel=dataSelect.model;
//	}
	
	
	
	
	$('#OGNSystemVersion').val(dataSelect.OGNSystemVersion); 
	
	$('#billTaskPanel').hide();
	
	$('#taskBPID').val(dataSelect.BPID); 

	$('.form_date').datetimepicker({
	      language:  'zh-CN',
	      weekStart: 1,
	      todayBtn:  1,
			autoclose: 1,
			todayHighlight: 1,
			startView: 2,
			minView: 2,
			forceParse: 0,
			startDate:Ndate,//设置最小日期
			endDate:dataSelect.limitDate//设置最大日期
	  });
	
	tasksTableSQL={"SQL":"SQLTableBillsTask","filter":"taskBPID = '"+dataSelect.BPID+"'"};

	tasksTableInfo={
				"tableID":"#billsTaskTable",
				"columnsData":[
					{ data: 'DBID' ,"visible": false},
			        { data: 'BTID' },
			        { data: 'BTVersion'},
			        { data: 'taskTypeText'},
			        { data: 'taskStaff'},
			        { data: 'taskLimitDate'},
			        { data: 'BTAuditResultText'}
				]
	     }

}

//函数:详情按钮详情页自动填写内容2:方案单审核状态为0,1,2时加载------------------------

function Fun_BPTDetailInitPart2(dataSelect){
	switch(dataSelect.modifyType){
	  case 1:
		  $("#modifyTypeOption1").prop("checked",true);
		  break;
	  case 2:
		  $("#modifyTypeOption2").prop("checked",true);
		  break;
	  case 3:
		  $("#modifyTypeOption3").prop("checked",true);
		  break;  
    case 4:
	      $("#modifyTypeOption4").prop("checked",true);
	      break;  
	  default:
		  $("#modifyTypeOption1").prop("checked",true);
    }
	
	 if(dataSelect.modifyReason!=null){
		 setCheckBoxValue("modifyReason",dataSelect.modifyReason);
	 }
	 
	 $('#BPTDescribe').val(dataSelect.BPTDescribe); 
	 
	 var Para={"billName":"ppm_bills_blueprint","billID":dataSelect.BPTID,"billVersion":dataSelect.version}
	 Fun_getBillFile(Para,"#divFilesUploaded",true);
	 

	  Fun_showSQLLiteTable(tasksTableSQL,tasksTableInfo);
	  $('#maker').val(dataSelect.maker);
	  $('#makeDate').val(dataSelect.makeDate);
	  
	  var SQLAuditor={SQL:"SQLSRStaffs"};
	  var auditor="#auditor";
	  Fun_getSQLSelectDBData(SQLAuditor,auditor,dataSelect.auditor);
	  $("#auditor").attr("disabled",true);

	
}


//函数:详情按钮详情页自动填写内容------------------------
function Fun_BPTDetailInit(dataSelect){
	
	Fun_BPTDetailInitPart1(dataSelect);
	var auditResult=dataSelect.auditResult;
	
	var auditor=dataSelect.auditor;
//	var auditor=Fun_getSelectText($('#auditor option:selected').text());
	console.log("Fun_BPTDetailInit auditor:"+auditor);
	
	if(auditResult==null){
		var SQLMHEName={SQL:"SQLSRMachines"};
		var MHEName="#MHEName";
		Fun_getSQLSelectDBData(SQLMHEName,MHEName,dataSelect.PLDMHEName);
		
		var SQLModel={SQL:"SQLSRSystems"};
		var model="#model";
		Fun_getSQLSelectDBData(SQLModel,model,dataSelect.PLDModel);
	}else{
		var SQLMHEName={SQL:"SQLSRMachines"};
		var MHEName="#MHEName";
		Fun_getSQLSelectDBData(SQLMHEName,MHEName,dataSelect.MHEName);
		
		var SQLModel={SQL:"SQLSRSystems"};
		var model="#model";
		Fun_getSQLSelectDBData(SQLModel,model,dataSelect.model);
		
	}
	
	
	
	if(auditor==null){
		 $("#auditTypeOption1").prop("checked",true);
	}else{
		$("#auditTypeOption3").prop("checked",true);
	}
	
	
	

	switch(auditResult){
	case null:
		
		

		 $("#modifyTypeOption1").prop("checked",true);
		 $('#maker').val(sessionName); 
		
		 
		 $("#BTNBPTSave").show();
		 $("#BTNBPTUpdate").hide();
		 $("#BTNBPTAuditYes").hide();
		 $("#BTNBPTAuditNo").hide();
		 
		 break;
	case 0:
		Fun_BPTDetailInitPart2(dataSelect);

		 $("#BTNBPTSave").show();
		 $("#BTNBPTUpdate").hide();
		 
		 if(auditor==""){
			 console.log("auditor case0:"+auditor)
			 
			 $("#BTNBPTAuditYes").hide();
			 $("#BTNBPTAuditNo").hide();
			 
		 }else{
			 $("#BTNBPTAuditYes").show();
			 $("#BTNBPTAuditNo").show();
		 }
		 
		 
		break;
	default:
		Fun_BPTDetailInitPart2(dataSelect);
	
	  $('#auditDate').val(dataSelect.auditDate);
	  $('#BPTAuditOpinion').val(dataSelect.BPTAuditOpinion);
	    
	   $("#BTNBPTSave").hide();
	   $("#BTNBPTUpdate").show();
	   $("#BTNBPTAuditYes").hide();
	   $("#BTNBPTAuditNo").hide();

	
	}


}

//函数-根据自定义SQL获取数据加载Task表格,不显示搜索分页,简易模式


function Fun_showSQLLiteTable(SQL,tableInfo){
	
	//alert(JSON.stringify(DataPara));
		
		$(tableInfo.tableID).DataTable().destroy();//销毁原数据表格,防止加载错误
		
		$(tableInfo.tableID).DataTable({
		    ajax: {
		        url: '/app/PM/getSQLDBData',
		        data:SQL,
		        dataSrc: ''
		    },
		    columns: tableInfo.columnsData,
		    aaSorting: [0, 'desc'],//默认排序
		    paging: false, // 禁止分页
		    bFilter: false,    //去掉搜索框方法三：这种方法可以
//	        bLengthChange: false,   //去掉每页显示多少条数据方法
		    "language": languageCN
		});
		
		//判断是否选中数据-------
		
		 $(tableInfo.tableID+' tbody').unbind();//解除事件绑定,防止重复定义.
		 
		 var tableTask = $(tableInfo.tableID).DataTable();
		 
		 $(tableInfo.tableID+' tbody').on('click', 'tr', function() {
			 
			 
			 
		     if ($(this).hasClass('selected')) {
		         $(this).removeClass('selected');
		         $('#billTaskPanel').hide();
		     } else {
		    	 tableTask.$('tr.selected').removeClass('selected');
		         $(this).addClass('selected');
		         $('#billTaskPanel').show();
		         
		         var dataSelectTask = tableTask.row('.selected').data();
			     
			     console.log("dataSelectTask:"+JSON.stringify(dataSelectTask));
			     
			     //控制其他组件防止误操作.bear

			     $("input:radio[name=taskType][value="+dataSelectTask.taskType+"]").prop("checked",true); 
			     $('input:radio[name="taskType"]').attr("disabled",true);
			     
			     
			 	 $('input:checkbox[name="modfiyABE"]').prop("checked",false);
			 	 
			     setCheckBoxValue("modfiyABE",dataSelectTask.modfiyABE);
			     
			     
			     $("#BTID").val(dataSelectTask.BTID);
			     $("#BTID").attr("disabled","true");
			     
			    var SQLTaskStaff={SQL:"SQLSRStaffs"};
				var taskStaff="#taskStaff";
				Fun_getSQLSelectDBData(SQLTaskStaff,taskStaff,dataSelectTask.taskStaff);	 

				 $("#BTVersion").text(dataSelectTask.BTVersion);
				 
				 $("#BTAuditResultText").text(dataSelectTask.BTAuditResultText);
		         
				 $("#taskDBE").val(dataSelectTask.taskDBE);

		     }

		 });

}



//函数-添加任务单,并刷新任务单列表
function Fun_addTask(DBData) {
	
    $.ajax({
        method: 'post',
        url: '/app/PM/addDBData',
        data: DBData,
        success: function(data) {
//            alert("成功数据:" + JSON.stringify(data));
           if (data.affectedRows != 0) {
               alert("新增任务单成功!");
          	   Fun_showSQLLiteTable(tasksTableSQL,tasksTableInfo);
          	   $('#BTNTaskAdd').click();
          	   $('#billTaskPanel').hide();

           }
       },
       error:function(err){
       	alert("失败数据:"+JSON.stringify(err));
       }
    });
}


///函数-更新任务单,并刷新任务单列表
function Fun_updTask(DBData) {
    $.ajax({
        method: 'post',
        url: '/app/PM/updDBData',
        data: DBData,
        success: function(data, textStatus) {
 //                alert("成功数据:"+JSON.stringify(data));
            if (data.changedRows != 0) {
                alert("更新任务单数据成功!");
                
                Fun_showSQLLiteTable(tasksTableSQL,tasksTableInfo);
                
                $('#BTNTaskAdd').click();
           	    $('#billTaskPanel').hide();

            } else {
                alert("未有任务单数据更新!");
            }
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {}
    });
}


//函数-添加任务单,并刷新任务单列表
function Fun_delTask(IDData) {
    $.ajax({
        method: 'post',
        url: '/app/PM/delDBData',
        data: IDData,
        success: function(data, textStatus) {
            //  alert("成功数据:"+JSON.stringify(data));
            if (data.affectedRows != 0) {
                alert("删除任务单成功!");
             	   Fun_showSQLLiteTable(tasksTableSQL,tasksTableInfo);
             	  $('#BTNTaskAdd').click();
             	  $('#billTaskPanel').hide();
                
            } else {
                alert("删除任务单失败!");
            }
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {}
    });
}
//函数:添加方案单附件记录
function Fun_addPGEFile(){
	
	

	var billID=$('#BPTID').val();
	console.log("fileKey:"+$('#filePath').attr('href'));
	var fileKey=$('#filePath').attr('href').substring(30);//去掉多余的字符串前缀
	var fileName=$('#fileName').html();
	var fileData={
			"DBTable":"ppm_files_upload",
			"billName":"ppm_bills_blueprint",
			"billID":billID,
			"billVersion":$('#version').text(),
			"fileKey":fileKey,
			"fileName":fileName
	}
	
	if(fileKey!=undefined){
		Fun_addFileInfo(fileData);
	}
}

//函数:添加方案单附件记录
function Fun_updPGEFile(){

	var billID=$('#BPTID').val();
	var fileDBID=$('#fileDBID').html();
	console.log("fileKey:"+$('#filePath').attr('href'));
	var fileKey=$('#filePath').attr('href').substring(30);//去掉多余的字符串前缀
	var fileName=$('#fileName').html();
	var fileData={
			"DBTable":"ppm_files_upload",
			"DBID":fileDBID,
			"billName":"ppm_bills_blueprint",
			"billID":billID,
			"billVersion":$('#version').text(),
			"fileKey":fileKey,
			"fileName":fileName
	}
	
	console.log("upd:"+JSON.stringify(fileData));
		Fun_updFileInfo(fileData);

}






//页面加载函数---------------
$(document).ready( function () {
	
	
    tableSQL={"SQL":"SQLTableBillsBPT"};
	
    sessionName="<%-locals.session.yjUser.Name%>";
	
//	console.log("sessionName:"+sessionName);
	
	
    tableInfo={
			"tableID":"#billsBPTTable",
			"columnsData":[
				{ data: 'DBID' ,"visible": false},
		        { data: 'BPID' },
		        { data: 'PLDVersion'},
		        { data: 'CTRName'},
		        { data: 'limitDate'},
		        { data: 'PGEMaker'},
		        { data: 'BPTID'},
		        { data: 'version'},
		        { data: 'BPTAuditResultText'}

			]
	}

	Fun_showSQLTable(tableSQL,tableInfo);

	
//判断是否选中数据-------
var table = $('#billsBPTTable').DataTable();
$('#billsBPTTable tbody').on('click', 'tr', function() {
    if ($(this).hasClass('selected')) {
        $(this).removeClass('selected');
    } else {
        table.$('tr.selected').removeClass('selected');
        $(this).addClass('selected');
    }
 
    var dataSelect = table.row('.selected').data();


});




//定义左侧跟踪栏按钮效果,设定可添加html
$("[data-toggle='popover']").popover({html : true });
	

////按钮-新增计划单---------
//$('#BTNAdd').click(function() {
//	$('#BillBPT').modal('show');
//	Fun_winAddInit();
// 
//});



//radio 定义更换按键触发事件-----------
$('input:radio[name="auditType"]').click(function(){
	var radioValue = $('input:radio[name="auditType"]:checked').val(); 
//	alert(radioValue);
	
	switch(radioValue){
	case "1":
		var SQLAuditor={SQL:"SQLSRStaffs"};
		var auditor="#auditor";
		Fun_getSQLSelectDBData(SQLAuditor,auditor);
	    $("#auditor").attr("disabled",true);
	    $('#auditDate').val("");
	    $('#auditResult').val("");

	    break;
	case "2":

	    var SQLAuditor={SQL:"SQLSRStaffs"};
		var auditor="#auditor";
		Fun_getSQLSelectDBData(SQLAuditor,auditor,sessionName);	 
	    $("#auditor").attr("disabled",true);
	    $('#auditDate').val("");
	    $('#auditResult').val(0);
	    break;
	case "3":
	
	    $('#auditDate').val("");
	    var SQLAuditor={SQL:"SQLSRStaffs"};
		var auditor="#auditor";
		Fun_getSQLSelectDBData(SQLAuditor,auditor);
	    $("#auditor").attr("disabled",false);
	    $('#auditResult').val(0);
	    break;
		
	
	}

});


//radio 定义taskType更换按键触发事件-----------
$('input:radio[name="taskType"]').click(function(){
	var radioValue = $('input:radio[name="taskType"]:checked').val(); 
	
	switch(radioValue){
	case "T1":
		var BTID=Fun_billIDCreate('DSP');
		$('#BTID').val(BTID);
		
	    break;
	case "T2":
		var BTID=Fun_billIDCreate('HMI');
		$('#BTID').val(BTID);
	
	    break;
	case "T3":
		var BTID=Fun_billIDCreate('KEN');
		$('#BTID').val(BTID);
		
	    break;

	}

});




//按钮-方案维护--------
$('#BTNBPTInfo').click(function() {
    console.log("seclet: "+JSON.stringify(table.row('.selected').data()));
    // table.row('.selected').remove().draw( false );
    var dataSelect = table.row('.selected').data();
    if (dataSelect == undefined) {
        alert("请点击表格先选中需要维护方案的计划单!");
    } else {
    	
    	$('#BillBPT').modal('show');
    	Fun_BPTDetailInit(dataSelect);
    	

    }
});


//按钮-方案审核--------
$('#BTNBPTAudit').click(function() {
    console.log("seclet: "+JSON.stringify(table.row('.selected').data()));
    // table.row('.selected').remove().draw( false );
    var dataSelect = table.row('.selected').data();
    if (dataSelect == undefined) {
        alert("请点击表格先选中需要审核的方案!");
    } else {
    	
    	switch(dataSelect.auditResult){
    	case null:
    		alert("该计划单不存在方案,请与方案人确认!");
    		break;
    	case 0:
    		$('#BillBPT').modal('show');
        	Fun_BPTDetailInit(dataSelect);
        	$('#BTNBPTSave').hide();
        	break;
    	default:
    		alert("该方案已经审核,无需再次审核!");
    	
    	}

    }
});









//按钮-任务新增

$('#BTNTaskAdd').click(function(){
	

	
	$('#billTaskPanel').show();
	
	$('input:radio[name="taskType"]').prop("checked",false);
	
	$('input:radio[name="taskType"]').attr("disabled",false);
	
	$('input:checkbox[name="modfiyABE"]').prop("checked",false);
	
	$('#BTID').val(""); 
	
	$('#BTVersion').text(0); 
	$('#BTAuditResultText').text('新增');
	
	var SQLTaskStaff={SQL:"SQLSRStaffs"};
	var taskStaff="#taskStaff";
	Fun_getSQLSelectDBData(SQLTaskStaff,taskStaff);
	
	$('#taskDBE').val(""); 


});


//按钮-任务删除---------
$('#BTNTaskDel').click(function() {
	
	var tableTask = $('#billsTaskTable').DataTable();
    var dataSelectTask = tableTask.row('.selected').data();
    
   console.log(JSON.stringify(dataSelectTask));
    
    if (dataSelectTask == undefined) {
        alert("未选择任何任务单,请在任务清单中选中需要删除的任务单!");
    } else {

    	if(dataSelectTask.BTAuditResult!=0){
    		alert("已审核单据禁止删除!");
    	}else{

    		var msg = confirm("风险操作！此行数据内容移除后无法还原，请确认操作是否无误！");
            if (msg === true) {

                    var IDData = {"DBTable":"ppm_bills_task","DBID":dataSelectTask.DBID};
 //                   console.log("IDData:"+JSON.stringify(IDData));
                    Fun_delTask(IDData);
            
            }
    		
    		
    	}

    }
   
});


//按钮-任务保存

$('#BTNTaskSave').click(function(){

	var taskType = $('input:radio[name="taskType"]:checked').val();
	var taskBPID=$('#taskBPID').val();
	var modfiyABE=getCheckBoxValue('modfiyABE');
	
	var BTAuditResultText=$('#BTAuditResultText').text();
	
	switch(BTAuditResultText){
	case '新增':
		var billData={
		"DBTable":"ppm_bills_task",
		"BTID":$('#BTID').val(),
		"BTVersion":0,
		"taskBPID":taskBPID,
		"taskType":$('input:radio[name="taskType"]:checked').val(),
		"taskStaff":$('#taskStaff option:selected').text(),
		"modfiyABE":modfiyABE,
		"taskDBE":$('#taskDBE').val(),
		"taskLimitDate":$('#taskLimitDate').val(),
		"BTAuditResult":0,
		"BTStatus":1
        }
		
        console.log("billData:"+JSON.stringify(billData));
        Fun_addTask(billData);
	
	break;
	case '未审核':
		
		var tableTask = $('#billsTaskTable').DataTable();
	    var dataSelectTask = tableTask.row('.selected').data();
		
		var billData={
		"DBTable":"ppm_bills_task",
		"DBID":dataSelectTask.DBID,
		"BTID":$('#BTID').val(),
		"BTVersion":0,
		"taskBPID":taskBPID,
		"taskType":$('input:radio[name="taskType"]:checked').val(),
		"taskStaff":$('#taskStaff option:selected').text(),
		"modfiyABE":modfiyABE,
		"taskDBE":$('#taskDBE').val(),
		"taskLimitDate":$('#taskLimitDate').val(),
		"BTAuditResult":0,
		"BTStatus":1
        }
		
        console.log("billData:"+JSON.stringify(billData));
		Fun_updTask(billData);
	
	break;
	
	default:
		
		var msg = confirm("风险操作！已审核任务单不允许修改,如保存将更新任务单版本!");
        if (msg === true){
        	
        	var tableTask = $('#billsTaskTable').DataTable();
            var dataSelectTask = tableTask.row('.selected').data();
        	
            var billData={
            		"DBTable":"ppm_bills_task",
            		"BTID":dataSelectTask.BTID,
            		"BTVersion":dataSelectTask.BTVersion+1,
            		"taskBPID":taskBPID,
            		"taskType":$('input:radio[name="taskType"]:checked').val(),
            		"taskStaff":$('#taskStaff option:selected').text(),
            		"modfiyABE":modfiyABE,
            		"taskDBE":$('#taskDBE').val(),
            		"taskLimitDate":$('#taskLimitDate').val(),
            		"BTAuditResult":0,
            		"BTStatus":1
                    }
            		
                    console.log("billData:"+JSON.stringify(billData));
                    Fun_addTask(billData);
        	
        }

	
    }
	


});




//按钮-方案保存

$('#BTNBPTSave').click(function(){
	
	var BPID=$('#BPID').val();
	var BPTID=$('#BPTID').val();
	var version=$('#version').text();
	var CTRName=$('#CTRName').val();
	var PGEMaker=$('#PGEMaker').val();
	var limitDate=$('#limitDate').val();
    var	MHEName=Fun_getSelectText($('#MHEName option:selected').text());
    var	model=Fun_getSelectText($('#model option:selected').text());
    var OGNSystemVersion=$('#OGNSystemVersion').val();
    
    
    
    var modifyType=$('input:radio[name="modifyType"]:checked').val();
    var	modifyReason=getCheckBoxValue("modifyReason");
    var BPTDescribe=$('#BPTDescribe').val();
    var auditor=Fun_getSelectText($('#auditor option:selected').text());
    console.log("auditor:"+auditor);
    

    var BPTAuditResultText=$('#BPTAuditResultText').text();
    
    switch(BPTAuditResultText){
    case '无方案':
    	var billData={
			"DBTable":"ppm_bills_blueprint",
			"BPID":BPID,
			"BPTID":BPTID,
			"version":version,
			"CTRName":CTRName,
			"PGEMaker":PGEMaker,
			"limitDate":limitDate,
			"MHEName":MHEName,
			"model":model,
			"OGNSystemVersion":OGNSystemVersion,
			"modifyType":modifyType,
			"modifyReason":modifyReason,
			"BPTDescribe":BPTDescribe,
			"maker":sessionName,
			"makeDate":Ndate,
			"auditResult":0,
			"auditor":auditor
			}
    	
    	console.log("无方案 billData:"+JSON.stringify(billData));
    	
    	if(auditor!=null&&auditor!=""){
    		var DDMsg={"Msg":billData.auditor+"您已被指定为,方案单号:"+billData.BPTID+"的审核人,请注意审核!"};
    		Fun_addDBDataDD(billData,DDMsg);
    		Fun_addPGEFile();
    		
    	}else{
    		
    		
    		console.log("billData:"+JSON.stringify(billData));
        	addDBData(billData);
        	Fun_addPGEFile();
    	}

    	break;
    	
    case '未审核':
    	var DBID=$('#DBID').val();
    	var fileDBID=$('#fileDBID').text();
    	
    	var billData={
			"DBTable":"ppm_bills_blueprint",
			"DBID":DBID,
			"BPID":BPID,
			"BPTID":BPTID,
			"version":version,
			"CTRName":CTRName,
			"PGEMaker":PGEMaker,
			"limitDate":limitDate,
			"MHEName":MHEName,
			"model":model,
			"OGNSystemVersion":OGNSystemVersion,
			"modifyType":modifyType,
			"modifyReason":modifyReason,
			"BPTDescribe":BPTDescribe,
			"maker":sessionName,
			"makeDate":Ndate,
			"auditResult":0,
			"auditor":auditor
			}
    	
    	console.log("未审核 billData:"+JSON.stringify(billData));
    	
    	if(fileDBID==""){
    		Fun_addPGEFile();
    	}else{
    		Fun_updPGEFile();
    	}

    	if(auditor!=null&&auditor!=""){
    		var DDMsg={"Msg":billData.auditor+"您已被指定为,方案单号:"+billData.BPTID+"的审核人,请注意审核!"};
    		Fun_updDBDataDD(billData,DDMsg,'方案');
    	}else{
    		console.log("billData:"+JSON.stringify(billData));
        	updDBData(billData,"方案");
        	
    	}

    	break;

    }
    
    
    window.location.reload();

});






//按钮-表单审核通过按钮
$('#BTNBPTAuditYes').click(function() {
	
	if(sessionName==$('#auditor option:selected').text()){
		var msg = confirm("审核后无法修改单据,是否立即审核通过?");
		if(msg==true){	
			
			var BPTAuditData={
					"DBTable":"ppm_bills_blueprint",
					"DBID":$('#DBID').val(),
					"auditor":sessionName,
					"auditDate":Ndate,
					"auditResult":1,
					"BPTAuditOpinion":$('#BPTAuditOpinion').val()
			}
			
			updDBData(BPTAuditData,"方案审核状态");
			
			
			var PLDUpdData={
					"DBTable":"ppm_bills_plan",
					"DBID":$('#PLDDBID').val(),
					"WFStatus":20
			}
			
			updDBData(PLDUpdData,"计划单流程状态");
			
			window.location.reload();
		}
	}else{
		alert("审核人未指定或,当前账号非该单据的指定审核人,不允许审核!");
	}


});

//按钮-表单审核驳回按钮
$('#BTNBPTAuditNo').click(function() {
	
	if(sessionName==$('#auditor option:selected').text()){
		var msg = confirm("如计划单信息有误,可先修改后再审核,驳回后此单立即完结,是否立即审核驳回?");
		if(msg==true){	
			
			var BPTAuditData={
					"DBTable":"ppm_bills_blueprint",
					"DBID":$('#DBID').val(),
					"auditor":sessionName,
					"auditDate":Ndate,
					"auditResult":2,
					"BPTAuditOpinion":$('#BPTAuditOpinion').val()
			}
			
			updDBData(BPTAuditData,"方案审核状态");
			
			
			var PLDUpdData={
					"DBTable":"ppm_bills_plan",
					"DBID":$('#PLDDBID').val(),
					"WFStatus":19
			}
			
			updDBData(PLDUpdData,"计划单流程状态");
			
			window.location.reload();
		}
	}else{
		alert("审核人未指定或,当前账号非该单据的指定审核人,不允许审核!");
	}


});



//按钮-表单关闭按钮,添加刷新数据功能
$('#BTNBPTClose').click(function() {
	 window.location.reload();
});
	
}); 

</script>
