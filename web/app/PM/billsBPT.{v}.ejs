<!-- CSS -->
<link rel="stylesheet" type="text/css" href="/css/PM/PMContent.css">
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/Bootstrap-3.3.7/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/DataTables-1.10.18/css/dataTables.bootstrap.css">
<link href="/css/PM/datetimepicker/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
<link rel="stylesheet" href="/css/PM/bootstrap-select.min.css" />


<!-- JS  -->

<script src="/css/PM/DataTables/Bootstrap-3.3.7/js/bootstrap.min.js"></script>
<script src="/css/PM/bootstrap-select.min.js"></script>
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.min.js" charset="UTF-8"></script>
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>

<script type="text/javascript"  src="/css/PM/DataTables/DataTables-1.10.18/js/jquery.dataTables.min.js"></script>
<script type="text/javascript"  src="/css/PM/DataTables/DataTables-1.10.18/js/dataTables.bootstrap.min.js"></script>
<script src="/js/PM/FileSaver.min.js"></script>
<script src="/js/PM/tableExport.js"></script>
<script src="/js/PM/PMfuns.js"></script>




<% layout(locals.global.theme_layout_dir+'/master.ejs') -%>



<div class="divcontent">
    <h1>工作流程-方案单</h1>
    <hr>

    <!-- 操作区（按钮等） -->
    <div class="lineitem">


        <!-- 按钮触发模态框 -->

        <button id="BTNBPTInfo" class="btn btn-info" data-toggle="modal" >方案维护</button>
        <button id="BTNBPTAudit" class="btn btn-warning" data-toggle="modal" >方案审核</button>
        <!-- 模态框（Modal） -->
        <div class="modal fade" id="BillBPT" tabindex="-1" role="dialog" aria-labelledby="BillBPTLabel" aria-hidden="true">
            <div class="modal-dialog" style="width:70%">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="BillPLDLabel">方案单面板</h4>
                    </div>
                    <div class="modal-body">
                    
                    
                    <!---折叠------------------------>
                    
                    <div class="panel-group" id="accordion">
                	
                	<div class="panel panel-default">
                		<div class="panel-heading">
                			<h4 class="panel-title">
                				<a data-toggle="collapse" data-parent="#accordion" 
                				   href="#collapseTrack" >
                					流程跟踪面板:点击可收起
                				</a>
                			</h4>
                		</div>
                		<div id="collapseTrack" class="panel-collapse collapse in" >
                			<div class="panel-body">
                			
                			 <!--------------panel--------------------->
                             
                             <h3 class="panel-title">计划单信息</h3>
                             </br>
                            

                             <table id="tableTrackPLD" class="table table-bordered">
                             <thead></thead>
                             
                             <tbody></tbody>
                             </table>

                             
                             <!--------------panel--------------------->
                			</div>
                		</div>
                	</div>
                	
                </div>
                    
                <!---折叠------------------------>
                    
                    
                    
                    



                    <!--------------方案单面板----------------->

                    <div class="panel panel-info" >

                    <div class="panel-heading">
                        <h3 class="panel-title">方案单</h3>
                    </div>

                    <div class="panel-body">




                    <form class="form-horizontal" >

                    <input id="PLDDBID" type="text" value="" style="display:none;">

                    <input id="DBID" type="text" value="" style="display:none;">


                    <input id="auditResult" type="text" value="" style="display:none;">
                    
                    <div  style="z-index:999;position:absolute;right:50px" >
                    <img id="DivAuditImage" src="">
                    </div>



                     <!-------------------------------------------------------------------------->
                     
                     <div id="DIVPLDInfo">
                     
                     <!-------------------------------------------------------------------------->

                     <div class="form-group">
                       <label class="col-sm-1 control-label">计划单号:</label>
                       <div class="col-sm-3">
                         <input id="BPTBPID" class="form-control"  type="text" value="">
                       </div>

                       <label class="col-sm-1 control-label">客户名称:</label>
                       <div class="col-sm-3">

                         <select  id="CTRName" class="selectpicker" data-live-search="true">
                         </select>
                       </div>

                     </div>



                     <!-------------------------------------------------------------------------->

                     <div class="form-group">
                     <label class="col-sm-1 control-label">方案人:</label>
                     <div class="col-sm-3">
                       <input id="PGEMaker" class="form-control"  type="text" value="">
                       
                     </div>

                     <label for="limitDate" class="col-sm-1 control-label">完成期限:</label>
                     <div class="col-sm-3">
                     <input id="limitDate" class="form-control"  type="text" value="">
                     </div>

                     </div>

                     <!-------------------------------------------------------------------------->
                     <div class="form-group">

                     <label class="col-sm-1 control-label">方案单号:</label>
                     <div class="col-sm-3">
                       <input id="BPTID" class="form-control"  type="text" value="">
                     </div>

                     <label class="col-sm-2 control-label">方案单版本号: <span id="BPTVersion"></span></label>
                     
                     <div style="display:none;">
                     <label class="col-sm-2 control-label">方案单状态: <span id="BPTStatusText" ></span></label>
                     </div>

                     </div>

                     <!-------------------------------------------------------------------------->
                     
                     </div>
                     <!-------end div pLd info------------------------------------------------------------------->
                     
                     
                     <div class="form-group">

                     <label  class="col-sm-1 control-label" for="name">机型:</label>
                     <div class="col-sm-3">
                     <select  id="MHEName" class="selectpicker" data-live-search="true" data-dropup-auto="false">
                     </select>
                     </div>


                     <label class="col-sm-2 control-label">原系统版本:</label>
                     <div class="col-sm-2">
                       <input id="OGNSystemVersion" class="form-control"  type="text" value="">
                     </div>

                     </div>
                     
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     
                     <label  class="col-sm-1 control-label" for="name">系统:</label>
                     <div class="col-sm-3">
                     <select  id="modelD" class="selectpicker" data-live-search="true" data-dropup-auto="false">
                     </select>
                     </div>
                     
                     <div class="col-sm-3">
                     <select  id="modelH" class="selectpicker" data-live-search="true" data-dropup-auto="false">
                     </select>
                     </div>
                     
                     </div>
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">



                 	 </div>

                     <!-------------------------------------------------------------------------->

                     <div class="form-group">

                     <label class="col-sm-1 control-label"> 是否修改:</label>
                  	 <div class="col-sm-6">

                  	    <label class="radio-inline">
                  	        <input type="radio" name="modifyType" id="modifyTypeOption1" value="1"> 修改
                  	    </label>
                  	    <label class="radio-inline">
                  	        <input type="radio" name="modifyType" id="modifyTypeOption2"  value="2"> 程序已有不处理
                  	    </label>
                  	    <label class="radio-inline">
                 	        <input type="radio" name="modifyType" id="modifyTypeOption3"  value="3"> 要求不合理
                 	    </label>

                 	    <label class="radio-inline">
                	        <input type="radio" name="modifyType" id="modifyTypeOption4"  value="4"> 非常规维护产品
                	    </label>

                  	</div>

                     </div>

                     <!-------------------------------------------------------------------------->
                     <div class="form-group">

                     <label class="col-sm-1 control-label">修改原因:</label>
                 	 <div class="col-sm-8">
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" name="modifyReason" id="modifyReasonCheckbox1" value="R1"> 功能修改
                 	    </label>
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" name="modifyReason" id="modifyReasonCheckbox2" value="R2"> 功能新增
                 	    </label>
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" name="modifyReason" id="modifyReasonCheckbox3" value="R3"> 优化
                 	    </label>
                 	    <label class="checkbox-inline">
                	        <input type="checkbox" name="modifyReason" id="modifyReasonCheckbox3" value="R4">测试程序
                	    </label>
                 	 </div>


                     </div>





                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     <label  class="col-sm-1 control-label" for="name">修改方案说明:</label>
                     <div class="col-sm-8">
                     <textarea id="BPTDescribe" class="form-control" rows="3"></textarea>
                     </div>
                     </div>


                      <!-------------------------------------------------------------------------->

                     <div class="form-group" id="DivFileBTNS">
                     <label  class="col-sm-1 control-label" for="name">上传</label>

                     <div class="col-sm-8">
                     <input type="file" name="myHead" multiple="multiple" id="fileToUpload" style="display:none;" onchange="fileSelected()" >
                     <a class="btn btn-info" onclick="$('#fileToUpload').click()">选择文件</a>


                 	<input  type="button" class="btn btn-success" onclick="uploadFile()" value="确认上传" >
                 	<input type="button" class="btn btn-warning" onclick="deleteFile()" value="清空附件" >

                     </div>

                 	</div>

                 	<!-------------------------------------------------------------------------->
                 	 <div class="form-group">
                 	<label  class="col-sm-1 control-label" for="name">附件:</label>

                 	<div class="col-sm-8">


                 	<div id="div_previewImages"></div>
                    <div id="progressNumber"></div>

                    <div id="divFilesUploaded"></div>

                 	</div>


                 	</div>








                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     <label  class="col-sm-1 control-label" for="name">任务清单:</label>
                     <div class="col-sm-11">

                     <div class="panel panel-default">
                     <div class="panel-heading">任务清单</div>

                     <div style="margin:10px;">
                  	 <table id="billsTaskTable" class="table table-bordered" style="width:100%;" >
                     <thead>
                         <tr>
                             <th>数据库ID</th>
                             <th>任务单号</th>
                             <th>任务单版本号</th>
                             <th>任务类别</th>
                             <th>任务类型</th>
                             <th>任务负责人</th>
                             <th>任务完成期限</th>
                             <th>任务状态</th>
                         </tr>
                     </thead>
                     </table>
                     </div>

                     </div>
                     </div>
                     </div>

                     <!-------------------------------------------------------------------------->
                     <div class="form-group" id="DivTaskBTNS">
                     <label  class="col-sm-1 control-label" for="name">任务管理:</label>

                     <div class="col-sm-11">

                     <button id="BTNTaskAdd" type="button" class="btn btn-primary">新增任务</button>

                 	 <button id="BTNTaskDel" type="button" class="btn btn-danger">删除任务</button>
                 	 
                 	<button id="BTNTaskAuto" type="button" class="btn btn-danger">智能分配任务(开发中)</button>
                 	 </div>
                 	 </div>

                 	 <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     <label  class="col-sm-1 control-label" for="name"></label>

                     <div class="col-sm-11">


                     <div class="panel panel-default" id="billTaskPanel">
                     <div class="panel-heading">任务单填写</div>
                     
                     
 
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">

                     <label class="col-sm-2 control-label">单据类别:</label>
                 	 <div class="col-sm-10">
                 	    <label class="radio-inline">
                 	        <input type="radio" name="taskSortType" id="radio1" value="D" checked> <span>DSP任务单</span>
                 	    </label>
                 	    <label class="radio-inline">
                 	        <input type="radio" name="taskSortType" id="radio2" value="H"> <span>HMI任务单</span>
                 	    </label>
                 	    <label class="radio-inline">
                	        <input type="radio" name="taskSortType" id="radio3" value="M"> <span>轴卡任务单</span>
                	    </label>
                 	    <label class="radio-inline">
                 	        <input type="radio" name="taskSortType" id="radio4" value="P"> <span>PLC任务单</span>
                 	    </label>
                 	    <label class="radio-inline">
                	        <input type="radio" name="taskSortType" id="radio5" value="C"> <span>codesys任务单</span>
                	    </label>

                 	 </div>

                     </div>

                     <!-------------------------------------------------------------------------->

                     <!-------------------------------------------------------------------------->
                     <div class="form-group">

                     <label class="col-sm-2 control-label">类型:</label>
                 	 <div class="col-sm-10">
                 	 
                 	 <span id="taskTypeA">
                 	    <label class="radio-inline">
                 	        <input type="radio" name="taskType" id="radio1" value="A" checked> <span>APP</span>
                 	    </label>
                 	 </span> 
                 	 
                 	 <span id="taskTypeK">      
                 	    <label class="radio-inline">
                 	        <input type="radio" name="taskType" id="radio2" value="K"> <span>Kernel</span>
                 	    </label>
                 	 </span>       
                 	 <span id="taskTypeL">
                 	    <label class="radio-inline">
                 	        <input type="radio" name="taskType" id="radio3" value="L"> <span>LIB</span>
                 	    </label>
                 	 </span>    
                 	 <span id="taskTypeO">
                 	    <label class="radio-inline">
                	        <input type="radio" name="taskType" id="radio4" value="O"> <span>OS</span>
                	    </label>
                	 </span>   
                	 <span id="taskTypeB">
                	    <label class="radio-inline">
                	        <input type="radio" name="taskType" id="radio5" value="B"> <span>Boot</span>
                	    </label>    
                	 </span>  



                 	 </div>

                     </div>

                     <!-------------------------------------------------------------------------->
                     <div class="form-group">

                     <label class="col-sm-2 control-label">修改属性:</label>
                 	 <div class="col-sm-8">
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" name="modfiyABE"  value="ABE1"> 画面
                 	    </label>
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" name="modfiyABE"  value="ABE2"> 结构
                 	    </label>
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" name="modfiyABE"  value="ABE3"> 参数
                 	    </label>

                 	    <label class="checkbox-inline">
                	        <input type="checkbox" name="modfiyABE"  value="ABE4">通信
                	    </label>
                	        <label class="checkbox-inline">
                	        <input type="checkbox" name="modfiyABE"  value="ABE5">逻辑
                	    </label>
                	        
                 	 </div>


                     </div>
                     <!-------------------------------------------------------------------------->

                     <div class="form-group">

                     <label class="col-sm-2 control-label">任务单号:</label>
                     
                     <div class="col-sm-1">
                     <span id="BTID" class="help-block"></span>
                     </div>
                     
                     <div class="col-sm-2">
                     
                       <input id="taskDBID" class="form-control"  type="hidden" value="" >
                       <input id="taskBPID" class="form-control"  type="hidden" value="" >

                     </div>

                     <label class="col-sm-2 control-label">任务单版本号: <span id="BTVersion"></span></label>

                     <label class="col-sm-2 control-label">任务状态: <span id="BTStatusText"></span></label>


                     </div>
                     
                     <!-------------------------->
                     
                     <div class="form-group">

                     <label  class="col-sm-2 control-label" for="name">机型:</label>
                     <div class="col-sm-3">
                     <select  id="taskMHEName" class="selectpicker" data-live-search="true" data-dropup-auto="false">
                     </select>
                     </div>
                     
                     <label  class="col-sm-2 control-label" for="name">系统:</label>
                     <div class="col-sm-3">
                     <select  id="taskModel" class="selectpicker" data-live-search="true" data-dropup-auto="false">
                     </select>
                     </div>
                     
                     </div>
                     <!-------------------------->
                     <div class="form-group">
                     
                     <label class="col-sm-2 control-label">原系统版本:</label>
                     <div class="col-sm-3">
                       <input id="taskOGNSystemVersion" class="form-control"  type="text" value="">
                     </div>
                     
                     <label class="col-sm-2 control-label">BugID:</label>
                     <div class="col-sm-3">
                       <input id="taskBugID" class="form-control"  type="text" value="">
                     </div>
                     
                     
                     </div>
                     <!-------------------------->


                     <div class="form-group">

                     <label  class="col-sm-2 control-label" for="name">负责人:</label>
                     <div class="col-sm-2">
                     <select  id="taskStaff" class="selectpicker" data-live-search="true"  data-dropup-auto="false">
                     </select>
                     </div>

                     <label for="limitDate" class="col-sm-3 control-label">任务完成期限:</label>
                     <div class="col-sm-3">
                     <div class="input-group date form_date " data-date="" data-date-format="yyyy-mm-dd" data-link-field="limitDate" data-link-format="yyyy-mm-dd" >
                         <input id="taskLimitDate" class="form-control " size="16" type="text" value="" readonly>
                 		<span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                     </div>
                     <input type="hidden" id="taskLimitDate" value="" />
                 	 </div>

                     </div>
                     <!-------------------------------------------------------------------------->

                     <div class="form-group">
                     <label class="col-sm-2 control-label">任务要求:</label>
                     <div class="col-sm-8">
                     <textarea id="taskDBE" class="form-control" rows="2"></textarea>
                     </div>

                     </div>
                     
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">

                     <label  class="col-sm-2 control-label" for="name">任务发布人:</label>
                     <div class="col-sm-3">
                    
                     <span id="taskMaker"  class="help-block"></span>
                     
                     </div>

                     <label  class="col-sm-2 control-label" for="name">任务发布日期:</label>
                     <div class="col-sm-3">
           
                     <span id="taskMakeDate"  class="help-block"></span>
                     </div>


                     </div>



                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     <label class="col-sm-2 control-label"></label>
                  	 <div class="col-sm-6">
                  	<button id="BTNTaskSave" type="button" class="btn btn-success">保存</button>


                  	 </div>
                  	 </div>

                  	 <!-------------------------------------------------------------------------->


                     </div>


                     </div>
 
                     </div>
                     <!-------------------------------------------------------------------------->



                   	<div id="auditTypeDiv" class="form-group">

                   	<label class="col-sm-1 control-label">审核方式:</label>
                   	<div class="col-sm-6">

                   	<!--    <label class="radio-inline">
           	            <input type="radio" name="auditType" id="auditTypeOption1"  value="1"> 暂不审核
           	            </label>-->

                   	    <label class="radio-inline">
                   	        <input type="radio" name="auditType" id="auditTypeOption2" value="2"> 自我审核
                   	    </label>

                   	    <label class="radio-inline">
                  	        <input type="radio" name="auditType" id="auditTypeOption3"  value="3"> 指定审核人
                  	    </label>


                   	</div>

                      </div>

                      <!-------------------------------------------------------------------------->
  

                    
                     

                     <div class="form-group">

                     <label  class="col-sm-1 control-label" for="name">制单人:</label>
                     <div class="col-sm-3">
                    
                     <span id="maker"  class="help-block"></span>
                     
                     </div>

                     <label  class="col-sm-1 control-label" for="name">制单日期:</label>
                     <div class="col-sm-3">
           
                     <span id="makeDate"  class="help-block"></span>
                     </div>


                     </div>

                     <!-------------------------------------------------------------------------->

                     <div class="form-group">

                     <label  class="col-sm-1 control-label" for="name">审核人:</label>
                     <div class="col-sm-3">
                     <select  id="auditor" class="selectpicker" data-live-search="true">
                     </select>
                     </div>

                     <label  class="col-sm-1 control-label" for="name">审核日期:</label>
                     <div class="col-sm-3">
             
                     
                     <span id="auditDate"  class="help-block"></span>
                     
                     </div>


                     </div>

                     <!-------------------------------------------------------------------------->
                     <div class="form-group" id="DivBPTAudit">
                     <label class="col-sm-1 control-label">审核意见:</label>
                     <div class="col-sm-8">
                     <textarea id="BPTAuditOpinion" class="form-control" rows="2"></textarea>
                     </div>

                     </div>

                     </form>




                    </div>

                    <div class="panel-footer">

                    <label class="col-sm-1 control-label"></label>
                    <button id="BTNBPTSave" type="button" class="btn btn-primary">保存方案</button>
                    <button id="BTNBPTUpdateVer" type="button" class="btn btn-warning">更新版本</button>
                    <button id="BTNBPTAuditYes" type="button" class="btn btn-success">审核通过</button>
                    <button id="BTNBPTAuditNo" type="button" class="btn btn-danger">审核驳回</button>


                    </div>


                   </div>


                   <!--------------方案单面板----------------->



                   <!---------清除浮动---------------------------------->
                   <div style='clear:both'></div>



                    </div>
                    <div class="modal-footer">

                        <button id="BTNBPTClose" type="button" class="btn btn-default" data-dismiss="modal">关闭</button>

                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>



    </div>




    <br/>

    <!--数据呈现区-->
    <table id="billsBPTTable" class="table table-striped table-bordered"  >
        <thead>
            <tr>
                <th>时间戳</th>
                <th>数据库ID</th>
                <th>计划单号</th>
                <th>计划版本号</th>
                <th>客户简称</th>
                <th>计划单完成期限</th>
                <th>方案人</th>
                <th>方案版本号</th>
                <th>方案单状态</th>

            </tr>
        </thead>
    </table>


</div>


<script>




//函数:任务单号生成规则

function Fun_BTIDCreate(){
	

	
	 var BPTBPID=$('#BPTBPID').val();
	 var tableTask = $('#billsTaskTable').DataTable();
	 var TaskNum = (tableTask.page.info()).recordsTotal+1;//总任务数
	 
	 if(TaskNum.length=1){
		 TaskNumT="0"+TaskNum;
	 }else{
		 TaskNumT=TaskNum;
	 }
	 
	 
	 
	 var BTID="T"+BPTBPID.substring(1,11)+"_"+$('input:radio[name="taskSortType"]:checked').val()+$('input:radio[name="taskType"]:checked').val()+"_"+TaskNumT;
	 $("#BTID").text(BTID);


}






//函数:详情按钮详情页自动填写内容1:所有情况必定加载------------------------

function Fun_BPTDetailInitPart1(dataSelect){
	

	var SQLParamPLD={
			"tableName":"ppm_bills_plan",
			"titles":[
				"BPID",
				"version",
				"CTRName",
				"topic",
				"detail",
				"MHEName",
				"modelD",
				"modelH",
				"OGNSystemVersion",
				"limitDate",
				"files"
				],
			"BID":"BPID",
			"VER":"version",
			"filter":"BPID='"+dataSelect.BPID+"'"
			};
	
	
	Fun_fillTrackTable("#tableTrackPLD",SQLParamPLD);
	


	$('#PLDDBID').val(dataSelect.PLDDBID);

    $('#DBID').val(dataSelect.DBID);

	$('#BPTBPID').val(dataSelect.BPID);
//	$("#BPTBPID").attr("disabled",true);
	

	Fun_getSQLSelectDBData({SQL:"SQLSRCustomers"},"#CTRName",dataSelect.PLDCTRName);
//	$("#CTRName").attr("disabled",true);

//	$('#CTRName').val(dataSelect.PLDCTRName);
	

	$('#BPTID').val(dataSelect.BPID);
//	$("#BPTID").attr("disabled",true);

//	var BPTID=Fun_billIDCreate('FA');
//	$('#BPTID').val(BPTID); 

	$('#PGEMaker').val(dataSelect.PLDPGEMaker);

	$('#limitDate').val(dataSelect.PLDLimitDate);


	$('#taskLimitDate').val(dataSelect.limitDate);

	if(dataSelect.BPTVersion==null){
		$('#BPTVersion').text(0);
	}else{
		$('#BPTVersion').text(dataSelect.BPTVersion);
	}


	$('#BPTStatusText').text(dataSelect.BPTStatusText);
	
	 $('#DIVPLDInfo input').attr("disabled",true);
	 $('#DIVPLDInfo select').attr("disabled",true);



	$('#billTaskPanel').hide();

	$('#taskBPID').val(dataSelect.BPID);

	$('.form_date').datetimepicker({
	      language:  'zh-CN',
	      weekStart: 1,
	      todayBtn:  1,
			autoclose: 1,
			todayHighlight: 1,
			startView: 2,
			minView: 2,
			forceParse: 0,
			startDate:Ndate,//设置最小日期
			endDate:dataSelect.limitDate//设置最大日期
	  });

	tasksTableSQL={"SQL":"SQLTableBillsTask","filter":"taskBPID = '"+dataSelect.BPID+"'"};

	tasksTableInfo={
				"tableID":"#billsTaskTable",
				"columnsData":[
					{ data: 'DBID' ,"visible": false},
			        { data: 'BTID' },
			        { data: 'BTVersion'},
			        { data: 'taskSortTypeText'},
			        { data: 'taskTypeText'},
			        { data: 'taskStaff'},
			        { data: 'taskLimitDate'},
			        { data: 'BTStatusText'}
				]
	     }
	
	Fun_showSQLLiteTable(tasksTableSQL,tasksTableInfo);

}

//函数:详情按钮详情页自动填写内容2:方案单审核状态为0,1,2时加载------------------------

function Fun_BPTDetailInitPart2(dataSelect){
	switch(dataSelect.modifyType){
	  case 1:
		  $("#modifyTypeOption1").prop("checked",true);
		  break;
	  case 2:
		  $("#modifyTypeOption2").prop("checked",true);
		  break;
	  case 3:
		  $("#modifyTypeOption3").prop("checked",true);
		  break;
    case 4:
	      $("#modifyTypeOption4").prop("checked",true);
	      break;
	  default:
		  $("#modifyTypeOption1").prop("checked",true);
    }

	 if(dataSelect.modifyReason!=null){
		 setCheckBoxValue("modifyReason",dataSelect.modifyReason);
	 }

	 $('#BPTDescribe').val(dataSelect.BPTDescribe);

//	 var Para={"billName":"ppm_bills_blueprint","billID":dataSelect.BPTID,"billVersion":dataSelect.version}
//	 Fun_getBillFile(Para,"#divFilesUploaded",true);

	 $('#divFilesUploaded').html("");


	  
	  if(dataSelect.files!=null){
		  
		  var files=JSON.parse(dataSelect.files);
		  if(files!=null){
			  
			  var fileLink="";
				 if(files.length>0){
					 for(var i=0;i<files.length;i++){
						 console.log("files[i].fileName:"+files[i].fileName);
						 
						fileLink=fileLink+"<a  href="+'/system.files.download/upload_'+files[i].fileKey+" download="+files[i].fileName+">"+"<span>"+files[i].fileName+"</span></a>"+" ; ";
					 } 
					 
					 fileLink=fileLink.substr(0, fileLink.length-3); 
				 }
		  var downloadurl=fileLink;
		  }else{
			  downloadurl="";
		  }
		  $('#divFilesUploaded').html(downloadurl);
	  }
	  
	  
	  

		Fun_getSQLSelectDBData({SQL:"SQLSRStaffs"},"#taskStaff");



	  $('#maker').text(dataSelect.maker);
	  $('#makeDate').text(dataSelect.makeDate);


	  Fun_getSQLSelectDBData({SQL:"SQLSRStaffs"},"#auditor",dataSelect.auditor);
	  $("#auditor").attr("disabled",true);


}


//函数:详情按钮详情页自动填写内容------------------------
function Fun_BPTDetailInit(dataSelect){
	
	

	Fun_BPTDetailInitPart1(dataSelect);
	
	

	
	var auditResult=dataSelect.auditResult;

	var auditor=dataSelect.auditor;
//	var auditor=Fun_getSelectText($('#auditor option:selected').text());
	console.log("Fun_BPTDetailInit auditor:"+auditor);

	if(auditResult==null){
		

		Fun_getSQLSelectDBData({SQL:"SQLSRMachines"},"#MHEName",dataSelect.PLDMHEName);
		
		Fun_getSQLSelectDBData({SQL:"SQLSRSystems",filter:"sort='DSP' AND status=1"},"#modelD",dataSelect.PLDModelD);
		Fun_getSQLSelectDBData({SQL:"SQLSRSystems",filter:"sort='HMI' AND status=1"},"#modelH",dataSelect.PLDModelH);

		$('#OGNSystemVersion').val(dataSelect.PLDOGNSystemVersion);
	}else{
		
		Fun_getSQLSelectDBData({SQL:"SQLSRMachines"},"#MHEName",dataSelect.MHEName);
		Fun_getSQLSelectDBData({SQL:"SQLSRSystems",filter:"sort='DSP' AND status=1"},"#modelD",dataSelect.modelD);
		Fun_getSQLSelectDBData({SQL:"SQLSRSystems",filter:"sort='HMI' AND status=1"},"#modelH",dataSelect.modelH);

		$('#OGNSystemVersion').val(dataSelect.OGNSystemVersion);
	}



	if(auditor==null){
		 $("#auditTypeOption2").prop("checked",true);
		 $('input:radio[name="auditType"]').click();
	}else{
		$("#auditTypeOption3").prop("checked",true);
	}

	switch(auditResult){
	case null:
		
		 $("#DivAuditImage").attr('src',"");
		 $('input').attr("disabled",false);
		 $('select').attr("disabled",false);
		 $('textarea').attr("disabled",false);
		 
		 
		 $('#DIVPLDInfo input').attr("disabled",true);
		 $('#DIVPLDInfo select').attr("disabled",true);



		 $("#modifyTypeOption1").prop("checked",true);
//		 $('#maker').text(sessionName);

		 $("#DivFileBTNS").show();
		 $("#DivTaskBTNS").show();
		 $('#BTNTaskSave').show();
		 
		 $('#BPTAuditOpinion').val("");
		 $('#DivBPTAudit').hide();

		 $("#BTNBPTSave").show();
		 $("#BTNBPTUpdateVer").hide();
		 $("#BTNBPTAuditYes").hide();
		 $("#BTNBPTAuditNo").hide();

		 break;
	case 0:
		
		 $("#DivAuditImage").attr('src',"");
		 $('input').attr("disabled",false);
		 $('select').attr("disabled",false);
		 $('textarea').attr("disabled",false);
		 
		 $('#DIVPLDInfo input').attr("disabled",true);
		 $('#DIVPLDInfo select').attr("disabled",true);

		 
		 Fun_BPTDetailInitPart2(dataSelect);

		 $("#DivFileBTNS").show();
		 $("#DivTaskBTNS").show();
		 $('#BTNTaskSave').show();
		 
		 $('#BPTAuditOpinion').val("");
		 $('#DivBPTAudit').hide();

		 $("#BTNBPTSave").show();
		 $("#BTNBPTUpdateVer").hide();

		 $("#BTNBPTAuditYes").hide();
		 $("#BTNBPTAuditNo").hide();
		break;
	case 1:
		
		
		$("#DivAuditImage").attr('src',"/images/auditYes.png");
		$('input').attr("disabled",true);
		$('select').attr("disabled",true);
		$('textarea').attr("disabled",true);
		
		
		  
		Fun_BPTDetailInitPart2(dataSelect);

	  $('#auditDate').text(dataSelect.auditDate);
	  $('#BPTAuditOpinion').val(dataSelect.BPTAuditOpinion);
	  $('#DivBPTAudit').show();

	  $("#DivFileBTNS").hide();
	  $("#DivTaskBTNS").hide();
	  $('#BTNTaskSave').hide();

	  $("#BTNBPTSave").hide();
	  $("#BTNBPTUpdateVer").show();
	  $("#BTNBPTAuditYes").hide();
	  $("#BTNBPTAuditNo").hide();
	  
	    break;
	
	case 2:
		
		$("#DivAuditImage").attr('src',"/images/auditNo.png");
		$('input').attr("disabled",true);
		$('select').attr("disabled",true);
		$('textarea').attr("disabled",true);
		
		Fun_BPTDetailInitPart2(dataSelect);

	  $('#auditDate').text(dataSelect.auditDate);
	  
	  $('#BPTAuditOpinion').val(dataSelect.BPTAuditOpinion);
	  $('#DivBPTAudit').show();
	  
	  $("#DivFileBTNS").hide();
	  $("#DivTaskBTNS").hide();
	  $('#BTNTaskSave').hide();

	  $("#BTNBPTSave").hide();
	  $("#BTNBPTUpdateVer").show();
	  $("#BTNBPTAuditYes").hide();
	  $("#BTNBPTAuditNo").hide();
	  
	    break;


	}
	
	


}

//函数-根据自定义SQL获取数据加载Task表格,不显示搜索分页,简易模式


function Fun_showSQLLiteTable(SQL,tableInfo){

	//alert(JSON.stringify(DataPara));

		$(tableInfo.tableID).DataTable().destroy();//销毁原数据表格,防止加载错误

		$(tableInfo.tableID).DataTable({
		    ajax: {
		        url: '/app/PM/getSQLDBData',
		        data:SQL,
		        dataSrc: ''
		    },
		    columns: tableInfo.columnsData,
		    aaSorting: [0, 'desc'],//默认排序
		    paging: false, // 禁止分页
		    bFilter: false,    //去掉搜索框方法三：这种方法可以
//	        bLengthChange: false,   //去掉每页显示多少条数据方法
		    language: languageCN
		});

		//判断是否选中数据-------
		


		 $(tableInfo.tableID+' tbody').unbind();//解除事件绑定,防止重复定义.

		 var tableTask = $(tableInfo.tableID).DataTable();


		 $(tableInfo.tableID+' tbody').on('click', 'tr', function() {

		     if ($(this).hasClass('selected')) {
		         $(this).removeClass('selected');
		         $('#billTaskPanel').hide();
		     } else {
		    	 tableTask.$('tr.selected').removeClass('selected');
		         $(this).addClass('selected');
		         $('#billTaskPanel').show();

		         var dataSelectTask = tableTask.row('.selected').data();

			     console.log("dataSelectTask:"+JSON.stringify(dataSelectTask));

			     //控制其他组件防止误操作.bear
			     
			     $("input:radio[name=taskSortType][value="+dataSelectTask.taskSortType+"]").prop("checked",true);
			     $('input:radio[name="taskSortType"]').attr("disabled",true);
			     

			     $("input:radio[name=taskType][value="+dataSelectTask.taskType+"]").prop("checked",true);
			     $('input:radio[name="taskType"]').attr("disabled",true);
//			     
//			     
			        $("#taskTypeA").show();
			        $("#taskTypeK").show();
				 	$("#taskTypeL").show();
					$("#taskTypeO").show();
					$("#taskTypeB").show();


			 	 $('input:checkbox[name="modfiyABE"]').prop("checked",false);

			     setCheckBoxValue("modfiyABE",dataSelectTask.modfiyABE);
		     
			     $("#taskDBID").val(dataSelectTask.DBID);

			     $("#BTID").text(dataSelectTask.BTID);
			     
			    Fun_getSQLSelectDBData({SQL:"SQLSRMachines"},"#taskMHEName",dataSelectTask.taskMHEName);
			    
			    switch(dataSelectTask.taskSortType){
			    case 'D':
			    	Fun_getSQLSelectDBData({SQL:"SQLSRSystems",filter:"sort='DSP' AND status=1"},"#taskModel",dataSelectTask.taskModel);
			    	break;
			    case 'H':
			    	Fun_getSQLSelectDBData({SQL:"SQLSRSystems",filter:"sort='HMI' AND status=1"},"#taskModel",dataSelectTask.taskModel);
			    	break;
			    case 'M':
			    	Fun_getSQLSelectDBData({SQL:"SQLSRSystems",filter:"sort='轴卡' AND status=1"},"#taskModel",dataSelectTask.taskModel);
			    	break;
			    case 'P':
			    	Fun_getSQLSelectDBData({SQL:"SQLSRSystems",filter:"sort='PLC' AND status=1"},"#taskModel",dataSelectTask.taskModel);
			    	break;
			    case 'C':
			    	Fun_getSQLSelectDBData({SQL:"SQLSRSystems",filter:"sort='codesys' AND status=1"},"#taskModel",dataSelectTask.taskModel);
			    	break;
			    
			    }
			    
			    
			    
			    $('#taskOGNSystemVersion').val(dataSelectTask.taskOGNSystemVersion);
			    
			    $('#taskBugID').val(dataSelectTask.taskBugID);
			    
				Fun_getSQLSelectDBData({SQL:"SQLSRStaffs"},"#taskStaff",dataSelectTask.taskStaff);
				
				
//			     alert($("#taskStaff").text() );

//			     $("#taskStaff option[text='熊奇龙']").attr("selected", true);  

				 $('#taskLimitDate').val(dataSelectTask.taskLimitDate);

				 $("#BTVersion").text(dataSelectTask.BTVersion);

				 $("#BTStatusText").text(dataSelectTask.BTStatusText);

				 $("#taskMaker").text(dataSelectTask.taskMaker);
				 
				 $("#taskMakeDate").text(dataSelectTask.taskMakeDate);

		     }

		 });

}



//函数-添加任务单,并刷新任务单列表
function Fun_addTask(DBData) {

    $.ajax({
        method: 'post',
        url: '/app/PM/addDBData',
        data: DBData,
        success: function(data) {
//            alert("成功数据:" + JSON.stringify(data));
           if (data.affectedRows != 0) {
               alert("新增任务单成功!");
          	   Fun_showSQLLiteTable(tasksTableSQL,tasksTableInfo);
          	   $('#BTNTaskAdd').click();
          	   $('#billTaskPanel').hide();

           }
       },
       error:function(err){
       	alert("失败数据:"+JSON.stringify(err));
       }
    });
}


///函数-更新任务单,并刷新任务单列表
function Fun_updTask(DBData) {
    $.ajax({
        method: 'post',
        url: '/app/PM/updDBData',
        data: DBData,
        success: function(data, textStatus) {
 //                alert("成功数据:"+JSON.stringify(data));
            if (data.changedRows != 0) {
                alert("更新任务单数据成功!");

                Fun_showSQLLiteTable(tasksTableSQL,tasksTableInfo);

                $('#BTNTaskAdd').click();
           	    $('#billTaskPanel').hide();

            } else {
                alert("未有任务单数据更新!");
            }
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {}
    });
}

///函数-更新任务单,并刷新任务单列表
function Fun_saveTask(DBData) {
    $.ajax({
        method: 'post',
        url: '/app/PM/saveDBData',
        data: DBData,
        success: function(data, textStatus) {
            //     alert("成功数据:"+JSON.stringify(data));
            if (data.affectedRows != 0) {
                alert("保存任务单数据成功!");

                Fun_showSQLLiteTable(tasksTableSQL,tasksTableInfo);

                $('#BTNTaskAdd').click();
           	    $('#billTaskPanel').hide();

            } else {
                alert("未有任务单数据更新!");
            }
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {}
    });
}


//函数-添加任务单,并刷新任务单列表
function Fun_delTask(IDData) {
    $.ajax({
        method: 'post',
        url: '/app/PM/delDBData',
        data: IDData,
        success: function(data, textStatus) {
            //  alert("成功数据:"+JSON.stringify(data));
            if (data.affectedRows != 0) {
                alert("删除任务单成功!");
             	   Fun_showSQLLiteTable(tasksTableSQL,tasksTableInfo);
             	  $('#BTNTaskAdd').click();
             	  $('#billTaskPanel').hide();

            } else {
                alert("删除任务单失败!");
            }
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {}
    });
}

//函数,检查输入项是否完整

function checkBPTInput(){
	
	if($("#MHEName").val()==null){
		alert("机型未选择,请检查!");
		return false;
	}else if($("#modelD").val()==null||$("#modelH").val()==null){
		alert("系统未选择,请检查!");
		return false;
	}else if(getCheckBoxValue("modifyReason")==""){
		alert("修改原因未选择,请检查!");
		return false;
	}else if($("#BPTDescribe").val()==""){
		alert("方案说明未输入,请检查!");
		return false;
	}else if($("#auditor").val()==null){
		alert("审核人未选则,请检查!");
		return false;
	}
	
	
	return true;
	
}




//页面加载函数---------------
$(document).ready( function () {




    sessionName="<%-locals.session.yjUser.Name%>";
    
    
    var undone=getQueryString("undone");
	
	if(undone=="true"){
		var tableSQL={"SQL":"SQLTableBillsBPT","filter":" (maker = '"+sessionName+"' OR auditor = '"+sessionName+"'  OR PLDPGEMaker = '"+sessionName+"') AND (BPTStatus IS NULL OR BPTStatus <>1)  ","orderBy":" saveTimeStamp DESC"};
	}else{
		var tableSQL={"SQL":"SQLTableBillsBPT","orderBy":" saveTimeStamp DESC"};
	}
    

//	console.log("sessionName:"+sessionName);


    tableInfo={
			"tableID":"#billsBPTTable",
			"columnsData":[
				{ data: 'saveTimeStamp' ,"visible": false},
				{ data: 'DBID' ,"visible": false},
		        { data: 'BPID' },
		        { data: 'PLDVersion'},
		        { data: 'PLDCTRName'},
		        { data: 'PLDLimitDate'},
		        { data: 'PLDPGEMaker'},
		        { data: 'BPTVersion'},
		        { data: 'BPTStatusText'}

			]
	}

	Fun_showSQLTable(tableSQL,tableInfo);

//判断是否选中数据-------
var table = $('#billsBPTTable').DataTable();
$('#billsBPTTable tbody').on('click', 'tr', function() {
    if ($(this).hasClass('selected')) {
        $(this).removeClass('selected');
    } else {
        table.$('tr.selected').removeClass('selected');
        $(this).addClass('selected');
    }

    var dataSelect = table.row('.selected').data();


});

//dbclick 测试判断是否选中数据-------

$('#billsBPTTable tbody').on('dblclick', 'tr', function() {
	$('#BTNBPTInfo').click();

});


//绑定radio切换改变任务单号事件

$('input[type=radio][name=taskSortType]').change(function() {
	
	var taskSortType=$('input:radio[name="taskSortType"]:checked').val();
	
	$("#taskTypeA").show();
	$("#taskTypeK").show();
	$("#taskTypeL").show();
	$("#taskTypeO").show();
	$("#taskTypeB").show();
	
	switch(taskSortType){
	case "D":
		$("input:radio[name=taskType][value='A']").prop("checked",true);
		$("#taskTypeL").hide();
		$("#taskTypeO").hide();
		$("#taskTypeB").hide();
		Fun_getSQLSelectDBData({SQL:"SQLSRSystems",filter:"sort='DSP' AND status=1"},"#taskModel",Fun_getSelectText($('#modelD option:selected').text()));
		break;
	case "H":
		$("input:radio[name=taskType][value='A']").prop("checked",true);
		$("#taskTypeL").hide();
		$("#taskTypeB").hide();
		Fun_getSQLSelectDBData({SQL:"SQLSRSystems",filter:"sort='HMI' AND status=1"},"#taskModel",Fun_getSelectText($('#modelH option:selected').text()));
		break;
	case "M":
		$("input:radio[name=taskType][value='A']").prop("checked",true);
		$("#taskTypeK").hide();
		$("#taskTypeL").hide();
		$("#taskTypeO").hide();
		Fun_getSQLSelectDBData({SQL:"SQLSRSystems",filter:"sort='轴卡' AND status=1"},"#taskModel");
		break;
	case "P":
		$("input:radio[name=taskType][value='A']").prop("checked",true);
		$("#taskTypeK").hide();
		$("#taskTypeB").hide();
		break;
	case "C":
		$("input:radio[name=taskType][value='A']").prop("checked",true);
		$("#taskTypeK").hide();
		$("#taskTypeB").hide();
		break;
		
		
	}
	
	
	Fun_BTIDCreate();

});

$('input[type=radio][name=taskType]').change(function() {
	
	var taskSortType=$('input:radio[name="taskSortType"]:checked').val();
	var taskType=$('input:radio[name="taskType"]:checked').val();
	
	
	switch(taskType){
	case 'A':
		switch(taskSortType){
		case 'D':
			Fun_getSQLSelectDBData({SQL:"SQLSRSystems",filter:"sort='DSP' AND status=1"},"#taskModel",Fun_getSelectText($('#modelD option:selected').text()));
			break;
		case 'H':
			Fun_getSQLSelectDBData({SQL:"SQLSRSystems",filter:"sort='HMI' AND status=1"},"#taskModel",Fun_getSelectText($('#modelH option:selected').text()));
			break;
			
		case 'M':
			Fun_getSQLSelectDBData({SQL:"SQLSRSystems",filter:"sort='轴卡' AND status=1"},"#taskModel");
			break;
		case 'P':
			Fun_getSQLSelectDBData({SQL:"SQLSRSystems",filter:" status=1"},"#taskModel");
		    break;
        case 'C':
        	Fun_getSQLSelectDBData({SQL:"SQLSRSystems",filter:" status=1"},"#taskModel");
		    break;
		
		
		}
		
		
		
		break;
	case 'K':
		Fun_getSQLSelectDBData({SQL:"SQLSRSystems",filter:"sort='kernel' AND status=1"},"#taskModel");
		break;
		
	case 'L':
		Fun_getSQLSelectDBData({SQL:"SQLSRSystems",filter:"sort='LIB' AND status=1"},"#taskModel");
		break;
	
	case 'O':
		Fun_getSQLSelectDBData({SQL:"SQLSRSystems",filter:"sort='OS' AND status=1"},"#taskModel");
		break;
		
	case 'B':
		
		break;
	
	}
	
	
	Fun_BTIDCreate();

});




//定义左侧跟踪栏按钮效果,设定可添加html
$("[data-toggle='popover']").popover({html : true });


////按钮-新增计划单---------
//$('#BTNAdd').click(function() {
//	$('#BillBPT').modal('show');
//	Fun_winAddInit();
// 
//});



//radio 定义更换按键触发事件-----------
$('input:radio[name="auditType"]').click(function(){
	var radioValue = $('input:radio[name="auditType"]:checked').val();
//	alert(radioValue);

	switch(radioValue){
	case "1":

		Fun_getSQLSelectDBData({SQL:"SQLSRStaffs"},"#auditor");
	    $("#auditor").attr("disabled",true);
	    $('#auditDate').text("");
	    $('#auditResult').val("");

	    break;
	case "2":


		Fun_getSQLSelectDBData({SQL:"SQLSRStaffs"},"#auditor",sessionName);
	    $("#auditor").attr("disabled",true);
	    $('#auditDate').text("");
	    $('#auditResult').val(0);
	    break;
	case "3":

	    $('#auditDate').text("");

		Fun_getSQLSelectDBData({SQL:"SQLSRStaffs"},"#auditor");
	    $("#auditor").attr("disabled",false);
	    $('#auditResult').val(0);
	    break;


	}

});



//按钮-方案维护--------
$('#BTNBPTInfo').click(function() {
    console.log("seclet: "+JSON.stringify(table.row('.selected').data()));
    // table.row('.selected').remove().draw( false );
    var dataSelect = table.row('.selected').data();
    if (dataSelect == undefined) {
        alert("操作提示:单击选中数据行后,再双击可快速打开表单!");
    } else {

    	$('#BillBPT').modal('show');
    	Fun_BPTDetailInit(dataSelect);


    }
});


//按钮-方案审核--------
$('#BTNBPTAudit').click(function() {
    console.log("seclet: "+JSON.stringify(table.row('.selected').data()));
    // table.row('.selected').remove().draw( false );
    var dataSelect = table.row('.selected').data();
    if (dataSelect == undefined) {
        alert("请点击表格先选中需要审核的方案!");
    } else {

    	switch(dataSelect.auditResult){
    	case null:
    		alert("该计划单不存待审核的方案,请与方案人确认!");
    		break;
    	case 0:
    		$('#BillBPT').modal('show');
        	Fun_BPTDetailInit(dataSelect);
        	
            $('input').attr("disabled",true);
   		    $('select').attr("disabled",true);
   		    $('textarea').attr("disabled",true);
   		  
   		    $('#BPTAuditOpinion').attr("disabled",false);
        	
        	 $("#DivFileBTNS").hide();
      	     $("#DivTaskBTNS").hide();
      	     
      	     $('#BPTAuditOpinion').val(dataSelect.BPTAuditOpinion);
     	     $('#DivBPTAudit').show();

        	 $('#BTNBPTSave').hide();
        	 $("#BTNBPTAuditYes").show();
    		 $("#BTNBPTAuditNo").show();
        	break;
    	default:
    		alert("该方案已经审核,无需再次审核!");

    	}

    }
});





//按钮-任务新增

$('#BTNTaskAdd').click(function(){
	
	

	$('#billTaskPanel').show();
	
	
	$("#taskTypeL").hide();
	$("#taskTypeO").hide();
	$("#taskTypeB").hide();

	$("#taskDBID").val("");
	
	var tableTask = $('#billsTaskTable').DataTable();
	tableTask.$('tr.selected').removeClass('selected');
	
	
	Fun_BTIDCreate();

//	$('input:radio[name="taskType"]').prop("checked",false);
	
	$('input:radio[name="taskSortType"]').attr("disabled",false);

	$('input:radio[name="taskType"]').attr("disabled",false);

	$('input:checkbox[name="modfiyABE"]').prop("checked",false);

	$('#BTVersion').text(0);
	$('#BTStatusText').text('新增');
	

	Fun_getSQLSelectDBData({SQL:"SQLSRStaffs"},"#taskStaff");
	
	Fun_getSQLSelectDBData({SQL:"SQLSRMachines"},"#taskMHEName",Fun_getSelectText($('#MHEName option:selected').text()));
	
	Fun_getSQLSelectDBData({SQL:"SQLSRSystems",filter:"sort='DSP' AND status=1"},"#taskModel",Fun_getSelectText($('#modelD option:selected').text()));

	$('#taskOGNSystemVersion').val($("#OGNSystemVersion").val());
	
	$('#taskLimitDate').val($('#limitDate').val());

	$('#taskDBE').val("");


});
//按钮-任务智能分配------
$('#BTNTaskAuto').click(function() {
	
let CTRNameDBID=$('#CTRName option:selected').val();
	
	
	if(CTRNameDBID==undefined){
		alert("请选择客户,以便系统加载绑定数据!");
	}else{

		let selectSQL={"SQL":"SQLGetDataBinds","filter":"baseDBID="+CTRNameDBID+" AND tableName='ppm_customers'"}

		let bindStaffs=[];
		
		 $.ajax({
	         method:'get',
	         data:selectSQL,
	         url:"/app/PM/getSQLDBData",
	         async:false, 
	         success:function(data){
	        	 
	        	 if(data.length==0){
	        		 alert("系统未检测到绑定数据,请先维护绑定关系!");
	        	 }else{

	            	 let bindsInfo=JSON.parse(data[0].bindsInfo);
	            	 
	            	 for(let i=0;i<bindsInfo.length;i++){
	            		 console.log(bindsInfo[i].DataType);
	            		 
	            		 if(bindsInfo[i].DataType=="人员"){
	            			 let bindStaff={
	            					 staffName:bindsInfo[i].DataVal,
	            					 staffSort:bindsInfo[i].DataSort
	            			 }
	            			 bindStaffs.push(bindStaff); 
	            		 }

	            	 }

	        	 }

	         },
	         error:function(){}
	     })
	     
//--------------------------------------------------------------	     
	     
	     Fun_BTIDCreate();
		 
		 if(bindStaffs.length==0){
			 alert("系统检测到该客户为与任何人员绑定关系,使用智能排单前请先维护数据绑定关系!");
		 }else{
			 
			 let BTID=$('#BTID').text();

				let DBData={
						taskBPID:$('#taskBPID').val(),
						BTID:BTID,
						CTRDBID:$('#CTRName').val(),
						taskCTRName:Fun_getSelectText($('#CTRName option:selected').text()),
						bindStaffs:JSON.stringify(bindStaffs),
						taskMaker:sessionName,
						taskMakeDate:Ndate,
						taskLimitDate:$('#limitDate').val()	
				}
				

				
				$.ajax({
			        method: 'post',
			        url: '/app/PM/autoAddTasks',
			        data: DBData,
			        success: function(data) {
//			            alert("成功数据:" + JSON.stringify(data));
			           if (data.affectedRows != 0) {
			               alert("生成系统任务单成功,请点击任务单完善细节!");
			          	   Fun_showSQLLiteTable(tasksTableSQL,tasksTableInfo);
			          	   $('#BTNTaskAdd').click();
			          	   $('#billTaskPanel').hide();

			           }
			       },
			       error:function(err){
			       	alert("失败数据:"+JSON.stringify(err));
			       }
			    });
			 
		 }
			
	}

})


//按钮-任务删除---------
$('#BTNTaskDel').click(function() {

	var tableTask = $('#billsTaskTable').DataTable();
    var dataSelectTask = tableTask.row('.selected').data();

   console.log(JSON.stringify(dataSelectTask));

    if (dataSelectTask == undefined) {
        alert("未选择任何任务单,请在任务清单中选中需要删除的任务单!");
    } else {

    	if(dataSelectTask.BTAcceptResult==1||dataSelectTask.BTAcceptResult==2){
    		alert("已确认过的任务单禁止删除!");
    	}else{

    		var msg = confirm("风险操作！此行数据内容移除后无法还原，请确认操作是否无误！");
            if (msg === true) {

                    var IDData = {"DBTable":"ppm_bills_task","DBID":dataSelectTask.DBID};
 //                   console.log("IDData:"+JSON.stringify(IDData));
                    Fun_delTask(IDData);

            }

    	}

    }

});


//按钮-任务保存

$('#BTNTaskSave').click(function(){
	
	var tableTask = $('#billsTaskTable').DataTable();
    var dataSelectTask = tableTask.row('.selected').data();
    
    console.log("dataSelectTask:"+JSON.stringify(dataSelectTask));
    
    var taskDBID= $('#taskDBID').val();

	var taskBPID=$('#taskBPID').val();
	
	var modfiyABE=getCheckBoxValue('modfiyABE');

//	var BTAcceptResultText=$('#BTAcceptResultText').text();

	if(dataSelectTask==undefined){
		var taskData={
				"DBTable":"ppm_bills_task",
				"DBID":taskDBID,
				"BTID":$('#BTID').text(),
				"BTVersion":0,
				"taskBPID":taskBPID,
				"taskCTRName":Fun_getSelectText($('#CTRName option:selected').text()),
				"taskSortType":$('input:radio[name="taskSortType"]:checked').val(),
				"taskSortTypeText":$('input:radio[name="taskSortType"]:checked').next("span").text(),
				"taskType":$('input:radio[name="taskType"]:checked').val(),
				"taskTypeText":$('input:radio[name="taskType"]:checked').next("span").text(),
				"taskMHEName":Fun_getSelectText($('#taskMHEName option:selected').text()),
				"taskModel":Fun_getSelectText($('#taskModel option:selected').text()),
				"taskOGNSystemVersion":$('#taskOGNSystemVersion').val(),
				"taskBugID":$('#taskBugID').val(),
				"taskStaff":$('#taskStaff option:selected').text(),
				"modfiyABE":modfiyABE,
				"taskDBE":$('#taskDBE').val(),
				"taskLimitDate":$('#taskLimitDate').val(),
				"taskMaker":sessionName,
				"taskMakeDate":Ndate,
				"BTStatus":1,
				"BTStatusText":"新增"
		        }
		 Fun_saveTask(taskData);
		
	}else{
		
		if(dataSelectTask.BTStatus==1){
			
			var taskData={
					"DBTable":"ppm_bills_task",
					"DBID":taskDBID,
					"BTID":$('#BTID').text(),
					"BTVersion":0,
					"taskBPID":taskBPID,
					"taskCTRName":Fun_getSelectText($('#CTRName option:selected').text()),
					"taskSortType":$('input:radio[name="taskSortType"]:checked').val(),
					"taskSortTypeText":$('input:radio[name="taskSortType"]:checked').next("span").text(),
					"taskType":$('input:radio[name="taskType"]:checked').val(),
					"taskTypeText":$('input:radio[name="taskType"]:checked').next("span").text(),
					"taskMHEName":Fun_getSelectText($('#taskMHEName option:selected').text()),
					"taskModel":Fun_getSelectText($('#taskModel option:selected').text()),
					"taskOGNSystemVersion":$('#taskOGNSystemVersion').val(),
					"taskBugID":$('#taskBugID').val(),
					"taskStaff":$('#taskStaff option:selected').text(),
					"modfiyABE":modfiyABE,
					"taskDBE":$('#taskDBE').val(),
					"taskLimitDate":$('#taskLimitDate').val(),
					"taskMaker":sessionName,
					"taskMakeDate":Ndate,
					"BTStatus":1,
					"BTStatusText":"新增"
			        }
			
			 Fun_saveTask(taskData);
		}else{
			
			
			
			if(confirm("风险操作:该任务单已非新增状态,保存将更新任务单版本,是否继续?")){
				var taskData={
						"DBTable":"ppm_bills_task",
						"BTID":$('#BTID').text(),
						"BTVersion":dataSelectTask.BTVersion+1,
						"taskBPID":taskBPID,
						"taskCTRName":Fun_getSelectText($('#CTRName option:selected').text()),
						"taskSortType":$('input:radio[name="taskSortType"]:checked').val(),
						"taskSortTypeText":$('input:radio[name="taskSortType"]:checked').next("span").text(),
						"taskType":$('input:radio[name="taskType"]:checked').val(),
						"taskTypeText":$('input:radio[name="taskType"]:checked').next("span").text(),
						"taskMHEName":Fun_getSelectText($('#taskMHEName option:selected').text()),
						"taskModel":Fun_getSelectText($('#taskModel option:selected').text()),
						"taskOGNSystemVersion":$('#taskOGNSystemVersion').val(),
						"taskBugID":$('#taskBugID').val(),
						"taskStaff":$('#taskStaff option:selected').text(),
						"modfiyABE":modfiyABE,
						"taskDBE":$('#taskDBE').val(),
						"taskLimitDate":$('#taskLimitDate').val(),
						"taskMaker":sessionName,
						"taskMakeDate":Ndate,
						"BTStatus":1,
						"BTStatusText":"新增"
				        }
				
				 Fun_addTask(taskData);

			}
		}
		
		
		
		
	}
	

});




//按钮-方案保存

$('#BTNBPTSave').click(function(){
	

	if(checkBPTInput()){
		

		var BPTBPID=$('#BPTBPID').val();
		var BPTID=$('#BPTID').val();
		var BPTVersion=$('#BPTVersion').text();
		var CTRName=Fun_getSelectText($('#CTRName option:selected').text());
		var PGEMaker=$('#PGEMaker').val();
		var limitDate=$('#limitDate').val();
	    var	MHEName=Fun_getSelectText($('#MHEName option:selected').text());

	    var OGNSystemVersion=$('#OGNSystemVersion').val();

	    var modifyType=$('input:radio[name="modifyType"]:checked').val();
	    var	modifyReason=getCheckBoxValue("modifyReason");
	    var BPTDescribe=$('#BPTDescribe').val();
	    var auditor=Fun_getSelectText($('#auditor option:selected').text());
	    console.log("auditor:"+auditor);
	    
	    
	    

	    var files=[];
		
		$('#divFilesUploaded a').each(function(){
			var fileKey=$(this).attr('href').substring(30);
			var fileName=$(this).attr('download');
			
			var fileInfo={
					"fileName":fileName,
					"fileKey":fileKey
			}
			
			files.push(fileInfo);
		});


	    var BPTStatusText=$('#BPTStatusText').text();
	    
		var DBID=$('#DBID').val();
	    
	        	var BPTData={
	    			"DBTable":"ppm_bills_blueprint",
	    			"DBID":DBID,
	    			"BPTBPID":BPTBPID,
	    			"BPTID":BPTID,
	    			"BPTVersion":BPTVersion,
	    			"CTRName":CTRName,
	    			"PGEMaker":PGEMaker,
	    			"limitDate":limitDate,
	    			"MHEName":MHEName,
	    			"modelD":Fun_getSelectText($('#modelD option:selected').text()),
	    			"modelH":Fun_getSelectText($('#modelH option:selected').text()),
	    			"OGNSystemVersion":OGNSystemVersion,
	    			"modifyType":modifyType,
	    			"modifyReason":modifyReason,
	    			"BPTDescribe":BPTDescribe,
	    			"maker":sessionName,
	    			"makeDate":Ndate,
	    			"auditResult":0,
	    			"auditor":auditor,
	    			"files":JSON.stringify(files)

	    			}
	    
	        	
//	        	alert("BPTData:"+JSON.stringify(BPTData));
	        	
	        	
	        	if(auditor==sessionName){
	            	
	            	
	            	 $.ajax({
	            	        method: 'post',
	            	        url: '/app/PM/saveDBData',
	            	        data: BPTData,
	            	        success: function(data) {
	            	  //         alert("成功数据:" + JSON.stringify(data));
	            	           if (data.affectedRows != 0) {
	            	               alert("方案单数据保存成功!");

	            	               let msg=confirm("是否立刻自动审核通过并发布任务?");
	            	               
	            	               if(msg){
	            	            	   $('#BTNBPTAuditYes').click();
	            	               }
	            	           }
	            	       },
	            	       error:function(err){
	            	    	   if(err.responseText.indexOf("ER_DUP_ENTRY") != -1){
	            	    		   alert("系统中已存在重复数据,请检查!");
	            	    	   }else{
	            	    		   alert("失败数据:"+JSON.stringify(err));
	            	    	   }
	            	       }
	            	    });
	            	

	            }else{
	            	saveDBData(BPTData,"方案单");
	            }
		
	}



});


//按钮-方案更新

$('#BTNBPTUpdateVer').click(function(){


	var msg1 = confirm("风险操作！已审核的单据更新版本,原单据将失效!");
    if (msg1 === true) {
    	
    	
    	 var tableTask = $('#billsTaskTable').DataTable();
		 var TaskNum = (tableTask.page.info()).recordsTotal;//总任务数
//		 alert("TaskNum:"+TaskNum);

			 let allTaskCheck=0;
			 
			 for(let i=0;i<TaskNum;i++){
				 var trData=tableTask.row(i).data().BTAcceptResult;
				 allTaskCheck=allTaskCheck+trData;
			 }
			 
			 console.log(allTaskCheck);
			 
			 
			    var BPTBPID=$('#BPTBPID').val();
	        	var BPTID=$('#BPTID').val();
	        	var newVersion=parseInt($('#BPTVersion').text())+1;
	        	var CTRName=Fun_getSelectText($('#CTRName option:selected').text());
	        	var PGEMaker=$('#PGEMaker').val();
	        	var limitDate=$('#limitDate').val();
	            var	MHEName=Fun_getSelectText($('#MHEName option:selected').text());

	            var OGNSystemVersion=$('#OGNSystemVersion').val();

	            var modifyType=$('input:radio[name="modifyType"]:checked').val();
	            var	modifyReason=getCheckBoxValue("modifyReason");
	            var BPTDescribe=$('#BPTDescribe').val();
//	            var auditor=Fun_getSelectText($('#auditor option:selected').text());
//	            console.log("auditor:"+auditor);

	            var files=[];
	        	
	        	$('#divFilesUploaded a').each(function(){
	        		var fileKey=$(this).attr('href').substring(30);
	        		var fileName=$(this).attr('download');
	        		
	        		var fileInfo={
	        				"fileName":fileName,
	        				"fileKey":fileKey
	        		}
	        		
	        		files.push(fileInfo);
	        	});


	            var billData={
	        			"DBTable":"ppm_bills_blueprint",
	        			"BPTBPID":BPTBPID,
	        			"BPTID":BPTID,
	        			"BPTVersion":newVersion,
	        			"CTRName":CTRName,
	        			"PGEMaker":PGEMaker,
	        			"limitDate":limitDate,
	        			"MHEName":MHEName,
	        			"modelD":Fun_getSelectText($('#modelD option:selected').text()),
	        			"modelH":Fun_getSelectText($('#modelH option:selected').text()),
	        			"OGNSystemVersion":OGNSystemVersion,
	        			"modifyType":modifyType,
	        			"modifyReason":modifyReason,
	        			"BPTDescribe":BPTDescribe,
	        			"maker":sessionName,
	        			"makeDate":Ndate,
	        			"auditResult":0,
	        			"files":JSON.stringify(files)
	        			}

	            	console.log("无方案 billData:"+JSON.stringify(billData));
			 

		 if(allTaskCheck==0){
			 addDBData(billData);
		 }else{
			 
			var msg2=confirm("检测到该方案单存在正在进行或完成的任务单,如对应任务单需调整,请在新方案单中更新对应任务单版本!");
			if(msg2){
				addDBData(billData);
			}else{
				alert("方案单版本更新取消!");
			}
			 
		 }

     }

});



//按钮-表单审核通过按钮
$('#BTNBPTAuditYes').click(function() {


	if(sessionName==$('#auditor option:selected').text()){
		var msg = confirm("审核后无法修改单据,是否立即审核通过?");
		if(msg==true){
			
			
			
//		//原审核功能-----------------

////			 alert("TaskNum:"+TaskNum);
//
//				 let allTaskCheck=0;
//				 
//				 for(let i=0;i<TaskNum;i++){
//					 var trData=tableTask.row(i).data().BTAcceptResult;
//					 allTaskCheck=allTaskCheck+trData;
//				 }
//				 
//				 console.log(allTaskCheck);
//
//			 if(allTaskCheck==0){
				 
				 
				//-FQC 判断------------------
					
					// 根据系统信息自动识别FQC申请功能	
			     var tableTask = $('#billsTaskTable').DataTable();
			     var TaskNum = (tableTask.page.info()).recordsTotal;//总任务数
					
					var CTRNameDBID=$('#CTRName option:selected').val();
					var MHENameDBID=$('#MHEName option:selected').val();
					var modelDDBID=$('#modelD option:selected').val();
					var modelHDBID=$('#modelH option:selected').val();


					
					
//					 var tableTask = $('#billsTaskTable').DataTable();
//					 var TaskNum = (tableTask.page.info()).recordsTotal;//总任务数
//					 alert("TaskNum:"+TaskNum);

						 let taskStaffs="";
						 
						 for(let i=0;i<TaskNum;i++){
							 var trStaff=tableTask.row(i).data().taskStaff;
							 taskStaffs=taskStaffs+"'"+trStaff+"'"+",";
						 }
						 
						 taskStaffs=taskStaffs.substring(0,taskStaffs.length-1);
						 
						 taskStaffs="("+taskStaffs+")";
						 
						 console.log(taskStaffs);
					

				//添加FQCRequest 判断功能更
					var SQLGetFQCRequest="SELECT GREATEST(ta.FQCRequest,tb.FQCRequest,tc.FQCRequest,td.FQCRequest,te.maxFQCRequest) AS FQCRequestResult FROM " +
							"(SELECT FQCRequest FROM `ppm_customers` WHERE DBID="+CTRNameDBID+") ta," +
							"(SELECT FQCRequest FROM `ppm_machines` WHERE DBID="+MHENameDBID+") tb," +
							"(SELECT FQCRequest FROM `ppm_systems` WHERE DBID="+modelDDBID+") tc," +
							"(SELECT FQCRequest FROM `ppm_systems` WHERE DBID="+modelHDBID+") td," +
							"(SELECT MAX(FQCRequest) AS maxFQCRequest FROM `ppm_staffs` WHERE staffName IN "+taskStaffs+") te";

					
				  $.ajax({
				  method: 'get',
				  url: '/app/PM/getSQLDBData',
				  data: {"SQL":SQLGetFQCRequest},
				  success: function(data) {
//				      alert("成功数据:" + JSON.stringify(data));
				      
				      if(data[0].FQCRequestResult==1){
				    	  var FQCRequest=1;
				    	  var FQCRequestText="有";
				      }else{
				    	  var FQCRequest=0;
				    	  var FQCRequestText="无";
				      }
				      
				      var PLDUpdData={
								"DBTable":"ppm_bills_plan",
								"BillIDName":"BPID",
								"BillID":$('#BPTBPID').val(),
								"FQCRequest":FQCRequest,
								"FQCRequestText":FQCRequestText,
								"TaskNum":TaskNum,
								"WFStatus":20
						}
				      
				      var ajax1=$.ajax({
					        method: 'post',
					        url: '/app/PM/updBillStatus',
					        data: PLDUpdData,
					        success: function(data, textStatus) {
					        },
					        error: function(XMLHttpRequest, textStatus, errorThrown) {}
					        });
				      
				      //-----------------
				      
				      var PLDUpdData={
								"DBTable":"ppm_bills_plan",
								"BillIDName":"BPID",
								"BillID":$('#BPTBPID').val(),
								"TaskNum":TaskNum,
								"WFStatus":20
						}

			//		 updDBDataS(PLDUpdData);

					var BPTAuditData={
							"DBTable":"ppm_bills_blueprint",
							"DBID":$('#DBID').val(),
							"auditor":sessionName,
							"auditDate":Ndate,
							"auditResult":1,
							"BPTAuditOpinion":$('#BPTAuditOpinion').val(),
							"BPTStatus":1
					}
				      
				      var ajax2=$.ajax({
					        method: 'post',
					        url: '/app/PM/updDBData',
					        data: BPTAuditData,
					        success: function(data, textStatus) {
					        },
					        error: function(XMLHttpRequest, textStatus, errorThrown) {}
					        });


					 var taskUpdData={
								"DBTable":"ppm_bills_task",
								"BillIDName":"taskBPID",
								"BillID":$('#BPTBPID').val(),
								"BTAcceptResult":0,
								"filter":"BTAcceptResult IS NULL"
					}

					var ajax3=$.ajax({
					        method: 'post',
					        url: '/app/PM/updBillStatus',
					        data: taskUpdData,
					        success: function(data, textStatus) {
					        },
					        error: function(XMLHttpRequest, textStatus, errorThrown) {}
					        });


			//		updDBData(BPTAuditData,"方案审核状态");


					$.when(ajax1,ajax2,ajax3).done(function(){
						alert("方案已审核通过!");
						window.location.reload();

					});


				 },
				 error:function(err){
				 	alert("失败数据:"+JSON.stringify(err));
				   }
				 });
			
					
					
					//FQC判断-----------------
				 
	
				
//			 }else{
//				 alert("不符合审核标准,存在正在进行的任务单,请更新全部任务单版本后再审核!");
//				 
//			 }
			 
			 
			//原审核功能-----------------

//	window.location.reload();
		}
	}else{
		alert("审核人未指定或,当前账号非该单据的指定审核人,不允许审核!");
	}


});

//按钮-表单审核驳回按钮
$('#BTNBPTAuditNo').click(function() {

	if(sessionName==$('#auditor option:selected').text()){
		var msg = confirm("如计划单信息有误,可先修改后再审核,驳回后此单立即完结,是否立即审核驳回?");
		if(msg==true){




			var PLDUpdData={
					"DBTable":"ppm_bills_plan",
					"BillIDName":"BPID",
					"DBID":$('#PLDDBID').val(),
					"WFStatus":19
			}



			var BPTAuditData={
					"DBTable":"ppm_bills_blueprint",
					"DBID":$('#DBID').val(),
					"auditor":sessionName,
					"auditDate":Ndate,
					"auditResult":2,
					"BPTAuditOpinion":$('#BPTAuditOpinion').val(),
					"BPTStatus":2
			}

//			var taskUpdData={
//					"DBTable":"ppm_bills_task",
//					"BillIDName":"taskBPID",
//					"DBID":$('#PLDDBID').val(),
//					"BTAcceptResult":19
//			}


			var ajax1=$.ajax({
		        method: 'post',
		        url: '/app/PM/updBillStatus',
		        data: PLDUpdData,
		        success: function(data, textStatus) {
		        },
		        error: function(XMLHttpRequest, textStatus, errorThrown) {}
		        });

			var ajax2=$.ajax({
	        method: 'post',
	        url: '/app/PM/updDBData',
	        data: BPTAuditData,
	        success: function(data, textStatus) {
	        },
	        error: function(XMLHttpRequest, textStatus, errorThrown) {}
	        });



		$.when(ajax1,ajax2).done(function(){
			alert("方案已审核驳回!");
			window.location.reload();

		});


		}
	}else{
		alert("审核人未指定或,当前账号非该单据的指定审核人,不允许审核!");
	}


});



//按钮-表单关闭按钮,添加刷新数据功能
$('#BTNBPTClose').click(function() {
	 window.location.reload();
});

});

</script>
