<!-- CSS -->
<link rel="stylesheet" type="text/css" href="/css/PM/PMContent.css">
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/Bootstrap-3.3.7/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/DataTables-1.10.18/css/dataTables.bootstrap.css">
<link href="/css/PM/datetimepicker/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
<link rel="stylesheet" href="/css/PM/bootstrap-select.min.css" />


<!-- JS  -->

<script src="/css/PM/DataTables/Bootstrap-3.3.7/js/bootstrap.min.js"></script>
<script src="/css/PM/bootstrap-select.min.js"></script>
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.min.js" charset="UTF-8"></script>
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>

<script type="text/javascript"  src="/css/PM/DataTables/DataTables-1.10.18/js/jquery.dataTables.min.js"></script>
<script type="text/javascript"  src="/css/PM/DataTables/DataTables-1.10.18/js/dataTables.bootstrap.min.js"></script>
<script src="/js/PM/FileSaver.min.js"></script>
<script src="/js/PM/tableExport.js"></script>
<script src="/js/PM/PMfuns.js"></script>




<% layout(locals.global.theme_layout_dir+'/master.ejs') -%>



<div class="divcontent">
    <h1>工作流程-方案单</h1>
    <hr>

    <!-- 操作区（按钮等） -->
    <div class="lineitem">
        
     <!--   <button id="BTNInfo" class="btn btn-warning">详情</button> -->
        
        <!-- 按钮触发模态框 -->
        <button id="BTNAdd" class="btn btn-primary" data-toggle="modal" >新增</button>
        <button id="BTNInfo" class="btn btn-info" data-toggle="modal" >详情</button>
        <button id="BTNDelete" class="btn btn-danger" data-toggle="modal" >删除</button>
        <!-- 模态框（Modal） -->
        <div class="modal fade" id="BillPLD" tabindex="-1" role="dialog" aria-labelledby="BillPLDLabel" aria-hidden="true">
            <div class="modal-dialog" style="width:98%">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="BillPLDLabel">计划单详情</h4>
                    </div>
                    <div class="modal-body">
                    
                    <!--------------跟踪面板----------------->
                    
                    <div class="panel panel-info" style="width:34%;float:left;">
                    
                    <!--------------panel--------------------->
                    <div class="panel-heading">
                        <h3 class="panel-title">计划单信息</h3>
                    </div>
                    <div class="panel-body" >
                    
                    <table class="table table-bordered">
                    <tr>
                      <td id="TBillPLD-BPID"></td>
                      <td id="TBillPLD-version"></td>
                      <td id="TBillPLD-CTRName"></td>
                      <td id="TBillPLD-orderFrom"></td>
                    </tr>
                    <tr>
                      <td id="TBillPLD-MHEName"></td>
                      <td id="TBillPLD-model"></td>
                      <td id="TBillPLD-OGNSystemVersion"></td>
                      <td id="TBillPLD-urgency"></td>
                    </tr>
                    <tr>
                    <td id="TBillPLD-applyDate"></td>
                    <td id="TBillPLD-limitDate"></td>
                    <td id="TBillPLD-PGEMaker"></td>
                    <td id="TBillPLD-fileName"></td>
                    </tr>

                    <tr>
                    <td id="TBillPLD-topic" colspan="2"></td>
                    <td id="TBillPLD-detail" colspan="2"></td>

                    </tr>
                    
                    <tr>
                    <td id="TBillPLD-maker"></td>
                    <td id="TBillPLD-makeDate"></td>
                    <td id="TBillPLD-auditor"></td>
                    <td id="TBillPLD-auditDate"></td>
                    </tr>
                    
                    </table>
                    
                    
                    </div>
                    <!--------------panel--------------------->
                    <!--------------panel--------------------->
                    <div class="panel-heading">
                        <h3 class="panel-title">方案单信息</h3>
                    </div>
                    
                    <div class="panel-body">
                    
                    <table class="table table-bordered">
                    
                    <tr>
                      <td>&nbsp;</td>
                      <td colspan="3">&nbsp;</td>
                      <td>&nbsp;</td>
                      <td colspan="3">&nbsp;</td>
                    </tr>
                    <tr>
                      <td>&nbsp;</td>
                      <td colspan="7">&nbsp;</td>
                    </tr>
                    </table>
                    </div>
                    <!--------------panel--------------------->
                    </div>
                    
                    
                    
                    
                    <!--------------跟踪面板----------------->
                    
                    <!--------------方案单面板----------------->

                    <div class="panel panel-info" style="width:65%;float:right;">
                	
                    <div class="panel-heading">
                        <h3 class="panel-title">方案单</h3>
                    </div>
                    
                    <div class="panel-body">
                    

                    

                    <form class="form-horizontal" >  
                    
                    <input id="DBID" type="text" value="" style="display:none;">
                    
                    <input id="fileDBID" type="text" value="" style="display:none;">
                    
                    <input id="auditResult" type="text" value="" style="display:none;">
                    
                    
                    <!-------------------------------------------------------------------------->
                     <div class="form-group">
                       
                       
                       <table class="table table-bordered" style="table-layout:fixed;">
                       
                       <tr>
                         <td>计划单号:</td>
                         <td colspan="2"><span id="BPID"></span></td>
                         <td>版本号:</td>
                         <td colspan="2"><span id="version"></span></td>
                         <td>客户:</td>
                         <td colspan="2"><span id="CTRName"></span></td>
                         <td>紧急度:</td>
                         <td colspan="2"><span id="urgency"></span></td>
                         
                       </tr>
                       <tr>
                         <td>方案人:</td>
                         <td><span id="PGEMaker"></span></td>
                         <td>修改主题:</td>
                         <td colspan="3"><span id="topic"></span></td>
                         <td>客户要求:</td>
                         <td colspan="5"><span id="detail"></span></td>
                       </tr>
                       </table>
                       

                     </div>
                     <!-------------------------------------------------------------------------->
                     
                     <div class="form-group">
                     
                     <label class="col-sm-1 control-label">方案单号:</label>
                     <div class="col-sm-3">
                       <input id="FA" class="form-control"  type="text" value="">
                     </div>
                     
                     <label for="limitDate" class="col-sm-1 control-label">完成期限:</label>                     
                     <div class="col-sm-3">
                     <div class="input-group date form_date " data-date="" data-date-format="yyyy-mm-dd" data-link-field="limitDate" data-link-format="yyyy-mm-dd" >
                         <input id="limitDate" class="form-control " size="16" type="text" value="" readonly>
                 		<span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                     </div>
                     <input type="hidden" id="limitDate" value="" />                 	
                 	 </div>
                     
                     </div>
                    
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">   
                     
                     <label  class="col-sm-1 control-label" for="name">机型:</label>    
                     <div class="col-sm-3">
                     <select  id="MHEName" class="selectpicker" data-live-search="true"> 
                     </select>
                     </div>  
                     
                     
                     <label  class="col-sm-1 control-label" for="name">系统:</label>    
                     <div class="col-sm-3">
                     <select  id="model" class="selectpicker" data-live-search="true"> 
                     </select>
                     </div>  
                    
                     </div>
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">

                    

                 	 </div>

                     <!-------------------------------------------------------------------------->

                     <div class="form-group">
                     
                     <label class="col-sm-1 control-label"> 是否修改:</label>   
                  	 <div class="col-sm-6">
                        
                  	    <label class="radio-inline">
                  	        <input type="radio" name="urgency" id="urgencyOption1" value="1"> 修改
                  	    </label>
                  	    <label class="radio-inline">
                  	        <input type="radio" name="urgency" id="urgencyOption2"  value="2"> 程序已有不处理
                  	    </label>
                  	    <label class="radio-inline">
                 	        <input type="radio" name="urgency" id="urgencyOption3"  value="3"> 要求不合理
                 	    </label> 
                 	        
                 	    <label class="radio-inline">
                	        <input type="radio" name="urgency" id="urgencyOption3"  value="4"> 非常规维护产品
                	    </label>     
                 	    
                  	</div>
                  	
                     </div>
                     
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     
                     <label class="col-sm-1 control-label">修改原因:</label>   
                 	 <div class="col-sm-8">
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" id="inlineCheckbox1" value="option1"> 功能修改
                 	    </label>
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" id="inlineCheckbox2" value="option2"> 功能新增
                 	    </label>
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" id="inlineCheckbox3" value="option3"> 优化
                 	    </label>
                 	        
                 	    <label class="checkbox-inline">
                	        <input type="checkbox" id="inlineCheckbox3" value="option3">bug修正
                	    </label>   
                	        <label class="checkbox-inline">
                	        <input type="checkbox" id="inlineCheckbox3" value="option3">测试程序
                	    </label>
                 	 </div>
                 	 
                 	 
                     </div>
                     

                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     
                     <label class="col-sm-1 control-label">核心处理范围:</label>   
                 	 <div class="col-sm-8">
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" id="inlineCheckbox1" value="option1"> kernel
                 	    </label>
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" id="inlineCheckbox2" value="option2"> LIB
                 	    </label>
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" id="inlineCheckbox3" value="option3"> OS
                 	    </label>
                 	   
                 	 </div>
                 	 
                 	 
                     </div>
                     
                     
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     <label  class="col-sm-1 control-label" for="name">修改方案说明:</label>    
                     <div class="col-sm-8">
                     <textarea id="detail" class="form-control" rows="3"></textarea>
                     </div>
                     </div>
                     
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     <label  class="col-sm-1 control-label" for="name">添加任务:</label>    
                     <div class="col-sm-11">
                     
                     <div class="panel panel-default">
                     <div class="panel-heading">任务单填写</div>
                     
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     
                     <label class="col-sm-2 control-label">类型:</label>   
                 	 <div class="col-sm-10">
                 	    <label class="radio-inline">
                 	        <input type="radio" name="taskType" id="radio1" value="option1"> DSP任务单
                 	    </label>
                 	    <label class="radio-inline">
                 	        <input type="radio" name="taskType" id="radio2" value="option2"> HMI任务单
                 	    </label>
                 	    <label class="radio-inline">
                 	        <input type="radio" name="taskType" id="radio3" value="option3"> 内核任务单
                 	    </label>
                 	   
                 	        
                 	      
                 	 </div>
                 	 
                 	
                 	
                 	
                     </div>
                     
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     
                     <label class="col-sm-2 control-label">修改属性:</label>   
                 	 <div class="col-sm-8">
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" id="inlineCheckbox1" value="option1"> 画面
                 	    </label>
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" id="inlineCheckbox2" value="option2"> 结构
                 	    </label>
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" id="inlineCheckbox3" value="option3"> 参数
                 	    </label>
                 	        
                 	    <label class="checkbox-inline">
                	        <input type="checkbox" id="inlineCheckbox3" value="option3">通信
                	    </label>   
                	        <label class="checkbox-inline">
                	        <input type="checkbox" id="inlineCheckbox3" value="option3">逻辑
                	    </label>
                 	 </div>
                 	 
                 	 
                     </div>
                     <!-------------------------------------------------------------------------->
                     
                     <div class="form-group">
                     
                     <label class="col-sm-2 control-label">任务单号:</label>
                     <div class="col-sm-3">
                       <input id="FA" class="form-control"  type="text" value="">
                     </div>
                     
                     <label for="limitDate" class="col-sm-2 control-label">完成期限:</label>                     
                     <div class="col-sm-3">
                     <div class="input-group date form_date " data-date="" data-date-format="yyyy-mm-dd" data-link-field="limitDate" data-link-format="yyyy-mm-dd" >
                         <input id="limitDate" class="form-control " size="16" type="text" value="" readonly>
                 		<span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                     </div>
                     <input type="hidden" id="limitDate" value="" />                 	
                 	 </div>
                     
                     </div>
                     
                     
                     <div class="form-group">  
                     
                     <label  class="col-sm-2 control-label" for="name">负责人:</label>    
                     <div class="col-sm-2">
                     <select  id="auditor" class="selectpicker" data-live-search="true"> 
                     </select>
                     </div>

                     </div>
                     <!-------------------------------------------------------------------------->
                     
                     <div class="form-group"> 
                     <label class="col-sm-2 control-label">任务要求:</label>
                     <div class="col-sm-8">
                       <input id="FA" class="form-control"  type="text" value="">
                     </div>
                     
                     </div>
                     
                    
                    
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     <label class="col-sm-10 control-label"></label>   
                  	<div class="col-sm-2">
                  	 <button id="BTNTaskAdd" type="button" class="btn btn-primary">新增任务</button>
                  	</div>
                  	</div>
                  	
                  	 <!-------------------------------------------------------------------------->


                     </div>
                     </div>
                     </div>
                     
                    
                 	
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     <label  class="col-sm-1 control-label" for="name">任务清单:</label>    
                     <div class="col-sm-11">
                     
                     <div class="panel panel-default">
                     <div class="panel-heading">任务清单</div>
                     <table class="table">
                         <th>任务单号</th><th>负责人</th><th>任务说明</th><th>完成期限</th><th>删除</th>
                         <tr><td>20190215T1</td><td>熊奇龙</td><td>调节123123123123131231233123123</td><td>2019-03-31</td><td>删除</td></tr>
                         <tr><td>20190215T2</td><td>李明</td><td>调节123123123123131231233123123</td><td>2019-03-31</td><td>删除</td></tr>
                     </table>
                     </div>
                     
                     </div>
                     </div>
                    
                    <!-------------------------------------------------------------------------->

                 

                 	<div id="auditTypeDiv" class="form-group">
                 	
                 	<label class="col-sm-1 control-label">审核方式:</label>   
                 	<div class="col-sm-6">
                 	    
                 	    <label class="radio-inline">
         	            <input type="radio" name="auditType" id="auditTypeOption2"  value="2"> 暂不审核
         	            </label>
                       
                 	    <label class="radio-inline">
                 	        <input type="radio" name="auditType" id="auditTypeOption1" value="1"> 自我审核
                 	    </label>
                 	    
                 	    <label class="radio-inline">
                	        <input type="radio" name="auditType" id="auditTypeOption3"  value="3"> 指定审核人
                	    </label>
                 	        
                 	        
                 	</div>
                     
                    </div>
                     
                    
                     <!-------------------------------------------------------------------------->

                     <div class="form-group">  
                     
                     <label  class="col-sm-1 control-label" for="name">制单人:</label>    
                     <div class="col-sm-3">
                     <input id="maker" class="form-control"  type="text" disabled="true" >
                     </div>
                     
                     <label  class="col-sm-1 control-label" for="name">制单日期:</label>    
                     <div class="col-sm-3">
                     <input id="makeDate" class="form-control"  type="text" disabled="true" >
                     </div>
                     
                     
                     </div>
                     
                     <!-------------------------------------------------------------------------->

                     <div class="form-group">  
                     
                     <label  class="col-sm-1 control-label" for="name">审核人:</label>    
                     <div class="col-sm-3">
                     <select  id="auditor" class="selectpicker" data-live-search="true"> 
                     </select>
                     </div>
                     
                     <label  class="col-sm-1 control-label" for="name">审核日期:</label>    
                     <div class="col-sm-3">
                     <input id="auditDate" class="form-control"  type="text" disabled="true" >
                     </div>
                     
                     
                     </div>

                     </form>
                     
                     
                    

                    </div>
                    
                    <div class="panel-footer">
                    
                    <button id="BTNFormAdd" type="button" class="btn btn-primary">新增</button>
                    <button id="BTNFormModify" type="button" class="btn btn-info">修改</button> 
                    <button id="BTNFormUpdate" type="button" class="btn btn-warning">更新版本</button>
                    <button id="BTNFormAuditYes" type="button" class="btn btn-success">审核通过</button>
                    <button id="BTNFormAuditNo" type="button" class="btn btn-danger">审核驳回</button>

                    
                    </div>
                   
                    
                   </div>
                   
                  
                   
                   
                   
                   <!--------------方案单面板----------------->

                   
                   
                   <!---------清除浮动---------------------------------->
                   <div style='clear:both'></div>

                    
                    
                    </div>
                    <div class="modal-footer">
                      
                        
                       
                     
                        <button id="BTNFormClose" type="button" class="btn btn-default" data-dismiss="modal">关闭</button>

                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>
        
        

    </div>
    
    
    
    
    <br/>

    <!--数据呈现区-->
    <table id="billsBPTTable" class="table table-striped table-bordered"  >
        <thead>
            <tr>
                <th>数据库ID</th>
                <th>计划单号</th>
                <th>版本号</th>
                <th>客户简称</th>
                <th>主题</th>
                <th>方案人</th>
                <th>审核状态</th>


            </tr>
        </thead>
    </table>

    
</div>


<script>


//函数:计划单号生成规则

function Fun_billIDCreate(para){
	var BillID=new Date(Ndate).Format("yyyyMMdd")+para+Math.floor(Math.random()*1000);
	return BillID;
}


////函数:新增详情页自动填写内容------------------------
//function Fun_winAddInit(){
//
//	$('#BPID').val(Fun_billIDCreate("DG")); 
//	
//	var SQLCTRName={SQL:"SQLSRCustomers"};
//	var CTRName="#CTRName";
//	Fun_getSQLSelectDBData(SQLCTRName,CTRName);
//    	
//	var SQLMHEName={SQL:"SQLSRMachines"};
//	var MHEName="#MHEName";
//	Fun_getSQLSelectDBData(SQLMHEName,MHEName);
//	
//	var SQLModel={SQL:"SQLSRSystems"};
//	var model="#model";
//	Fun_getSQLSelectDBData(SQLModel,model);
//	
//	var SQLPGEMaker={SQL:"SQLSRStaffs"};
//	var PGEMaker="#PGEMaker";
//	Fun_getSQLSelectDBData(SQLPGEMaker,PGEMaker);
//	
//	var SQLAuditor={SQL:"SQLSRStaffs"};
//	var auditor="#auditor";
//	Fun_getSQLSelectDBData(SQLAuditor,auditor,"<%-locals.session.yjUser.Name%>");
//
//
//	
//	
////    var staff_Select_Para={DBTable:"ppm_staffs",selectTitle:"staff_Name"};
////	var staff_selectorID="#PGEMaker";
////    getSelectDBData(staff_Select_Para,staff_selectorID);  
////    
////
////	var staff_Select_Para={DBTable:"ppm_staffs",selectTitle:"staff_Name"};
////	var staff_selectorID="#auditor";
////    getSelectDBData(staff_Select_Para,staff_selectorID,"<%-locals.session.yjUser.Name%>");  
//    
//    
//    $("#auditor").attr("disabled",true);
//    
//    $('#topic').val(""); 
//    $('#detail').val(""); 
//    
//    $('#version').text(0); 
//    
//  
//  $('.form_date').datetimepicker({
//      language:  'zh-CN',
//      weekStart: 1,
//      todayBtn:  1,
//		autoclose: 1,
//		todayHighlight: 1,
//		startView: 2,
//		minView: 2,
//		forceParse: 0
//  });
//  
//  $('#divFilesUploaded').html("");
//  
//  $("#auditTypeOption1").attr("checked",true);
//  $("#urgencyOption1").attr("checked",true);
//  
//  
//  $('#applyDate').val(Ndate); 
//  $('#limitDate').val(Fun_getEndDate(Ndate,3));
//  $('#maker').val("<%-locals.session.yjUser.Name%>");
//  $('#makeDate').val(Ndate);
//
//  $('#auditDate').val(Ndate);
//  $('#auditResult').val(1);
//  
//  $("#auditTypeDiv").show();
//  
//  $("#BTNFormAdd").show();
//  
//  $("#BTNFormModify").hide();
//  $("#BTNFormUpdate").hide();
//  $("#BTNFormAuditYes").hide();
//  $("#BTNFormAuditNo").hide();
//  
//  
//
//}

//函数:详情按钮详情页自动填写内容------------------------
function Fun_winDetailInit(dataSelect){
	
	$('#DBID').val(dataSelect.DBID); 
	$('#fileDBID').val(dataSelect.fileDBID); 
	
	console.log("fileDBID:"+dataSelect.fileDBID);
	
	$('#BPID').text(dataSelect.BPID); 
	$('#version').text(dataSelect.version); 
	$('#CTRName').text(dataSelect.CTRName); 
	$('#topic').text(dataSelect.topic); 
	$('#detail').text(dataSelect.detail); 
	$('#urgency').text(dataSelect.urgency);
	$('#PGEMaker').text(dataSelect.PGEMaker);
	
//	var SQLCTRName={SQL:"SQLSRCustomers"};
//	var CTRName="#CTRName";
//	Fun_getSQLSelectDBData(SQLCTRName,CTRName,dataSelect.CTRName);
//	
	var SQLMHEName={SQL:"SQLSRMachines"};
	var MHEName="#MHEName";
	Fun_getSQLSelectDBData(SQLMHEName,MHEName,dataSelect.MHEName);
	
	var SQLModel={SQL:"SQLSRSystems"};
	var model="#model";
	Fun_getSQLSelectDBData(SQLModel,model,dataSelect.model);
	
//	var SQLPGEMaker={SQL:"SQLSRStaffs"};
//	var PGEMaker="#PGEMaker";
//	Fun_getSQLSelectDBData(SQLPGEMaker,PGEMaker,dataSelect.PGEMaker);

    
    $('#topic').val(dataSelect.topic); 
    $('#detail').val(dataSelect.detail); 
    
  
  $('.form_date').datetimepicker({
      language:  'zh-CN',
      weekStart: 1,
      todayBtn:  1,
		autoclose: 1,
		todayHighlight: 1,
		startView: 2,
		minView: 2,
		forceParse: 0
  });

  $('#divFilesUploaded').html("");
  
  if(dataSelect.fileKey!=null){
	  
	  console.log("不为空"+dataSelect.fileKey);
	  var downloadurl="<a id='filePath' href="+'/system.files.download/upload_'+dataSelect.fileKey+" download="+dataSelect.fileName+">"+"<span id='fileName'>"+dataSelect.fileName+"</span></a>";
	  $('#divFilesUploaded').html(downloadurl);
  }
  
  
  $('#applyDate').val(dataSelect.applyDate); 
  $('#limitDate').val(dataSelect.limitDate);
  $('#maker').val(dataSelect.maker);
  $('#makeDate').val(dataSelect.makeDate);
//  $('#auditor').val("<%-locals.session.yjUser.Name%>");
//  $('#auditDate').val(Ndate);
  
  
  $("#BTNFormAdd").hide();
  
  switch(dataSelect.urgency){
  case 1:
	  $("#urgencyOption1").attr("checked",true);
	  break;
  case 2:
	  $("#urgencyOption2").attr("checked",true);
	  break;
  case 3:
	  $("#urgencyOption3").attr("checked",true);
	  break;  
  }
  
  $('#auditResult').val(dataSelect.auditResult);

  //如果是已审核单据 则不显示更新和审核按钮
  if(dataSelect.auditDate==null){
	  

	  $("#BTNFormModify").show();
	  $("#BTNFormUpdate").hide();
	  $("#BTNFormAuditYes").show();
	  $("#BTNFormAuditNo").show();
	  
	  var SQLAuditor={SQL:"SQLSRStaffs"};
	  var auditor="#auditor";
	  
	  if(dataSelect.auditor==null){
		  
		  console.log("审核日期空,审核人空");
		  
		    $("#auditTypeOption2").attr("checked",true);	 
			Fun_getSQLSelectDBData(SQLAuditor,auditor);	   
		    $("#auditor").attr("disabled",true);
		    $('#auditDate').val("");

	  }else{
		  
		  console.log("审核日期空,审核人有");
		  
		    $("#auditTypeOption3").attr("checked",true);
		    Fun_getSQLSelectDBData(SQLAuditor,auditor,dataSelect.auditor);	   
		    $("#auditor").attr("disabled",true);
		    $('#auditDate').val("");
	  }
	  
	  
	
	  
  }else{ 
	  
	    
	    
	    var SQLAuditor={SQL:"SQLSRStaffs"};
	    var auditor="#auditor";
	    
	    $("#BPID").attr("disabled",true);
	  
	    $("#auditTypeOption1").attr("checked",true);
	    Fun_getSQLSelectDBData(SQLAuditor,auditor,dataSelect.auditor);	 
	    
	    $("#auditor").attr("disabled",true);
	    
	    $('#auditDate').val(dataSelect.auditDate);
	    
	    $("#BTNFormModify").hide();
	    $("#BTNFormUpdate").show();
	    $("#BTNFormAuditYes").hide();
	    $("#BTNFormAuditNo").hide();
	
	  
  }
  

 

}

//页面加载函数---------------
$(document).ready( function () {
	
	
	const tableSQL={"SQL":"SQLTableBillsBPT"};
	
	var sessionName="<%-locals.session.yjUser.Name%>";
	
	console.log("sessionName:"+sessionName);
	
	
	const tableInfo={
			"tableID":"#billsBPTTable",
			"columnsData":[
				{ data: 'DBID' ,"visible": false},
		        { data: 'BPID' },
		        { data: 'version'},
		        { data: 'CTRName'},
		        { data: 'topic'},
		        { data: 'PGEMaker'},
		        { data: 'auditText'}
			]
	}
	
	
	Fun_showSQLTable(tableSQL,tableInfo)

	
//判断是否选中数据-------
var table = $('#billsBPTTable').DataTable();
$('#billsBPTTable tbody').on('click', 'tr', function() {
    if ($(this).hasClass('selected')) {
        $(this).removeClass('selected');
    } else {
        table.$('tr.selected').removeClass('selected');
        $(this).addClass('selected');
    }
 
    var dataSelect = table.row('.selected').data();
    
    

});
	

//按钮-新增计划单---------
$('#BTNAdd').click(function() {
	$('#BillPLD').modal('show');
	Fun_winAddInit();
 
});



//radio 定义更换按键触发事件-----------
$('input:radio[name="auditType"]').click(function(){
	var radioValue = $('input:radio[name="auditType"]:checked').val(); 
//	alert(radioValue);
	
	switch(radioValue){
	case "1":		
		var SQLAuditor={SQL:"SQLSRStaffs"};
		var auditor="#auditor";
		Fun_getSQLSelectDBData(SQLAuditor,auditor,sessionName);	 
	    $("#auditor").attr("disabled",true);
	    $('#auditDate').val(Ndate);
	    $('#auditResult').val(1);
	    break;
	case "2":
		var SQLAuditor={SQL:"SQLSRStaffs"};
		var auditor="#auditor";
		Fun_getSQLSelectDBData(SQLAuditor,auditor);
	    $("#auditor").attr("disabled",true);
	    $('#auditDate').val("");
	    $('#auditResult').val("");
	    break;
	case "3":
		alert("请选择指定审核人!");
	    $('#auditDate').val("");
	    var SQLAuditor={SQL:"SQLSRStaffs"};
		var auditor="#auditor";
		Fun_getSQLSelectDBData(SQLAuditor,auditor);
	    $("#auditor").attr("disabled",false);
	    $('#auditResult').val("");
	    break;
		
	
	}

});


//详情按钮---------
$('#BTNInfo').click(function() {
    console.log("seclet: "+JSON.stringify(table.row('.selected').data()));
    // table.row('.selected').remove().draw( false );
    var dataSelect = table.row('.selected').data();
    if (dataSelect == undefined) {
        alert("请先点击表格中的表单!");
    } else {
    	
    	
    	$('#BillPLD').modal('show')
    	Fun_winDetailInit(dataSelect);
    	

    }
});




//删除按钮----------
$('#BTNDelete').click(function() {
    var dataSelect = table.row('.selected').data();
    
 //   console.log(JSON.stringify(dataSelect));
    
    if (dataSelect == undefined) {
        alert("当前未选择任何数据,请先点击需要删除的数据行!");
    } else {
    	
    	
    	if(dataSelect.auditDate!=null){
    		alert("已审核单据禁止删除!");
    	}else{
    		
    		
    		var msg1 = confirm("风险操作！此行数据内容移除后无法还原，请确认操作是否无误！");
            if (msg1 === true) {
                var msg2 = confirm("确认删除此行数据？");
                if (msg2 === true) {
                	
                //	console.log(dataSelect.DBID);
                    var IDData = {"DBTable":"ppm_bills_plan","DBID":dataSelect.DBID};
 //                   console.log("IDData:"+JSON.stringify(IDData));
                    delDBData(IDData);
                }
            }
    		
    		
    	}

    }
    //          table.row('.selected').remove().draw( false );//前端删除显示数据 ,数据库不删除
});


//按钮-表格新增计划单

$('#BTNFormAdd').click(function(){
	
	var radioValue = $('input:radio[name="auditType"]:checked').val();
	
	if(radioValue==1){
		var WFStatus=10;
	}else{
		var WFStatus=1;
	}
	
	var billData={
			"DBTable":"ppm_bills_plan",
			"BPID":$('#BPID').val(),
			"CTRName":Fun_getSelectText($('#CTRName option:selected').text()),
			"topic":$('#topic').val(),
			"detail":$('#detail').val(),
			"PGEMaker":$('#PGEMaker option:selected').text(),
			"orderFrom":$('#orderFrom option:selected').text(),
			"MHEName":Fun_getSelectText($('#MHEName option:selected').text()),
			"model":Fun_getSelectText($('#model option:selected').text()),
			"applyDate":$('#applyDate').val(),
			"limitDate":$('#limitDate').val(),
			"urgency":$('input:radio[name="urgency"]:checked').val(),
			"maker":$('#maker').val(),
			"auditor":$('#auditor option:selected').text(),
			"makeDate":$('#makeDate').val(),
			"auditDate":$('#auditDate').val(),
			"auditResult":$('#auditResult').val(),
			"version": $('#version').text(),
			"WFStatus":WFStatus
	}
	
	console.log("billData:"+JSON.stringify(billData));
	addDBData(billData);
	
    //记录附件信息------------------	
	var billID=$('#BPID').val();
	var fileKey=$('#filePath').attr('href').substring(30);//去掉多余的字符串前缀
	var fileName=$('#fileName').html();
	var fileData={
			"DBTable":"ppm_files_upload",
			"billName":"ppm_bills_plan",
			"billID":billID,
			"billVersion":$('#version').text(),
			"fileKey":fileKey,
			"fileName":fileName
	}
	
	if(fileKey!=undefined){
		Fun_addfileInfo(fileData);
	}


});


//按钮-表格修改计划单

$('#BTNFormModify').click(function() {

	var billData={
			"DBTable":"ppm_bills_plan",
			"DBID":$('#DBID').val(),
			"BPID":$('#BPID').val(),
			"CTRName":Fun_getSelectText($('#CTRName option:selected').text()),
			"topic":$('#topic').val(),
			"detail":$('#detail').val(),
			"PGEMaker":$('#PGEMaker option:selected').text(),
			"orderFrom":$('#orderFrom option:selected').text(),
			"MHEName":Fun_getSelectText($('#MHEName option:selected').text()),
			"model":Fun_getSelectText($('#model option:selected').text()),
			"applyDate":$('#applyDate').val(),
			"limitDate":$('#limitDate').val(),
			"urgency":$('input:radio[name="urgency"]:checked').val(),
			"maker":$('#maker').val(),
			"auditor":$('#auditor option:selected').text(),
			"makeDate":$('#makeDate').val(),
			"auditDate":$('#auditDate').val(),
			"version": $('#version').text(),
			"WFStatus":2
	}

	updDBData(billData,"表单");
	
    //记录附件信息------------------	
	var fileDBID=$('#fileDBID').val();
	var billID=$('#BPID').val();

	if($('#filePath').attr('href')!=undefined){
		var fileKey=$('#filePath').attr('href').substring(30);//去掉多余的字符串前缀
		var fileName=$('#fileName').html();
		
	}else{
		var fileKey="";
		var fileName="";
	}
	

	var fileData={
			"DBTable":"ppm_files_upload",
			"DBID":fileDBID,
			"billID":billID,
			"fileKey":fileKey,
			"fileName":fileName
	}
	
	console.log("fileData:"+JSON.stringify(fileData));
	

	if(fileKey!=undefined){
		
		console.log("fileKey:"+fileKey);
		console.log("fileDBID:"+fileDBID);
		if(fileDBID==""){
			console.log("fileDBID:null");			
			var fileAddData={
					"DBTable":"ppm_files_upload",
					"billName":"ppm_bills_plan",
					"billID":billID,
					"billVersion":$('#version').text(),
					"fileKey":fileKey,
					"fileName":fileName
			}
			
			console.log("fileAddData:"+fileAddData);
			Fun_addfileInfo(fileAddData);
			
		}else{
			console.log("fileDBID:not null,"+fileDBID);
			updDBData(fileData,"附件");
		}
	}


});

//按钮-表单更新版本按钮



$('#BTNFormUpdate').click(function() {
	
	var msg1 = confirm("风险操作！已审核的单据更新版本,原单据将失效!");
    if (msg1 === true) {
        var msg2 = confirm("确认更新版本？");
        if (msg2 === true) {
        	
        	var newVersion=parseInt($('#version').text())+1;
  
        	var billData={
        			"DBTable":"ppm_bills_plan",
        			"BPID":$('#BPID').val(),
        			"CTRName":Fun_getSelectText($('#CTRName option:selected').text()),
        			"topic":$('#topic').val(),
        			"detail":$('#detail').val(),
        			"PGEMaker":$('#PGEMaker option:selected').text(),
        			"orderFrom":$('#orderFrom option:selected').text(),
        			"MHEName":Fun_getSelectText($('#MHEName option:selected').text()),
        			"model":Fun_getSelectText($('#model option:selected').text()),
        			"applyDate":$('#applyDate').val(),
        			"limitDate":$('#limitDate').val(),
        			"urgency":$('input:radio[name="urgency"]:checked').val(),
        			"maker":$('#maker').val(),
        			"auditor":$('#auditor option:selected').text(),
        			"makeDate":$('#makeDate').val(),
        			"auditDate":$('#auditDate').val(),
        			"version": newVersion
        	}
        	
        	console.log("billData:"+JSON.stringify(billData));
        	addDBData(billData);
        	
            //记录附件信息------------------	
        	var billID=$('#BPID').val();
        	var fileKey=$('#filePath').attr('href').substring(30);//去掉多余的字符串前缀
        	var fileName=$('#fileName').html();
        	var fileData={
        			"DBTable":"ppm_files_upload",
        			"billName":"ppm_bills_plan",
        			"billID":billID,
        			"billVersion":newVersion,
        			"fileKey":fileKey,
        			"fileName":fileName
        	}
        	
        	if(fileKey!=undefined){
        		Fun_addfileInfo(fileData);
        	}

        	
        }
    }

});

//按钮-表单审核通过按钮
$('#BTNFormAuditYes').click(function() {
	
	if(sessionName==$('#auditor option:selected').text()){
		var msg = confirm("审核后无法修改单据,是否立即审核通过?");
		if(msg==true){	
			var auditData={
					"DBTable":"ppm_bills_plan",
					"DBID":$('#DBID').val(),
					"auditor":sessionName,
					"auditDate":Ndate,
					"auditResult":1,
					"WFStatus":10

			}

			updDBData(auditData,"表单审核状态");
			window.location.reload();
		}
	}else{
		alert("审核人未指定或,当前账号非该单据的指定审核人,不允许审核!");
	}


});

//按钮-表单审核驳回按钮
$('#BTNFormAuditNo').click(function() {
	
	if(sessionName==$('#auditor option:selected').text()){
		var msg = confirm("如计划单信息有误,可先修改后再审核,驳回后此单立即完结,是否立即审核驳回?");
		if(msg==true){	
			var auditData={
					"DBTable":"ppm_bills_plan",
					"DBID":$('#DBID').val(),
					"auditor":sessionName,
					"auditDate":Ndate,
					"auditResult":2,
					"WFStatus":9
			}

			updDBData(auditData,"表单审核状态");
			window.location.reload();
		}
	}else{
		alert("审核人未指定或,当前账号非该单据的指定审核人,不允许审核!");
	}


});



//按钮-表单关闭按钮,添加刷新数据功能
$('#BTNFormClose').click(function() {
	 window.location.reload();
});
	
}); 

</script>
