<!-- CSS -->
<link rel="stylesheet" type="text/css" href="/css/PM/PMContent.css">
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/Bootstrap-3.3.7/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/DataTables-1.10.18/css/dataTables.bootstrap.css">
<link href="/css/PM/datetimepicker/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
<link rel="stylesheet" href="/css/PM/bootstrap-select.min.css" />


<!-- JS  -->

<script src="/css/PM/DataTables/Bootstrap-3.3.7/js/bootstrap.min.js"></script>
<script src="/css/PM/bootstrap-select.min.js"></script>
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.min.js" charset="UTF-8"></script>
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>

<script type="text/javascript" src="/css/PM/DataTables/DataTables-1.10.18/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="/css/PM/DataTables/DataTables-1.10.18/js/dataTables.bootstrap.min.js"></script>
<script src="/js/PM/FileSaver.min.js"></script>
<script src="/js/PM/tableExport.js"></script>
<script src="/js/PM/PMfuns.js"></script>

<script src="/js/sweetalert.min.js"></script>
<script src="/public/funs.js"></script>

<% layout(locals.global.theme_layout_dir+'/master.ejs') -%>

<!------begin view-------------------------->
<div class="divcontent">
	<h1>工作流程-IPQC单</h1>
	<hr>

	<!-- 操作区（按钮等） -->
	<div class="lineitem">

		<!--   <button id="BTNInfo" class="btn btn-warning">详情</button> -->

		<!-- 按钮触发模态框 -->
		<!--   <button id="BTNIPQCAudit" class="btn btn-primary" data-toggle="modal" >IPQC审核</button> -->
		<button id="BTNIPQCRecord" class="btn btn-info" data-toggle="modal">IPQC登记</button>
		<!--      <button id="BTNDelete" class="btn btn-danger" data-toggle="modal" >删除</button> -->

		<div class="btn-group" style="margin-left:20px">
			<button id="BTNFilterSimple" class="btn btn-default">未完成单据</button>
			<button id="BTNFilterAll" class="btn btn-default">全部单据</button>
		</div>

		<a href="/app/PM/workCenter"><button id="BTNWorkCenter" class="btn btn-success"
				style="float:right">个人中心</button></a>
		<!-- 模态框（Modal） -->
		<div class="modal fade" id="BillTask" tabindex="-1" role="dialog" aria-labelledby="BillTaskLabel"
			aria-hidden="true" data-backdrop="static">
			<div class="modal-dialog" style="width:70%">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title" id="BillTaskLabel">任务单详情</h4>
					</div>
					<div class="modal-body">




						<div id="DivTaskInfo" class="panel panel-info">
							<div class="panel-heading">
								<h3 class="panel-title">任务信息</h3>
							</div>

							<div class="panel-body">

								<div class="form-horizontal">
									<span id="DBID" style="display:none"></span>
									<span id="taskBPID" style="display:none"></span>

									<!-------------------------------------------------------------------------->

									<div class="form-group">

										<label class="col-sm-1 control-label">任务单号:</label>
										<div class="col-sm-2">
											<span id="BTID" class="help-block"></span>

										</div>

										<label class="col-sm-2 control-label">任务单版本号:</label>
										<div class="col-sm-1">
											<span id="BTVersion" class="help-block"></span>
										</div>

										<label class="col-sm-1 control-label">客户名称:</label>
										<div class="col-sm-1">
											<span id="taskCTRName" class="help-block"></span>
										</div>

									</div>

									<!-------------------------------------------------------------------------->
									<div class="form-group">

										<label class="col-sm-1 control-label">修改属性:</label>
										<div class="col-sm-8">
											<label class="checkbox-inline">
												<input type="checkbox" name="modifyABE" value="ABE1"> 画面
											</label>
											<label class="checkbox-inline">
												<input type="checkbox" name="modifyABE" value="ABE2"> 结构
											</label>
											<label class="checkbox-inline">
												<input type="checkbox" name="modifyABE" value="ABE3"> 参数
											</label>

											<label class="checkbox-inline">
												<input type="checkbox" name="modifyABE" value="ABE4">通信
											</label>
											<label class="checkbox-inline">
												<input type="checkbox" name="modifyABE" value="ABE5">逻辑
											</label>

										</div>


									</div>

									<!-------------------------------------------------------------------------->
									<div class="form-group">

										<label class="col-sm-1 control-label" for="name">负责人:</label>
										<div class="col-sm-1">

											<span id="taskStaff" class="help-block"></span>
										</div>

										<label class="col-sm-1 control-label"></label>
										<label for="limitDate" class="col-sm-2 control-label">任务完成期限:</label>
										<div class="col-sm-2">
											<span id="taskLimitDate" class="help-block"></span>
										</div>


										<label class="col-sm-2 control-label" for="name">任务发布人:</label>
										<div class="col-sm-2">

											<span id="taskMaker" class="help-block"></span>
										</div>

									</div>




									<div class="form-group">
										<label class="col-sm-1 control-label">任务要求:</label>
										<div class="col-sm-10">
											<span id="taskDBE" class="help-block" style="white-space:pre-wrap;"></span>


										</div>

									</div>

									<!-------------------------------------------------------------------------->

									<div class="form-group">
										<label class="col-sm-1 control-label">确认意见:</label>
										<div class="col-sm-10">
											<span id="BTAcceptOpinion" class="help-block"></span>
										</div>

									</div>

									<!-------------------------------------------------------------------------->
									<div class="form-group">

										<label class="col-sm-1 control-label">FQC申请:</label>
										<div class="col-sm-3">
											<label class="radio-inline">
												<input type="radio" name="FQCRequest" id="radio1" value="1">
												<span>有</span>
											</label>
											<label class="radio-inline">
												<input type="radio" name="FQCRequest" id="radio2" value="2" checked>
												<span>无</span>
											</label>

										</div>


										<label class="col-sm-1 control-label">返工任务:</label>
										<div class="col-sm-2">
											<span id="taskRepeat" style="display:none"></span>
											<span id="taskRepeatText" class="help-block"></span>
										</div>


										<label class="col-sm-1 control-label">IPQC填单:</label>
										<div class="col-sm-3 ">
											<span id="IPQCMaker" class="help-block"></span>
										</div>

									</div>

								</div>


							</div>
						</div>


						<!-------------------------------------------------------------------------->
						<div class="panel panel-warning">
							<div class="panel-heading">
								<h3 class="panel-title">任务记录</h3>
							</div>
							<div class="panel-body">

								<div class="form-horizontal">

									<!-recordtable-------------->


										<span id="recordDBID" style="display:none"></span>

										<table id="tableRecords" class="table table-bordered">
											<thead></thead>
											<tbody></tbody>
										</table>





										<!-recordtable-------------->
								</div>


							</div>
						</div>

						<!-------------------------------------------------------------------------->


						<div id="divIPQCPanel" class="panel panel-success">
							<div class="panel-heading">
								<h3 class="panel-title">IPQC记录</h3>
							</div>
							<div class="panel-body">


								<div class="form-horizontal">
									<!-------------------------------------------------------------------------->

									<div class="form-group">
										<label class="col-sm-1 control-label">测试内容:</label>
										<div class="col-sm-10">

											<table id="TableTestContents" class="table table-bordered"
												style="width:100%;">
												<thead>
													<tr>
														<th width="70px">模块</th>
														<th>测试内容</th>
														<th width="120px">测试结果</th>
														<th width="200px">备注</th>
													</tr>
												</thead>
												<tbody>
												</tbody>
											</table>





										</div>
									</div>

									<!-------------------------------------------------------------------------->
									<div id="DivIPQCInfo">
										<!----begin--DivIPQCInfo-------------------------------------------------------------------->

										<div class="form-group">
											<label class="col-sm-1 control-label">备注:</label>
											<div class="col-sm-10">
												<span id="IPQCContentShow" class="help-block"></span>
												<textarea id="IPQCContent" class="form-control" rows="2"></textarea>
											</div>
										</div>

										<!-------------------------------------------------------------------------->
										<div class="form-group">
											<label class="col-sm-1 control-label">测试结果:</label>
											<div class="col-sm-10">
												<label class="radio-inline">
													<input type="radio" name="IPQCResult" id="radio1" value="1">
													测试通过
												</label>
												<label class="radio-inline">
													<input type="radio" name="IPQCResult" id="radio2" value="2" checked>
													测试未通过
												</label>

											</div>
										</div>
										<!-------------------------------------------------------------------------->
										<div class="form-group">



											<label for="recordAuditDate"
												class="col-sm-1 control-label">IPQC制单日期:</label>
											<div class="col-sm-2">
												<span id="IPQCMakeDate" class="help-block"></span>
											</div>

											<label class="col-sm-2 control-label">IPQC结果:</label>
											<div class="col-sm-1">
												<span id="IPQCAuditResultText" class="help-block"></span>
											</div>

											<label class="col-sm-2 control-label">测试项目版本:</label>
											<div class="col-sm-1">
												<span id="testContentsVer" class="help-block"></span>
											</div>


										</div>

										<!-------------------------------------------------------------------------->

										<!-------------------------------------------------------------------------->
										<div class="form-group">

											<label class="col-sm-1 control-label" for="name">IPQC审核人:</label>
											<div class="col-sm-1">

												<select id="IPQCAuditor" class="selectpicker" data-live-search="true">
												</select>
											</div>

											<label class="col-sm-1 control-label"></label>
											<label for="recordAuditDate"
												class="col-sm-2 control-label">IPQC审核日期:</label>
											<div class="col-sm-2">
												<span id="IPQCAuditDate" class="help-block"></span>
											</div>



										</div>

										<!-------------------------------------------------------------------------->
										<div class="form-group">
											<label class="col-sm-1 control-label" for="name">报告:</label>
											<div class="col-sm-3">
												<div id="report"></div>
											</div>
										</div>

										<!-------------------------------------------------------------------------->

										<div class="form-group" id="DivIPQCBTNS">
											<label class="col-sm-1 control-label"></label>
											<div class="col-sm-10">
												<button id="BTNTaskIPQCSave" class="btn btn-success"
													data-toggle="modal">保存IPQC记录</button>
												<button id="BTNTaskIPQCAudit" class="btn btn-warning"
													data-toggle="modal">审核IPQC记录</button>
												<!-- <button id="BTNReportCreate" class="btn btn-warning" data-toggle="modal" >生成IPQC报告(开发中)</button>-->
											</div>
										</div>

									</div>
									<!----end DivIPQCInfo------------->



								</div>



							</div>
						</div>













						<!--------------方案单面板----------------->



						<!---------清除浮动---------------------------------->
						<div style='clear:both'></div>



					</div>
					<div class="modal-footer">

						<button id="BTNFormClose" type="button" class="btn btn-default" data-dismiss="modal">关闭</button>

					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal -->
		</div>



	</div>



	<br />

	<!--数据呈现区-->
	<table id="billsTaskTable" class="table table-striped table-bordered">
		<thead>
			<tr>
				<th>时间戳</th>
				<th>数据库ID</th>
				<th>任务单号</th>
				<th>版本号</th>
				<th>客户名称</th>
				<th>任务类别</th>
				<th>任务类型</th>
				<th>完成期限</th>
				<th>IPQC填单人</th>
				<th>审核人</th>
				<th>IPQC结果</th>
				<th>IPQC状态</th>


			</tr>
		</thead>
	</table>


</div>

<!--------end view-------------------->
<script>
	//检查输入项
	function checkIPQCInput() {

		if ($("#IPQCAuditor").val() == null || $("#IPQCAuditor").val() == "") {
			swal("IPQC审核人未选择,请检查!");
			return false;
		}

		return true;

	}

	//绑定change事件

	function IPQCResultEventBind() {
		//绑定radio切换改变 计划单号事件
		//	$('input[type=radio][name=IPQCResult]').unbind();

		$('input[type=radio][name=IPQCResult]').change(function () {

			if ($('input:radio[name="IPQCResult"]:checked').val() == 1) {
				Fun_getSQLSelectDBData({
					SQL: "SQLSRStaffs"
				}, "#IPQCAuditor", sessionName);
			} else {
				Fun_getSQLSelectDBData({
					SQL: "SQLSRStaffs"
				}, "#IPQCAuditor", $('#taskStaff').text());
			}

		});
	}

	//ipqc 增加项
	const showIPQCAddItem = async ({
		BTID,
		BTVersion
	}) => {

		var tr = "<tr>" +
			"<td>修改内容</td>" +
			"<td><div id='recordModifyContent'></div></td>" +
			"<td><input type='radio' name='recordResultRadio'  value='1' ><span>正确</span> <input type='radio' name='recordResultRadio' value='2' checked> <span>不正确</span></td>" +
			"<td><input id='recordRemark' type='text' value='' style='width:100%'></td></td>" +
			"</tr>";
		//$("table").append(tr);
		// $("#TableTestContents tbody tr:eq(0)").before(tr);
		$("#TableTestContents tbody").append(tr);

		$.ajax({
			method: 'get',
			data: {
				SQL: 'SQLTaskRecords',
				filter: 'BTID="' + BTID + '" and BTVersion=' + BTVersion
			},
			url: "/app/PM/getSQLDBData",
			success: function (data) {
				console.log('data111111', data);
				//刷新recordDBID
				$("#recordDBID").text(data[0].DBID)

				$('#recordModifyContent').html(data[0].modifyContent)


				let defaultCheckedValue = 2
				if (data[0].testResult) {
					defaultCheckedValue = data[0].testResult
				}

				$("input:radio[name='recordResultRadio'][value=" + defaultCheckedValue +
					"]").prop("checked", true);
				$("#recordRemark").val(data[0].testRemark);

			},
			error: function (err) {
				console.log('err', err);
			}
		});
	}



	//函数:记录按钮详情页自动填写内容------------------------
	function Fun_IPQCRecordInit(dataChoose) {

		let dataSelect = NulltoEmpty(dataChoose);


		$('#DBID').text(dataSelect.DBID);
		$('#taskBPID').text(dataSelect.taskBPID);
		$('#taskRepeat').text(dataSelect.taskRepeat);
		$('#taskRepeatText').text(dataSelect.taskRepeatText);

		//	$("input:radio[name=taskSortType][value="+dataSelect.taskSortType+"]").prop("checked",true); 
		//	$('input:radio[name="taskSortType"]').attr("disabled",true);
		//	
		//	$("input:radio[name=taskType][value="+dataSelect.taskType+"]").prop("checked",true); 
		//	$('input:radio[name="taskType"]').attr("disabled",true);

		$('input:checkbox[name="modifyABE"]').prop("checked", false);
		setCheckBoxValue("modifyABE", dataSelect.modifyABE);
		$('input:checkbox[name="modifyABE"]').attr("disabled", true);


		$('#BTID').text(dataSelect.BTID);
		$('#BTVersion').text(dataSelect.BTVersion);
		$('#taskCTRName').text(dataSelect.taskCTRName);



		$('#taskStaff').text(dataSelect.taskStaff);
		$('#taskLimitDate').text(dataSelect.taskLimitDate);

		$('#taskMaker').text(dataSelect.taskMaker);



		$('#taskDBE').text(dataSelect.taskDBE.replace(/<br\/>/g, '\n'));

		$('#BTAcceptOpinion').text(dataSelect.BTAcceptOpinion);

		$("input:radio[name=FQCRequest][value=" + dataSelect.FQCRequest + "]").prop("checked", true);
		$('input:radio[name="FQCRequest"]').attr("disabled", true);

		$('#IPQCMaker').text(dataSelect.IPQCMaker);

		//	  $('#IPQCAuditor').text(dataSelect.IPQCAuditor);

		//	  console.log("dataSelect.IPQCAuditor:"+dataSelect.IPQCAuditor);

		if (dataSelect.IPQCAuditor == "") {
			Fun_getSQLSelectDBData({
				SQL: "SQLSRStaffs"
			}, "#IPQCAuditor", sessionName);
		} else {
			Fun_getSQLSelectDBData({
				SQL: "SQLSRStaffs"
			}, "#IPQCAuditor", dataSelect.IPQCAuditor);
		}




		$('#IPQCAuditDate').text(dataSelect.IPQCAuditDate);
		$('#IPQCAuditResultText').text(dataSelect.IPQCAuditResultText);


		var SQLParamRecords = {
			"tableName": "ppm_bills_taskrecord",
			"titles": [
				"modifyContent",
				"functionsDBE",
				"recordMaker",
				"recordAuditor",
				"taskFiles"
			],
			"BID": "BTID",
			"VER": "BTVersion",
			"filter": "BTID='" + dataSelect.BTID + "' AND BTVersion='" + dataSelect.BTVersion + "'"
		};


		Fun_fillTrackTable("#tableRecords", SQLParamRecords);



		var tableID = "#TableTestContents";

		//   console.log("IPQCTestResult:"+dataSelect.IPQCTestResult);
		//读取测试项目版本号
		$('#testContentsVer').text(dataSelect.testContentsVer);

		if (dataSelect.IPQCTestResult == "") {

			let tasksTableSQL = {
				"SQL": "SQLTableTestContents",
				"filter": "taskSortType = '" + dataSelect.taskSortType + "' AND taskType = '" + dataSelect.taskType +
					"' AND billType='IPQC' AND billVersion=(Select MAX(billVersion)  FROM `ppm_testcontents` WHERE taskSortType='" +
					dataSelect.taskSortType + "' AND taskType='" + dataSelect.taskType + "' AND billType='IPQC')",
				"orderBy": "modelType"
			};

			Fun_showSQLTestContentsTable(tasksTableSQL, tableID, null, null);

			console.log('dataSelect', dataSelect);



		} else {
			var IPQCTestResult = JSON.parse(dataSelect.IPQCTestResult);
			console.log("IPQCTestResult:" + JSON.stringify(IPQCTestResult));

			let tasksTableSQL = {
				"SQL": "SQLTableTestContents",
				"filter": "taskSortType = '" + dataSelect.taskSortType + "' AND taskType = '" + dataSelect.taskType +
					"' AND billType='IPQC' AND billVersion='" + $('#testContentsVer').text() + "'",
				"orderBy": "modelType"
			};

			Fun_showSQLTestContentsTable(tasksTableSQL, tableID, IPQCTestResult, dataSelect.IPQCAuditResult);

		}

		showIPQCAddItem({
			BTID: dataSelect.BTID,
			BTVersion: dataSelect.BTVersion
		})



		$('#IPQCMakeDate').text(dataSelect.IPQCMakeDate);
		$('#recordAuditor').text(dataSelect.recordAuditor);
		$('#recordAuditDate').text(dataSelect.recordAuditDate);
		$('#recordAuditResultText').text(dataSelect.recordAuditResultText);


		if (dataSelect.IPQCAuditResult == 1 || dataSelect.IPQCAuditResult == 2) {

			$('#divIPQCPanel input').attr("disabled", true);
			//		$('#divIPQCPanel :select').attr("disabled",true);
			//		$('#divIPQCPanel :textarea').attr("disabled",true);


			// 		  if(IPQCTestResult!=null){
			// 			 for(var i=0;i<IPQCTestResult.length;i++){
			// 				swal(1);
			// 	  		  swal(IPQCTestResult[i].testResult);
			// 	 		$("input:radio[name='testResultRadio"+i+"']").attr("disabled",true); 
			// 	        }
			// 		  }

			$('#DivIPQCInfo input').attr("disabled", true);
			$('#DivIPQCInfo select').attr("disabled", true);
			$('#DivIPQCInfo textarea').attr("disabled", true);

			$('#DivIPQCBTNS').hide();


		} else {

			$('#DivIPQCInfo input').attr("disabled", false);
			$('#DivIPQCInfo select').attr("disabled", false);
			$('#DivIPQCInfo textarea').attr("disabled", false);

			$('#DivIPQCBTNS').show();

			if (sessionName == $("#IPQCMaker").text()) {

				$('#IPQCAuditor').attr("disabled", false);
			} else {
				$('#IPQCAuditor').attr("disabled", true);
			}


		}



		$('#modifyContent').text(dataSelect.modifyContent);

		$('#functionsDBE').text(dataSelect.functionsDBE);

		$('#recordRemark').text(dataSelect.recordRemark);

		$('#divFilesUploaded').html("");

		if (dataSelect.taskFileKey != null) {

			//   console.log("不为空"+dataSelect.taskFileKey);
			var downloadurl = "<a id='filePath' href=" + '/system.files.download/' + dataSelect.taskFileKey +
				" download=" + dataSelect.taskFileName + ">" + "<span id='fileName'>" + dataSelect.taskFileName +
				"</span></a>";
			$('#divFilesUploaded').html(downloadurl);
		}

		$("input:radio[name=FQCRequest][value=" + dataSelect.FQCRequest + "]").prop("checked", true);
		$('input:radio[name="FQCRequest"]').attr("disabled", true);
		$('#IPQCMaker').text(dataSelect.IPQCMaker);

		if (dataSelect.IPQCResult != "") {
			$("input:radio[name=IPQCResult][value=" + dataSelect.IPQCResult + "]").prop("checked", true);
			$('#IPQCContent').val(dataSelect.IPQCContent.replace(/<br\/>/g, '\n'));
		}


		//	  if(dataSelect.IPQCAuditResult==1||dataSelect.IPQCAuditResult==2){
		//		  $('#DivIPQCBTNS').hide();
		//		}else{
		//			$('#DivIPQCBTNS').show();
		//		}



	}

	//检测是否符合FQC条件并发送钉钉消息

	const checkFQCStatusAndSendDDMsg = async (i, o) => {
		let R1_i = {
			"SQL": "SQLTableBillsFQC",
			"filter": "(FQCStatus<>1 OR FQCStatus IS NULL) AND BPID='" + i.BPID + "'",
			"orderBy": " saveTimeStamp DESC"
		}
		let R1_o

		let R1 = await getBizDataBySQL(R1_i, R1_o)

		// console.log("R1:"+JSON.stringify(R1))

		if (R1.length !== 0) {
			let R2_i = {
				DDMsg: {
					msg: '@' + R1[0].FQCStaff + ',计划单号:' + R1[0].BPID + ',客户:' + R1[0].PLDCTRName +
						',该订单已符合FQC检验条件,请进行FQC检验!',
					at: R1[0].FQCStaff
				}
			}
			let R2_o

			aio_sendDDMsg(R2_i, R2_o)

		}
	}


	//检测是否符合PBH条件并发送钉钉消息

	const checkPBHStatusAndSendDDMsg = async (i, o) => {
		let R1_i = {
			"SQL": "SQLTableBillsPBH",
			"filter": "PBHStatus IS NULL AND BPID='" + i.BPID + "'",
			"orderBy": " saveTimeStamp DESC"
		}
		let R1_o

		let R1 = await getBizDataBySQL(R1_i, R1_o)

		// console.log("R1:"+JSON.stringify(R1))

		if (R1.length !== 0) {
			let R2_i = {
				DDMsg: {
					msg: '@' + R1[0].maker + ',计划单号:' + R1[0].BPID + ',客户:' + R1[0].PLDCTRName +
						',该订单已符合发布单条件,请填写发布单!',
					at: R1[0].maker
				}
			}
			let R2_o

			aio_sendDDMsg(R2_i, R2_o)

		}
	}





	//页面加载函数---------------
	$(document).ready(function () {




		sessionName = "<%-locals.session.yjUser.Name%>";

		var undone = getQueryString("undone");

		switch (undone) {
			case "unRecord":
				var tableSQL = {
					"SQL": "SQLTableBillsTaskIPQC",
					"filter": "IPQCMaker = '" + sessionName + "' AND IPQCResult IS NULL",
					"orderBy": " saveTimeStamp DESC"
				};
				break;
			case "unAudit":
				var tableSQL = {
					"SQL": "SQLTableBillsTaskIPQC",
					"filter": "IPQCAuditor = '" + sessionName + "' AND IPQCAuditDate IS NULL",
					"orderBy": " saveTimeStamp DESC"
				};
				break;

			case "all":
				var tableSQL = {
					"SQL": "SQLTableBillsTaskIPQC",
					"orderBy": " saveTimeStamp DESC"
				};
				$("#BTNFilterAll").addClass("active");
				break;
			default:
				var tableSQL = {
					"SQL": "SQLTableBillsTaskIPQC",
					"filter": " IPQCAuditResult<>1 OR IPQCAuditResult IS NULL",
					"orderBy": " saveTimeStamp DESC"
				};
				//		var tableSQL={"SQL":"SQLTableBillsTaskIPQC","filter":" IPQCMaker = '"+sessionName+"'AND IPQCAuditResult IS NULL","orderBy":" saveTimeStamp DESC"};

				$("#BTNFilterSimple").addClass("active");
				break;

		}

		//    if(undone=="true"){
		//		
		//		var tableSQL={"SQL":"SQLTableBillsTaskIPQC","filter":" (taskStaff = '"+sessionName+"' OR IPQCMaker = '"+sessionName+"'  OR IPQCAuditor = '"+sessionName+"') AND BTStatus <>3","orderBy":" saveTimeStamp DESC"};
		//	}else{
		//		var tableSQL={"SQL":"SQLTableBillsTaskIPQC","orderBy":" saveTimeStamp DESC"};
		//	}

		tableInfo = {
			"tableID": "#billsTaskTable",
			"columnsData": [{
					data: 'saveTimeStamp',
					"visible": false
				},
				{
					data: 'DBID',
					"visible": false
				},
				{
					data: 'BTID'
				},
				{
					data: 'BTVersion'
				},
				{
					data: 'taskCTRName'
				},
				{
					data: 'taskSortTypeText'
				},
				{
					data: 'taskTypeText'
				},
				{
					data: 'taskLimitDate'
				},
				{
					data: 'IPQCMaker'
				},
				{
					data: 'IPQCAuditor'
				},
				//		        { data: 'recordText'},
				{
					data: 'IPQCAuditResultText'
				},
				//		        { data: 'BTStatusText'}
				{
					data: 'IPQCStatus'
				}



			]
		}


		Fun_showSQLTable(tableSQL, tableInfo)


		//判断是否选中数据-------
		var table = $('#billsTaskTable').DataTable();
		$('#billsTaskTable tbody').on('click', 'tr', function () {
			if ($(this).hasClass('selected')) {
				$(this).removeClass('selected');
			} else {
				table.$('tr.selected').removeClass('selected');
				$(this).addClass('selected');
			}

			var dataSelect = table.row('.selected').data();



		});


		//dbclick 测试判断是否选中数据-------

		$('#billsTaskTable tbody').on('dblclick', 'tr', function () {
			table.$('tr.selected').removeClass('selected');
			$(this).addClass('selected');
			$('#BTNIPQCRecord').click();

		});

		//过滤按钮组
		$('#BTNFilterSimple').click(function () {
			window.location.href = '/app/PM/billsIPQC';
		});

		$('#BTNFilterAll').click(function () {
			window.location.href = '/app/PM/billsIPQC?undone=all';
		});


		//按钮-记录任务单---------
		$('#BTNIPQCRecord').click(function () {

			var dataSelect = table.row('.selected').data();
			if (dataSelect == undefined) {
				swal("请先点击选择表格中的任务单!");
			} else {
				//	    	console.log("dataSelect:"+JSON.stringify(dataSelect));
				$('#BillTask').modal('show')
				Fun_IPQCRecordInit(dataSelect);

			}

		});

		//按钮-任务记录保存按钮
		$('#BTNTaskIPQCSave').click(async function () {


			if (checkAuthority({
					"SQL": "SQLGetAuthorities",
					"filter": "StaffName='" + sessionName + "'"
				}, "IPQC01")) {

				if (sessionName == $('#IPQCMaker').text()) {


					if (checkIPQCInput()) {








						//do-保存ipqc测试内容
						var IPQCTestResult = [];

						// var testNum = $("#TableTestContents").find("tr").length - 1;

						var testNum = $("#TableTestContents").find("tr").length - 2; //加入记录测试后多减一行


						var radioCheck = true;
						//	
						//			swal($("#TableTestContents").find("tr").length );

						for (var i = 0; i < testNum; i++) {
							var testResult = {
								"testContentDBID": $("#testContentDBID" + i).text(),
								"testResult": $('input:radio[name="testResultRadio' + i +
										'"]:checked')
									.val(),
								"testRemark": $("#testRemark" + i).val()

							}
							radioCheck = radioCheck &&
								$('input:radio[name="recordResultRadio"]:checked').val() &&
								$('input:radio[name="testResultRadio' + i + '"]:checked').val();

							IPQCTestResult.push(testResult);
						}


						// if (radioCheck === undefined) {
						// 	swal("存在未测试内容,请检查!");
						// 	return
						// }
						// alert(radioCheck)

						if (radioCheck != 1) {
							if (!confirm('测试内容存在不正确项,是否继续')) {
								return
							}
						}

						if ($('input:radio[name="IPQCResult"]:checked').val() == 2) {
							if (!confirm('当前任务单IPQC结果未通过,是否继续')) {
								return
							}
						}

						if ($('input:radio[name="IPQCResult"]:checked').val() == 1 &&
							radioCheck != 1) {
							alert('存在未通过检查项目,无法通过IPQC!')
							return
						}


						//do-保存修改内容检测结果

						let recordTestData = {
							"DBTable": "ppm_bills_taskrecord",
							"DBID": $('#recordDBID').text(),
							"testResult": $('input:radio[name="recordResultRadio"]:checked').val(),
							"testRemark": $("#recordRemark").val()
						}

						let rRecordUpdate = await $.ajax({
							method: 'post',
							url: '/app/PM/updDBData',
							data: recordTestData,
							success: function (data, textStatus) {},
							error: function (XMLHttpRequest, textStatus, errorThrown) {}
						});

						if (!rRecordUpdate) {
							alert('保存测试记录错误')
							return
						}

						var recordData = {
							"DBTable": "ppm_bills_task",
							"DBID": $('#DBID').text(),
							"IPQCTestResult": JSON.stringify(IPQCTestResult),
							"testContentsVer": $('#testContentsVer').text(),
							"IPQCContent": $('#IPQCContent').val().replace(/\n|\r\n/g, '<br/>')
								.replace(/'/g, '"'),
							"IPQCResult": $('input:radio[name="IPQCResult"]:checked').val(),
							"IPQCMaker": sessionName,
							"IPQCMakeDate": Ndate,
							"IPQCAuditResult": 0,
							"IPQCAuditor": $("#IPQCAuditor option:selected").text(),
							"IPQCStatus": "已填写,未审核",
							"BTStatus": 5
						}

						// console.log("recordData:"+JSON.stringify(recordData));


						$.ajax({
							method: 'post',
							url: '/app/PM/updDBData',
							data: recordData,
							success: function (data, textStatus) {
								//                swal("成功数据:"+JSON.stringify(data));
								if (data.changedRows != 0) {

									$('#IPQCMakeDate').text(Ndate);

									if (sessionName == $(
											"#IPQCAuditor option:selected")
										.text()) {
										let msgNext = confirm("是否立即审核?");
										if (msgNext) {
											$('#BTNTaskIPQCAudit').click();
										}
									} else {

										if (sessionName != $(
												"#IPQCAuditor option:selected")
											.text() &&
											$('input:radio[name="IPQCResult"]:checked')
											.val() == 2) {
											let msgContent = "@" + $(
													"#IPQCAuditor option:selected")
												.text() + ",检测到未通过的IPQC待您审核,请登陆系统处理!";
											sendDingMsg({
												at: $(
														"#IPQCAuditor option:selected"
													)
													.text(),
												msg: msgContent
											});

										}
									}

									swal("IPQC记录更新数据成功!")


								} else {


									let i = {
										alertMsg: "IPQC记录未有数据更新!"
									}
									swalAndRefresh(i)

								}
							},
							error: function (XMLHttpRequest, textStatus, errorThrown) {}
						});



					}




				} else {
					swal("非指定的IPQC填单人,不允许填单!");
				}

			}
		});


		//按钮-任务记录审核按钮
		$('#BTNTaskIPQCAudit').click(function () {

			//	if(sessionName==){}

			if (checkAuthority({
					"SQL": "SQLGetAuthorities",
					"filter": "StaffName='" + sessionName + "'"
				}, "IPQC02")) {

				var IPQCMakeDate = $('#IPQCMakeDate').text();

				if (IPQCMakeDate == "") {
					swal("请先保存IPQC单,再审核");
				} else {

					if (sessionName == $("#IPQCAuditor option:selected").text()) {

						var msg = confirm("审核后无法对IPQC记录进行修改,是否立即审核?");
						if (msg == true) {


							var IPQCResult = $('input:radio[name="IPQCResult"]:checked').val();

							var taskRepeat = $('#taskRepeat').text();



							//如果为重复订单 则不更新计划单信息
							if (IPQCResult == 1) {

								//				        	 console.log( $("#tableRecords tbody").find("tr").length)

								//				        	 console.log($("#tableRecords tbody tr:eq(0) td:last").html());

								var trNum = $("#tableRecords tbody").find("tr").length;

								var taskFiles = [];
								var modifyContent = "";
								var functionsDBE = "";

								for (var i = 0; i < trNum; i++) {

									// console.log("1.file"+$("#tableRecords tbody tr:eq("+i+") td:last").html());
									let trFileHtml = $("#tableRecords tbody tr:eq(" + i + ") td:last")
										.html();

									if (trFileHtml !== "") {
										let trFileArray = trFileHtml.split(';');
										for (let j = 0; j < trFileArray.length; j++) {

											let tdfile = {
												"fileName": $("#tableRecords tbody tr:eq(" + i +
													") td:last a:eq(" + j + ")").attr('download'),
												"fileKey": $("#tableRecords tbody tr:eq(" + i +
														") td:last a:eq(" + j + ")").attr('href')
													.substring(23)
											}
											taskFiles.push(tdfile);

										}

									}


									// console.log("eq0:"+$("#tableRecords tbody tr:eq("+i+") td:last a:eq(0)").attr('href').substring(23));
									//  console.log("eq1:"+$("#tableRecords tbody tr:eq("+i+") td:last a:eq(1)").attr('href').substring(23));
									//  console.log($("#tableRecords tbody tr:eq("+i+") td:last a").attr('download'));

									modifyContent = modifyContent + $("#tableRecords tbody tr:eq(" + i +
										") td:last").text() + ":" + "\n" + $(
										"#tableRecords tbody tr:eq(" + i + ") td:first").html() + "\n";
									functionsDBE = functionsDBE + $("#tableRecords tbody tr:eq(" + i +
										") td:last").text() + ":" + "\n" + $(
										"#tableRecords tbody tr:eq(" + i + ") td:eq(1)").html() + "\n";

								}


								//  console.log("taskFiles:"+JSON.stringify(taskFiles));



								var PLDUpdData = {
									"DBTable": "ppm_bills_plan",
									"BillIDName": "BPID",
									"BillID": $('#taskBPID').text(),
									"TaskNumDoneAdd": 1,
									"WFStatus": 30
								}

								var taskUpdData = {
									"DBTable": "ppm_bills_task",
									"DBID": $('#DBID').text(),
									"IPQCAuditResult": 1,
									"IPQCAuditResultText": "测试通过",
									"IPQCAuditor": sessionName,
									"IPQCAuditDate": Ndate,
									"taskFinishDate": Ndate,
									"IPQCStatus": "已填写,已审核",
									"BTStatus": 3,
									"BTStatusText": "任务完成",
									"modifyContent": modifyContent,
									"functionsDBE": functionsDBE,
									"taskFiles": JSON.stringify(taskFiles)

								}


								var ajax1 = $.ajax({
									method: 'post',
									url: '/app/PM/updBillStatus',
									data: PLDUpdData,
									success: function (data, textStatus) {},
									error: function (XMLHttpRequest, textStatus, errorThrown) {}
								});

								var ajax2 = $.ajax({
									method: 'post',
									url: '/app/PM/updDBData',
									data: taskUpdData,
									success: function (data, textStatus) {},
									error: function (XMLHttpRequest, textStatus, errorThrown) {}
								});

								$.when(ajax1, ajax2).done(function () {
									checkFQCStatusAndSendDDMsg({
										BPID: $('#taskBPID').text()
									}); //自动检验是否符合FQC条件发送通知
									checkPBHStatusAndSendDDMsg({
										BPID: $('#taskBPID').text()
									}); //自动检验是否符合BPH条件发送通知
									let i = {
										alertMsg: "通过IPQC测试,该任务单完结!"
									}
									swalAndRefresh(i)
								});

							} else {

								var taskUpdData = {
									"DBTable": "ppm_bills_task",
									"DBID": $('#DBID').text(),
									"IPQCAuditResult": 2,
									"IPQCAuditResultText": "测试未通过",
									"IPQCAuditor": sessionName,
									"IPQCAuditDate": Ndate,
									"IPQCStatus": "已填写,已审核",
									"BTStatus": 4,
									"BTStatusText": "任务失败"
								}

								var ajax1 = $.ajax({
									method: 'post',
									url: '/app/PM/updDBData',
									data: taskUpdData,
									success: function (data, textStatus) {},
									error: function (XMLHttpRequest, textStatus, errorThrown) {}
								});

								$.when(ajax1).done(function () {


									// let i={alertMsg:"未通过IPQC测试,请更新任务单版本重新开始该任务!"}
									// swalAndRefresh(i)

									let i = {
										confirmMsg: '未通过IPQC测试,是否发送钉钉提醒消息?',
										DDMsg: {
											at: $('#taskStaff').text(),
											msg: "@" + $('#taskStaff').text() +
												"任务未通过IPQC检测,请登陆系统更新任务单版本重新开始该任务!"
										}
									}
									let o = {
										f: io_refresh
									}

									aio_chooseSendDDMsg(i, o)


								});
							}
						}
					} else {
						swal('非IPQC指定审核人,不允许审核!')
					}
				}
			}
		});


		////按钮-生成报告---------
		//$('#BTNReportCreate').click(function() {
		//	
		//	var IPQCtr="";
		//	
		//	var tableLength=$("#TableTestContents tbody").find("tr").length-1;
		//	
		//	for(var i=0;i<=tableLength;i++){
		//		
		//		var IPQCtr=IPQCtr+"<tr>" +
		//				"<td>"+$("#TableTestContents tbody tr:eq("+i+") td:nth-child(2)").text()+"</td>" +
		//				"<td colspan='5'>"+$("#TableTestContents tbody tr:eq("+i+") td:nth-child(3)").text()+"</td>" +
		//				"<td>"+$("#TableTestContents tbody tr:eq("+i+") td:nth-child(4)").find("input[type='radio']:checked").next("span").text()+"</td>" +
		//				"<td>"+$("#TableTestContents tbody tr:eq("+i+") td:nth-child(5)").find("input").val()+"</td>" +
		//						"</tr>";
		//	}
		//
		//	
		//	var htmlContent=" <html><head></head>" +
		//			"<body>" +
		//			"<table   border='1' width='100%'>" +
		//			"<thead>" +
		//			"<tr>" +
		//			"<th>任务单号:</th>" +
		//			"<th>"+$('#BTID').text()+"</th>" +
		//			"<th>客户名称:</th>" +
		//			"<th  colspan='2'>"+$('#taskCTRName').text()+"</th>" +
		//			"<th>IPQC结果:</th>" +
		//			"<th  colspan='2'>"+$('#IPQCAuditResultText').text()+"</th>" +
		//			"</tr>" +
		//			"<tr>" +
		//			"<th>修改内容:</th>" +
		//			"<th colspan='7'></th>" +
		//			"</tr>" +
		//			"<tr>" +
		//			"<th>功能说明:</th>" +
		//			"<th colspan='7'></th>" +
		//			"</tr>" +
		//			"<tr>" +
		//			"<th>测试人:</th>" +
		//			"<th>"+$('#IPQCMaker').text()+"</th>" +
		//			"<th>审核人:</th>" +
		//			"<th colspan='2'>"+$('#IPQCAuditor option:selected').text()+"</th>" +
		//			"<th>测试日期:</th>" +
		//			"<th colspan='2'>"+$('#IPQCAuditDate').text()+"</th>" +
		//			"</tr>" +
		//			"</thead>" +
		//			"<tbody>" +
		//			"<tr>" +
		//			"<th>模块</th>" +
		//			"<th colspan='5'>测试内容</th>" +
		//			"<th>结果</th>" +
		//			"<th>备注</th>" +
		//			"</tr>" +
		//			IPQCtr+
		//			"</table>" +
		//			"</body>" +
		//			"</html>";


		//  $.ajax({
		//        method: 'post',
		//        url: '/app/PM/createReportPDF',
		//        data: {"BTID":$("#BTID").text(),"htmlContent":htmlContent},
		//        success: function(data, textStatus) {
		//        	
		//        	console.log("filename:"+JSON.stringify(data));
		//        	
		//        	reportLink="<a href='/system.files.download/"+$("#BTID").text()+"_IPQC.pdf' download='"+$("#BTID").text()+"_IPQC.pdf'>"+$("#BTID").text()+"_IPQC.pdf</a>";
		//        	
		//        	$("#report").html(reportLink);
		//        },
		//        error: function(XMLHttpRequest, textStatus, errorThrown) {}
		//        });
		//});


		//按钮-表单关闭按钮,添加刷新数据功能
		$('#BTNFormClose').click(function () {
			window.location.reload();
		});

		IPQCResultEventBind()

	});
</script>