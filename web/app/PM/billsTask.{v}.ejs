<!-- CSS -->
<link rel="stylesheet" type="text/css" href="/css/PM/PMContent.css">
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/Bootstrap-3.3.7/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/DataTables-1.10.18/css/dataTables.bootstrap.css">
<link href="/css/PM/datetimepicker/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
<link rel="stylesheet" href="/css/PM/bootstrap-select.min.css" />


<!-- JS  -->

<script src="/css/PM/DataTables/Bootstrap-3.3.7/js/bootstrap.min.js"></script>
<script src="/css/PM/bootstrap-select.min.js"></script>
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.min.js" charset="UTF-8"></script>
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>

<script type="text/javascript"  src="/css/PM/DataTables/DataTables-1.10.18/js/jquery.dataTables.min.js"></script>
<script type="text/javascript"  src="/css/PM/DataTables/DataTables-1.10.18/js/dataTables.bootstrap.min.js"></script>
<script src="/js/PM/FileSaver.min.js"></script>
<script src="/js/PM/tableExport.js"></script>
<script src="/js/PM/PMfuns.js"></script>




<% layout(locals.global.theme_layout_dir+'/master.ejs') -%>


<!------begin view-------------------------->
<div class="divcontent">
    <h1>工作流程-任务单</h1>
    <hr>

    <!-- 操作区（按钮等） -->
    <div class="lineitem">
        
     <!--   <button id="BTNInfo" class="btn btn-warning">详情</button> -->
        
        <!-- 按钮触发模态框 -->
        <button id="BTNTaskAccept" class="btn btn-primary" data-toggle="modal" >任务确认</button>
        <button id="BTNTaskRecord" class="btn btn-info" data-toggle="modal" >任务登记</button>
        <!-- <button id="BTNDelete" class="btn btn-danger" data-toggle="modal" >删除</button> -->
        <!-- 模态框（Modal） -->
        <div class="modal fade" id="BillTask" tabindex="-1" role="dialog" aria-labelledby="BillTaskLabel" aria-hidden="true">
            <div class="modal-dialog" style="width:98%">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="BillTaskLabel">任务单详情</h4>
                    </div>
                    <div class="modal-body">
                    
                    <!--------------跟踪面板----------------->
                    
                    <div class="panel panel-info" style="width:24%;float:left;">
                    
                    <!--------------panel--------------------->
                    <div class="panel-heading">
                        <h3 class="panel-title">计划单信息</h3>
                    </div>
                    <div class="panel-body" >
                    
                    <table class="table table-bordered">
                    <tr>
                      <td id="TBillPLD-BPID"></td>
                      <td id="TBillPLD-version"></td>
                      <td id="TBillPLD-CTRName"></td>
                      <td id="TBillPLD-orderFrom"></td>
                    </tr>
                    <tr>
                      <td id="TBillPLD-MHEName"></td>
                      <td id="TBillPLD-model"></td>
                      <td id="TBillPLD-OGNSystemVersion"></td>
                      <td id="TBillPLD-urgency"></td>
                    </tr>
                    <tr>
                    <td id="TBillPLD-applyDate"></td>
                    <td id="TBillPLD-limitDate"></td>
                    <td id="TBillPLD-PGEMaker"></td>
                    <td id="TBillPLD-fileName"></td>
                    </tr>

                    <tr>
                    <td id="TBillPLD-topic" colspan="2"></td>
                    <td id="TBillPLD-detail" colspan="2"></td>

                    </tr>
                    
                    <tr>
                    <td id="TBillPLD-maker"></td>
                    <td id="TBillPLD-makeDate"></td>
                    <td id="TBillPLD-auditor"></td>
                    <td id="TBillPLD-auditDate"></td>
                    </tr>
                    
                    </table>
                    
                    
                    </div>
                    <!--------------panel--------------------->
                    <!--------------panel--------------------->
                    <div class="panel-heading">
                        <h3 class="panel-title">方案单信息</h3>
                    </div>
                    
                    <div class="panel-body">
                    
                    <table class="table table-bordered">
                    
                    <tr>
                      <td>&nbsp;</td>
                      <td colspan="3">&nbsp;</td>
                      <td>&nbsp;</td>
                      <td colspan="3">&nbsp;</td>
                    </tr>
                    <tr>
                      <td>&nbsp;</td>
                      <td colspan="7">&nbsp;</td>
                    </tr>
                    </table>
                    </div>
                    <!--------------panel--------------------->
                    </div>
                    
                    
                    
                    
                    <!--------------跟踪面板----------------->
                    
                    <!--------------方案单面板----------------->

                    <div class="panel panel-info" style="width:75%;float:right;">
                	
                    <div class="panel-heading">
                        <h3 class="panel-title">任务单</h3>
                    </div>
                    
                    <div class="panel-body">
                    <!--begin task panel-------------->
                    
                    <div id="DivTaskInfo" class="panel panel-info" >
                    <div class="panel-heading">
                        <h3 class="panel-title">任务信息</h3>
                    </div>
                    
                    
                    <div class="panel-body">
                    
                    
                    <div class="form-horizontal" > 
                    <span id="DBID" style="display:none"></span>
                    <span id="taskBPID" style="display:none"></span>
                    
                    
                    <!-------------------------------------------------------------------------->
                    <div class="form-group">
                    <label class="col-sm-1 control-label">类型:</label>   
                	 <div class="col-sm-10">
                	    <label class="radio-inline">
                	        <input type="radio" name="taskType" id="radio1" value="T1"> DSP任务单
                	    </label>
                	    <label class="radio-inline">
                	        <input type="radio" name="taskType" id="radio2" value="T2"> HMI任务单
                	    </label>
                	    <label class="radio-inline">
                	        <input type="radio" name="taskType" id="radio3" value="T3"> 内核任务单
                	    </label>
                	 </div>
                	 </div>
                	 <!-------------------------------------------------------------------------->
                     <div class="form-group">
                    
                     
                     <label class="col-sm-1 control-label">修改属性:</label>   
                 	 <div class="col-sm-8">
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" name="modfiyABE"  value="ABE1"> 画面
                 	    </label>
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" name="modfiyABE"  value="ABE2"> 结构
                 	    </label>
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" name="modfiyABE"  value="ABE3"> 参数
                 	    </label>
                 	        
                 	    <label class="checkbox-inline">
                	        <input type="checkbox" name="modfiyABE"  value="ABE4">通信
                	    </label>   
                	        <label class="checkbox-inline">
                	        <input type="checkbox" name="modfiyABE"  value="ABE5">逻辑
                	    </label>
                	        <label class="checkbox-inline">
                 	        <input type="checkbox" name="modfiyABE"  value="ABE6"> kernel
                 	    </label>
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" name="modfiyABE"  value="ABE7"> LIB
                 	    </label>
                 	    <label class="checkbox-inline">
                 	        <input type="checkbox" name="modfiyABE"  value="ABE8"> OS
                 	    </label>
                 	 </div>
                 	 
                 	 
                     </div>
                     <!-------------------------------------------------------------------------->
                     
                     <div class="form-group">
                     
                     <label class="col-sm-1 control-label">任务单号:</label>
                     <div class="col-sm-2">
                   
                     <span id="BTID" class="help-block"></span>

                     </div>
                     
                     <label class="col-sm-2 control-label">任务单版本号:</label>
                     <div class="col-sm-1">
                     <span id="BTVersion" class="help-block"></span>
                     </div>
                     
                     <label class="col-sm-1 control-label">客户名称:</label>
                     <div class="col-sm-1">
                     <span id="taskCTRName" class="help-block"></span>
                     </div>
                     
                    
                     
                     </div>
                     
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">  
                     
                     <label  class="col-sm-1 control-label" for="name">负责人:</label>    
                     <div class="col-sm-1">
                     
                     <span id="taskStaff"  class="help-block"></span>
                     </div>
                     
                     <label class="col-sm-1 control-label"></label>
                     <label for="limitDate" class="col-sm-2 control-label">任务完成期限:</label>                     
                     <div class="col-sm-2">
                     <span id="taskLimitDate" class="help-block"></span>  	
                 	 </div>

                     </div>
                     <!-------------------------------------------------------------------------->
                     <div class="form-group">  
                     
                     <label class="col-sm-1 control-label">确认结果:</label>
                     <div class="col-sm-1">
                     <span id="BTAcceptResultText" class="help-block"></span>
                     </div>
                     
                     <label class="col-sm-1 control-label">处理结果:</label>
                     <div class="col-sm-1">
                     <span id="recordAuditResultText" class="help-block"></span>
                     </div>
                 	 
                     <label class="col-sm-1 control-label">IPQC结果:</label>
                     <div class="col-sm-1">
                     <span id="IPQCAuditResultText" class="help-block"></span>
                     </div>
                     
                     <label class="col-sm-1 control-label">最终结果:</label>
                     <div class="col-sm-1">
                     <span id="IPQCResultText" class="help-block"></span>
                     </div>
                 	 


                     </div>
                     <!-------------------------------------------------------------------------->
                     
                     <div class="form-group"> 
                     <label class="col-sm-1 control-label">任务要求:</label>
                     <div class="col-sm-10">
                     <span id="taskDBE" class="help-block"></span>
                     </div>
                     
                     </div>
                     
                     <!-------------------------------------------------------------------------->
                     
                     <div class="form-group"> 
                     <label class="col-sm-1 control-label">确认意见:</label>
                     <div class="col-sm-10">
                     <span id="BTAuditOpinionShow" class="help-block"></span>
                     <textarea id="BTAuditOpinion" class="form-control" rows="2"></textarea>
                     </div>
                     
                     </div>
                     
                     <!-------------------------------------------------------------------------->
                     
                     <div class="form-group" id="DivTaskAuditBTNS"> 
                     <label class="col-sm-1 control-label">确认:</label>
                     <div class="col-sm-10">
                     <button id="BTNTaskAcceptYes" class="btn btn-success" data-toggle="modal" >确认任务</button>
                     <button id="BTNTaskAcceptNo" class="btn btn-warning" data-toggle="modal" >驳回任务</button>
                     </div>
                     
                     </div>
                     
                     <!-------------------------------------------------------------------------->

                    </div>
                    
                    
                    </div>
                    </div>
                    
                    
                    <!-------------------------------------------------------------------------->
                    <div class="panel panel-warning" id="DivRecordPanel">
                    <div class="panel-heading">
                        <h3 class="panel-title">任务记录</h3>
                    </div>
                    <div class="panel-body">
                    
                    <div class="form-horizontal" > 
                    
                    <!-------------------------------------------------------------------------->
                    <div class="form-group"> 
                    <label class="col-sm-1 control-label">修改内容说明:</label>
                    <div class="col-sm-10">
                    <textarea id="modifyContent" class="form-control" rows="2"></textarea>
                    </div>
                    
                    </div>
                    <!-------------------------------------------------------------------------->
                    <div class="form-group"> 
                    <label class="col-sm-1 control-label">程序功能说明:</label>
                    <div class="col-sm-10">
                    <textarea id="functionsDBE" class="form-control" rows="2"></textarea>
                    </div>
                    
                    </div>
                    
                    <!-------------------------------------------------------------------------->
                    
                    <div class="form-group" id="DivUploadBTNS">
                    <label  class="col-sm-1 control-label" for="name">上传</label>  
                    
                    <div class="col-sm-8">
                    <input type="file" name="myHead" multiple="multiple" id="fileToUpload" style="display:none;" onchange="fileSelected()" >
                    <a class="btn btn-info" onclick="$('#fileToUpload').click()">选择文件</a>
                	<input  type="button" class="btn btn-success" onclick="uploadFile()" value="确认上传" >
                	<input type="button" class="btn btn-warning" onclick="deleteFile()" value="清空附件" >

                    </div>

                	</div>
                	
                	<!-------------------------------------------------------------------------->
                	 <div class="form-group">
                	<label  class="col-sm-1 control-label" for="name">程序附件:</label>
                	
                	<div class="col-sm-8">
                	<div id="div_previewImages"></div>
                    <div id="progressNumber"></div> 
                    <div id="divFilesUploaded"></div>
                	</div>

                	</div>

                    <!-------------------------------------------------------------------------->
                    
                    
                    <div class="form-group"> 
                    <label class="col-sm-1 control-label">备注:</label>
                    <div class="col-sm-10">
                    <textarea id="recordRemark" class="form-control" rows="2"></textarea>
                    </div>
                    
                    </div>
                    
                    <!-------------------------------------------------------------------------->
                    <div class="form-group">
                    <label class="col-sm-1 control-label">FQC申请:</label>   
                	 <div class="col-sm-3">
                	    <label class="radio-inline">
                	        <input type="radio" name="FQCRequest" id="radio1" value="1"> FQC申请
                	    </label>
                	    <label class="radio-inline">
                	        <input type="radio" name="FQCRequest" id="radio2" value="2" checked> 无需FQC
                	    </label>
                	    
                	 </div>
                	 
                	 <label class="col-sm-1 control-label">IPQC填单:</label>
                	 
                	 <div class="col-sm-3 ">
                     <select  id="IPQCMaker" class="selectpicker" data-live-search="true"> 
                     </select>
                     </div>
                	 
                	 
                	 </div>
                    <!-------------------------------------------------------------------------->
                    <div class="form-group" id="DivRecordAuditInfo">  
                    
                    <label  class="col-sm-1 control-label" for="name">记录审核人:</label>    
                    <div class="col-sm-1">
                    
                    <span id="recordAuditor"  class="help-block"></span>
                    </div>
                    
                    <label class="col-sm-1 control-label"></label>
                    <label for="recordAuditDate" class="col-sm-2 control-label">记录审核日期:</label>                     
                    <div class="col-sm-2">
                    <span id="recordAuditDate" class="help-block"></span>  	
                	 </div>
                	 
                	 <label class="col-sm-2 control-label">记录审核状态:</label>
                    <div class="col-sm-1">
                    <span id="recordAuditResultText" class="help-block"></span>
                    </div>
                    </div>
                    
                    
                	 <!-------------------------------------------------------------------------->
                    
                    <div class="form-group" id="DivTaskRecordBTNS"> 
                    <label class="col-sm-1 control-label">登记:</label>
                    <div class="col-sm-10">
                    <button id="BTNTaskRecordSave" class="btn btn-success" data-toggle="modal" >保存记录</button>
                    <button id="BTNTaskRecordAudit" class="btn btn-warning" data-toggle="modal" >审核记录</button>
                   
                    
                    </div>
                    
                    </div>
                    <!-------------------------------------------------------------------------->
                    
                    <div class="form-group" id="DivTaskUpdVerBTN"> 
                    <label class="col-sm-1 control-label"></label>
                    <div class="col-sm-10">
                    <button id="BTNTaskUpdVer" class="btn btn-danger" data-toggle="modal" >更新版本</button>
                    </div>
                    
                    </div>
                    
                    
                    
                    <!-------------------------------------------------------------------------->


                        
                        
                        
                    </div>      
                        
                    
                    </div>
                    </div>
                    

                    

                    
                   
                    

                   
                     
                     
                    <!----end task panel---------------------->

                    </div>
                    
                    <div class="panel-footer">
                    
                   
                    
               

                    
                    </div>
                   
                    
                   </div>
                   
                  
                   
                   
                   
                   <!--------------方案单面板----------------->

                   
                   
                   <!---------清除浮动---------------------------------->
                   <div style='clear:both'></div>

                    
                    
                    </div>
                    <div class="modal-footer">
                      
                        
                       
                     
                        <button id="BTNFormClose" type="button" class="btn btn-default" data-dismiss="modal">关闭</button>

                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>
        
        

    </div>
    
    
    
    
    <br/>

    <!--数据呈现区-->
    <table id="billsTaskTable" class="table table-striped table-bordered"  >
        <thead>
            <tr>
                <th>数据库ID</th>
                <th>任务单号</th>
                <th>版本号</th>
                <th>客户名称</th>
                <th>任务类型</th>
                <th>任务负责人</th>
                <th>完成期限</th>
                <th>确认结果</th>
                <th>处理结果</th>
                <th>IPQC结果</th>

            </tr>
        </thead>
    </table>

    
</div>

<!--------end view-------------------->
<script>


////函数:计划单号生成规则
//
//function Fun_billIDCreate(para){
//	var BillID=new Date(Ndate).Format("yyyyMMdd")+para+Math.floor(Math.random()*1000);
//	return BillID;
//}



//函数:审核按钮详情页自动填写内容------------------------
function Fun_taskAuditInit(dataSelect){
	
	$('#DBID').text(dataSelect.DBID); 
	$('#taskBPID').text(dataSelect.taskBPID); 
	
	$("input:radio[name=taskType][value="+dataSelect.taskType+"]").prop("checked",true); 
	$('input:radio[name="taskType"]').attr("disabled",true);
	
	$('input:checkbox[name="modfiyABE"]').prop("checked",false);
    setCheckBoxValue("modfiyABE",dataSelect.modfiyABE);
    $('input:checkbox[name="modfiyABE"]').attr("disabled",true);
	
	
	$('#BTID').text(dataSelect.BTID); 
	$('#BTVersion').text(dataSelect.BTVersion); 
	$('#taskCTRName').text(dataSelect.taskCTRName);
	
	

	$('#taskStaff').text(dataSelect.taskStaff);
	$('#taskLimitDate').text(dataSelect.taskLimitDate);
	$('#BTAcceptResultText').text(dataSelect.BTAcceptResultText);
	$('#recordAuditResultText').text(dataSelect.recordAuditResultText);
	$('#IPQCAuditResultText').text(dataSelect.IPQCAuditResultText);
	$('#IPQCResultText').text(dataSelect.IPQCResultText);
	
	$('#taskDBE').text(dataSelect.taskDBE);
	
	$('#BTAuditOpinionShow').hide();
	$('#BTAuditOpinion').show();
	
	$('#DivTaskAuditBTNS').show();
	
	
	$('#DivRecordPanel').hide();

	
	
	
	

}


//函数:记录按钮详情页自动填写内容------------------------
function Fun_taskRecordInit(dataSelect){
	
	$('#DBID').text(dataSelect.DBID); 
	$('#taskBPID').text(dataSelect.taskBPID); 
	
	$("input:radio[name=taskType][value="+dataSelect.taskType+"]").prop("checked",true); 
	$('input:radio[name="taskType"]').attr("disabled",true);
	
	$('input:checkbox[name="modfiyABE"]').prop("checked",false);
    setCheckBoxValue("modfiyABE",dataSelect.modfiyABE);
    $('input:checkbox[name="modfiyABE"]').attr("disabled",true);
	
	
	$('#BTID').text(dataSelect.BTID); 
	$('#BTVersion').text(dataSelect.BTVersion); 
	$('#taskCTRName').text(dataSelect.taskCTRName);
	
	

	$('#taskStaff').text(dataSelect.taskStaff);
	$('#taskLimitDate').text(dataSelect.taskLimitDate);
	$('#BTAcceptResultText').text(dataSelect.BTAcceptResultText);
	$('#recordAuditResultText').text(dataSelect.recordAuditResultText);
	$('#IPQCAuditResultText').text(dataSelect.IPQCAuditResultText);
	$('#IPQCResultText').text(dataSelect.IPQCResultText);
	
	$('#taskDBE').text(dataSelect.taskDBE);
	$('#BTAuditOpinionShow').text(dataSelect.BTAuditOpinion);
	
	$("input:radio[name=FQCRequest][value="+dataSelect.FQCRequest+"]").prop("checked",true); 

	var SQLIPQCMaker={SQL:"SQLSRStaffs"};
	var IPQCMaker="#IPQCMaker";
	
	if(dataSelect.IPQCMaker==null){
		Fun_getSQLSelectDBData(SQLIPQCMaker,IPQCMaker,sessionName);
	}else{
		Fun_getSQLSelectDBData(SQLIPQCMaker,IPQCMaker,dataSelect.IPQCMaker);
	}
	
	
	
	
	
	$('#BTAuditOpinionShow').show();
	$('#BTAuditOpinion').hide();
	
	$('#DivTaskAuditBTNS').hide();
	
	
	
	if(dataSelect.recordAuditResult==1){

		$('#recordAuditor').text(dataSelect.recordAuditor);
		$('#recordAuditDate').text(dataSelect.recordAuditDate);
		$('#recordAuditResultText').text(dataSelect.recordAuditResultText);
		
		
		$('#DivRecordAuditInfo').show();
		
		$('#DivUploadBTNS').hide();

		$('#DivTaskRecordBTNS').hide();
		
		$('#DivTaskUpdVerBTN').show();
		
		
	}else{
		
		$('#DivRecordAuditInfo').hide();
		$('#DivUploadBTNS').show();
		$('#DivTaskRecordBTNS').show();
		
		$('#DivTaskUpdVerBTN').hide();

		
	}
	
	
	
	
	$('#modifyContent').val(dataSelect.modifyContent);
	
	$('#functionsDBE').val(dataSelect.functionsDBE);
	
	$('#recordRemark').val(dataSelect.recordRemark);
	
	 $('#divFilesUploaded').html("");
	  
	  if(dataSelect.taskFileKey!=null){
		  
		  console.log("不为空"+dataSelect.taskFileKey);
		  var downloadurl="<a id='filePath' href="+'/system.files.download/upload_'+dataSelect.taskFileKey+" download="+dataSelect.taskFileName+">"+"<span id='fileName'>"+dataSelect.taskFileName+"</span></a>";
		  $('#divFilesUploaded').html(downloadurl);
	  }
	  
	  $('#DivRecordPanel').show();  
	  
	
}





//页面加载函数---------------
$(document).ready( function () {
	
	
	const tableSQL={"SQL":"SQLTableBillsTaskRecord"};
	
    sessionName="<%-locals.session.yjUser.Name%>";
	
	console.log("sessionName:"+sessionName);
	
	
	const tableInfo={
			"tableID":"#billsTaskTable",
			"columnsData":[
				{ data: 'DBID' ,"visible": false},
		        { data: 'BTID' },
		        { data: 'BTVersion'},
		        { data: 'taskCTRName'},
		        { data: 'taskTypeText'},
		        { data: 'taskStaff'},
		        { data: 'taskLimitDate'},
		        { data: 'BTAcceptResultText'},
		        { data: 'recordAuditResultText'},
		        { data: 'IPQCResultText'}
			]
	}
	
	
	Fun_showSQLTable(tableSQL,tableInfo)

	
//判断是否选中数据-------
var table = $('#billsTaskTable').DataTable();
$('#billsTaskTable tbody').on('click', 'tr', function() {
    if ($(this).hasClass('selected')) {
        $(this).removeClass('selected');
    } else {
        table.$('tr.selected').removeClass('selected');
        $(this).addClass('selected');
    }
 
    var dataSelect = table.row('.selected').data();
    
    

});
	

//按钮-审核任务单---------
$('#BTNTaskAccept').click(function() {
	
	  var dataSelect = table.row('.selected').data();
	    if (dataSelect == undefined) {
	        alert("请先点击选择表格中的任务单!");
	    } else {
	    	console.log("dataSelect:"+JSON.stringify(dataSelect));
	    	
	    	$('#BillTask').modal('show')
	    	Fun_taskAuditInit(dataSelect);
	    	
	    	if(dataSelect.BTAcceptResult==0){
	    		$('#DivTaskAuditBTNS').show();
	    	}else{
	    		$('#DivTaskAuditBTNS').hide();
	    	}
	    	
	    	
	    }
	
 
});

//按钮-任务审核通过按钮
$('#BTNTaskAcceptYes').click(function() {
	
	if(sessionName==$('#taskStaff').text()){
		var msg = confirm("审核后无法修改单据,是否立即审核通过?");
		if(msg==true){	

			var acceptData={
					"DBTable":"ppm_bills_task",
					"DBID":$('#DBID').text(),
					"BTAcceptOpinion":$('#BTAuditOpinion').val(),
					"BTAcceptor":sessionName,
					"BTAcceptDate":Ndate,
					"BTAcceptResult":1,
					"BTStatus":1
			}

			updDBData(acceptData,"任务单审核通过状态");
		}
	}else{
		alert("非该方案单的负责人,不允许审核!");
	}


});


//按钮-任务审核驳回按钮
$('#BTNTaskAcceptNo').click(function() {
	
	if(sessionName==$('#taskStaff').text()){
		var msg = confirm("审核后无法修改单据,是否立即审核驳回?");
		if(msg==true){	

			
			var acceptData={
					"DBTable":"ppm_bills_task",
					"DBID":$('#DBID').text(),
					"BTAcceptOpinion":$('#BTAuditOpinion').val(),
					"BTAcceptor":sessionName,
					"BTAcceptDate":Ndate,
					"BTAcceptResult":2,
					"BTStatus":2
			}

			updDBData(acceptData,"任务单确认接收状态");
		}
	}else{
		alert("非该方案单的负责人,不允许审核!");
	}


});

//按钮-记录任务单---------
$('#BTNTaskRecord').click(function() {
	
	  var dataSelect = table.row('.selected').data();
	    if (dataSelect == undefined) {
	        alert("请先点击选择表格中的任务单!");
	    } else {
	    	console.log("dataSelect:"+JSON.stringify(dataSelect));
	    	
	    	
	    		$('#BillTask').modal('show')
		    	Fun_taskRecordInit(dataSelect);

	    }

});

//按钮-任务记录保存按钮
$('#BTNTaskRecordSave').click(function() {
	
	
	if($('#BTAcceptResultText').text()!="已确认"){
		alert("该任务单未确认接收,无法添加处理记录,请确认!");
	}else{
		if(sessionName==$('#taskStaff').text()){
			
			
			 if($('#filePath').attr('href')!=undefined){
					var fileKey=$('#filePath').attr('href').substring(30);//去掉多余的字符串前缀
					var fileName=$('#fileName').html();
					}else{
					var fileKey="";
					var fileName="";
				}
			 
			 if(fileName==""){
				 alert("程序附件必须上传!");
			 }else{
				 
				 var recordData={
							"DBTable":"ppm_bills_task",
							"DBID":$('#DBID').text(),
							"modifyContent":$('#modifyContent').val(),
							"functionsDBE":$('#functionsDBE').val(),
							"recordRemark":$('#recordRemark').val(),
							"IPQCMaker":$('#IPQCMaker option:selected').text(),
							"FQCRequest":$('input:radio[name="FQCRequest"]:checked').val(),
							"taskFileName":fileName,
							"taskFileKey":fileKey,
							"recordDate":Ndate,
							"recordAuditResult":0,
							"BTStatus":3
					}
					
					console.log("recordData:"+JSON.stringify(recordData));

					updDBData(recordData,"任务单记录");
				 
			 }
		}else{
			alert("非该方案单的负责人,不允许填单!");
		}
		
	}
	
	


});


//按钮-任务记录审核按钮
$('#BTNTaskRecordAudit').click(function() {
	
	
	if($('#filePath').attr('href')!=undefined){
		var fileKey=$('#filePath').attr('href').substring(30);//去掉多余的字符串前缀
		var fileName=$('#fileName').html();
		}else{
		var fileKey="";
		var fileName="";
	}
	
	if(fileName==""){
		alert("未检测到程序附件,请确认任务单是否完成!");
		}else{
			var msg = confirm("审核后无法再次进行任务登记,如任务记录有误,请修改后再审核,是否立即审核通过?");
			if(msg==true){	

					 var recordAuditData={
								"DBTable":"ppm_bills_task",
								"DBID":$('#DBID').text(),
								"recordAuditor":sessionName,
								"recordAuditDate":Ndate,
								"recordAuditResult":1,
								"BTStatus":4
					 }
						
						console.log("recordAuditData:"+JSON.stringify(recordAuditData));
						updDBData(recordAuditData,"任务单记录审核状态");
						
						
						
			}
		}
	
	
	
	

});





//详情按钮---------
$('#BTNInfo').click(function() {
    console.log("seclet: "+JSON.stringify(table.row('.selected').data()));
    // table.row('.selected').remove().draw( false );
    var dataSelect = table.row('.selected').data();
    if (dataSelect == undefined) {
        alert("请先点击表格中的表单!");
    } else {
    	
    	
    	$('#BillTask').modal('show')
    	Fun_winDetailInit(dataSelect);
    	

    }
});



//按钮-更新版本---------
$('#BTNTaskUpdVer').click(function() {
	
	var msg1 = confirm("风险操作！更新任务版本后,系统内任务单将被新版本替代!");
    if (msg1 === true) {
        var msg2 = confirm("再次确认？");
        if (msg2 === true) {
        	
        	var newBTVersion=parseInt($('#BTVersion').text())+1;
        	
        	var IPQCResultText=$('#IPQCResultText').text();
        	
        	if(IPQCResultText=="出货后修正"){
        		var taskRepeat=1;
        	}else{
        		var taskRepeat=0;
        	}
        	
//        	
        	
        	var taskData={
					"DBTable":"ppm_bills_task",
					"BTID":$('#BTID').text(),
					"BTVersion":newBTVersion,
					"taskType":$('input:radio[name="taskType"]:checked').val(),
					"taskRepeat":taskRepeat,
					"taskCTRName":$('#taskCTRName').text(),
					"taskStaff":$('#taskStaff').text(),
					"taskBPID":$('#taskBPID').text(),
					"modfiyABE":getCheckBoxValue('modfiyABE'),
					"taskDBE":$('#taskDBE').val(),
					"taskLimitDate":$('#taskLimitDate').text(),
					"BTAcceptResult":0,
					"BTStatus":1
					}
        	
        	addDBData(taskData);

          
        }
    }

    	
});





//删除按钮----------
$('#BTNDelete').click(function() {
    var dataSelect = table.row('.selected').data();
    
 //   console.log(JSON.stringify(dataSelect));
    
    if (dataSelect == undefined) {
        alert("当前未选择任何数据,请先点击需要删除的数据行!");
    } else {
    	
    	
    	if(dataSelect.auditDate!=null){
    		alert("已审核单据禁止删除!");
    	}else{
    		
    		
    		var msg1 = confirm("风险操作！此行数据内容移除后无法还原，请确认操作是否无误！");
            if (msg1 === true) {
                var msg2 = confirm("确认删除此行数据？");
                if (msg2 === true) {
                	
                //	console.log(dataSelect.DBID);
                    var IDData = {"DBTable":"ppm_bills_plan","DBID":dataSelect.DBID};
 //                   console.log("IDData:"+JSON.stringify(IDData));
                    delDBData(IDData);
                }
            }
    		
    		
    	}

    }
    //          table.row('.selected').remove().draw( false );//前端删除显示数据 ,数据库不删除
});


//按钮-表单关闭按钮,添加刷新数据功能
$('#BTNFormClose').click(function() {
	 window.location.reload();
});
	
}); 

</script>
