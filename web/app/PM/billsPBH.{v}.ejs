<!-- CSS -->
<link rel="stylesheet" type="text/css" href="/css/PM/PMContent.css">
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/Bootstrap-3.3.7/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/DataTables-1.10.18/css/dataTables.bootstrap.css">
<link href="/css/PM/datetimepicker/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
<link rel="stylesheet" href="/css/PM/bootstrap-select.min.css" />


<!-- JS  -->

<script src="/css/PM/DataTables/Bootstrap-3.3.7/js/bootstrap.min.js"></script>
<script src="/css/PM/bootstrap-select.min.js"></script>
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.min.js" charset="UTF-8"></script>
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>

<script type="text/javascript"  src="/css/PM/DataTables/DataTables-1.10.18/js/jquery.dataTables.min.js"></script>
<script type="text/javascript"  src="/css/PM/DataTables/DataTables-1.10.18/js/dataTables.bootstrap.min.js"></script>
<script src="/js/PM/FileSaver.min.js"></script>
<script src="/js/PM/tableExport.js"></script>
<script src="/js/PM/PMfuns.js"></script>




<% layout(locals.global.theme_layout_dir+'/master.ejs') -%>



<div class="divcontent">
    <h1>工作流程-发布单</h1>
    <hr>

    <!-- 操作区（按钮等） -->
    <div class="lineitem">


        <!-- 按钮触发模态框 -->
        <button id="BTNPBHDetail" class="btn btn-primary" data-toggle="modal" >发布维护</button>

        <!-- 模态框（Modal） -->
        <div class="modal fade" id="BillPLD" tabindex="-1" role="dialog" aria-labelledby="BillPLDLabel" aria-hidden="true">
            <div class="modal-dialog" style="width:75%">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="BillPLDLabel">计划单面板</h4>
                    </div>
                    <div class="modal-body">

                    <div class="panel panel-info">

                    <div class="panel-heading">
                        <h3 class="panel-title">计划单信息</h3>
                    </div>

                    <div class="panel-body">




                    <div class="form-horizontal" >

                    <input id="DBID" type="text" value="" style="display:none;">


                    <input id="auditResult" type="text" value="" style="display:none;">


                    <!-------------------------------------------------------------------------->
                     <div class="form-group">
                       <label class="col-sm-1 control-label">计划单号:</label>
                       <div class="col-sm-1">
                         <span id="BPID" class="help-block"></span>
                       </div>

                       <label class="col-sm-1 control-label">计划版本号:</label>
                       <div class="col-sm-1">
                       <span id="version" class="help-block"></span>
                       </div>

                       <label  class="col-sm-1 control-label" for="name">客户:</label>
                       <div class="col-sm-1 ">
                       <span id="CTRName" class="help-block"></span>
                       </div>


                       <label  class="col-sm-1 control-label" for="name">机型:</label>
                       <div class="col-sm-1 ">
                       <span id="MHEName" class="help-block"></span>
                       </div>


                       <label  class="col-sm-1 control-label" for="name">系统:</label>
                       <div class="col-sm-1 ">
                       <span id="model" class="help-block"></span>
                       </div>





                     </div>




                     <!-------------------------------------------------------------------------->
                     <div class="form-group">

                     <label for="applyDate" class="col-sm-1 control-label">申请日期:</label>
                     <div class="col-sm-1 ">
                     <span id="applyDate" class="help-block"></span>
                 	 </div>


                     <label for="limitDate" class="col-sm-1 control-label">完成期限:</label>
                     <div class="col-sm-2 ">
                     <span id="limitDate" class="help-block"></span>
                 	 </div>


                 	<label  class="col-sm-1 control-label" for="name">方案负责人:</label>
                    <div class="col-sm-3 ">
                    <span id="PGEMaker" class="help-block"></span>
                    </div>


                 	 </div>




                     <!-------------------------------------------------------------------------->

                     <div class="form-group">
                     <label class="col-sm-1 control-label">修改主题:</label>
                     <div class="col-sm-8">
                     <span id="topic" class="help-block"></span>
                     </div>
                     </div>

                     <!-------------------------------------------------------------------------->
                     <div class="form-group">
                     <label  class="col-sm-1 control-label" for="name">修改要求:</label>
                     <div class="col-sm-8">
                     <span id="detail" class="help-block"></span>
                     </div>
                     </div>





                     <!-------------------------------------------------------------------------->

                     </div>
                    </div>
                   </div>
                   <!--panel------------------------------------------------------------------------>

                   <div class="panel panel-default">
                   <div class="panel-heading">任务清单</div>

                   <div style="margin:10px;">
                	 <table id="billsTaskTable" class="table table-bordered" style="width:100%;" >
                   <thead>
                       <tr>
                           <th>任务单号</th>
                           <th>任务版本号</th>
                           <th>任务类型</th>
                           <th>任务负责人</th>
                           <th>任务要求</th>
                           <th>修改内容</th>
                           <th>程序附件</th>
                       </tr>
                   </thead>
                   <tbody>
                   </tbody>
                   </table>
                   </div>

                   </div>

                   <!--panel------------------------------------------------------------------------>
                   <div class="panel panel-success">
                   <div class="panel-heading">
                       <h3 class="panel-title">发布记录</h3>
                   </div>
                   <div class="panel-body">


                   <div class="form-horizontal" >
                   
                   <!-------------------------------------------------------------------------->
                   <div class="form-group">
                   <label class="col-sm-1 control-label">收件人:</label>
                   <div class="col-sm-10">
                     <input id="emailADRS" class="form-control"  type="text" value="">
                   </div>
                   </div>
                   <!-------------------------------------------------------------------------->
                   <div class="form-group">
                   <label class="col-sm-1 control-label">抄送:</label>
                   <div class="col-sm-10">
                     <input id="BPID" class="form-control"  type="text" value="">
                   </div>
                   </div>
                   <!-------------------------------------------------------------------------->
                   <div class="form-group">
                   <label class="col-sm-1 control-label">主题:</label>
                   <div class="col-sm-10">
                     <input id="emailTitle" class="form-control"  type="text" value="">
                   </div>
                   </div>
                   <!-------------------------------------------------------------------------->
                   <div class="form-group">
                   <label class="col-sm-1 control-label">附件:</label>
                   <div class="col-sm-10">
                   <span id="PBHRemarkShow" class="help-block"></span>
                   </div>
                   </div>
                   <!-------------------------------------------------------------------------->
                   <div class="form-group">
                   <label class="col-sm-1 control-label">邮件内容:</label>
                   <div class="col-sm-10">
                   <div id="DIVEmailContent">
                   Dear <span id="contact" ></span>:</br>
                   您好，程序已修改完成，请查收，谢谢！
                   
                   
                   </div>
                   
                  
                   </div>
                   </div>
                   <!-------------------------------------------------------------------------->

                   <div class="form-group">
                   <label class="col-sm-1 control-label">备注:</label>
                   <div class="col-sm-10">
                   <span id="PBHRemarkShow" class="help-block"></span>
                   <input id="PBHRemark" class="form-control"  type="text" value="">
                   </div>
                   </div>

                  


               	<!-------------------------------------------------------------------------->
                <div class="form-group" >

                <label  class="col-sm-1 control-label" for="name">发布制单人:</label>
                <div class="col-sm-2">
                <span id="PBHMaker" class="help-block"></span>
                </div>

                <label class="col-sm-1 control-label"></label>
                <label for="PBHMakeDate" class="col-sm-2 control-label">发布制单日期:</label>
                <div class="col-sm-2">
                <span id="PBHMakeDate" class="help-block"></span>
            	 </div>


                </div>

                <!-------------------------------------------------------------------------->
                    <div class="form-group" id="DivPBHAuditInfo">

                    <label  class="col-sm-1 control-label" for="name">发布审核人:</label>
                    <div class="col-sm-2">
                    <select  id="PBHAuditor" class="selectpicker" data-live-search="true">
                    </select>
                    </div>

                    <label class="col-sm-1 control-label"></label>
                    <label for="recordAuditDate" class="col-sm-2 control-label">发布审核日期:</label>
                    <div class="col-sm-2">
                    <span id="PBHAuditDate" class="help-block"></span>
                	 </div>

                	<label class="col-sm-1 control-label">发布结果:</label>
                    <div class="col-sm-1">
                    <span id="PBHResultText" class="help-block"></span>
                    </div>

                    </div>

                    <!-------------------------------------------------------------------------->



               	    <div class="form-group" id="DivPBHBTNS">
                    <label class="col-sm-1 control-label">登记:</label>
                    <div class="col-sm-10">
                    <button id="BTNPBHSave" class="btn btn-success" data-toggle="modal" >保存发布信息</button>
                    <button id="BTNPBHAudit" class="btn btn-warning" data-toggle="modal" >审核发布信息</button>
                    <button id="BTNModelEmail" class="btn btn-warning" data-toggle="modal" >生成模版邮件</button>
                    <button id="BTNSendEmail" class="btn btn-warning" data-toggle="modal" >发送邮件</button>
                    <a id="mailhref"><button id="BTNSendEmailDiv" class="btn btn-warning" data-toggle="modal" >发送自定义邮件</button></a>
                    </div>

                    </div>



                   </div>



                   </div>
                   </div>
                   <!--panel------------------------------------------------------------------------>




                    </div>
                    <div class="modal-footer">
                        <button id="BTNFormClose" type="button" class="btn btn-default" data-dismiss="modal">关闭</button>

                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>



    </div>




    <br/>

    <!--数据呈现区-->
    <table id="billsPLDTable" class="table table-striped table-bordered"  >
        <thead>
            <tr>
                <th>数据库ID</th>
                <th>计划单号</th>
                <th>计划版本号</th>
                <th>客户简称</th>
                <th>完成期限</th>
                <th>任务数量</th>
                <th>任务完结数量</th>
                <th>流程状态</th>
                <th>PBH结果</th>
            </tr>
        </thead>
    </table>



    <!-- 点击更新、添加按钮后弹出的窗口 -->
    <div id="winEmail" class="easyui-window" title="表单详情" closed="true" style="width:90%;height:800px;">

    <div class="divcontent">

	<h3>邮件预览</h3>
	<hr>




    </div>




    </div>
    <!-- 点击更新、添加按钮后弹出的窗口 -->


</div>


<script>
//函数-根据自定义SQL获取数据加载Task表格,不显示搜索分页,简易模式


function Fun_showSQLFileTable(SQL,tableID){

	//alert(JSON.stringify(DataPara));

	 $.ajax({
         method:'get',
         data:SQL,
         url:"/app/PM/getSQLDBData",
         success:function(data){
        	// console.log("back Task data:"+JSON.stringify(data));

        	 for(var i=0;i<data.length;i++){

        		 var tr="<tr>" +
        		 		"<td>"+data[i].BTID+"</td><td>"+data[i].BTVersion+"</td><td>"+data[i].taskTypeText+"</td>" +
        		 		"<td>"+data[i].taskStaff+"</td><td>"+data[i].taskDBE+"</td><td>"+data[i].modifyContent+"</td>" +
        		 		"<td><a  href='/system.files.download/upload_"+data[i].taskFileKey+"' download="+data[i].taskFileName+">"+data[i].taskFileName+"</a></td>"
        		 		"</tr>";

        		 $(tableID+" tbody").append(tr);

        	 }

         },
         error:function(){}
     })

}






//函数:详情按钮详情页自动填写内容------------------------
function Fun_winDetailInit(dataSelect){
	
	 console.log("dataSelect:"+JSON.stringify(dataSelect));


	$('#DBID').val(dataSelect.DBID);
	$('#BPID').text(dataSelect.BPID);
	$('#version').text(dataSelect.version);
	$('#CTRName').text(dataSelect.PLDCTRName);
	$('#MHEName').text(dataSelect.MHEName);
	$('#model').text(dataSelect.model);
	$('#PGEMaker').text(dataSelect.PGEMaker);

	$('#applyDate').text(dataSelect.applyDate);
	$('#limitDate').text(dataSelect.limitDate);
	$('#topic').text(dataSelect.topic);
	$('#detail').text(dataSelect.detail);
	
	
	
	
	
	$('#PBHRemark').val(dataSelect.PBHRemark);
	

	
	$('#PBHMaker').text(dataSelect.PBHMaker);
	$('#PBHMakeDate').text(dataSelect.PBHMakeDate);
	
	$('#PBHAuditor').text(dataSelect.PBHAuditor);
	$('#PBHAuditDate').text(dataSelect.PBHAuditDate);
	
	$('#PBHResultText').text(dataSelect.PBHResultText);
	
	
	var SQLAuditor={SQL:"SQLSRStaffs"};
	var PBHAuditor="#PBHAuditor";
	Fun_getSQLSelectDBData(SQLAuditor,PBHAuditor,sessionName);


	tasksTableSQL={"SQL":"SQLTableBillsTask","filter":"taskBPID = '"+dataSelect.BPID+"'"};

	var tableID="#billsTaskTable";



	Fun_showSQLFileTable(tasksTableSQL,tableID);
	
	
	

	

	
	
	
	if(dataSelect.PBHAuditResult==null){
		
		$('#PBHRemarkShow').hide();
		$('#PBHRemark').show();
		$('#DivPBHBTNS').show();
		$("#PBHAuditor").attr("disabled",false);
	}else{
		$('#PBHRemarkShow').show();
		$('#PBHRemark').hide();
		$('#DivPBHBTNS').hide();
		$("#PBHAuditor").attr("disabled",true);
	}





}

//页面加载函数---------------
$(document).ready( function () {


	 tableSQL={"SQL":"SQLTableBillsPBH"};

	 sessionName="<%-locals.session.yjUser.Name%>";

	console.log("sessionName:"+sessionName);


	 tableInfo={
			"tableID":"#billsPLDTable",
			"columnsData":[
				{ data: 'DBID' ,"visible": false},
		        { data: 'BPID' },
		        { data: 'version'},
		        { data: 'CTRName'},
		        { data: 'limitDate'},
		        { data: 'taskNum'},
		        { data: 'taskNumDone'},
		        { data: 'WFStatusText'},
		        { data: 'PBHResultText'}
			]
	}


	Fun_showSQLTable(tableSQL,tableInfo);





//判断是否选中数据-------
var table = $('#billsPLDTable').DataTable();
$('#billsPLDTable tbody').on('click', 'tr', function() {
    if ($(this).hasClass('selected')) {
        $(this).removeClass('selected');
    } else {
        table.$('tr.selected').removeClass('selected');
        $(this).addClass('selected');
    }

    var dataSelect = table.row('.selected').data();


});


//按钮-发布维护---------
$('#BTNPBHDetail').click(function() {

	console.log("seclet: "+JSON.stringify(table.row('.selected').data()));
    // table.row('.selected').remove().draw( false );
    var dataSelect = table.row('.selected').data();
    if (dataSelect == undefined) {
        alert("请先点击表格中的表单!");
    } else {

    	$('#BillPLD').modal('show')
    	Fun_winDetailInit(dataSelect);


    }


});



//按钮-PBH保存---------
$('#BTNPBHSave').click(function() {

		 var PBHData={
					"DBTable":"ppm_bills_PBH",
					"DBID":$('#DBID').val(),
					"PBHBPID":$('#BPID').text(),
					"CTRName":$('#CTRName').text(),
					"PBHRemark":$('#PBHRemark').val(),
				    "PBHResult":$('input:radio[name="PBHResult"]:checked').val(),
					"PBHMaker":sessionName,
					"PBHMakeDate":Ndate,
					"PBHAuditor":$('#PBHAuditor option:selected').text()
			}

	saveDBData(PBHData,"PBH单");

});



//按钮-PBH审核---------
$('#BTNPBHAudit').click(function() {

		 var PBHData={
					"DBTable":"ppm_bills_PBH",
					"DBID":$('#DBID').val(),
					"PBHAuditor":sessionName,
					"PBHAuditDate":Ndate,
					"PBHAuditResult":1
			}

	updDBData(PBHData,"PBH单审核状态");

});


//radio 定义更换按键触发事件-----------
$('input:radio[name="auditType"]').click(function(){

	  var PGEMaker=$('#PGEMaker').children('option:selected').text();
	  console.log("PGEMaker:"+PGEMaker);
	  var radioValue = $('input:radio[name="auditType"]:checked').val();
	     switch(radioValue){
	 	case "1":
	 		var SQLAuditor={SQL:"SQLSRStaffs"};
	 		var auditor="#auditor";
	 		Fun_getSQLSelectDBData(SQLAuditor,auditor,PGEMaker);
	 	    $("#auditor").attr("disabled",true);
	 	    $('#auditDate').val("");
     	    $('#auditResult').val("");
	 	    break;
	 	case "2":

	 	    var SQLAuditor={SQL:"SQLSRStaffs"};
	 		var auditor="#auditor";
	 		Fun_getSQLSelectDBData(SQLAuditor,auditor);
	 	    $("#auditor").attr("disabled",false);
	 	    $('#auditDate').val("");
	 	    $('#auditResult').val("");
	 	    break;
	 	}

});

//按钮-邮件预览
$('#BTNModelEmail').click(function() {
	
	var CTRName= $("#CTRName").text();
	
	SQLEMails={"SQL":"SQLGetEMails","filter":"FTYName = '"+CTRName+"'"};
	 $.ajax({
         method:'get',
         data:SQLEMails,
         url:"/app/PM/getSQLDBData",
         success:function(data){
        	 console.log("back email data:"+JSON.stringify(data));
        	 
        	 $("#emailADRS").val(data[0].email);
        	 $("#contact").text(data[0].contact);
        	 



         },
         error:function(){}
     })
	

	     


   
});


//按钮-邮件自定义
$('#BTNSendEmailDiv').click(function() {
	
	
	$('#mailhref').attr("href","mailto:908178054@qq.com");
	$('#mailhref').click();
   
});


//按钮-表单关闭按钮,添加刷新数据功能
$('#BTNFormClose').click(function() {
	 window.location.reload();
});



});

</script>
