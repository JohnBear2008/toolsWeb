<!-- CSS -->
<link rel="stylesheet" type="text/css" href="/css/PM/PMContent.css">
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/Bootstrap-3.3.7/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="/css/PM/DataTables/DataTables-1.10.18/css/dataTables.bootstrap.css">
<link href="/css/PM/datetimepicker/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
<link rel="stylesheet" href="/css/PM/bootstrap-select.min.css" />


<!-- JS  -->

<script src="/css/PM/DataTables/Bootstrap-3.3.7/js/bootstrap.min.js"></script>
<script src="/css/PM/bootstrap-select.min.js"></script>
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.min.js" charset="UTF-8"></script>
<script type="text/javascript" src="/css/PM/datetimepicker/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>

<script type="text/javascript" src="/css/PM/DataTables/DataTables-1.10.18/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="/css/PM/DataTables/DataTables-1.10.18/js/dataTables.bootstrap.min.js"></script>
<script src="/js/PM/FileSaver.min.js"></script>
<script src="/js/PM/tableExport.js"></script>
<script src="/js/PM/PMfuns.js"></script>


<script src="/js/sweetalert.min.js"></script>
<script src="/public/funs.js"></script>

<!-- 导入js库 -->
<script type="text/javascript" src="/ppmLib/publicFuns.js"></script>


<% layout(locals.global.theme_layout_dir+'/master.ejs') -%>



<div class="divcontent">
	<h1>工作流程-发布单</h1>
	<hr>

	<!-- 操作区（按钮等） -->
	<div class="lineitem">


		<!-- 按钮触发模态框 -->
		<button id="BTNPBHDetail" class="btn btn-primary" data-toggle="modal">发布维护</button>

		<div class="btn-group" style="margin-left:20px">
			<button id="BTNFilterSimple" class="btn btn-default">未完成单据</button>
			<button id="BTNFilterAll" class="btn btn-default">全部单据</button>
		</div>

		<a href="/app/PM/workCenter"><button id="BTNWorkCenter" class="btn btn-success"
				style="float:right">个人中心</button></a>

		<!-- 模态框（Modal） -->
		<div class="modal fade" id="BillPLD" tabindex="1" role="dialog" aria-labelledby="BillPLDLabel"
			aria-hidden="true" data-backdrop="static">
			<div class="modal-dialog" style="width:75%">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" id='btnModalClose' class="close" data-dismiss="modal"
							aria-hidden="true">&times;</button>
						<h4 class="modal-title" id="BillPLDLabel">发布面板</h4>
					</div>
					<div class="modal-body">

						<div class="panel panel-info">

							<div class="panel-heading">
								<h3 class="panel-title">计划单信息</h3>
							</div>

							<div class="panel-body">

								<div class="form-horizontal">

									<input id="DBID" type="text" value="" style="display:none;">
									<input id="auditResult" type="text" value="" style="display:none;">


									<!-------------------------------------------------------------------------->
									<div class="form-group">
										<label class="col-sm-1 control-label">计划单号:</label>
										<div class="col-sm-2">
											<span id="BPID" class="help-block"></span>
										</div>

										<label class="col-sm-1 control-label">计划版本号:</label>
										<div class="col-sm-1">
											<span id="version" class="help-block"></span>
										</div>

										<label class="col-sm-1 control-label" for="name">客户:</label>
										<div class="col-sm-1 ">
											<span id="PBHCTRName" class="help-block"></span>
										</div>


										<label class="col-sm-1 control-label" for="name">机型:</label>
										<div class="col-sm-1 ">
											<span id="MHEName" class="help-block"></span>
										</div>


										<label class="col-sm-1 control-label" for="name">系统:</label>
										<div class="col-sm-1 ">
											<span id="model" class="help-block"></span>
										</div>
									</div>
									<!-------------------------------------------------------------------------->
									<div class="form-group">

										<label for="applyDate" class="col-sm-1 control-label">申请日期:</label>
										<div class="col-sm-1 ">
											<span id="applyDate" class="help-block"></span>
										</div>

										<label for="limitDate" class="col-sm-1 control-label">完成期限:</label>
										<div class="col-sm-2 ">
											<span id="limitDate" class="help-block"></span>
										</div>

										<label class="col-sm-1 control-label" for="name">方案负责人:</label>
										<div class="col-sm-1 ">
											<span id="PGEMaker" class="help-block"></span>
										</div>

										<label class="col-sm-1 control-label" for="name">FQC需求:</label>
										<div class="col-sm-1 ">
											<span id="FQCRequestText" class="help-block"></span>
										</div>

										<label class="col-sm-1 control-label" for="name">FQC结果:</label>
										<div class="col-sm-1 ">
											<span id="FQCPassText" class="help-block"></span>
										</div>

									</div>

									<!-------------------------------------------------------------------------->

									<div class="form-group">
										<label class="col-sm-1 control-label">修改主题:</label>
										<div class="col-sm-8">
											<span id="topic" class="help-block"></span>
										</div>
									</div>

									<!-------------------------------------------------------------------------->
									<div class="form-group">
										<label class="col-sm-1 control-label" for="name">修改要求:</label>
										<div class="col-sm-8">
											<span id="detail" class="help-block" style="white-space:pre-wrap;"></span>
										</div>
									</div>

									<!-------------------------------------------------------------------------->

								</div>
							</div>
						</div>
						<!--panel------------------------------------------------------------------------>

						<div class="panel panel-default">
							<div class="panel-heading">任务清单</div>

							<div style="margin:10px;">
								<table id="billsTaskTable" class="table table-bordered" style="width:100%;">
									<thead>
									</thead>
									<tbody>
									</tbody>
								</table>
							</div>

						</div>

						<!--panel------------------------------------------------------------------------>
						<div class="panel panel-success">
							<div class="panel-heading">
								<h3 class="panel-title">发布记录</h3>
							</div>
							<div class="panel-body">
								<div class="form-horizontal">

									<!-------------------------------------------------------------------------->
									<div class="form-group">
										<label class="col-sm-1 control-label">收件人:</label>
										<div class="col-sm-10">
											<input id="emailADRS" class="form-control" type="text" value="">
										</div>
									</div>
									<!-------------------------------------------------------------------------->
									<div class="form-group">
										<label class="col-sm-1 control-label">抄送:</label>
										<div class="col-sm-10">
											<input id="emailCopyADRS" class="form-control" type="text" value="">
										</div>
									</div>
									<!-------------------------------------------------------------------------->
									<div class="form-group">
										<label class="col-sm-1 control-label">主题:</label>
										<div class="col-sm-10">
											<input id="emailTitle" class="form-control" type="text" value="">
										</div>
									</div>


									<!-------------------------------------------------------------------------->


									<!-------------------------------------------------------------------------->
									<div class="form-group">
										<label class="col-sm-1 control-label" for="name">附件:</label>

										<div class="col-sm-8">
											<div id="div_previewImages"></div>
											<div id="progressNumber"></div>
											<div id="divFilesUploaded"></div>
										</div>


									</div>

									<!-------------------------------------------------------------------------->
									<div class="form-group">
										<label class="col-sm-1 control-label">联系人:</label>
										<div class="col-sm-10">
											<input id="emailContact" class="form-control" type="text" value="">
										</div>
									</div>
									<!-------------------------------------------------------------------------->
									<div class="form-group">
										<label class="col-sm-1 control-label">邮件内容:</label>
										<div class="col-sm-10">
											<textarea id="emailContent" class="form-control" rows="6"></textarea>

										</div>
									</div>
									<!-------------------------------------------------------------------------->

									<div class="form-group">
										<label class="col-sm-1 control-label">备注:</label>
										<div class="col-sm-10">

											<input id="PBHRemark" class="form-control" type="text" value="">
										</div>
									</div>




									<!-------------------------------------------------------------------------->
									<div class="form-group">

										<label class="col-sm-1 control-label" for="name">发布制单人:</label>
										<div class="col-sm-2">
											<span id="PBHMaker" class="help-block"></span>
										</div>

										<label class="col-sm-1 control-label"></label>
										<label for="PBHMakeDate" class="col-sm-2 control-label">发布制单日期:</label>
										<div class="col-sm-2">
											<span id="PBHMakeDate" class="help-block"></span>
										</div>

										<label class="col-sm-1 control-label">发布版本号:</label>
										<div class="col-sm-1">
											<span id="PBHVersion" class="help-block"></span>
										</div>


									</div>

									<!-------------------------------------------------------------------------->
									<div class="form-group" id="DivPBHAuditInfo">

										<label class="col-sm-1 control-label" for="name">发布审核人:</label>
										<div class="col-sm-2">
											<select id="PBHAuditor" class="selectpicker" data-live-search="true">
											</select>
										</div>

										<label class="col-sm-1 control-label"></label>
										<label for="recordAuditDate" class="col-sm-2 control-label">发布审核日期:</label>
										<div class="col-sm-2">
											<span id="PBHAuditDate" class="help-block"></span>
										</div>

										<label class="col-sm-1 control-label">发布结果:</label>
										<div class="col-sm-1">
											<span id="PBHResultText" class="help-block"></span>
										</div>

									</div>
									<!-------------------------------------------------------------------------->



									<div class="form-group" id="DivToolBTNS">
										<label class="col-sm-1 control-label">工具:</label>
										<div class="col-sm-10">
											<button id="BTNGetInfo" class="btn btn-success"
												data-toggle="modal">智能填单</button>

											<input type="file" name="myHead" multiple="multiple" id="fileToUpload"
												style="display:none;" onchange="fileSelected()">
											<a class="btn btn-info" onclick="$('#fileToUpload').click()">附加程序及文件</a>


											<button id="BTNResetInfo" class="btn btn-warning"
												data-toggle="modal">清空信息</button>

										</div>
									</div>

									<!-------------------------------------------------------------------------->



									<div class="form-group" id="DivPBHBTNS">
										<label class="col-sm-1 control-label">登记:</label>
										<div class="col-sm-10">
											<button id="BTNPBHSave" class="btn btn-success"
												data-toggle="modal">保存发布信息</button>
											<button id="BTNPBHAudit" class="btn btn-warning"
												data-toggle="modal">审核发布信息</button>

										</div>
									</div>

									<!-------------------------------------------------------------------------->



									<div class="form-group" id="DivEmaiBTNS">
										<label class="col-sm-1 control-label">邮件:</label>
										<div class="col-sm-10">
											<button id="BTNModelEmail" class="btn btn-default"
												data-toggle="modal">系统邮件</button>
											<a id="mailhref"><button id="BTNSendEmailDiv" class="btn btn-default"
													data-toggle="modal">自定义邮件</button></a>
										</div>
									</div>
									<!-------------------------------------------------------------------------->



								</div>



							</div>
						</div>
						<!--panel------------------------------------------------------------------------>

						<button id="BTNUpdVer" class="btn btn-danger" data-toggle="modal">更新版本</button>
						<button id="BTNProgramEnd" class="btn btn-success" data-toggle="modal">程序归档</button>
						<button id="BTNSendSMSOpen" class="btn btn-success" data-toggle="modal">短信通知</button>
						<button id="BTNEnd" class="btn btn-success" data-toggle="modal">完结归档</button>




					</div>
					<div class="modal-footer">
						<button id="BTNFormClose" type="button" class="btn btn-default" data-dismiss="modal">关闭</button>

					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal -->
		</div>



	</div>




	<br />

	<!--数据呈现区-->
	<table id="billsPBHTable" class="table table-striped table-bordered">
		<thead>
			<tr>
				<th>时间戳</th>
				<th>数据库ID</th>
				<th>计划单号</th>
				<th>计划版本号</th>
				<th>客户简称</th>
				<th>完成期限</th>
				<th>任务数量</th>
				<th>任务完结数量</th>
				<th>制单人</th>
				<th>审核人</th>
				<th>发布单状态</th>
				<th>邮件发布结果</th>
			</tr>
		</thead>
	</table>

	<!-- 点击更新、添加按钮后弹出的窗口 -->
	<!-- <div id="winSMS" class="easyui-window" title="表单详情" closed="true">
		<h3>短信发送</h3>
		<hr>
		<input id="smsPhone" class="form-control" type="text" list="phoneList" />
		<datalist id="phoneList">
			<option value="BMW">
			<option value="Ford">
			<option value="Volvo">
		</datalist>

		<button id="BTNSendSMS" class="btn btn-default">发送</button>
	</div> -->

	<!-- 短信模态框（Modal） -->
	<div class="modal fade" id="winSMS">
		<div class="modal-dialog" style="width: 750px;">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
						&times;
					</button>
					<h4 class="modal-title">
						短信发送
					</h4>
				</div>
				<div class="modal-body form-horizontal" style="height: 300px;">

					<div class="form-group" style="text-align: center;">
						注意事项:仅支持有效手机号,可直接输入或下拉选择,发送多个手机号,以","分隔
					</div>

					<div class="form-group">
						<label class="col-sm-2 control-label">手机号:</label>
						<div class="col-sm-8">
							<input id="smsPhone" class="form-control" type="text" />
							<!-- <datalist id="phoneList">
							</datalist> -->
						</div>
						<div class="col-sm-2"><button id="BTNSendSMS" class="btn btn-default">发送</button></div>
					</div>
				</div>
			</div>
		</div>
	</div>


	<!-- 点击更新、添加按钮后弹出的窗口 -->
	<div id="winEmail" class="easyui-window" title="表单详情" closed="true" style="width:80%;height:800px;">

		<div class="divcontent">

			<h3>邮件预览</h3>
			<hr>

			<div class="form-horizontal" id="DivEmailModel">
				<!-------------------------------------------------------------------------->
				<div class="form-group">
					<label class="col-sm-1 control-label">收件人:</label>
					<div class="col-sm-10">
						<span id="emailADRSModel" class="help-block"></span>

					</div>
				</div>
				<!-------------------------------------------------------------------------->
				<div class="form-group">
					<label class="col-sm-1 control-label">抄送:</label>
					<div class="col-sm-10">
						<span id="emailCopyADRSModel" class="help-block"></span>

					</div>
				</div>
				<!-------------------------------------------------------------------------->
				<div class="form-group">
					<label class="col-sm-1 control-label">主题:</label>
					<div class="col-sm-10">
						<span id="emailTitleModel" class="help-block"></span>

					</div>
				</div>
				<!-------------------------------------------------------------------------->
				<div class="form-group">
					<label class="col-sm-1 control-label">附件:</label>
					<div class="col-sm-10">
						<span id="emailFilesModel" class="help-block"></span>

					</div>
				</div>

				<!-------------------------------------------------------------------------->
				<div class="form-group">
					<label class="col-sm-1 control-label">邮件内容:</label>
					<div class="col-sm-10">

						<div>

							<div id="emailContentHello" class="help-block" style="white-space:pre;"></div>

							<table width="60%" border="1">
								<tr>
									<td colspan="2">
										<p align="center">出货附件档案说明</p>
										<p align="right">表单编号：TMC011 版次：1 </p>
									</td>
								</tr>

								<tr>
									<td width="100">需求单编号：</td>
									<td>
										<div id="emailBPID" class="help-block"></div>
									</td>
								</tr>
								<tr>
									<td>主机：</td>
									<td>
										<div id="emailDSPInfo" class="help-block"></div>
									</td>
								</tr>
								<tr>
									<td>面板：</td>
									<td>
										<div id="emailHMIInfo" class="help-block"></div>
									</td>
								</tr>
								<tr>
									<td colspan="2">修改内容：</td>
								</tr>
								<tr>
									<td colspan="2">

										<div id="emailContentModel" class="help-block">

										</div>

									</td>
								</tr>
							</table>
						</div>
					</div>
				</div>
				<!-------------------------------------------------------------------------->

				<div class="form-group">
					<label class="col-sm-1 control-label"></label>
					<div class="col-sm-10">
						<button id="BTNModelEmailSend" class="btn btn-default" data-toggle="modal">发送邮件</button>

					</div>
				</div>
				<!-------------------------------------------------------------------------->

				<div>
				</div>
			</div>
			<!-- 点击更新、添加按钮后弹出的窗口 -->


		</div>





		<script>
			//函数-根据自定义SQL获取数据加载Task表格,不显示搜索分页,简易模式

			//
			//function Fun_showSQLFileTable(SQL,tableID){
			//
			//	//swal(JSON.stringify(DataPara));
			//
			//	 $.ajax({
			//         method:'get',
			//         data:SQL,
			//         url:"/app/PM/getSQLDBData",
			//         success:function(data){
			//        	// console.log("back Task data:"+JSON.stringify(data));
			//
			//        	 for(var i=0;i<data.length;i++){
			//
			//        		 var tr="<tr>" +
			//        		 		"<td>"+data[i].BTID+"</td><td>"+data[i].BTVersion+"</td><td>"+data[i].taskTypeText+"</td>" +
			//        		 		"<td>"+data[i].taskStaff+"</td><td>"+data[i].taskDBE+"</td><td id='modifyContent"+i+"'>"+data[i].modifyContent+"</td>" +
			//        		 		"<td id='TDfile"+i+"'><a id='hrefA"+i+"'  href='/system.files.download/upload_"+data[i].taskFileKey+"' download="+data[i].taskFileName+"><span id='fileName"+i+"'>"+data[i].taskFileName+"</span></a></td>"
			//        		 		"</tr>";
			//
			//        		 $(tableID+" tbody").append(tr);
			//
			//        	 }
			//
			//         },
			//         error:function(){}
			//     })
			//
			//}


			//检测填入邮箱格式是否符合 aa<1@1.com>

			const checkEmail = (email) => {

				let o = true;
				try {
					let emailAdr = email.substring(email.indexOf('<'), email.length);



					var myReg1 = /^<[a-zA-Z0-9_-]+\.+[a-zA-Z0-9_-]+@([a-zA-Z0-9_-]+\.)+(com|cn|net|org|tw|world)>$/;
					var myReg2 = /^<[a-zA-Z0-9_-]+@([a-zA-Z0-9_-]+\.)+(com|cn|net|org|tw|world)>$/;


					if (myReg1.test(emailAdr) || (myReg2.test(emailAdr))) {
						o = true;
					} else {
						o = false;
					}

				} catch (error) {
					console.log('checkEmail error:' + error)

				}

				return o;
			}

			// checkEmail('aaa<596417327@qq.com>');

			const checkEmailAdrsFormate = (adrs) => {

				let o = true
				try {
					if (adrs.indexOf(',') !== -1) {
						let adrsArray = adrs.split(',');

						for (let n = 0; n < adrsArray.length; n++) {
							o = o && checkEmail(adrsArray[n])
						}

					} else if (adrs !== "") {
						o = checkEmail(adrs)
					}
				} catch (error) {
					console.log('checkEmailAdrsFormate error:' + error)
				}

				console.log('checkEmailAdrsFormate o:' + o)

				return o
			}





			//检查输入项
			function checkPBHInput() {

				var reg =
					/[\u3002|\uff1f|\uff01|\uff0c|\u3001|\uff1b|\uff1a|\u201c|\u201d|\u2018|\u2019|\uff08|\uff09|\u300a|\u300b|\u3008|\u3009|\u3010|\u3011|\u300e|\u300f|\u300c|\u300d|\ufe43|\ufe44|\u3014|\u3015|\u2026|\u2014|\uff5e|\ufe4f|\uffe5]/;


				// console.log("a:"+$('#divFilesUploaded a').text())

				if ($("#emailADRS").val() === "") {
					swal("收件人邮箱未填写,请检查!");
					return false;
				} else if (reg.test($("#emailADRS").val()) || reg.test($("#emailCopyADRS").val())) {
					swal("系统检测到收件人或抄送人地址包含中文标点符号会导致邮件发送失败,请检查!");
					return false;
				} else if (!(checkEmailAdrsFormate($("#emailADRS").val()) && checkEmailAdrsFormate($("#emailCopyADRS")
						.val()))) {
					swal("收件人或抄送人邮件格式不符合系统规范,请检查!" + "\n 标准格式:海天-张三<aaa@163.com>");
					return false;

				} else if ($('#divFilesUploaded a').text() === "") {
					swal("程序附件不存在,请检查!");
					return false;
				} else if ($("#emailContent").val() === "") {
					swal("邮件内容未填写,请检查!");
					return false;
				}
				return true;
			}



			//函数:详情按钮详情页自动填写内容------------------------
			function Fun_winDetailInit(dataChoose) {


				let dataSelect = NulltoEmpty(dataChoose);

				$('#DBID').val(dataSelect.DBID);
				$('#BPID').text(dataSelect.BPID);
				$('#version').text(dataSelect.version);
				$('#PBHCTRName').text(dataSelect.PLDCTRName);
				$('#MHEName').text(dataSelect.MHEName);
				$('#model').text(dataSelect.model);
				$('#PGEMaker').text(dataSelect.PGEMaker);
				$('#FQCRequestText').text(dataSelect.FQCRequestText);
				$('#FQCPassText').text(dataSelect.FQCPassText);
				$('#applyDate').text(dataSelect.applyDate);
				$('#limitDate').text(dataSelect.limitDate);
				$('#topic').text(dataSelect.topic);

				// console.log('detail:' + dataSelect.detail)
				$('#detail').text(dataSelect.detail.replace(/<br\/>/g, '\n'));

				//	tasksTableSQL={"SQL":"SQLTableBillsTask","filter":"taskBPID = '"+dataSelect.BPID+"'"};
				//	var tableID="#billsTaskTable";
				//	Fun_showSQLFileTable(tasksTableSQL,tableID);

				//加载任务表内容, 
				var SQLParamTask = {
					"tableName": "ppm_bills_task",
					"titles": [
						"BTID",
						"BTVersion",
						"taskStaff",
						"taskTypeText",
						"taskLimitDate",
						"modifyContent",
						"functionsDBE",
						"taskFiles"
					],
					"filter": "taskBPID='" + dataSelect.BPID + "'",
					"BID": "BTID",
					"VER": "BTVersion"
				};



				Fun_fillTrackTable("#billsTaskTable", SQLParamTask);


				$('#emailADRS').val(dataSelect.emailADRS);
				$('#emailCopyADRS').val(dataSelect.emailCopyADRS);

				$('#emailTitle').val(dataSelect.emailTitle);



				//    var emailFiles=JSON.parse(dataSelect.emailFiles);
				//    
				//    var emailFilesHtml=$('#emailFiles').html();
				//    
				//   console.log("emailFiles:"+emailFiles);

				//   if(emailFiles!=null){
				//	   for(var i=0;i<emailFiles.length;i++){
				//	    	 $("#emailFiles").html(emailFilesHtml+"<a href='/system.files.download/upload_"+emailFiles[i].fileKey+"' download='"+emailFiles[i].fileName+"'>"+emailFiles[i].fileName+"</a>");
				//	    	 
				//	    	 emailFilesHtml=$("#emailFiles").html()+" ; ";
				//
				//	    }
				//   }
				//    
				//   emailFilesValue=emailFiles;

				if (dataSelect.files != null && dataSelect.files != "") {

					var files = JSON.parse(dataSelect.files);
					if (files != null) {

						var fileLink = "";
						if (files.length > 0) {
							for (var i = 0; i < files.length; i++) {
								// console.log("files[i].fileName:" + files[i].fileName);

								fileLink = fileLink + "<a  href=" + '/system.files.download/upload_' + files[i].fileKey +
									" download=" + files[i].fileName + ">" + "<span>" + files[i].fileName + "</span></a>" +
									" ; ";
							}

							// fileLink = fileLink.substr(0, fileLink.length - 3);
						}
						var downloadurl = fileLink;
					} else {
						downloadurl = "";
					}
					$('#divFilesUploaded').html(downloadurl);
				}

				if (dataSelect.files != "") {

					var files = JSON.parse(dataSelect.files);
					if (files != null) {

						var fileLink = "";
						if (files.length > 0) {
							for (var i = 0; i < files.length; i++) {
								// console.log("files[i].fileName:" + files[i].fileName);
								fileLink = fileLink + "<a  href=" + '/system.files.download/' + files[i].fileKey +
									" download=" +
									files[i].fileName + ">" + "<span>" + files[i].fileName + "</span></a>" + " ; ";
							}
							// fileLink = fileLink.substr(0, fileLink.length - 3);
						}
						var downloadurl = fileLink;
					} else {
						downloadurl = "";
					}
					$('#divFilesUploaded').html(downloadurl);
				}

				$('#emailContact').val(dataSelect.emailContact);


				$('#emailContent').val(dataSelect.emailContent.replace(/<br\/>/g, '\n'));
				$('#PBHRemark').val(dataSelect.PBHRemark);

				$('#PBHMaker').text(dataSelect.PBHMaker);
				$('#PBHMakeDate').text(dataSelect.PBHMakeDate);
				$('#PBHVersion').text(dataSelect.PBHVersion);
				// $('#PBHAuditor').text(dataSelect.PBHAuditor);
				$('#PBHAuditDate').text(dataSelect.PBHAuditDate);
				$('#PBHResultText').text(dataSelect.PBHResultText);


				if (dataSelect.PBHAuditor === "") {
					Fun_getSQLSelectDBData({
						SQL: "SQLSRStaffs"
					}, "#PBHAuditor", '谢丽君');
				} else {
					Fun_getSQLSelectDBData({
						SQL: "SQLSRStaffs"
					}, "#PBHAuditor", dataSelect.PBHAuditor);
				}







				if (dataSelect.PBHAuditResult == 0 || dataSelect.PBHAuditResult == null || dataSelect.PBHAuditResult == "") {
					$("#DivFileBTNS").show();
					$('#DivToolBTNS').show();
					$('#DivPBHBTNS').show();
					$('#DivEmaiBTNS').hide();


					$("#PBHAuditor").attr("disabled", false);
					$('#BTNUpdVer').hide();

					if (sessionName === dataSelect.PBHMaker || dataSelect.PBHMaker === "") {
						$('#PBHAuditor').attr("disabled", false);
					} else {
						$('#PBHAuditor').attr("disabled", true);
					}

				} else {

					$('input').attr("disabled", true);
					$('select').attr("disabled", true);
					$('textarea').attr("disabled", true);

					$("#DivFileBTNS").hide();
					$('#DivToolBTNS').hide();
					$('#DivPBHBTNS').hide();
					$('#DivEmaiBTNS').show();
					$("#PBHAuditor").attr("disabled", true);
					$('#BTNUpdVer').show();

				}

			}


			//格式化抄送邮件格式

			const formateCopyEmailADS = (adrs, mark) => {

				// console.log(adrs)
				let o = '';

				o = adrs;
				// try {
				// 	if (adrs.indexOf(',') !== -1) {
				// 		adrs = adrs.replace(/;/g, ',');
				// 		adrsArray = adrs.split(',');

				// 		for (let n = 0; n < adrsArray.length; n++) {
				// 			adrsArray[n] = mark + '-抄送' + (n + 1) + '<' + adrsArray[n] + '>';

				// 			console.log("adrsArray[n]:" + adrsArray[n]);

				// 			o = o + adrsArray[n] + ',';
				// 		}

				// 		o = o.substring(0, o.length - 1);
				// 	} else if (adrs !== '') {
				// 		o = mark + '-抄送<' + adrs + '>';
				// 	}

				// } catch (error) {
				// 	console.log("formateCopyEmailADS error:" + error)

				// }

				return o;

			}

			const sendSMS = async (phone, content) => {
				$.ajax({
					method: 'post',
					url: '/app/PM/lib/sms',
					data: {
						phone,
						content
					},
					success: function (data) {
						alert('发送短信成功!')
					},
					error: function () {}
				})
			}

			//页面加载函数---------------
			$(document).ready(function () {




				sessionName = "<%-locals.session.yjUser.Name%>";
				customerPhone = '';

				var undone = getQueryString("undone");


				switch (undone) {
					case "unRecord":
						var tableSQL = {
							"SQL": "SQLTableBillsPBH",
							"filter": " maker = '" + sessionName + "' AND  ( emailResult=3 OR PBHStatus IS NULL )",
							"orderBy": " saveTimeStamp DESC"
						};
						break;
					case "unAudit":
						var tableSQL = {
							"SQL": "SQLTableBillsPBH",
							"filter": "PBHAuditor = '" + sessionName + "' AND PBHStatus =0",
							"orderBy": " saveTimeStamp DESC"
						};
						break;
					case "unSend":
						var tableSQL = {
							"SQL": "SQLTableBillsPBH",
							"filter": "PBHMaker = '" + sessionName + "' AND PBHStatus =1 AND emailResult=0",
							"orderBy": " saveTimeStamp DESC"
						};
						break;
					case "all":
						var tableSQL = {
							"SQL": "SQLTableBillsPBH",
							"orderBy": " saveTimeStamp DESC"
						};
						$("#BTNFilterAll").addClass("active");
						break;
					default:
						var tableSQL = {
							"SQL": "SQLTableBillsPBH",
							"filter": "emailResult=0 OR emailResult=3 OR emailResult IS NULL",
							"orderBy": " saveTimeStamp DESC"
						};
						$("#BTNFilterSimple").addClass("active");
						break;
				}

				//		if(undone=="true"){
				//			var tableSQL={"SQL":"SQLTableBillsPBH","filter":" (PGEMaker = '"+sessionName+"' OR PBHMaker = '"+sessionName+"'  OR PBHAuditor = '"+sessionName+"') AND ( emailResult IS NULL OR emailResult =0)","orderBy":" saveTimeStamp DESC"};
				//		}else{
				//			var tableSQL={"SQL":"SQLTableBillsPBH","orderBy":" saveTimeStamp DESC"};
				//		}


				tableInfo = {
					"tableID": "#billsPBHTable",
					"columnsData": [{
							data: 'saveTimeStamp',
							"visible": false
						},
						{
							data: 'DBID',
							"visible": false
						},
						{
							data: 'BPID'
						},
						{
							data: 'version'
						},
						{
							data: 'PLDCTRName'
						},
						{
							data: 'limitDate'
						},
						{
							data: 'taskNum'
						},
						{
							data: 'taskNumDone'
						},
						{
							data: 'PBHMaker'
						},
						{
							data: 'PBHAuditor'
						},
						{
							data: 'billPBHStatus'
						},
						{
							data: 'PBHResultText'
						}
					]
				}


				Fun_showSQLTable(tableSQL, tableInfo);





				//判断是否选中数据-------
				var table = $('#billsPBHTable').DataTable();
				$('#billsPBHTable tbody').on('click', 'tr', function () {
					if ($(this).hasClass('selected')) {
						$(this).removeClass('selected');
					} else {
						table.$('tr.selected').removeClass('selected');
						$(this).addClass('selected');
					}

					var dataSelect = table.row('.selected').data();


				});

				//dbclick 测试判断是否选中数据-------

				$('#billsPBHTable tbody').on('dblclick', 'tr', function () {
					table.$('tr.selected').removeClass('selected');
					$(this).addClass('selected');
					$('#BTNPBHDetail').click();

				});


				//过滤按钮组
				$('#BTNFilterSimple').click(function () {
					window.location.href = '/app/PM/billsPBH';
				});

				$('#BTNFilterAll').click(function () {
					window.location.href = '/app/PM/billsPBH?undone=all';
				});

				//按钮-发布维护---------
				$('#BTNPBHDetail').click(function () {

					// console.log("seclet: " + JSON.stringify(table.row('.selected').data()));
					// table.row('.selected').remove().draw( false );
					var dataSelect = table.row('.selected').data();
					if (dataSelect == undefined) {
						swal("请先点击表格中的表单!");
					} else {

						$('#BillPLD').modal('show')
						Fun_winDetailInit(dataSelect);


					}


				});

				//按钮-填入系统信息

				$('#BTNGetInfo').click(function () {

					$('#BTNResetInfo').click();
					var PBHCTRName = $("#PBHCTRName").text();
					$("#emailTitle").val("【弘讯PPM处理结果】" + $("#topic").text() + "  ,  单号:" + $("#BPID").text());

					var fileNum = $("#billsTaskTable tbody").find("tr").length;
					// console.log("fileNum:" + fileNum);

					var filesHtml = $("#divFilesUploaded").html();
					//emailFilesValue=[];
					//console.log("emailFiles:"+emailFiles);

					SQLEMails = {
						"SQL": "SQLGetEMails",
						"filter": "FTYName = '" + PBHCTRName + "'"
					};

					let emailContentFormat = "";

					var filesHtml = "";

					var emailModifyContent = "";

					var emailFunctionsDBE = "";

					for (var i = 0; i < fileNum; i++) {

						var tdFiles = $("#billsTaskTable tbody tr:eq(" + i + ") td:last")
							.html();

						var tdTaskType = $("#billsTaskTable tbody tr:eq(" + i + ") td:eq(3)")
							.html();

						if (tdFiles != "" && tdTaskType == "APP") {

							filesHtml = filesHtml + tdFiles + " ; ";

							emailModifyContent = emailModifyContent +
								htmlToTextarea($("#billsTaskTable tbody tr:eq(" + i + ") td:eq(5)").html()) +
								"\n";

							emailFunctionsDBE = emailFunctionsDBE +
								htmlToTextarea($("#billsTaskTable tbody tr:eq(" + i + ") td:eq(6)").html()) +
								"\n";

						}

					}

					// console.log("filesHtml:" + JSON.stringify(filesHtml));

					if (filesHtml != "") {
						filesHtml = filesHtml.substr(0, filesHtml.length - 3);
						$("#divFilesUploaded").html(filesHtml);
					}


					var ibtn = "<button  class='btn btn-default btn-xs'>×</button>";
					$("#divFilesUploaded").find("a").after(ibtn);


					$("#divFilesUploaded :button").on('click', function () {
						$(this).prev("a").remove();
						$(this).prev("span").remove();
						// $(this).next(";").remove();
						$(this).remove();
					})


					//不抓取功能说明
					$("#emailContent").val(emailContentFormat + "修改内容:\n" +
						emailModifyContent);

					// $("#emailContent").val(emailContentFormat + "修改内容:\n" +
					// 	emailModifyContent + "功能说明:\n" + emailFunctionsDBE);




					Fun_getSQLSelectDBData({
						SQL: "SQLSRStaffs"
					}, "#PBHAuditor", '谢丽君');

					$.ajax({
						method: 'get',
						data: SQLEMails,
						url: "/app/PM/getSQLDBData",
						success: function (data) {
							// console.log("back email data:" + JSON.stringify(data));

							$("#emailADRS").val($('#PBHCTRName').text() + '-' + data[0].contact +
								'<' + data[0].email + '>');

							// swal(JSON.stringify(getEmails(data[0].contacts)));

							// let emailCopyADRS = formateCopyEmailADS(getEmails(data[0].contacts), $(
							// 	'#PBHCTRName').text());

							emailCopyADRS = data[0].contacts;
							// console.log('emailCopyADRS', emailCopyADRS);

							if (emailCopyADRS) {
								$("#emailCopyADRS").val(emailCopyADRS.replace(/\s+/g, ""));
							}

							$("#emailContact").val(data[0].contact);

						},
						error: function () {}
					})

				});


				//按钮-清空信息
				$('#BTNResetInfo').click(function () {
					$("#emailADRS").val("");
					$("#emailCopyADRS").val("");
					$("#emailTitle").val("");
					$("#divFilesUploaded").text("");
					$("#emailContact").val("");

					$("#emailContent").val("");
					$("#PBHRemark").val("");

				});



				//按钮-PBH保存---------
				$('#BTNPBHSave').click(function () {

					if (checkAuthority({
							"SQL": "SQLGetAuthorities",
							"filter": "StaffName='" + sessionName + "'"
						}, "PBH01")) {
						if (checkPBHInput()) {

							let dataSelect = table.row('.selected').data();

							// console.log("dataSelect.maker:" + dataSelect.maker);


							if (sessionName !== dataSelect.maker) {
								swal("当前帐户非此单方案人,不可填单!")
							} else {
								var files = [];

								$('#divFilesUploaded a').each(function () {
									var fileKey = $(this).attr('href').substring(23);
									var fileName = $(this).attr('download');

									var fileInfo = {
										"fileName": fileName,
										"fileKey": fileKey
									}

									files.push(fileInfo);
								});

								let PBHMaker = $('#PBHMaker').text();

								if (PBHMaker === '') {
									PBHMaker = sessionName;
								}

								var PBHData = {
									"DBTable": "ppm_bills_PBH",
									"DBID": $('#DBID').val(),
									"PBHBPID": $('#BPID').text(),
									"PBHCTRName": $('#PBHCTRName').text(),
									"emailADRS": $('#emailADRS').val(),
									"emailCopyADRS": $('#emailCopyADRS').val(),
									"emailTitle": $('#emailTitle').val(),
									//						"files":JSON.stringify(filesValue),
									"files": JSON.stringify(files),
									"emailContact": $('#emailContact').val(),
									"emailContent": $('#emailContent').val().replace(/\n|\r\n/g, '<br/>')
										.replace(/'/g, '"'),
									"PBHRemark": $('#PBHRemark').val(),
									"PBHMaker": PBHMaker,
									"PBHMakeDate": Ndate,
									"PBHAuditor": $('#PBHAuditor option:selected').text(),
									"billPBHStatus": "已填单,未审核"
								}

								//		saveDBData(PBHData,"PBH单");

								$.ajax({
									method: 'post',
									url: '/app/PM/saveDBData',
									data: PBHData,
									success: function (data) {
										//         swal("成功数据:" + JSON.stringify(data));
										if (data.affectedRows != 0) {

											// $('#PBHMaker').text(sessionName);

											//     	               swal("方案单数据保存成功!");

											if (sessionName == $('#PBHAuditor option:selected')
												.text()) {
												let msg = confirm("发布单保存成功,是否立刻自动审核?");

												if (msg) {
													$('#BTNPBHAudit').click();
												} else {
													io_refresh()
												}

											} else {
												// swal('发布单保存成功')
												// io_refresh()


												let i = {
													confirmMsg: '发布单保存成功,是否发送钉钉消息?',
													DDMsg: {
														at: '"' + $(
																'#PBHAuditor option:selected')
															.text() + '"',
														msg: '@' + $(
																'#PBHAuditor option:selected')
															.text() + ' 发布单已填写,请审核!'
													},
													alertMsg: '发送成功'
												}
												let o = {
													f: io_refresh
												}
												aio_chooseSendDDMsg(i, o)
											}

										}
									},
									error: function (err) {
										if (err.responseText.indexOf("ER_DUP_ENTRY") != -1) {
											swal("系统中已存在重复数据,请检查!");
										} else {
											swal("失败数据:" + JSON.stringify(err));
										}
									}
								});

							}

						}

					}
				});



				//按钮-PBH审核---------
				$('#BTNPBHAudit').click(function () {

					if (sessionName !== $('#PBHAuditor option:selected').text()) {
						swal('非指定审核人,不允许审核!')
					} else {
						if (checkAuthority({
								"SQL": "SQLGetAuthorities",
								"filter": "StaffName='" + sessionName + "'"
							}, "PBH02")) {

							if (checkPBHInput()) {
								let PBHVersion = 0

								if ($('#PBHVersion').text() !== "") {
									PBHVersion = $('#PBHVersion').text();

								}

								var files = [];

								$('#divFilesUploaded a').each(function () {
									var fileKey = $(this).attr('href').substring(23);
									var fileName = $(this).attr('download');

									var fileInfo = {
										"fileName": fileName,
										"fileKey": fileKey
									}

									files.push(fileInfo);
								});


								var PBHData = {
									"DBTable": "ppm_bills_PBH",
									"BillIDName": "pbhBPID",
									"BillID": $('#BPID').text(),
									"emailADRS": $('#emailADRS').val(),
									"emailCopyADRS": $('#emailCopyADRS').val(),
									"emailTitle": $('#emailTitle').val(),
									"files": JSON.stringify(files),
									"emailContact": $('#emailContact').val(),
									"emailContent": $('#emailContent').val().replace(/\n|\r\n/g, '<br/>')
										.replace(/'/g, '"'),
									"PBHRemark": $('#PBHRemark').val(),
									"PBHAuditor": sessionName,
									"PBHAuditDate": Ndate,
									"PBHAuditResult": 1,
									"PBHStatus": 1,
									"PBHStatusText": "已审核",
									"billPBHStatus": "已填单,已审核",
									"filter": " PBHVersion ='" + PBHVersion + "'"
								}

								//	     updDBData(PBHData,"PBH单审核状态");

								$.ajax({
									method: 'post',
									url: '/app/PM/updBillStatus',
									data: PBHData,
									success: function (data) {
										//         swal("成功数据:" + JSON.stringify(data));
										if (data.affectedRows != 0) {
											// swal('发布单审核成功')
											// io_refresh()

											let i = {
												confirmMsg: '发布单已审核,是否发送钉钉提醒消息?',
												DDMsg: {
													at: '"' + $('#PBHMaker').text() + '"',
													msg: '@' + $('#PBHMaker').text() +
														' 发布单已审核,请发邮件!'
												},
												alertMsg: '发送成功'
											}
											let o = {
												f: io_refresh
											}
											aio_chooseSendDDMsg(i, o)
										}
									},
									error: function (err) {
										if (err.responseText.indexOf("ER_DUP_ENTRY") != -1) {
											swal("系统中已存在重复数据,请检查!");
										} else {
											swal("失败数据:" + JSON.stringify(err));
										}
									}
								});

							}





						}

					}







				});


				//radio 定义更换按键触发事件-----------
				$('input:radio[name="auditType"]').click(function () {

					var PGEMaker = $('#PGEMaker').children('option:selected').text();
					// console.log("PGEMaker:" + PGEMaker);
					var radioValue = $('input:radio[name="auditType"]:checked').val();
					switch (radioValue) {
						case "1":
							var SQLAuditor = {
								SQL: "SQLSRStaffs"
							};
							var auditor = "#auditor";
							Fun_getSQLSelectDBData(SQLAuditor, auditor, PGEMaker);
							$("#auditor").attr("disabled", true);
							$('#auditDate').val("");
							$('#auditResult').val("");
							break;
						case "2":

							var SQLAuditor = {
								SQL: "SQLSRStaffs"
							};
							var auditor = "#auditor";
							Fun_getSQLSelectDBData(SQLAuditor, auditor);
							$("#auditor").attr("disabled", false);
							$('#auditDate').val("");
							$('#auditResult').val("");
							break;
					}

				});

				//按钮-邮件预览
				$('#BTNModelEmail').click(function () {

					if (checkAuthority({
							"SQL": "SQLGetAuthorities",
							"filter": "StaffName='" + sessionName + "'"
						}, "PBH03")) {




						$('#winEmail').window('open');

						$('#emailADRSModel').text($('#emailADRS').val());
						$('#emailCopyADRSModel').text($('#emailCopyADRS').val());
						$('#emailTitleModel').text($('#emailTitle').val());
						$('#emailFilesModel').text($('#divFilesUploaded').text());

						$('#emailDSPInfo').html("");
						$('#emailHMIInfo').html("");


						let fileNum = $("#billsTaskTable tbody").find("tr").length;

						for (let i = 0; i < fileNum; i++) {

							let tdBTID = $("#billsTaskTable tbody tr:eq(" + i + ") td:first").html()

							let tdBTType = tdBTID.substring(12, 13)

							let tdFiles = $("#billsTaskTable tbody tr:eq(" + i + ") td:last").text();
							// console.log("tdFiles:" + tdFiles)

							let tdTaskType = $("#billsTaskTable tbody tr:eq(" + i + ") td:eq(3)").html();

							if (tdFiles != "" && tdTaskType == "APP") {

								switch (tdBTType) {
									case 'D':
										$('#emailDSPInfo').html($('#emailDSPInfo').html() + ' ' + tdFiles);
										break
									case 'H':
										$('#emailHMIInfo').html($('#emailHMIInfo').html() + ' ' + tdFiles);
										break
								}



								//    		 filesHtml=filesHtml+tdFiles+" ; ";
								//    		 emailModifyContent=emailModifyContent+$("#billsTaskTable tbody tr:eq("+i+") td:eq(5)").html()+"\n";
								//    		 emailFunctionsDBE=emailFunctionsDBE+$("#billsTaskTable tbody tr:eq("+i+") td:eq(6)").html()+"\n";

							}



						}


						$('#emailContentHello').html("Dear " + $('#emailContact').val() +
							": \n  您好！程序已修改完成，请查收，谢谢！");

						$('#emailBPID').html($('#BPID').text())

						if ($('#emailContent').val().indexOf("功能说明") != -1) {

							let emailContent = $('#emailContent').val().split("功能说明"); //去除功能说明

							let emailContentModel = emailContent[0];

							if ($('#PBHRemark').val() !== '') {
								emailContentModel = emailContentModel + '备注:' + $('#PBHRemark').val();
							}

							$('#emailContentModel').html(emailContentModel.replace(/\n|\r\n/g, '<br/>'));

						} else {

							let emailContentModel = $('#emailContent').val().replace(/\n|\r\n/g, '<br/>');

							// console.log("emailContentModel:" + emailContentModel)

							if ($('#PBHRemark').val() !== '') {
								emailContentModel = emailContentModel + '备注:' + $('#PBHRemark').val();
							}

							$('#emailContentModel').html(emailContentModel);

						}

					}
				});

				//按钮-发送邮件

				$('#BTNModelEmailSend').click(async function () {


					if ($('#PBHAuditDate').text() === "") {
						swal('该发布单未审核,不允许发送系统邮件!')
					} else {

						//d-更新需求单状态

						let requestBill = {
							BPID: $('#BPID').text(),
							status: '已完结'
						}

						let requestRs = await postDBData({
							sql: 'update',
							params: {
								tableId: 'ppm_bills_request',
								data: [requestBill],
								key: 'BPID'
							}
						})

						if (!requestRs) {
							console.log('更新需求单状态错误', requestRs);
						}



						var files = [];

						$('#divFilesUploaded a').each(function () {
							var fileKey = $(this).attr('href').substring(23);
							var fileName = $(this).attr('download');

							var fileInfo = {
								"fileName": fileName,
								"fileKey": fileKey
							}

							files.push(fileInfo);
						});


						$.ajax({
							method: 'get',
							data: {
								SQL: 'select staffName,telNo from ppm_staffs',
								filter: 'staffName ="' + $('#PGEMaker').text() + '"'
							},
							url: "/app/PM/getSQLDBData",
							success: function (data) {
								// console.log('staff get:' + JSON.stringify(data))

								let signName = ''
								let signTelNo = ''

								if (data.length !== 0) {
									signName = data[0].staffName;
									signTelNo = data[0].telNo;
								}

								var emailData = {
									"pbhBPID": $('#BPID').text(),
									"emailResult": 1,
									"emailADRS": $('#emailADRS').val().replace(/;/g, ","),
									"emailCopyADRS": $('#emailCopyADRS').val().replace(/;/g,
										","),
									"emailDSPInfo": $('#emailDSPInfo').html(),
									"emailHMIInfo": $('#emailHMIInfo').html(),
									"emailTitle": $('#emailTitle').val(),
									"emailFiles": JSON.stringify(files),
									"emailContact": $('#emailContact').val(),
									"emailContentHello": $('#emailContentHello').html(),
									"emailContentModel": $('#emailContentModel').html(),
									"emailDate": Ndate,
									"signName": signName,
									"signTelNo": signTelNo
								}

								$.ajax({
									method: 'post',
									url: '/app/PM/sendSYSMail',
									data: emailData,
									success: function (data, textStatus) {


										let i = {

											DDMsg: {
												at: '"' + $('#PGEMaker')
													.text() +
													'"',
												msg: '@' + $('#PGEMaker')
													.text() +
													',客户:' + $('#PBHCTRName')
													.text() +
													',该客户计划单系统邮件已发送,请知悉!'
											},
										}

										aio_sendDDMsg(i);



									},
									error: function (XMLHttpRequest, textStatus,
										errorThrown) {

										swal("发送失败:" + JSON.stringify(textStatus));
									}
								});

								// let i={alertMsg:"系统邮件已发送!"}
								// swalAndRefresh(i)
								swal("系统邮件已发出，正在接收发送结果，请等待约10秒，收到success返回消息后可关闭！");


							},
							error: function () {}
						})


					}

				});


				//按钮-邮件自定义
				$('#BTNSendEmailDiv').click(async function () {

					var msg = confirm("点击自定义邮件后,将跳转至邮件客户端,发布单默认邮件已发送,是否继续?");
					if (msg == true) {

						//d-更新需求单状态

						let requestBill = {
							BPID: $('#BPID').text(),
							status: '已完结'
						}

						let requestRs = await postDBData({
							sql: 'update',
							params: {
								tableId: 'ppm_bills_request',
								data: [requestBill],
								key: 'BPID'
							}
						})

						if (!requestRs) {
							console.log('更新需求单状态错误', requestRs);
						}



						var emailData = {
							"pbhBPID": $('#BPID').text(),
							"emailResult": 2,
							"emailDate": Ndate,
						}

						$.ajax({
							method: 'post',
							url: '/app/PM/sendSYSMail',
							data: emailData,
							success: function (data, textStatus) {

							},
							error: function (XMLHttpRequest, textStatus, errorThrown) {

							}
						});


						$('#mailhref').attr("href", "mailto:" + $('#emailADRS').val() + "?subject=" +
							$(
								'#emailTitle').val() + "&cc=" + $('#emailCopyADRS').val() +
							"&body=" + $(
								'#emailContent').val().replace(/\n|\r\n/g, '<br/>').replace(/'/g, '"'));
						$('#mailhref').click();

					}

				});

				//按钮-更新版本

				$('#BTNUpdVer').click(function () {

					if (checkAuthority({
							"SQL": "SQLGetAuthorities",
							"filter": "StaffName='" + sessionName + "'"
						}, "PBH04")) {
						var msg = confirm("风险操作,更新版本后原发布单将失效,是否继续?");
						if (msg == true) {

							var newVersion = parseInt($('#PBHVersion').text()) + 1;

							var files = [];

							$('#divFilesUploaded a').each(function () {
								var fileKey = $(this).attr('href').substring(23);
								var fileName = $(this).attr('download');

								var fileInfo = {
									"fileName": fileName,
									"fileKey": fileKey
								}

								files.push(fileInfo);
							});

							// console.log("file:" + JSON.stringify(files))


							let oldPBHData = {
								"DBTable": "ppm_bills_pbh",
								"BillIDName": "pbhBPID",
								"BillID": $('#BPID').text(),
								"PBHStatus": 0
							}

							let ajax1 = $.ajax({
								method: 'post',
								url: '/app/PM/updBillStatus',
								data: oldPBHData,
								success: function (data, textStatus) {},
								error: function (XMLHttpRequest, textStatus, errorThrown) {}
							});


							var newPBHData = {

								"DBTable": "ppm_bills_PBH",
								"PBHVersion": newVersion,
								"PBHBPID": $('#BPID').text(),
								"PBHVersion": newVersion,
								"PBHCTRName": $('#PBHCTRName').text(),
								"emailADRS": $('#emailADRS').val(),
								"emailCopyADRS": $('#emailCopyADRS').val(),
								"emailTitle": $('#emailTitle').val(),
								"files": JSON.stringify(files),
								"emailContact": $('#emailContact').val(),
								"emailContent": $('#emailContent').val().replace(/\n|\r\n/g,
									'<br/>'),
								"PBHRemark": $('#PBHRemark').val(),
								"PBHMaker": sessionName,
								"PBHMakeDate": Ndate,
								"PBHAuditor": $('#PBHAuditor option:selected').text()
							}

							let ajax2 = $.ajax({
								method: 'post',
								url: '/app/PM/addDBData',
								data: newPBHData,
								success: function (data) {

								},
								error: function (err) {

									if (err.responseText.indexOf("ER_DUP_ENTRY") != -1) {
										swal("系统中已存在重复数据,请检查!");
									} else {
										swal("失败数据:" + JSON.stringify(err));
									}


								}
							});

							$.when(ajax1, ajax2).done(function () {



								// let i = {
								// 	alertMsg: "更新版本成功!"
								// }
								// swalAndRefresh(i)

								$('#BillPLD').modal('hide');

								let i = {
									msg: '更新版本成功,请填写更新原因!',
									updateParams: {
										"DBTable": "ppm_bills_pbh",
										"BillIDName": "pbhBPID",
										"BillID": $('#BPID').text(),
										"updateReason": '',
										"filter": "PBHVersion =" + $('#PBHVersion').text()

									}
								}
								updateAndWriteReason(i);

							});

						}

					}
				});


				//按钮-程序归档
				$('#BTNProgramEnd').click(async function () {

					//d 获得任务单数据
					let fileNum = $("#billsTaskTable tbody").find("tr").length;
					let taskFilter = ""
					for (let i = 0; i < fileNum; i++) {
						let tdBTID = $("#billsTaskTable tbody tr:eq(" + i + ") td:first").html()
						let tdBTVer = $("#billsTaskTable tbody tr:eq(" + i + ") td:eq(1)").html()
						taskFilter = taskFilter + "('" + tdBTID + "'," + tdBTVer + "),"
					}
					taskFilter = ' (BTID,BTVersion) in (' + taskFilter.substring(0, taskFilter.length - 1) +
						')';

					let tasks = await getDataBySql({
						sql: 'sqlProgramEnd',
						params: {
							filter: taskFilter
						}
					})
					console.log("tasks:", tasks);

					let autoFileArr = [];
					for (const n of tasks) {
						let nTaskFiles = JSON.parse(n.taskFiles);
						for (const file of nTaskFiles) {

							let customerPath = n.cust_FID + "(" + n.cust_Name + ")";
							let systemPath = "";
							if (n.catalog === '/') {
								systemPath = n.STMType.replace("DSP", "")
							} else {
								systemPath = n.catalog
							}
							let yearPath = n.BTID.substring(1, 5);
							let groupPath = n.groupLabel;
							let machinePath = n.MHEType;
							let modelPath = "";
							if (n.groupLabel === 'DSP') {
								modelPath = n.model
							} else if (n.model === '/') {
								modelPath = n.model
							} else {
								modelPath = n.STMType + '-' + n.model
							}

							if (!(customerPath && systemPath && yearPath && groupPath && machinePath &&
									modelPath)) {
								console.log(customerPath, systemPath, yearPath, groupPath, machinePath,
									modelPath);
								alert('归档终止,存在无效的归档参数,,请检查基础数据,或联系管理员!')
								return

							}



							let filePathArr = [
								customerPath,
								systemPath,
								yearPath,
								groupPath,
								machinePath,
								modelPath
							];
							autoFileArr.push({
								fileName: file.fileName,
								fileKey: file.fileKey,
								filePath: filePathArr,
								modifyContent: n.modifyContent,
							})
						}
					}

					console.log('autoFileArr', autoFileArr);

					//d api归档

					let res = await $.ajax({
						method: 'post',
						url: 'https://192.168.0.9:8000/api/ppm/lin/autoFile',
						data: {
							autoFileArr: autoFileArr
						},
						success: function (data) {
							console.log('111111', data);
							return data;
						},
						error: function (error) {
							console.log('111111', error);
							return error;
						}
					});
					alert(res)

				})


				//按钮-短信通知
				$('#BTNSendSMSOpen').click(async function () {
					$('#winSMS').modal('show')
					let customerName = $('#PBHCTRName').text();
					let customerData = await getDataBySql({
						sql: "getCustomer",
						params: {
							filter: "FTYName='" + customerName + "'"
						}
					})
					// console.log('customerData', customerData);
					let phone = customerData[0].phone;

					if (!phone) {
						alert('此客户手机号为空!')
						return
					}

					customerPhone = phone
					$('#smsPhone').val(phone)

				})


				$('#BTNSendSMS').click(async function () {

					//检查号码有效性
					let smsPhone = $('#smsPhone').val();
					let smsPhoneArr = smsPhone.split(',');

					//判断是否为有效手机号
					const isPhoneAvailable = (phone) => {
						let myreg = /^[1][3,4,5,6,7,8,9][0-9]{9}$/;
						if (!myreg.test(phone)) {
							return false;
						} else {
							return true;
						}
					}

					for (const n of smsPhoneArr) {
						if (!isPhoneAvailable(n)) {
							alert('存在无效手机号,请检查!')
							return;
						}
					}

					//发送短信
					let topic = $('#topic').text()
					await sendSMS(smsPhone, topic)

					if (smsPhone === customerPhone) {
						return
					}

					if (!confirm('检测到号码有异动,是否更新到客户信息?')) {
						return
					}
					//更新手机号
					let customerData = {
						FTYName: $('#PBHCTRName').text(),
						phone: smsPhone
					}
					let ru = await postDBData({
						sql: 'update',
						params: {
							tableId: 'ppm_customers',
							data: [customerData],
							key: 'FTYName'
						}
					})
					if (ru.affectedRows > 0) {
						alert('更新客户信息成功!')
						$('#winSMS').modal('hide')
					}
				})

				//按钮-完结归档
				$('#BTNEnd').click(function () {

					if ($('#PBHAuditDate').text() === "") {
						swal("发布单未保存审核,不符合完结归档条件,请检查!")
					} else {
						if (checkAuthority({
								"SQL": "SQLGetAuthorities",
								"filter": "StaffName='" + sessionName + "'"
							}, "PBH05")) {

							var msg1 = confirm("归档后,系统不再显示关于该计划的所有单据!是否继续?");
							if (msg1 === true) {

								var PLDUpdData = {
									"DBTable": "ppm_bills_plan",
									"BillIDName": "BPID",
									"BillID": $('#BPID').text(),
									"WFStatus": 100,
									"WFEndDate": Ndate
								}

								var taskUpdData = {
									"DBTable": "ppm_bills_task",
									"BillIDName": "taskBPID",
									"BillID": $('#BPID').text(),
									"WFStatus": 100
								}

								var ajax1 = $.ajax({
									method: 'post',
									url: '/app/PM/updBillStatus',
									data: PLDUpdData,
									success: function (data, textStatus) {},
									error: function (XMLHttpRequest, textStatus,
										errorThrown) {}
								});

								var ajax2 = $.ajax({
									method: 'post',
									url: '/app/PM/updBillStatus',
									data: taskUpdData,
									success: function (data, textStatus) {},
									error: function (XMLHttpRequest, textStatus,
										errorThrown) {}
								});

								$.when(ajax1, ajax2).done(function () {


									let i = {
										alertMsg: "归档完成,该计划任务完结!"
									}
									swalAndRefresh(i)
								});
							}

						}

					}



				});


				//按钮-表单关闭按钮,添加刷新数据功能
				$('#btnModalClose').click(function () {
					window.location.reload();
				});




				//按钮-表单关闭按钮,添加刷新数据功能
				$('#BTNFormClose').click(function () {
					window.location.reload();
				});



			});
		</script>